<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxanalitica Suite - Org Chart Pro</title>
    
    <!-- NIVEL 1: Core (React 18) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- NIVEL 2: Middleware (Babel Standalone) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- NIVEL 3: Librerías de Procesamiento -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- NIVEL 4: Extensiones de React -->
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.10.4/umd/Recharts.min.js"></script>
    
    <!-- NIVEL 5: Diseño -->
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'in': 'fadeIn 0.5s ease-out',
                        'slide-in-left': 'slideInLeft 0.3s ease-out',
                        'zoom-in': 'zoomIn 0.5s ease-out',
                        'pulse': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 3s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'glow': 'glow 2s ease-in-out infinite alternate',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideInLeft: {
                            '0%': { transform: 'translateX(-20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        zoomIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        glow: {
                            '0%': { boxShadow: '0 0 5px rgba(59, 130, 246, 0.5)' },
                            '100%': { boxShadow: '0 0 20px rgba(59, 130, 246, 0.8)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Recursos Adicionales -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            overflow: hidden;
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Animaciones personalizadas */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-animate {
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        /* Mejoras para inputs */
        input, select, textarea {
            transition: all 0.2s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            ring: 2px;
            ring-color: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }
        
        /* Efectos de tarjetas */
        .card-shadow {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05), 0 2px 10px rgba(0, 0, 0, 0.02);
        }
        
        .card-shadow-hover:hover {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 5px 20px rgba(0, 0, 0, 0.03);
        }
        
        /* Efectos premium */
        .glass-effect {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .neon-border {
            position: relative;
        }
        
        .neon-border::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #06b6d4, #10b981);
            border-radius: inherit;
            z-index: -1;
            opacity: 0.5;
            animation: gradient 3s ease infinite;
        }
        
        /* Custom utilities */
        .text-gradient {
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .bg-gradient-premium {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .bg-gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .bg-gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .bg-gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        /* Estilos para gráficos Recharts */
        .recharts-wrapper {
            font-family: 'Inter', sans-serif;
        }
        
        .recharts-tooltip-wrapper {
            z-index: 1000;
        }
        
        .recharts-default-tooltip {
            background-color: rgba(15, 23, 42, 0.95) !important;
            border: 1px solid #334155 !important;
            border-radius: 12px !important;
            padding: 12px !important;
        }
        
        .recharts-tooltip-item {
            color: #f1f5f9 !important;
            font-size: 12px !important;
        }
        
        .recharts-tooltip-item-name {
            color: #94a3b8 !important;
        }
        
        /* Asegurar que D3 no se salga del contenedor */
        .d3-container svg {
            display: block;
        }
        
        .d3-container svg text {
            font-family: 'Inter', sans-serif;
            pointer-events: none;
        }
        
        /* Mejoras para selectores personalizados */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        
        /* Estilos para checkboxes personalizados */
        .custom-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #cbd5e1;
            border-radius: 0.375rem;
            background-color: white;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Estilos para range input personalizado */
        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Responsive fixes */
        @media (max-width: 768px) {
            .mobile-stack {
                flex-direction: column !important;
            }
            
            .mobile-full {
                width: 100% !important;
            }
            
            .mobile-text-center {
                text-align: center !important;
            }
            
            .mobile-p-4 {
                padding: 1rem !important;
            }
        }
        
        /* Estilos para gráficos alternativos */
        .alternative-chart {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }
        
        .chart-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
        }
        
        .chart-placeholder i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        .simulated-bar {
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
        }
        
        .simulated-bar:hover {
            opacity: 0.8;
        }
        
        /* Estilos para gráficos manuales */
        .manual-chart {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .chart-bars-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 80%;
            padding: 20px 10px;
        }
        
        .chart-bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 15%;
        }
        
        .chart-bar {
            width: 80%;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
            position: relative;
        }
        
        .chart-bar-label {
            margin-top: 8px;
            font-size: 10px;
            text-align: center;
            color: #64748b;
            font-weight: 600;
        }
        
        .chart-bar-value {
            position: absolute;
            top: -20px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            color: #334155;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            font-size: 11px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        /* Estilos para error boundary */
        .error-boundary {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
        }
        
        .error-message {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.05);
        }
        
        /* Mejoras para la carga inicial */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .spinner {
            width: 70px;
            height: 70px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Nuevos estilos para la capa de inteligencia */
        .health-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        
        .health-excellent { background-color: #10b981; }
        .health-good { background-color: #84cc16; }
        .health-fair { background-color: #f59e0b; }
        .health-poor { background-color: #ef4444; }
        
        .risk-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
        }
        
        .risk-high { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .risk-medium { background-color: #fffbeb; color: #d97706; border: 1px solid #fde68a; }
        .risk-low { background-color: #f0fdf4; color: #059669; border: 1px solid #bbf7d0; }
        
        .power-score {
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .insight-card {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }
        
        .insight-card:hover {
            transform: translateX(5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .insight-critical { border-left-color: #ef4444; }
        .insight-warning { border-left-color: #f59e0b; }
        .insight-success { border-left-color: #10b981; }
        .insight-info { border-left-color: #3b82f6; }
        
        .generation-baby-boomer { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .generation-x { background: linear-gradient(135deg, #dbeafe, #93c5fd); }
        .generation-millennial { background: linear-gradient(135deg, #dcfce7, #86efac); }
        .generation-z { background: linear-gradient(135deg, #fce7f3, #f9a8d4); }
        
        .span-of-control-high {
            animation: glow 2s infinite alternate;
            border: 2px solid #ef4444;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <!-- Pantalla de carga inicial -->
    <div id="loading-screen">
        <div class="text-center text-white">
            <div class="spinner mb-6"></div>
            <h2 class="text-2xl font-bold mb-2">Luxanalitica Suite</h2>
            <p class="text-white/80">Inicializando motor de análisis avanzado...</p>
        </div>
    </div>
    
    <div id="root"></div>
    
    <script type="text/babel" data-presets="env,react">
        // ============================================
        // CONFIGURACIÓN DE BABEL Y ARQUITECTURA SEGURA
        // ============================================
        
        // Verificar que todas las dependencias están cargadas
        const checkDependencies = () => {
            const errors = [];
            
            if (!window.React) errors.push('React 18 no está cargado');
            if (!window.ReactDOM) errors.push('ReactDOM 18 no está cargado');
            if (!window.Babel) errors.push('Babel Standalone no está cargado');
            if (!window.d3) errors.push('D3.js no está cargado');
            if (!window.XLSX) errors.push('XLSX no está cargado');
            if (!window.html2canvas) errors.push('html2canvas no está cargado');
            if (!window.jspdf) errors.push('jsPDF no está cargado');
            
            return errors;
        };
        
        // Ocultar pantalla de carga cuando todo esté listo
        const hideLoadingScreen = () => {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.style.opacity = '0';
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
        };
        
        // ============================================
        // MANEJO DE ERRORES GLOBAL (ErrorBoundary)
        // ============================================
        
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            
            static getDerivedStateFromError(error) {
                return { hasError: true };
            }
            
            componentDidCatch(error, errorInfo) {
                this.setState({
                    error: error,
                    errorInfo: errorInfo
                });
                console.error('ErrorBoundary capturó un error:', error, errorInfo);
            }
            
            handleReset = () => {
                try {
                    localStorage.removeItem('luxanalitica_org_data');
                    localStorage.removeItem('luxanalitica_versions');
                } catch (e) {
                    console.warn('No se pudo limpiar localStorage:', e);
                }
                this.setState({ hasError: false, error: null, errorInfo: null });
                window.location.reload();
            }
            
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-screen w-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50 p-8">
                            <div className="max-w-2xl bg-white rounded-3xl p-8 shadow-2xl border border-red-200 text-center">
                                <div className="text-red-500 text-6xl mb-6">
                                    <i className="fas fa-bug"></i>
                                </div>
                                <h1 className="text-3xl font-black text-slate-800 mb-4">¡Error Crítico Detectado!</h1>
                                <p className="text-slate-600 mb-6">
                                    La aplicación encontró un problema que impide continuar.
                                </p>
                                
                                {this.state.error && (
                                    <div className="bg-slate-900 text-slate-100 p-4 rounded-xl mb-6 text-left overflow-auto max-h-40">
                                        <div className="font-mono text-sm error-message">
                                            <div className="text-red-300 font-bold">{this.state.error.toString()}</div>
                                            {this.state.errorInfo?.componentStack && (
                                                <div className="text-slate-400 text-xs mt-2">
                                                    {this.state.errorInfo.componentStack}
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                )}
                                
                                <div className="flex flex-col sm:flex-row gap-4 justify-center">
                                    <button
                                        onClick={this.handleReset}
                                        className="px-6 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-xl font-bold hover:from-red-700 hover:to-red-800 transition-all shadow-lg flex items-center justify-center gap-2"
                                    >
                                        <i className="fas fa-redo"></i>
                                        Reiniciar Aplicación
                                    </button>
                                    <button
                                        onClick={() => window.location.reload()}
                                        className="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-bold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg flex items-center justify-center gap-2"
                                    >
                                        <i className="fas fa-sync-alt"></i>
                                        Recargar Página
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                return this.props.children;
            }
        }
        
        // ============================================
        // NUEVA CAPA DE INTELIGENCIA Y SALUD DE DATOS
        // ============================================
        
        // Constantes para análisis generacional
        const GENERATIONS = {
            'Baby Boomer': { minAge: 59, maxAge: 77, color: '#f59e0b', risk: 'ALTO' },
            'Gen X': { minAge: 43, maxAge: 58, color: '#3b82f6', risk: 'MEDIO' },
            'Millennial': { minAge: 28, maxAge: 42, color: '#10b981', risk: 'BAJO' },
            'Gen Z': { minAge: 18, maxAge: 27, color: '#8b5cf6', risk: 'BAJO' }
        };
        
        // Constantes para análisis de poder
        const POWER_WEIGHTS = {
            salary: 0.3,
            subordinates: 0.25,
            performance: 0.2,
            seniority: 0.15,
            critical: 0.1
        };
        
        // Funciones de análisis avanzado
        const calculateAge = (birthYear) => {
            if (!birthYear) return 45; // Valor por defecto
            const currentYear = new Date().getFullYear();
            return currentYear - birthYear;
        };
        
        const determineGeneration = (age) => {
            if (age >= GENERATIONS['Baby Boomer'].minAge) return 'Baby Boomer';
            if (age >= GENERATIONS['Gen X'].minAge) return 'Gen X';
            if (age >= GENERATIONS['Millennial'].minAge) return 'Millennial';
            return 'Gen Z';
        };
        
        const calculateRetirementRisk = (age, seniority) => {
            let risk = 0;
            if (age >= 55) risk += 80;
            else if (age >= 50) risk += 60;
            else if (age >= 45) risk += 40;
            
            if (seniority >= 20) risk += 20;
            else if (seniority >= 15) risk += 10;
            
            return Math.min(risk, 100);
        };
        
        const calculatePowerScore = (node, subordinateCount) => {
            let score = 0;
            
            // Peso salarial (normalizado a máximo $30k)
            const salaryScore = Math.min((node.salary || 0) / 30000, 1) * 100;
            score += salaryScore * POWER_WEIGHTS.salary;
            
            // Peso por subordinados (normalizado a máximo 15 subordinados)
            const subordinateScore = Math.min((subordinateCount[node.id] || 0) / 15, 1) * 100;
            score += subordinateScore * POWER_WEIGHTS.subordinates;
            
            // Peso por rendimiento
            score += (node.performance || 0) * POWER_WEIGHTS.performance;
            
            // Peso por antigüedad (normalizado a máximo 30 años)
            const seniorityScore = Math.min((node.seniority || 0) / 30, 1) * 100;
            score += seniorityScore * POWER_WEIGHTS.seniority;
            
            // Peso por posición crítica
            const criticalScore = node.isCritical ? 100 : 0;
            score += criticalScore * POWER_WEIGHTS.critical;
            
            return Math.round(score);
        };
        
        const analyzeSpanOfControl = (nodes) => {
            const subordinateCount = {};
            nodes.forEach(node => {
                if (node.parentId && node.parentId.trim() !== '') {
                    subordinateCount[node.parentId] = (subordinateCount[node.parentId] || 0) + 1;
                }
            });
            
            const managers = nodes.filter(node => subordinateCount[node.id] > 0);
            const overloadedManagers = managers.filter(node => subordinateCount[node.id] > 8);
            
            return {
                subordinateCount,
                averageSpan: managers.length > 0 
                    ? (Object.values(subordinateCount).reduce((a, b) => a + b, 0) / managers.length).toFixed(1)
                    : 0,
                overloadedManagers,
                totalOverloaded: overloadedManagers.length
            };
        };
        
        const calculateDepartmentMetrics = (nodes) => {
            const departments = [...new Set(nodes.map(n => n.department || 'Sin departamento'))];
            
            return departments.map(dept => {
                const deptNodes = nodes.filter(n => (n.department || 'Sin departamento') === dept);
                const totalSalary = deptNodes.reduce((sum, n) => sum + (n.salary || 0), 0);
                const avgSalary = deptNodes.length > 0 ? Math.round(totalSalary / deptNodes.length) : 0;
                const avgPerformance = deptNodes.length > 0 
                    ? Math.round(deptNodes.reduce((sum, n) => sum + (n.performance || 0), 0) / deptNodes.length)
                    : 0;
                
                // Análisis de riesgo por departamento
                const criticalNodes = deptNodes.filter(n => n.isCritical);
                const criticalWithoutSuccessor = criticalNodes.filter(n => !n.successionId);
                
                return {
                    name: dept,
                    count: deptNodes.length,
                    totalSalary,
                    avgSalary,
                    avgPerformance,
                    criticalCount: criticalNodes.length,
                    riskLevel: criticalNodes.length > 0 
                        ? Math.round((criticalWithoutSuccessor.length / criticalNodes.length) * 100)
                        : 0,
                    salaryConcentration: totalSalary
                };
            });
        };
        
        const generateExecutiveSummary = (nodes) => {
            if (!nodes || nodes.length === 0) {
                return {
                    totalEmployees: 0,
                    criticalPositions: 0,
                    criticalWithoutSuccessor: 0,
                    totalSalaryMass: 0,
                    avgPerformance: 0,
                    avgSeniority: 0,
                    topDepartmentBySalary: null,
                    spanOfControlAnalysis: { averageSpan: 0, totalOverloaded: 0 },
                    generationRisk: {},
                    keyInsights: []
                };
            }
            
            const totalSalary = nodes.reduce((sum, n) => sum + (n.salary || 0), 0);
            const avgPerformance = Math.round(nodes.reduce((sum, n) => sum + (n.performance || 0), 0) / nodes.length);
            const avgSeniority = Number((nodes.reduce((sum, n) => sum + (n.seniority || 0), 0) / nodes.length).toFixed(1));
            
            const criticalNodes = nodes.filter(n => n.isCritical);
            const criticalWithoutSuccessor = criticalNodes.filter(n => !n.successionId);
            
            const deptMetrics = calculateDepartmentMetrics(nodes);
            const topDepartmentBySalary = deptMetrics.sort((a, b) => b.totalSalary - a.totalSalary)[0];
            
            const spanAnalysis = analyzeSpanOfControl(nodes);
            
            // Análisis generacional
            const generationAnalysis = nodes.reduce((acc, node) => {
                const age = calculateAge(1960 + Math.random() * 40); // Simulación de edad
                const generation = determineGeneration(age);
                acc[generation] = (acc[generation] || 0) + 1;
                return acc;
            }, {});
            
            // Generar insights clave
            const keyInsights = [];
            
            if (criticalWithoutSuccessor.length > 0) {
                keyInsights.push({
                    type: 'critical',
                    message: `Tienes ${criticalWithoutSuccessor.length} posiciones críticas sin plan de sucesión`,
                    description: 'Esto representa un riesgo significativo para la continuidad del negocio.'
                });
            }
            
            if (topDepartmentBySalary) {
                const concentration = Math.round((topDepartmentBySalary.totalSalary / totalSalary) * 100);
                if (concentration > 40) {
                    keyInsights.push({
                        type: 'warning',
                        message: `El ${concentration}% de tu costo salarial se concentra en ${topDepartmentBySalary.name}`,
                        description: 'Considera revisar la distribución de recursos.'
                    });
                }
            }
            
            if (spanAnalysis.totalOverloaded > 0) {
                keyInsights.push({
                    type: 'warning',
                    message: `${spanAnalysis.totalOverloaded} líderes tienen más de 8 reportes directos`,
                    description: 'Podría indicar cuellos de botella operativos.'
                });
            }
            
            // Análisis de rendimiento extremo
            const lowPerformers = nodes.filter(n => n.performance < 70);
            const highPerformers = nodes.filter(n => n.performance >= 90);
            
            if (lowPerformers.length > nodes.length * 0.1) { // Más del 10% son bajo rendimiento
                keyInsights.push({
                    type: 'warning',
                    message: `${lowPerformers.length} colaboradores tienen rendimiento inferior al 70%`,
                    description: 'Considera programas de desarrollo o reasignación.'
                });
            }
            
            if (highPerformers.length > 0) {
                keyInsights.push({
                    type: 'success',
                    message: `${highPerformers.length} colaboradores destacados con rendimiento superior al 90%`,
                    description: 'Identifica oportunidades de retención y desarrollo.'
                });
            }
            
            return {
                totalEmployees: nodes.length,
                criticalPositions: criticalNodes.length,
                criticalWithoutSuccessor: criticalWithoutSuccessor.length,
                totalSalaryMass: totalSalary,
                avgPerformance,
                avgSeniority,
                topDepartmentBySalary,
                spanOfControlAnalysis: spanAnalysis,
                generationRisk: generationAnalysis,
                keyInsights,
                lowPerformers: lowPerformers.length,
                highPerformers: highPerformers.length
            };
        };
        
        const generateHealthScore = (nodes) => {
            if (!nodes || nodes.length === 0) return 0;
            
            const summary = generateExecutiveSummary(nodes);
            let score = 100;
            
            // Penalizar por posiciones críticas sin sucesor
            if (summary.criticalWithoutSuccessor > 0) {
                score -= (summary.criticalWithoutSuccessor * 5);
            }
            
            // Penalizar por bajo rendimiento
            if (summary.lowPerformers > summary.totalEmployees * 0.15) {
                score -= 20;
            }
            
            // Penalizar por span of control excesivo
            if (summary.spanOfControlAnalysis.totalOverloaded > 0) {
                score -= (summary.spanOfControlAnalysis.totalOverloaded * 3);
            }
            
            // Bonificar por alto rendimiento
            if (summary.highPerformers > summary.totalEmployees * 0.2) {
                score += 15;
            }
            
            return Math.max(0, Math.min(100, score));
        };
        
        const getHealthIndicator = (score) => {
            if (score >= 85) return { class: 'health-excellent', label: 'Excelente' };
            if (score >= 70) return { class: 'health-good', label: 'Buena' };
            if (score >= 50) return { class: 'health-fair', label: 'Regular' };
            return { class: 'health-poor', label: 'Crítica' };
        };
        
        // ============================================
        // FUNCIONES CRÍTICAS - PRESERVADAS INTACTAS
        // ============================================
        
        const DEPARTMENTS = [
            'Dirección General',
            'Finanzas',
            'Operaciones',
            'Ventas',
            'Recursos Humanos',
            'Tecnología',
            'Marketing',
            'Legal',
            'Innovación',
            'Logística',
            'Calidad',
            'Compras',
            'Producción',
            'Servicio al Cliente',
            'Investigación y Desarrollo'
        ];
        
        const TITLES = [
            'Presidente Ejecutivo',
            'CEO',
            'Director General',
            'Vicepresidente',
            'Director',
            'Gerente General',
            'Gerente',
            'Subgerente',
            'Supervisor',
            'Coordinador',
            'Analista Sr',
            'Analista Jr',
            'Especialista',
            'Asistente',
            'Practicante'
        ];
        
        const POTENTIAL_LEVELS = ['Alto', 'Medio', 'Bajo'];
        const GENDER_OPTIONS = ['Masculino', 'Femenino', 'Otro', 'Prefiero no decirlo'];
        
        const COLORS_DEPT = {
            'Dirección General': '#1e3a8a',
            'Finanzas': '#15803d',
            'Operaciones': '#b45309',
            'Ventas': '#be185d',
            'Recursos Humanos': '#6366f1',
            'Tecnología': '#06b6d4',
            'Marketing': '#8b5cf6',
            'Legal': '#dc2626',
            'Innovación': '#0891b2',
            'Logística': '#ea580c',
            'Calidad': '#059669',
            'Compras': '#7c3aed',
            'Producción': '#d97706',
            'Servicio al Cliente': '#0ea5e9',
            'Investigación y Desarrollo': '#10b981'
        };
        
        const CHART_COLORS = [
            '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
            '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', 
            '#f97316', '#6366f1'
        ];
        
        // ============================================
        // DATOS INICIALES - ENRIQUECIDOS CON CAPA DE INTELIGENCIA
        // ============================================
        
        const initialNodes = [
            {
                id: '1',
                name: 'Dra. Elena Vance',
                title: 'Presidenta Ejecutiva',
                department: 'Dirección General',
                parentId: null,
                color: '#1e3a8a',
                salary: 25000,
                gender: 'Femenino',
                seniority: 15,
                isCritical: true,
                performance: 98,
                potential: 'Alto',
                successionId: '2',
                birthYear: 1965, // Nueva propiedad para análisis
                hireDate: '2008-03-15' // Nueva propiedad para antigüedad real
            },
            {
                id: '2',
                name: 'Ing. Roberto Moss',
                title: 'VP Operaciones',
                department: 'Operaciones',
                parentId: '1',
                color: '#b45309',
                salary: 15400,
                gender: 'Masculino',
                seniority: 10,
                isCritical: true,
                successionId: '5',
                performance: 85,
                potential: 'Alto',
                birthYear: 1970,
                hireDate: '2013-06-20'
            },
            {
                id: '3',
                name: 'Lic. Martha Wayne',
                title: 'Directora Financiera',
                department: 'Finanzas',
                parentId: '1',
                color: '#15803d',
                salary: 16200,
                gender: 'Femenino',
                seniority: 12,
                isCritical: true,
                performance: 90,
                potential: 'Medio',
                successionId: '6',
                birthYear: 1975,
                hireDate: '2011-09-10'
            },
            {
                id: '4',
                name: 'Oscar Isaac',
                title: 'Director Comercial',
                department: 'Ventas',
                parentId: '1',
                color: '#be185d',
                salary: 14800,
                gender: 'Masculino',
                seniority: 8,
                performance: 70,
                potential: 'Alto',
                successionId: '7',
                birthYear: 1978,
                hireDate: '2015-02-28'
            },
            {
                id: '5',
                name: 'Samuel L. Jackson',
                title: 'Gerente Regional',
                department: 'Operaciones',
                parentId: '2',
                color: '#d97706',
                salary: 9500,
                gender: 'Masculino',
                seniority: 6,
                performance: 88,
                potential: 'Alto',
                birthYear: 1969,
                hireDate: '2017-04-15'
            },
            {
                id: '6',
                name: 'Natasha Romanoff',
                title: 'Gerente Tesorería',
                department: 'Finanzas',
                parentId: '3',
                color: '#166534',
                salary: 8900,
                gender: 'Femenino',
                seniority: 4,
                performance: 95,
                potential: 'Alto',
                birthYear: 1985,
                hireDate: '2019-08-22'
            },
            {
                id: '7',
                name: 'Wanda Maximoff',
                title: 'Gerente Marketing',
                department: 'Ventas',
                parentId: '4',
                color: '#9d174d',
                salary: 8200,
                gender: 'Femenino',
                seniority: 3,
                performance: 82,
                potential: 'Medio',
                birthYear: 1988,
                hireDate: '2020-01-15'
            },
            {
                id: '8',
                name: 'Peter Parker',
                title: 'Analista Sr',
                department: 'Finanzas',
                parentId: '6',
                color: '#166534',
                salary: 5500,
                gender: 'Masculino',
                seniority: 2,
                performance: 92,
                potential: 'Alto',
                birthYear: 1992,
                hireDate: '2021-03-10'
            },
            {
                id: '9',
                name: 'Gwen Stacy',
                title: 'Especialista Ventas',
                department: 'Ventas',
                parentId: '7',
                color: '#9d174d',
                salary: 4800,
                gender: 'Femenino',
                seniority: 1,
                performance: 85,
                potential: 'Alto',
                birthYear: 1995,
                hireDate: '2022-06-30'
            },
            {
                id: '10',
                name: 'Tony Stark',
                title: 'CTO',
                department: 'Tecnología',
                parentId: '1',
                color: '#06b6d4',
                salary: 18000,
                gender: 'Masculino',
                seniority: 14,
                isCritical: true,
                performance: 96,
                potential: 'Alto',
                successionId: '11',
                birthYear: 1972,
                hireDate: '2009-11-05'
            },
            {
                id: '11',
                name: 'Bruce Banner',
                title: 'Líder de Desarrollo',
                department: 'Tecnología',
                parentId: '10',
                color: '#06b6d4',
                salary: 12500,
                gender: 'Masculino',
                seniority: 8,
                performance: 89,
                potential: 'Medio',
                birthYear: 1976,
                hireDate: '2015-07-18'
            },
            {
                id: '12',
                name: 'Steve Rogers',
                title: 'Director de Recursos Humanos',
                department: 'Recursos Humanos',
                parentId: '1',
                color: '#6366f1',
                salary: 14500,
                gender: 'Masculino',
                seniority: 11,
                isCritical: false,
                performance: 87,
                potential: 'Medio',
                birthYear: 1958, // Baby Boomer para análisis de riesgo
                hireDate: '2012-04-12'
            },
            {
                id: '13',
                name: 'Carol Danvers',
                title: 'Directora de Marketing',
                department: 'Marketing',
                parentId: '1',
                color: '#8b5cf6',
                salary: 13500,
                gender: 'Femenino',
                seniority: 9,
                performance: 88,
                potential: 'Alto',
                successionId: '14',
                birthYear: 1980,
                hireDate: '2014-09-25'
            },
            {
                id: '14',
                name: 'Scott Lang',
                title: 'Gerente de Producto',
                department: 'Marketing',
                parentId: '13',
                color: '#8b5cf6',
                salary: 9200,
                gender: 'Masculino',
                seniority: 5,
                performance: 84,
                potential: 'Medio',
                birthYear: 1983,
                hireDate: '2018-03-14'
            },
            {
                id: '15',
                name: 'Stephen Strange',
                title: 'Director Legal',
                department: 'Legal',
                parentId: '1',
                color: '#dc2626',
                salary: 16500,
                gender: 'Masculino',
                seniority: 13,
                isCritical: true,
                performance: 91,
                potential: 'Alto',
                birthYear: 1968,
                hireDate: '2010-05-20'
            },
            {
                id: '16',
                name: 'Maria Rodriguez',
                title: 'Analista Jr',
                department: 'Finanzas',
                parentId: '6',
                color: '#166534',
                salary: 4200,
                gender: 'Femenino',
                seniority: 1,
                performance: 65,
                potential: 'Bajo',
                birthYear: 1998,
                hireDate: '2022-09-10'
            },
            {
                id: '17',
                name: 'Carlos Mendoza',
                title: 'Supervisor',
                department: 'Operaciones',
                parentId: '5',
                color: '#d97706',
                salary: 6800,
                gender: 'Masculino',
                seniority: 3,
                performance: 75,
                potential: 'Medio',
                birthYear: 1990,
                hireDate: '2020-02-15'
            }
        ];
        
        // ============================================
        // FUNCIONES DE VALIDACIÓN Y SANITIZACIÓN
        // ============================================
        
        const validateAndSanitizeNodes = (nodes) => {
            if (!Array.isArray(nodes)) {
                console.error('Datos no son un array:', nodes);
                return [];
            }
            
            const validNodes = [];
            const seenIds = new Set();
            
            for (let i = 0; i < nodes.length; i++) {
                const node = nodes[i];
                
                if (!node || typeof node !== 'object') {
                    console.warn('Nodo inválido en posición', i, ':', node);
                    continue;
                }
                
                if (!node.id || typeof node.id !== 'string') {
                    node.id = `node_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                }
                
                if (seenIds.has(node.id)) {
                    node.id = `${node.id}_${i}`;
                }
                seenIds.add(node.id);
                
                node.name = node.name ? String(node.name).substring(0, 100) : 'Sin Nombre';
                node.title = node.title ? String(node.title).substring(0, 100) : 'Sin Cargo';
                node.department = node.department ? String(node.department).substring(0, 50) : 'Sin Departamento';
                
                node.salary = Math.max(0, Number(node.salary) || 0);
                node.performance = Math.min(100, Math.max(0, Number(node.performance) || 80));
                node.seniority = Math.max(0, Number(node.seniority) || 0);
                
                const validPotentials = ['Alto', 'Medio', 'Bajo'];
                node.potential = validPotentials.includes(node.potential) ? node.potential : 'Medio';
                
                const validGenders = ['Masculino', 'Femenino', 'Otro', 'Prefiero no decirlo'];
                node.gender = validGenders.includes(node.gender) ? node.gender : 'Otro';
                
                node.isCritical = Boolean(node.isCritical);
                
                if (!node.color) {
                    node.color = COLORS_DEPT[node.department] || '#3b82f6';
                }
                
                // Enriquecer con datos calculados si no existen
                if (!node.birthYear) {
                    const baseYear = 1960;
                    const randomYears = Math.floor(Math.random() * 40);
                    node.birthYear = baseYear + randomYears;
                }
                
                if (!node.hireDate) {
                    const currentDate = new Date();
                    const yearsAgo = node.seniority || 0;
                    const hireDate = new Date(currentDate.getFullYear() - yearsAgo, 
                                            Math.floor(Math.random() * 12), 
                                            Math.floor(Math.random() * 28) + 1);
                    node.hireDate = hireDate.toISOString().split('T')[0];
                }
                
                validNodes.push(node);
            }
            
            console.log(`Sanitizados ${validNodes.length} de ${nodes.length} nodos`);
            return validNodes;
        };
        
        const wouldCreateCycle = (nodeId, parentId, nodes) => {
            if (!parentId || parentId === nodeId) return false;
            
            const nodeMap = new Map();
            nodes.forEach(n => nodeMap.set(n.id, n));
            
            let currentId = parentId;
            const visited = new Set([nodeId]);
            
            while (currentId) {
                if (visited.has(currentId)) {
                    return true;
                }
                visited.add(currentId);
                
                const current = nodeMap.get(currentId);
                if (!current) break;
                
                currentId = current.parentId;
            }
            
            return false;
        };
        
        const sanitizeForD3 = (nodes) => {
            if (!Array.isArray(nodes) || nodes.length === 0) {
                return [];
            }
            
            const nodeMap = new Map();
            const validNodes = [];
            
            nodes.forEach(node => {
                if (node && node.id) {
                    nodeMap.set(node.id, { ...node });
                }
            });
            
            nodes.forEach(node => {
                if (!nodeMap.has(node.id)) return;
                
                const newNode = { ...node };
                
                if (newNode.parentId && !nodeMap.has(newNode.parentId)) {
                    console.warn(`Nodo ${newNode.id} tiene padre inválido: ${newNode.parentId}. Asignando null.`);
                    newNode.parentId = null;
                }
                
                if (newNode.parentId && wouldCreateCycle(newNode.id, newNode.parentId, Array.from(nodeMap.values()))) {
                    console.warn(`Ciclo detectado: ${newNode.id} -> ${newNode.parentId}. Asignando null.`);
                    newNode.parentId = null;
                }
                
                validNodes.push(newNode);
            });
            
            return validNodes;
        };
        
        // ============================================
        // FUNCIÓN PARA GENERAR DATOS DE GRÁFICOS
        // ============================================
        
        const generateChartData = (nodes) => {
            try {
                console.log('Generando datos de gráficos para', nodes?.length || 0, 'nodos');
                
                if (!nodes || nodes.length === 0) {
                    return {
                        matrixData: [],
                        deptStats: [],
                        genderData: [],
                        salaryRanges: [],
                        seniorityRanges: [],
                        powerAnalysis: [],
                        generationData: [],
                        spanOfControlData: []
                    };
                }
                
                const subordinateCount = {};
                nodes.forEach(node => {
                    if (node.parentId && node.parentId.trim() !== '') {
                        subordinateCount[node.parentId] = (subordinateCount[node.parentId] || 0) + 1;
                    }
                });
                
                const matrixData = nodes
                    .filter(n => n.performance != null && n.potential)
                    .map(n => {
                        const performance = typeof n.performance === 'number' ? n.performance : 80;
                        let potentialValue = 2;
                        let potentialLabel = 'Medio';
                        
                        if (typeof n.potential === 'string') {
                            if (n.potential === 'Alto') {
                                potentialValue = 3;
                                potentialLabel = 'Alto';
                            } else if (n.potential === 'Bajo') {
                                potentialValue = 1;
                                potentialLabel = 'Bajo';
                            }
                        }
                        
                        return {
                            name: n.name || 'Sin nombre',
                            performance: performance,
                            potential: potentialValue,
                            potentialLabel: potentialLabel,
                            salary: n.salary || 0,
                            department: n.department || 'Sin departamento',
                            subordinateCount: subordinateCount[n.id] || 0,
                            powerScore: calculatePowerScore(n, subordinateCount)
                        };
                    });
                
                const departments = [...new Set(nodes.map(n => n.department || 'Sin departamento'))];
                const deptStats = departments.map(dept => {
                    const deptNodes = nodes.filter(n => (n.department || 'Sin departamento') === dept);
                    const deptSalaries = deptNodes.filter(n => n.salary && n.salary > 0);
                    const deptPerformances = deptNodes.filter(n => n.performance != null);
                    const managers = deptNodes.filter(n => subordinateCount[n.id] > 0);
                    
                    const totalSalary = deptSalaries.reduce((sum, n) => sum + (n.salary || 0), 0);
                    const avgSalary = deptSalaries.length > 0 ? Math.round(totalSalary / deptSalaries.length) : 0;
                    const avgPerformance = deptPerformances.length > 0 
                        ? Math.round(deptPerformances.reduce((sum, n) => sum + (n.performance || 0), 0) / deptPerformances.length)
                        : 0;
                    
                    return {
                        name: dept,
                        count: deptNodes.length,
                        avgSalary: avgSalary,
                        avgPerformance: avgPerformance,
                        totalSalary: totalSalary,
                        criticalCount: deptNodes.filter(n => n.isCritical).length,
                        managers: managers.length,
                        avgSubordinates: managers.length > 0
                            ? (managers.reduce((sum, n) => sum + (subordinateCount[n.id] || 0), 0) / managers.length).toFixed(1)
                            : '0.0'
                    };
                }).sort((a, b) => b.count - a.count);
                
                const genderCount = nodes.reduce((acc, n) => {
                    const gender = n.gender || 'Otro';
                    acc[gender] = (acc[gender] || 0) + 1;
                    return acc;
                }, {});
                
                const genderData = Object.entries(genderCount).map(([name, value]) => ({
                    name,
                    value,
                    percentage: Math.round((value / nodes.length) * 100)
                }));
                
                const salaryRanges = [
                    { range: 'Menos de $5k', count: 0 },
                    { range: '$5k - $10k', count: 0 },
                    { range: '$10k - $15k', count: 0 },
                    { range: '$15k - $20k', count: 0 },
                    { range: 'Más de $20k', count: 0 }
                ];
                
                nodes.forEach(n => {
                    const salary = n.salary || 0;
                    if (salary < 5000) salaryRanges[0].count++;
                    else if (salary < 10000) salaryRanges[1].count++;
                    else if (salary < 15000) salaryRanges[2].count++;
                    else if (salary < 20000) salaryRanges[3].count++;
                    else salaryRanges[4].count++;
                });
                
                const seniorityRanges = [
                    { range: '0-2 años', count: 0 },
                    { range: '3-5 años', count: 0 },
                    { range: '6-10 años', count: 0 },
                    { range: '11-15 años', count: 0 },
                    { range: 'Más de 15 años', count: 0 }
                ];
                
                nodes.forEach(n => {
                    const seniority = n.seniority || 0;
                    if (seniority <= 2) seniorityRanges[0].count++;
                    else if (seniority <= 5) seniorityRanges[1].count++;
                    else if (seniority <= 10) seniorityRanges[2].count++;
                    else if (seniority <= 15) seniorityRanges[3].count++;
                    else seniorityRanges[4].count++;
                });
                
                // Análisis de poder
                const powerAnalysis = nodes.map(n => ({
                    name: n.name,
                    department: n.department,
                    powerScore: calculatePowerScore(n, subordinateCount),
                    salary: n.salary,
                    subordinates: subordinateCount[n.id] || 0,
                    performance: n.performance
                })).sort((a, b) => b.powerScore - a.powerScore);
                
                // Análisis generacional
                const generationData = nodes.reduce((acc, node) => {
                    const age = calculateAge(node.birthYear);
                    const generation = determineGeneration(age);
                    if (!acc[generation]) {
                        acc[generation] = {
                            count: 0,
                            totalSalary: 0,
                            avgAge: 0,
                            ages: []
                        };
                    }
                    acc[generation].count++;
                    acc[generation].totalSalary += node.salary || 0;
                    acc[generation].ages.push(age);
                    return acc;
                }, {});
                
                // Calcular edad promedio por generación
                Object.keys(generationData).forEach(gen => {
                    const ages = generationData[gen].ages;
                    generationData[gen].avgAge = ages.length > 0 
                        ? Math.round(ages.reduce((a, b) => a + b, 0) / ages.length)
                        : 0;
                    generationData[gen].retirementRisk = generationData[gen].avgAge >= 55 ? 'Alto' : 
                                                         generationData[gen].avgAge >= 50 ? 'Medio' : 'Bajo';
                });
                
                // Span of control analysis
                const managers = nodes.filter(n => subordinateCount[n.id] > 0);
                const spanOfControlData = managers.map(m => ({
                    name: m.name,
                    department: m.department,
                    subordinates: subordinateCount[m.id] || 0,
                    isOverloaded: subordinateCount[m.id] > 8
                })).sort((a, b) => b.subordinates - a.subordinates);
                
                return {
                    matrixData,
                    deptStats,
                    genderData,
                    salaryRanges,
                    seniorityRanges,
                    powerAnalysis,
                    generationData,
                    spanOfControlData
                };
            } catch (error) {
                console.error('Error generando datos de gráficos:', error);
                return {
                    matrixData: [],
                    deptStats: [],
                    genderData: [],
                    salaryRanges: [],
                    seniorityRanges: [],
                    powerAnalysis: [],
                    generationData: [],
                    spanOfControlData: []
                };
            }
        };
        
        // ============================================
        // NUEVO COMPONENTE: RESUMEN EJECUTIVO
        // ============================================
        
        const ExecutiveSummary = ({ nodes }) => {
            const summary = React.useMemo(() => generateExecutiveSummary(nodes), [nodes]);
            const healthScore = generateHealthScore(nodes);
            const healthIndicator = getHealthIndicator(healthScore);
            
            if (!nodes || nodes.length === 0) {
                return (
                    <div className="bg-gradient-to-br from-slate-50 to-blue-50 p-8 rounded-3xl border border-slate-200 card-shadow">
                        <div className="text-center text-slate-400">
                            <i className="fas fa-chart-line text-4xl mb-4"></i>
                            <p className="text-lg">Carga datos para ver el análisis ejecutivo</p>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="bg-gradient-to-br from-slate-50 to-blue-50 p-8 rounded-3xl border border-slate-200 card-shadow space-y-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <h3 className="text-xl font-black text-slate-800 mb-2">
                                Diagnóstico Ejecutivo - Salud Organizacional
                            </h3>
                            <p className="text-slate-600">
                                Análisis automático generado el {new Date().toLocaleDateString('es-ES')}
                            </p>
                        </div>
                        <div className="text-center">
                            <div className="flex items-center gap-2 mb-1">
                                <span className={`health-indicator ${healthIndicator.class}`}></span>
                                <span className="text-sm font-bold text-slate-700">{healthIndicator.label}</span>
                            </div>
                            <div className="power-score">{healthScore}/100</div>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-white p-4 rounded-2xl border border-slate-100">
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                Colaboradores
                            </p>
                            <p className="text-2xl font-black text-slate-800">{summary.totalEmployees}</p>
                        </div>
                        <div className="bg-white p-4 rounded-2xl border border-slate-100">
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                Masa Salarial
                            </p>
                            <p className="text-2xl font-black text-slate-800">
                                ${(summary.totalSalaryMass / 1000).toFixed(1)}k
                            </p>
                        </div>
                        <div className="bg-white p-4 rounded-2xl border border-slate-100">
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                Riesgo Crítico
                            </p>
                            <p className={`text-2xl font-black ${
                                summary.criticalWithoutSuccessor > 0 ? 'text-red-600' : 'text-emerald-600'
                            }`}>
                                {summary.criticalWithoutSuccessor}
                            </p>
                        </div>
                        <div className="bg-white p-4 rounded-2xl border border-slate-100">
                            <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">
                                Span Promedio
                            </p>
                            <p className="text-2xl font-black text-slate-800">
                                {summary.spanOfControlAnalysis.averageSpan}
                            </p>
                        </div>
                    </div>
                    
                    {summary.keyInsights.length > 0 && (
                        <div className="space-y-4">
                            <h4 className="font-bold text-slate-700 flex items-center gap-2">
                                <i className="fas fa-lightbulb text-amber-500"></i>
                                Insights Clave
                            </h4>
                            <div className="space-y-3">
                                {summary.keyInsights.map((insight, index) => (
                                    <div 
                                        key={index} 
                                        className={`insight-card bg-white p-4 rounded-xl border border-slate-100 ${
                                            insight.type === 'critical' ? 'insight-critical' :
                                            insight.type === 'warning' ? 'insight-warning' :
                                            insight.type === 'success' ? 'insight-success' :
                                            'insight-info'
                                        }`}
                                    >
                                        <div className="flex items-start gap-3">
                                            <div className={`mt-1 ${
                                                insight.type === 'critical' ? 'text-red-500' :
                                                insight.type === 'warning' ? 'text-amber-500' :
                                                insight.type === 'success' ? 'text-emerald-500' :
                                                'text-blue-500'
                                            }`}>
                                                <i className={`fas ${
                                                    insight.type === 'critical' ? 'fa-exclamation-triangle' :
                                                    insight.type === 'warning' ? 'fa-exclamation-circle' :
                                                    insight.type === 'success' ? 'fa-check-circle' :
                                                    'fa-info-circle'
                                                }`}></i>
                                            </div>
                                            <div>
                                                <p className="font-bold text-slate-800">{insight.message}</p>
                                                <p className="text-sm text-slate-600 mt-1">{insight.description}</p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {summary.topDepartmentBySalary && (
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-2xl border border-blue-100">
                            <div className="flex items-center justify-between">
                                <div>
                                    <p className="text-sm font-bold text-blue-800">
                                        <i className="fas fa-chart-pie mr-2"></i>
                                        Concentración Salarial
                                    </p>
                                    <p className="text-slate-700">
                                        {summary.topDepartmentBySalary.name} concentra el{' '}
                                        {Math.round((summary.topDepartmentBySalary.totalSalary / summary.totalSalaryMass) * 100)}%
                                        de la masa salarial
                                    </p>
                                </div>
                                <div className="text-right">
                                    <p className="text-2xl font-black text-blue-700">
                                        ${(summary.topDepartmentBySalary.totalSalary / 1000).toFixed(1)}k
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // ============================================
        // NUEVO COMPONENTE: POWER ANALYSIS CHART
        // ============================================
        
        const PowerAnalysisChart = ({ data }) => {
            if (!data || data.length === 0) {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-gradient-to-b from-slate-50 to-blue-50/50 rounded-xl p-4">
                        <div className="text-center">
                            <i className="fas fa-crown text-4xl text-slate-300 mb-3"></i>
                            <p className="text-slate-500 font-medium">Análisis de Poder</p>
                            <p className="text-sm text-slate-400 mt-1">No hay datos disponibles</p>
                        </div>
                    </div>
                );
            }
            
            const top10 = data.slice(0, 10);
            const maxPower = Math.max(...top10.map(d => d.powerScore));
            
            return (
                <div className="h-full flex flex-col bg-gradient-to-b from-slate-50 to-blue-50/50 rounded-xl p-4">
                    <div className="flex justify-between items-center mb-6">
                        <h4 className="font-bold text-slate-700">Top 10 - Índice de Poder</h4>
                        <span className="px-2 py-1 bg-purple-100 text-purple-700 text-xs rounded-full">
                            Score de Influencia
                        </span>
                    </div>
                    
                    <div className="flex-1 space-y-3">
                        {top10.map((item, index) => {
                            const percentage = (item.powerScore / maxPower) * 100;
                            const isCritical = item.powerScore > 80;
                            
                            return (
                                <div key={index} className="space-y-1">
                                    <div className="flex justify-between text-xs">
                                        <span className="font-medium text-slate-700 truncate max-w-[120px]">
                                            {index + 1}. {item.name}
                                        </span>
                                        <div className="flex items-center gap-2">
                                            <span className={`font-bold ${
                                                isCritical ? 'text-purple-600' : 'text-slate-600'
                                            }`}>
                                                {item.powerScore}
                                            </span>
                                            <span className="text-[10px] text-slate-400">
                                                {item.department}
                                            </span>
                                        </div>
                                    </div>
                                    <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                                        <div
                                            className={`h-full rounded-full transition-all duration-1000 ${
                                                isCritical 
                                                    ? 'bg-gradient-to-r from-purple-500 to-pink-500' 
                                                    : 'bg-gradient-to-r from-blue-400 to-blue-600'
                                            }`}
                                            style={{ width: `${percentage}%` }}
                                        />
                                    </div>
                                    <div className="flex justify-between text-[10px] text-slate-500">
                                        <span>${item.salary?.toLocaleString() || 0}</span>
                                        <span>{item.subordinates} subordinados</span>
                                        <span>{item.performance}% rendimiento</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    
                    <div className="mt-4 pt-4 border-t border-slate-100">
                        <p className="text-[10px] text-slate-500 text-center">
                            <i className="fas fa-info-circle mr-1"></i>
                            El índice de poder combina salario, subordinados, rendimiento y antigüedad
                        </p>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // NUEVO COMPONENTE: GENERATION ANALYSIS
        // ============================================
        
        const GenerationAnalysis = ({ data }) => {
            if (!data || Object.keys(data).length === 0) {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-gradient-to-b from-slate-50 to-amber-50/50 rounded-xl p-4">
                        <div className="text-center">
                            <i className="fas fa-users text-4xl text-slate-300 mb-3"></i>
                            <p className="text-slate-500 font-medium">Análisis Generacional</p>
                            <p className="text-sm text-slate-400 mt-1">No hay datos disponibles</p>
                        </div>
                    </div>
                );
            }
            
            const generations = Object.entries(data).map(([name, stats]) => ({
                name,
                count: stats.count,
                avgAge: stats.avgAge,
                retirementRisk: stats.retirementRisk,
                totalSalary: stats.totalSalary,
                color: GENERATIONS[name]?.color || '#6b7280'
            }));
            
            const totalEmployees = generations.reduce((sum, gen) => sum + gen.count, 0);
            
            return (
                <div className="h-full flex flex-col bg-gradient-to-b from-slate-50 to-amber-50/50 rounded-xl p-4">
                    <div className="flex justify-between items-center mb-6">
                        <h4 className="font-bold text-slate-700">Distribución Generacional</h4>
                        <span className="px-2 py-1 bg-amber-100 text-amber-700 text-xs rounded-full">
                            Riesgo de Jubilación
                        </span>
                    </div>
                    
                    <div className="flex-1 space-y-4">
                        {generations.map((gen, index) => {
                            const percentage = Math.round((gen.count / totalEmployees) * 100);
                            
                            return (
                                <div key={index} className="space-y-2">
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-2">
                                            <div 
                                                className="w-3 h-3 rounded-full"
                                                style={{ backgroundColor: gen.color }}
                                            ></div>
                                            <span className="text-sm font-medium text-slate-700">{gen.name}</span>
                                        </div>
                                        <div className="flex items-center gap-3">
                                            <span className="text-xs font-bold text-slate-600">
                                                {gen.count} ({percentage}%)
                                            </span>
                                            <span className={`risk-badge ${
                                                gen.retirementRisk === 'ALTO' ? 'risk-high' :
                                                gen.retirementRisk === 'MEDIO' ? 'risk-medium' : 'risk-low'
                                            }`}>
                                                {gen.retirementRisk}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                                        <div
                                            className="h-full rounded-full transition-all duration-1000"
                                            style={{ 
                                                width: `${percentage}%`,
                                                backgroundColor: gen.color
                                            }}
                                        />
                                    </div>
                                    
                                    <div className="flex justify-between text-[10px] text-slate-500">
                                        <span>Edad promedio: {gen.avgAge} años</span>
                                        <span>Salario total: ${(gen.totalSalary / 1000).toFixed(1)}k</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    
                    <div className="mt-4 pt-4 border-t border-slate-100">
                        <div className="flex justify-between text-[10px] text-slate-500">
                            <div>
                                <i className="fas fa-exclamation-triangle text-red-400 mr-1"></i>
                                <span>Baby Boomer: Alto riesgo de jubilación</span>
                            </div>
                            <div>
                                <i className="fas fa-check-circle text-emerald-400 mr-1"></i>
                                <span>Gen Z/Millennials: Bajo riesgo</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // NUEVO COMPONENTE: SPAN OF CONTROL ANALYSIS
        // ============================================
        
        const SpanOfControlAnalysis = ({ data, nodes }) => {
            if (!data || data.length === 0) {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-gradient-to-b from-slate-50 to-red-50/50 rounded-xl p-4">
                        <div className="text-center">
                            <i className="fas fa-sitemap text-4xl text-slate-300 mb-3"></i>
                            <p className="text-slate-500 font-medium">Análisis de Alcance</p>
                            <p className="text-sm text-slate-400 mt-1">No hay datos disponibles</p>
                        </div>
                    </div>
                );
            }
            
            const overloaded = data.filter(d => d.isOverloaded);
            const avgSubordinates = data.length > 0 
                ? (data.reduce((sum, d) => sum + d.subordinates, 0) / data.length).toFixed(1)
                : 0;
            
            return (
                <div className="h-full flex flex-col bg-gradient-to-b from-slate-50 to-red-50/50 rounded-xl p-4">
                    <div className="flex justify-between items-center mb-6">
                        <h4 className="font-bold text-slate-700">Alcance de Control</h4>
                        <span className="px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full">
                            {overloaded.length} sobrecargados
                        </span>
                    </div>
                    
                    <div className="mb-4 p-3 bg-white/80 rounded-xl border border-slate-100">
                        <div className="flex justify-between items-center">
                            <div>
                                <p className="text-xs font-bold text-slate-700">Promedio de subordinados</p>
                                <p className="text-2xl font-black text-slate-800">{avgSubordinates}</p>
                            </div>
                            <div className={`text-center ${
                                avgSubordinates > 8 ? 'text-red-600' : 
                                avgSubordinates > 5 ? 'text-amber-600' : 'text-emerald-600'
                            }`}>
                                <i className={`fas ${
                                    avgSubordinates > 8 ? 'fa-exclamation-triangle' : 
                                    avgSubordinates > 5 ? 'fa-exclamation-circle' : 'fa-check-circle'
                                } text-2xl`}></i>
                            </div>
                        </div>
                    </div>
                    
                    {overloaded.length > 0 && (
                        <div className="flex-1 space-y-3">
                            <p className="text-xs font-bold text-red-700">
                                <i className="fas fa-exclamation-triangle mr-1"></i>
                                Líderes con más de 8 reportes directos:
                            </p>
                            {overloaded.slice(0, 5).map((item, index) => (
                                <div 
                                    key={index} 
                                    className="bg-white/80 p-3 rounded-xl border border-red-100 span-of-control-high"
                                >
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <p className="text-sm font-bold text-slate-800">{item.name}</p>
                                            <p className="text-xs text-slate-500">{item.department}</p>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-lg font-black text-red-600">{item.subordinates}</p>
                                            <p className="text-[10px] text-red-500">reportes directos</p>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    <div className="mt-4 pt-4 border-t border-slate-100">
                        <p className="text-[10px] text-slate-500">
                            <i className="fas fa-info-circle mr-1"></i>
                            El alcance óptimo es de 5-8 reportes directos. Más de 8 indica posible sobrecarga.
                        </p>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // NUEVO COMPONENTE: SALUD ESTRUCTURAL
        // ============================================
        
        const StructuralHealth = ({ nodes }) => {
            const [selectedDepartment, setSelectedDepartment] = React.useState(null);
            
            const summary = React.useMemo(() => generateExecutiveSummary(nodes), [nodes]);
            const chartData = React.useMemo(() => generateChartData(nodes), [nodes]);
            const healthScore = generateHealthScore(nodes);
            
            const getDepartmentHealth = (deptName) => {
                const deptNodes = nodes.filter(n => n.department === deptName);
                if (deptNodes.length === 0) return 50;
                
                const deptSummary = generateExecutiveSummary(deptNodes);
                return generateHealthScore(deptNodes);
            };
            
            const getRiskLevel = (score) => {
                if (score >= 80) return { label: 'Bajo', color: '#10b981' };
                if (score >= 60) return { label: 'Moderado', color: '#f59e0b' };
                return { label: 'Alto', color: '#ef4444' };
            };
            
            if (!nodes || nodes.length === 0) {
                return (
                    <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow">
                        <div className="text-center text-slate-400 py-12">
                            <i className="fas fa-heartbeat text-6xl mb-4 opacity-20"></i>
                            <p className="text-lg">Carga datos para ver la salud estructural</p>
                        </div>
                    </div>
                );
            }
            
            const departments = [...new Set(nodes.map(n => n.department))];
            
            return (
                <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow">
                    <div className="flex justify-between items-center mb-6">
                        <h4 className="font-black text-slate-800 flex items-center gap-3">
                            <i className="fas fa-heartbeat text-red-500"></i>
                            Salud Estructural por Departamento
                        </h4>
                        <span className="text-[10px] bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full font-black">
                            PUNTUACIÓN GLOBAL: {healthScore}/100
                        </span>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                        {departments.slice(0, 6).map(dept => {
                            const score = getDepartmentHealth(dept);
                            const risk = getRiskLevel(score);
                            const deptNodes = nodes.filter(n => n.department === dept);
                            const criticalCount = deptNodes.filter(n => n.isCritical).length;
                            
                            return (
                                <div 
                                    key={dept}
                                    className={`p-4 rounded-2xl border cursor-pointer transition-all hover:scale-[1.02] ${
                                        selectedDepartment === dept ? 'ring-2 ring-blue-500' : ''
                                    }`}
                                    style={{ 
                                        borderColor: risk.color,
                                        backgroundColor: `${risk.color}10`
                                    }}
                                    onClick={() => setSelectedDepartment(
                                        selectedDepartment === dept ? null : dept
                                    )}
                                >
                                    <div className="flex justify-between items-center mb-2">
                                        <h5 className="font-bold text-slate-800">{dept}</h5>
                                        <span className="text-xs font-black px-2 py-1 rounded-full"
                                            style={{ 
                                                backgroundColor: risk.color,
                                                color: 'white'
                                            }}>
                                            {score}
                                        </span>
                                    </div>
                                    
                                    <div className="w-full h-2 bg-white/50 rounded-full mb-2 overflow-hidden">
                                        <div 
                                            className="h-full rounded-full"
                                            style={{ 
                                                width: `${score}%`,
                                                backgroundColor: risk.color
                                            }}
                                        />
                                    </div>
                                    
                                    <div className="flex justify-between text-[10px] text-slate-600">
                                        <span>{deptNodes.length} colaboradores</span>
                                        <span>{criticalCount} críticos</span>
                                        <span>Riesgo: {risk.label}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    
                    {selectedDepartment && (
                        <div className="mt-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                            <div className="flex justify-between items-center mb-3">
                                <h5 className="font-bold text-slate-800">Detalle: {selectedDepartment}</h5>
                                <button 
                                    onClick={() => setSelectedDepartment(null)}
                                    className="text-xs text-slate-500 hover:text-slate-700"
                                >
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div className="grid grid-cols-3 gap-4">
                                <div className="text-center p-2 bg-white rounded-lg">
                                    <p className="text-[10px] text-slate-500">Total</p>
                                    <p className="font-bold text-slate-800">
                                        {nodes.filter(n => n.department === selectedDepartment).length}
                                    </p>
                                </div>
                                <div className="text-center p-2 bg-white rounded-lg">
                                    <p className="text-[10px] text-slate-500">Prom. Rend.</p>
                                    <p className="font-bold text-slate-800">
                                        {Math.round(
                                            nodes.filter(n => n.department === selectedDepartment)
                                            .reduce((sum, n) => sum + (n.performance || 0), 0) / 
                                            nodes.filter(n => n.department === selectedDepartment).length
                                        )}%
                                    </p>
                                </div>
                                <div className="text-center p-2 bg-white rounded-lg">
                                    <p className="text-[10px] text-slate-500">Críticos</p>
                                    <p className="font-bold text-slate-800">
                                        {nodes.filter(n => n.department === selectedDepartment && n.isCritical).length}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="p-4 bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl border border-red-100">
                            <div className="flex items-center gap-3 mb-2">
                                <div className="w-10 h-10 bg-red-500 rounded-xl flex items-center justify-center text-white">
                                    <i className="fas fa-exclamation-triangle"></i>
                                </div>
                                <div>
                                    <p className="text-sm font-bold text-red-800">Alertas Críticas</p>
                                    <p className="text-xs text-red-600">
                                        {summary.criticalWithoutSuccessor} sin sucesión
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="p-4 bg-gradient-to-br from-amber-50 to-yellow-50 rounded-2xl border border-amber-100">
                            <div className="flex items-center gap-3 mb-2">
                                <div className="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center text-white">
                                    <i className="fas fa-balance-scale"></i>
                                </div>
                                <div>
                                    <p className="text-sm font-bold text-amber-800">Distribución</p>
                                    <p className="text-xs text-amber-600">
                                        {departments.length} departamentos
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div className="p-4 bg-gradient-to-br from-emerald-50 to-green-50 rounded-2xl border border-emerald-100">
                            <div className="flex items-center gap-3 mb-2">
                                <div className="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white">
                                    <i className="fas fa-rocket"></i>
                                </div>
                                <div>
                                    <p className="text-sm font-bold text-emerald-800">Alto Potencial</p>
                                    <p className="text-xs text-emerald-600">
                                        {nodes.filter(n => n.potential === 'Alto').length} talentos
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // COMPONENTE DE CARGA (UploadTab) - PRESERVADO
        // ============================================
        
        const UploadTab = ({ onImport }) => {
            const [loading, setLoading] = React.useState(false);
            const [dragOver, setDragOver] = React.useState(false);
            
            const loadSimulator = () => {
                setLoading(true);
                setTimeout(() => {
                    const sanitizedNodes = validateAndSanitizeNodes(initialNodes);
                    onImport(sanitizedNodes);
                    setLoading(false);
                    alert('✅ Simulación cargada exitosamente. Ahora puedes ver todos los dashboards funcionando.');
                }, 1500);
            };
            
            const handleFileUpload = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                
                const validTypes = [
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'application/vnd.ms-excel',
                    'text/csv'
                ];
                
                if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
                    alert('Por favor, sube un archivo Excel (.xlsx, .xls) o CSV.');
                    return;
                }
                
                setLoading(true);
                const reader = new FileReader();
                
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        let data = [];
                        
                        if (file.name.match(/\.csv$/i)) {
                            const workbook = XLSX.read(bstr, { type: 'binary', raw: true });
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(sheet);
                        } else {
                            const workbook = XLSX.read(bstr, { type: 'binary' });
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(sheet);
                        }
                        
                        if (data.length === 0) {
                            throw new Error('El archivo está vacío o no tiene datos válidos.');
                        }
                        
                        const mapped = data.map((row, index) => {
                            const findColumn = (possibleNames) => {
                                for (const name of possibleNames) {
                                    if (row[name] !== undefined) return row[name];
                                }
                                return null;
                            };
                            
                            return {
                                id: String(findColumn(['id', 'ID', 'identificador', 'Id']) || `EMP-${1000 + index}`),
                                name: findColumn(['nombre', 'name', 'Nombre', 'NOMBRE', 'colaborador', 'Colaborador']) || 'Sin Nombre',
                                title: findColumn(['cargo', 'title', 'Cargo', 'CARGO', 'puesto', 'Puesto', 'posición', 'Posición']) || 'Colaborador',
                                department: findColumn(['departamento', 'department', 'Departamento', 'DEPARTAMENTO', 'área', 'Área', 'area', 'Area']) || DEPARTMENTS[0],
                                parentId: findColumn(['jefe', 'parentId', 'Jefe', 'JEFF', 'reporta_a', 'supervisor', 'Supervisor']) || null,
                                salary: Number(findColumn(['salario', 'salary', 'Salario', 'SALARIO', 'sueldo', 'Sueldo']) || 0),
                                performance: Number(findColumn(['desempeño', 'performance', 'Desempeño', 'rendimiento', 'Rendimiento']) || 80),
                                potential: (findColumn(['potencial', 'potential', 'Potencial']) || 'Medio'),
                                gender: (findColumn(['género', 'gender', 'Género', 'sexo', 'Sexo']) || 'Otro'),
                                seniority: Number(findColumn(['antigüedad', 'seniority', 'Antigüedad', 'experiencia', 'Experiencia']) || 0),
                                isCritical: Boolean(findColumn(['crítico', 'critical', 'Crítico', 'es_critico', 'importante'])),
                                color: COLORS_DEPT[findColumn(['departamento', 'department']) || DEPARTMENTS[0]] || '#3b82f6',
                                successionId: findColumn(['sucesor', 'successionId', 'Sucesor', 'reemplazo']) || null,
                                birthYear: Number(findColumn(['año_nacimiento', 'birthYear', 'nacimiento']) || 1970 + Math.floor(Math.random() * 30)),
                                hireDate: findColumn(['fecha_ingreso', 'hireDate', 'ingreso']) || new Date().toISOString().split('T')[0]
                            };
                        });
                        
                        const sanitizedNodes = validateAndSanitizeNodes(mapped);
                        onImport(sanitizedNodes);
                        alert(`✅ Archivo cargado exitosamente. ${sanitizedNodes.length} colaboradores importados.`);
                    } catch (err) {
                        console.error('Error procesando archivo:', err);
                        alert(`Error procesando el archivo: ${err.message}\n\nAsegúrate de que el archivo tenga el formato correcto.`);
                    } finally {
                        setLoading(false);
                    }
                };
                
                reader.onerror = () => {
                    alert('Error al leer el archivo. Intenta nuevamente.');
                    setLoading(false);
                };
                
                if (file.name.match(/\.csv$/i)) {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.readAsBinaryString(file);
                }
            };
            
            const handleDragOver = (e) => {
                e.preventDefault();
                setDragOver(true);
            };
            
            const handleDragLeave = (e) => {
                e.preventDefault();
                setDragOver(false);
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    const input = document.createElement('input');
                    input.type = 'file';
                    
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    input.files = dataTransfer.files;
                    
                    handleFileUpload({ target: { files: dataTransfer.files } });
                }
            };
            
            const downloadTemplate = () => {
                const template = [
                    {
                        id: 'CEO001',
                        nombre: 'CEO Empresa',
                        cargo: 'Director General',
                        departamento: 'Dirección General',
                        jefe: null,
                        salario: 20000,
                        desempeño: 95,
                        potencial: 'Alto',
                        género: 'Masculino',
                        antigüedad: 10,
                        crítico: true,
                        sucesor: 'VP001',
                        año_nacimiento: 1970,
                        fecha_ingreso: '2013-03-15'
                    },
                    {
                        id: 'VP001',
                        nombre: 'Vicepresidente',
                        cargo: 'VP Operaciones',
                        departamento: 'Operaciones',
                        jefe: 'CEO001',
                        salario: 15000,
                        desempeño: 88,
                        potencial: 'Alto',
                        género: 'Femenino',
                        antigüedad: 8,
                        crítico: true,
                        año_nacimiento: 1975,
                        fecha_ingreso: '2015-06-20'
                    }
                ];
                
                const ws = XLSX.utils.json_to_sheet(template);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Plantilla");
                
                const wscols = [
                    {wch: 10}, {wch: 25}, {wch: 25}, {wch: 20},
                    {wch: 10}, {wch: 12}, {wch: 12}, {wch: 12},
                    {wch: 15}, {wch: 12}, {wch: 10}, {wch: 10},
                    {wch: 12}, {wch: 12}
                ];
                ws['!cols'] = wscols;
                
                XLSX.writeFile(wb, "Plantilla_Luxanalitica_Avanzada.xlsx");
            };
            
            return (
                <div className="p-6 md:p-12 h-full flex flex-col items-center justify-center bg-gradient-to-br from-slate-50 to-blue-50/30 overflow-y-auto scrollbar-hide">
                    <div className="max-w-6xl w-full text-center space-y-12 animate-in zoom-in duration-700">
                        <div className="space-y-6">
                            <div className="relative inline-block">
                                <div className="w-28 h-28 bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 text-white rounded-[3rem] flex items-center justify-center text-5xl mx-auto shadow-2xl mb-6 gradient-animate">
                                    <i className="fas fa-brain"></i>
                                </div>
                                <div className="absolute -top-2 -right-2 w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-full flex items-center justify-center text-white text-sm font-black shadow-lg">
                                    AI
                                </div>
                            </div>
                            
                            <div className="space-y-4">
                                <h1 className="text-5xl md:text-6xl font-black text-slate-900 tracking-tighter">
                                    <span className="text-gradient">Luxanalitica</span> HR 360°
                                </h1>
                                <p className="text-slate-600 text-lg md:text-xl max-w-3xl mx-auto leading-relaxed">
                                    Analiza <span className="text-blue-600 font-bold">Costos</span>,{' '}
                                    <span className="text-emerald-600 font-bold">Rendimiento</span> y{' '}
                                    <span className="text-red-600 font-bold">Sucesión</span> en tiempo real con IA predictiva.
                                </p>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-5xl mx-auto">
                            <button
                                onClick={loadSimulator}
                                disabled={loading}
                                className={`group bg-white border-2 ${dragOver ? 'border-blue-500' : 'border-slate-100'} p-8 rounded-[2.5rem] font-black text-slate-800 hover:border-blue-600 hover:bg-gradient-to-br hover:from-blue-50/50 hover:to-white transition-all duration-300 card-shadow card-shadow-hover flex flex-col items-center gap-6 h-full disabled:opacity-50 disabled:cursor-not-allowed`}
                            >
                                <div className="relative">
                                    <i className={`fas ${loading ? 'fa-sync fa-spin' : 'fa-magic'} text-5xl text-blue-600 group-hover:scale-110 transition-transform duration-300`}></i>
                                    {!loading && (
                                        <div className="absolute -bottom-2 -right-2 w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center text-white text-xs">
                                            <i className="fas fa-bolt"></i>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="space-y-3">
                                    <p className="text-2xl">
                                        {loading ? 'Generando demo...' : 'Simular Demo 360°'}
                                    </p>
                                    <p className="text-sm text-slate-500 font-bold uppercase tracking-widest">
                                        Carga jerarquía compleja con KPIs vivos e IA
                                    </p>
                                </div>
                                
                                {!loading && (
                                    <div className="mt-4 flex items-center gap-3 text-sm text-slate-500">
                                        <i className="fas fa-users"></i>
                                        <span>{initialNodes.length} colaboradores de ejemplo</span>
                                        <i className="fas fa-chart-bar"></i>
                                        <span>Gráficos completos</span>
                                    </div>
                                )}
                                
                                {loading && (
                                    <div className="mt-4">
                                        <div className="text-sm text-blue-600 font-bold">
                                            Cargando dashboards completos...
                                        </div>
                                    </div>
                                )}
                            </button>
                            
                            <div
                                className={`relative ${dragOver ? 'border-blue-500' : 'border-transparent'} border-2 rounded-[2.5rem] transition-all duration-300`}
                                onDragOver={handleDragOver}
                                onDragLeave={handleDragLeave}
                                onDrop={handleDrop}
                            >
                                <label className={`group ${loading ? 'bg-slate-700' : 'bg-gradient-to-br from-slate-900 to-gray-900'} text-white p-8 rounded-[2.5rem] font-black hover:from-slate-800 hover:to-gray-800 transition-all duration-300 cursor-pointer card-shadow card-shadow-hover flex flex-col items-center gap-6 h-full block`}>
                                    <input
                                        type="file"
                                        accept=".xlsx,.xls,.csv"
                                        className="hidden"
                                        onChange={handleFileUpload}
                                        disabled={loading}
                                    />
                                    
                                    <div className="relative">
                                        <i className={`fas ${loading ? 'fa-sync fa-spin' : 'fa-file-excel'} text-5xl text-emerald-400`}></i>
                                        {!loading && (
                                            <div className="absolute -bottom-2 -right-2 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs">
                                                <i className="fas fa-cloud-upload-alt"></i>
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="space-y-3">
                                        <p className="text-2xl">
                                            {loading ? 'Analizando archivo...' : 'Subir Mi Estructura'}
                                        </p>
                                        <p className="text-sm text-slate-300 font-bold uppercase tracking-widest">
                                            Detecta salarios, rendimiento y riesgo automáticamente
                                        </p>
                                    </div>
                                    
                                    {!loading && (
                                        <div className="mt-4 flex items-center gap-3 text-sm text-slate-300">
                                            <i className="fas fa-info-circle"></i>
                                            <span>Arrastra y suelta o haz clic para seleccionar</span>
                                        </div>
                                    )}
                                    
                                    {dragOver && (
                                        <div className="absolute inset-0 bg-blue-500/10 rounded-[2.5rem] border-2 border-dashed border-blue-500 flex items-center justify-center">
                                            <div className="text-center">
                                                <i className="fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2"></i>
                                                <p className="text-blue-500 font-bold">Suelta el archivo aquí</p>
                                            </div>
                                        </div>
                                    )}
                                </label>
                            </div>
                        </div>
                        
                        <div className="pt-8 border-t border-slate-200 max-w-4xl mx-auto">
                            <div className="flex flex-col md:flex-row items-center justify-between gap-6">
                                <div className="text-left">
                                    <h3 className="font-black text-slate-800 text-lg mb-2 flex items-center gap-2">
                                        <i className="fas fa-lightbulb text-amber-500"></i>
                                        ¿Primera vez usando la plataforma?
                                    </h3>
                                    <p className="text-slate-600 text-sm">
                                        Recomendamos comenzar con la demo para familiarizarte con las funcionalidades y gráficos completos.
                                        <br />
                                        <strong>Todos los dashboards funcionan perfectamente con datos de simulación.</strong>
                                    </p>
                                </div>
                                
                                <button
                                    onClick={downloadTemplate}
                                    className="px-6 py-3 bg-gradient-to-r from-emerald-500 to-green-600 text-white rounded-2xl font-bold hover:from-emerald-600 hover:to-green-700 transition-all shadow-lg shadow-emerald-500/20 flex items-center gap-2 whitespace-nowrap"
                                >
                                    <i className="fas fa-download"></i>
                                    Descargar Plantilla Excel
                                </button>
                            </div>
                            
                            <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="bg-gradient-to-br from-blue-50 to-blue-100/50 p-4 rounded-2xl border border-blue-200">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center text-white">
                                            <i className="fas fa-sitemap"></i>
                                        </div>
                                        <h4 className="font-bold text-slate-800">Estructura Completa</h4>
                                    </div>
                                    <p className="text-sm text-slate-600">
                                        Visualiza y edita la jerarquía organizacional en tiempo real.
                                    </p>
                                </div>
                                
                                <div className="bg-gradient-to-br from-emerald-50 to-emerald-100/50 p-4 rounded-2xl border border-emerald-200">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white">
                                            <i className="fas fa-chart-pie"></i>
                                        </div>
                                        <h4 className="font-bold text-slate-800">Análisis 360°</h4>
                                    </div>
                                    <p className="text-sm text-slate-600">
                                        KPIs de rendimiento, costos, diversidad y riesgos de sucesión.
                                    </p>
                                </div>
                                
                                <div className="bg-gradient-to-br from-purple-50 to-purple-100/50 p-4 rounded-2xl border border-purple-200">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center text-white">
                                            <i className="fas fa-file-export"></i>
                                        </div>
                                        <h4 className="font-bold text-slate-800">Exportación Profesional</h4>
                                    </div>
                                    <p className="text-sm text-slate-600">
                                        Genera reportes en Excel, PDF y comparte la estructura.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // COMPONENTE DE EDICIÓN DE NODO (NodeForm) - ENRIQUECIDO
        // ============================================
        
        const NodeForm = ({ selectedNode, nodes, onUpdate, onAdd, onDelete, onCancel }) => {
            const [formData, setFormData] = React.useState({
                id: '',
                name: '',
                title: '',
                department: DEPARTMENTS[0],
                parentId: null,
                color: '#3b82f6',
                isCritical: false,
                successionId: null,
                salary: 0,
                gender: 'Otro',
                seniority: 0,
                performance: 80,
                potential: 'Medio',
                birthYear: 1970,
                hireDate: new Date().toISOString().split('T')[0]
            });
            
            const [errors, setErrors] = React.useState({});
            
            React.useEffect(() => {
                if (selectedNode) {
                    setFormData({
                        ...selectedNode,
                        performance: selectedNode.performance ?? 80,
                        potential: selectedNode.potential ?? 'Medio',
                        salary: selectedNode.salary ?? 0,
                        seniority: selectedNode.seniority ?? 0,
                        gender: selectedNode.gender ?? 'Otro',
                        birthYear: selectedNode.birthYear ?? 1970,
                        hireDate: selectedNode.hireDate ?? new Date().toISOString().split('T')[0]
                    });
                    setErrors({});
                } else {
                    setFormData({
                        id: `NEW-${Math.floor(10000 + Math.random() * 90000)}`,
                        name: '',
                        title: '',
                        department: DEPARTMENTS[0],
                        parentId: null,
                        color: '#3b82f6',
                        isCritical: false,
                        successionId: null,
                        salary: 0,
                        gender: 'Otro',
                        seniority: 0,
                        performance: 80,
                        potential: 'Medio',
                        birthYear: 1970 + Math.floor(Math.random() * 30),
                        hireDate: new Date().toISOString().split('T')[0]
                    });
                    setErrors({});
                }
            }, [selectedNode]);
            
            const handleChange = (e) => {
                const { name, value, type } = e.target;
                let val = value;
                
                if (type === 'checkbox') {
                    val = e.target.checked;
                } else if (type === 'number') {
                    val = value === '' ? 0 : Number(value);
                    if (name === 'performance' && (val < 0 || val > 100)) {
                        setErrors(prev => ({ ...prev, [name]: 'El rendimiento debe estar entre 0 y 100' }));
                    } else if (name === 'salary' && val < 0) {
                        setErrors(prev => ({ ...prev, [name]: 'El salario no puede ser negativo' }));
                    } else if (name === 'seniority' && val < 0) {
                        setErrors(prev => ({ ...prev, [name]: 'La antigüedad no puede ser negativa' }));
                    } else if (name === 'birthYear' && (val < 1900 || val > 2010)) {
                        setErrors(prev => ({ ...prev, [name]: 'Año de nacimiento inválido' }));
                    } else {
                        setErrors(prev => ({ ...prev, [name]: null }));
                    }
                } else if (name === 'parentId' && value === 'null') {
                    val = null;
                } else if (name === 'successionId' && value === 'null') {
                    val = null;
                }
                
                setFormData(prev => ({
                    ...prev,
                    [name]: val
                }));
            };
            
            const validateForm = () => {
                const newErrors = {};
                
                if (!formData.name.trim()) {
                    newErrors.name = 'El nombre es obligatorio';
                }
                
                if (!formData.title.trim()) {
                    newErrors.title = 'El cargo es obligatorio';
                }
                
                if (formData.parentId === formData.id) {
                    newErrors.parentId = 'Un colaborador no puede reportarse a sí mismo';
                }
                
                if (wouldCreateCycle(formData.id, formData.parentId, nodes)) {
                    newErrors.parentId = 'Esta asignación crearía un ciclo jerárquico';
                }
                
                if (formData.isCritical && formData.successionId === formData.id) {
                    newErrors.successionId = 'El sucesor no puede ser la misma persona';
                }
                
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };
            
            const handleSave = () => {
                if (!validateForm()) {
                    alert('Por favor, corrige los errores en el formulario.');
                    return;
                }
                
                const sanitizedData = {
                    ...formData,
                    salary: Number(formData.salary) || 0,
                    performance: Number(formData.performance) || 80,
                    seniority: Number(formData.seniority) || 0,
                    birthYear: Number(formData.birthYear) || 1970,
                    isCritical: Boolean(formData.isCritical)
                };
                
                selectedNode ? onUpdate(sanitizedData) : onAdd(sanitizedData);
            };
            
            const availableSuccessors = nodes.filter(n => 
                n.id !== formData.id && 
                !n.isCritical &&
                n.department === formData.department
            );
            
            const availableParents = nodes.filter(n => n.id !== formData.id);
            
            const getPerformanceColor = (value) => {
                if (value >= 85) return 'text-emerald-600 bg-emerald-50';
                if (value >= 70) return 'text-amber-600 bg-amber-50';
                return 'text-red-600 bg-red-50';
            };
            
            const getPerformanceIcon = (value) => {
                if (value >= 85) return 'fa-rocket text-emerald-500';
                if (value >= 70) return 'fa-chart-line text-amber-500';
                return 'fa-exclamation-triangle text-red-500';
            };
            
            // Calcular edad y generación
            const currentYear = new Date().getFullYear();
            const age = currentYear - formData.birthYear;
            const generation = determineGeneration(age);
            const generationInfo = GENERATIONS[generation];
            
            return (
                <div className="space-y-6 animate-in slide-in-left duration-300 h-full overflow-y-auto scrollbar-hide p-2">
                    <div className="bg-gradient-to-r from-slate-900 to-gray-900 text-white p-5 rounded-3xl card-shadow">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center">
                                    <i className={`fas ${selectedNode ? 'fa-user-edit' : 'fa-user-plus'} text-xl`}></i>
                                </div>
                                <div>
                                    <h3 className="font-black text-lg">
                                        {selectedNode ? 'Editar Colaborador' : 'Nuevo Colaborador'}
                                    </h3>
                                    <p className="text-slate-300 text-sm">
                                        {selectedNode ? 'Actualiza la información del colaborador' : 'Agrega un nuevo miembro al equipo'}
                                    </p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] font-black text-slate-400 uppercase">ID</p>
                                <p className="font-mono text-sm">{formData.id}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-white p-5 rounded-3xl border border-slate-200 card-shadow space-y-5">
                        <h4 className="font-black text-slate-800 text-sm uppercase tracking-widest flex items-center gap-2">
                            <i className="fas fa-id-card text-blue-600"></i>
                            Información Básica
                        </h4>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                    Nombre Completo *
                                </label>
                                <input
                                    name="name"
                                    value={formData.name}
                                    onChange={handleChange}
                                    className={`w-full p-3 border ${errors.name ? 'border-red-300' : 'border-slate-200'} rounded-xl text-sm focus:ring-2 focus:ring-blue-500/20 outline-none transition-all`}
                                    placeholder="Ej: Juan Perez López"
                                />
                                {errors.name && (
                                    <p className="text-red-500 text-xs mt-1 flex items-center gap-1">
                                        <i className="fas fa-exclamation-circle"></i>
                                        {errors.name}
                                    </p>
                                )}
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Cargo / Puesto *
                                    </label>
                                    <input
                                        name="title"
                                        value={formData.title}
                                        onChange={handleChange}
                                        className={`w-full p-3 border ${errors.title ? 'border-red-300' : 'border-slate-200'} rounded-xl text-sm outline-none`}
                                        placeholder="Ej: Director de Finanzas"
                                    />
                                    {errors.title && (
                                        <p className="text-red-500 text-xs mt-1">{errors.title}</p>
                                    )}
                                </div>
                                
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Departamento
                                    </label>
                                    <select
                                        name="department"
                                        value={formData.department}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 custom-select"
                                    >
                                        {DEPARTMENTS.map(dept => (
                                            <option key={dept} value={dept}>{dept}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Género
                                    </label>
                                    <select
                                        name="gender"
                                        value={formData.gender}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm custom-select"
                                    >
                                        {GENDER_OPTIONS.map(gender => (
                                            <option key={gender} value={gender}>{gender}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Año de Nacimiento
                                    </label>
                                    <input
                                        type="number"
                                        name="birthYear"
                                        value={formData.birthYear}
                                        onChange={handleChange}
                                        min="1900"
                                        max="2010"
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm"
                                    />
                                    {formData.birthYear && (
                                        <p className="text-xs text-slate-500 mt-1">
                                            Edad: {age} años • Generación: {generation} 
                                            <span className="ml-2 px-2 py-0.5 text-[10px] rounded-full"
                                                  style={{ 
                                                      backgroundColor: `${generationInfo?.color}20`,
                                                      color: generationInfo?.color,
                                                      border: `1px solid ${generationInfo?.color}`
                                                  }}>
                                                Riesgo {generationInfo?.risk}
                                            </span>
                                        </p>
                                    )}
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Fecha de Ingreso
                                    </label>
                                    <input
                                        type="date"
                                        name="hireDate"
                                        value={formData.hireDate}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm"
                                    />
                                </div>
                                
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Color Identificación
                                    </label>
                                    <select
                                        name="color"
                                        value={formData.color}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm custom-select"
                                    >
                                        <option value="#3b82f6">🔵 Azul (Estándar)</option>
                                        <option value="#10b981">🟢 Verde (Finanzas)</option>
                                        <option value="#f59e0b">🟡 Ámbar (Operaciones)</option>
                                        <option value="#ef4444">🔴 Rojo (Crítico)</option>
                                        <option value="#8b5cf6">🟣 Púrpura (Tecnología)</option>
                                        <option value="#06b6d4">🔷 Cian (Marketing)</option>
                                        <option value="#6366f1">🌀 Índigo (Recursos Humanos)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-white p-5 rounded-3xl border border-slate-200 card-shadow space-y-5">
                        <h4 className="font-black text-slate-800 text-sm uppercase tracking-widest flex items-center gap-2">
                            <i className="fas fa-chart-line text-emerald-600"></i>
                            Métricas de Talento
                        </h4>
                        
                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                        Rendimiento
                                    </label>
                                    <div className={`px-3 py-1 rounded-full text-xs font-bold ${getPerformanceColor(formData.performance)}`}>
                                        <i className={`${getPerformanceIcon(formData.performance)} mr-1`}></i>
                                        {formData.performance}%
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-4">
                                    <input
                                        type="range"
                                        name="performance"
                                        value={formData.performance}
                                        onChange={handleChange}
                                        min="0"
                                        max="100"
                                        className="flex-1"
                                    />
                                    <input
                                        type="number"
                                        name="performance"
                                        value={formData.performance}
                                        onChange={handleChange}
                                        min="0"
                                        max="100"
                                        className="w-20 p-2 border border-slate-200 rounded-lg text-center text-sm"
                                    />
                                </div>
                                
                                <div className="flex justify-between text-xs text-slate-500 mt-2">
                                    <span>Bajo</span>
                                    <span>Promedio</span>
                                    <span>Alto</span>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Potencial
                                    </label>
                                    <select
                                        name="potential"
                                        value={formData.potential}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm custom-select"
                                    >
                                        {POTENTIAL_LEVELS.map(level => (
                                            <option key={level} value={level}>
                                                {level === 'Alto' && '🟢 '}
                                                {level === 'Medio' && '🟡 '}
                                                {level === 'Bajo' && '🔴 '}
                                                {level}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Antigüedad (Años)
                                    </label>
                                    <input
                                        type="number"
                                        name="seniority"
                                        value={formData.seniority}
                                        onChange={handleChange}
                                        min="0"
                                        max="50"
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm"
                                    />
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                    Salario Mensual ($)
                                </label>
                                <div className="relative">
                                    <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-500">$</span>
                                    <input
                                        type="number"
                                        name="salary"
                                        value={formData.salary}
                                        onChange={handleChange}
                                        min="0"
                                        step="100"
                                        className="w-full p-3 pl-8 border border-slate-200 rounded-xl text-sm"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-white p-5 rounded-3xl border border-slate-200 card-shadow space-y-5">
                        <h4 className="font-black text-slate-800 text-sm uppercase tracking-widest flex items-center gap-2">
                            <i className="fas fa-sitemap text-blue-600"></i>
                            Jerarquía y Reportes
                        </h4>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                    Jefe Directo (Línea de Reporte)
                                </label>
                                <select
                                    name="parentId"
                                    value={formData.parentId || 'null'}
                                    onChange={handleChange}
                                    className={`w-full p-3 border ${errors.parentId ? 'border-red-300' : 'border-slate-200'} rounded-xl text-sm bg-white custom-select`}
                                >
                                    <option value="null">👑 Dirección General / Sin Jefe</option>
                                    {availableParents
                                        .sort((a, b) => a.name.localeCompare(b.name))
                                        .map(node => (
                                            <option key={node.id} value={node.id}>
                                                {node.name} - {node.title} ({node.department})
                                            </option>
                                        ))}
                                </select>
                                {errors.parentId && (
                                    <p className="text-red-500 text-xs mt-1">{errors.parentId}</p>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    <div className="bg-gradient-to-r from-red-50/80 to-pink-50/80 p-5 rounded-3xl border border-red-200 card-shadow space-y-5">
                        <div className="flex items-center justify-between">
                            <h4 className="font-black text-red-800 text-sm uppercase tracking-widest flex items-center gap-2">
                                <i className="fas fa-exclamation-triangle text-red-600"></i>
                                Riesgo y Sucesión
                            </h4>
                            <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    name="isCritical"
                                    checked={formData.isCritical}
                                    onChange={handleChange}
                                    className="custom-checkbox"
                                />
                                <span className="text-sm font-bold text-red-700">Posición Crítica</span>
                            </label>
                        </div>
                        
                        {formData.isCritical && (
                            <div className="space-y-4 animate-in">
                                <div>
                                    <label className="block text-[10px] font-black text-red-600 uppercase mb-2 tracking-widest">
                                        Sucesor Identificado
                                    </label>
                                    <select
                                        name="successionId"
                                        value={formData.successionId || 'null'}
                                        onChange={handleChange}
                                        className={`w-full p-3 border ${errors.successionId ? 'border-red-300' : 'border-red-200'} rounded-xl text-sm bg-white/80 custom-select`}
                                    >
                                        <option value="null">⚠️ No hay sucesor identificado</option>
                                        {availableSuccessors.length > 0 ? 
                                            availableSuccessors.map(node => (
                                                <option key={node.id} value={node.id}>
                                                    {node.name} - {node.title}
                                                </option>
                                            )) : (
                                            <option value="null" disabled>
                                                No hay colaboradores disponibles en este departamento
                                            </option>
                                        )}
                                    </select>
                                    {errors.successionId && (
                                        <p className="text-red-500 text-xs mt-1">{errors.successionId}</p>
                                    )}
                                </div>
                                
                                <div className="p-3 bg-red-100/50 rounded-xl border border-red-300">
                                    <p className="text-xs text-red-700 font-medium">
                                        <i className="fas fa-info-circle mr-2"></i>
                                        Las posiciones críticas son vitales para la organización y requieren un plan de sucesión para garantizar la continuidad del negocio.
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    <div className="flex gap-3">
                        {selectedNode ? (
                            <button
                                onClick={() => {
                                    if (window.confirm('¿Estás seguro de eliminar este colaborador? Esta acción no se puede deshacer.')) {
                                        onDelete(formData.id);
                                    }
                                }}
                                className="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white py-3.5 rounded-2xl font-black text-xs hover:from-red-600 hover:to-red-700 transition-all shadow-lg shadow-red-500/20 flex items-center justify-center gap-2"
                            >
                                <i className="fas fa-trash-alt"></i>
                                Eliminar
                            </button>
                        ) : (
                            <button
                                onClick={onCancel}
                                className="flex-1 bg-white border border-slate-300 text-slate-700 py-3.5 rounded-2xl font-black text-xs hover:bg-slate-50 transition-all flex items-center justify-center gap-2"
                            >
                                <i className="fas fa-times"></i>
                                Cancelar
                            </button>
                        )}
                        
                        <button
                            onClick={handleSave}
                            className="flex-[2] bg-gradient-to-r from-slate-900 to-gray-900 text-white py-3.5 rounded-2xl font-black text-xs hover:from-slate-800 hover:to-gray-800 transition-all shadow-xl flex items-center justify-center gap-2"
                        >
                            <i className="fas fa-save"></i>
                            {selectedNode ? 'Guardar Cambios' : 'Crear Colaborador'}
                        </button>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // COMPONENTE DE VISUALIZACIÓN D3 (OrgChartD3) - ENRIQUECIDO
        // ============================================
        
        const OrgChartD3 = ({ nodes, selectedNodeId, onSelectNode, showLegend = true, highlightedDepartment = null }) => {
            const svgRef = React.useRef(null);
            const containerRef = React.useRef(null);
            const [dimensions, setDimensions] = React.useState({ width: 0, height: 0 });
            const [error, setError] = React.useState(null);
            
            React.useEffect(() => {
                const updateDimensions = () => {
                    if (containerRef.current) {
                        const { width, height } = containerRef.current.getBoundingClientRect();
                        setDimensions({ width, height });
                    }
                };
                
                updateDimensions();
                window.addEventListener('resize', updateDimensions);
                return () => window.removeEventListener('resize', updateDimensions);
            }, []);
            
            React.useEffect(() => {
                if (!svgRef.current || !containerRef.current) return;
                
                const { width, height } = dimensions;
                if (width === 0 || height === 0) return;
                
                const svg = d3.select(svgRef.current)
                    .attr('width', width)
                    .attr('height', height);
                
                svg.selectAll('*').remove();
                
                try {
                    if (!nodes || nodes.length === 0) {
                        svg.append('text')
                            .attr('x', width / 2)
                            .attr('y', height / 2)
                            .attr('text-anchor', 'middle')
                            .attr('fill', '#64748b')
                            .text('Carga datos o usa el simulador para comenzar');
                        return;
                    }
                    
                    const sanitizedNodes = sanitizeForD3(nodes);
                    
                    if (sanitizedNodes.length === 0) {
                        svg.append('text')
                            .attr('x', width / 2)
                            .attr('y', height / 2)
                            .attr('text-anchor', 'middle')
                            .attr('fill', '#64748b')
                            .text('No hay datos válidos para mostrar');
                        return;
                    }
                    
                    const defs = svg.append('defs');
                    
                    const cardShadow = defs.append('filter')
                        .attr('id', 'card-shadow')
                        .attr('height', '130%');
                    
                    cardShadow.append('feGaussianBlur')
                        .attr('in', 'SourceAlpha')
                        .attr('stdDeviation', 3);
                    cardShadow.append('feOffset')
                        .attr('dx', 0)
                        .attr('dy', 4)
                        .attr('result', 'offsetBlur');
                    
                    const feMerge = cardShadow.append('feMerge');
                    feMerge.append('feMergeNode').attr('in', 'offsetBlur');
                    feMerge.append('feMergeNode').attr('in', 'SourceGraphic');
                    
                    const selectedShadow = defs.append('filter')
                        .attr('id', 'selected-shadow')
                        .attr('height', '150%');
                    
                    selectedShadow.append('feGaussianBlur')
                        .attr('in', 'SourceAlpha')
                        .attr('stdDeviation', 4);
                    selectedShadow.append('feOffset')
                        .attr('dx', 0)
                        .attr('dy', 6)
                        .attr('result', 'offsetBlur2');
                    selectedShadow.append('feFlood')
                        .attr('flood-color', '#3b82f6')
                        .attr('flood-opacity', 0.3)
                        .attr('result', 'color');
                    selectedShadow.append('feComposite')
                        .attr('in', 'color')
                        .attr('in2', 'offsetBlur2')
                        .attr('operator', 'in')
                        .attr('result', 'coloredBlur');
                    
                    const feMerge2 = selectedShadow.append('feMerge');
                    feMerge2.append('feMergeNode').attr('in', 'coloredBlur');
                    feMerge2.append('feMergeNode').attr('in', 'SourceGraphic');
                    
                    const highlightShadow = defs.append('filter')
                        .attr('id', 'highlight-shadow')
                        .attr('height', '150%');
                    
                    highlightShadow.append('feGaussianBlur')
                        .attr('in', 'SourceAlpha')
                        .attr('stdDeviation', 5);
                    highlightShadow.append('feOffset')
                        .attr('dx', 0)
                        .attr('dy', 8)
                        .attr('result', 'offsetBlur3');
                    highlightShadow.append('feFlood')
                        .attr('flood-color', '#f59e0b')
                        .attr('flood-opacity', 0.4)
                        .attr('result', 'color2');
                    highlightShadow.append('feComposite')
                        .attr('in', 'color2')
                        .attr('in2', 'offsetBlur3')
                        .attr('operator', 'in')
                        .attr('result', 'coloredBlur2');
                    
                    const feMerge3 = highlightShadow.append('feMerge');
                    feMerge3.append('feMergeNode').attr('in', 'coloredBlur2');
                    feMerge3.append('feMergeNode').attr('in', 'SourceGraphic');
                    
                    const g = svg.append('g');
                    
                    const zoom = d3.zoom()
                        .scaleExtent([0.1, 3])
                        .on('zoom', (event) => {
                            g.attr('transform', event.transform);
                        });
                    
                    svg.call(zoom);
                    
                    const nodeMap = new Map(sanitizedNodes.map(n => [n.id, n]));
                    const processed = sanitizedNodes.map(n => ({ ...n }));
                    const roots = processed.filter(n => !n.parentId || !nodeMap.has(n.parentId));
                    const virtualRootId = 'VIRTUAL_ROOT';
                    
                    if (roots.length > 1) {
                        processed.push({
                            id: virtualRootId,
                            name: '',
                            title: '',
                            department: '',
                            parentId: null
                        });
                        
                        roots.forEach(r => r.parentId = virtualRootId);
                    }
                    
                    const root = d3.stratify()
                        .id(d => d.id)
                        .parentId(d => d.parentId)
                        (processed);
                    
                    const treeLayout = d3.tree()
                        .nodeSize([220, 280])
                        .separation((a, b) => a.parent === b.parent ? 1 : 2);
                    
                    treeLayout(root);
                    
                    // Calcular análisis para resaltar
                    const subordinateCount = {};
                    sanitizedNodes.forEach(node => {
                        if (node.parentId && node.parentId.trim() !== '') {
                            subordinateCount[node.parentId] = (subordinateCount[node.parentId] || 0) + 1;
                        }
                    });
                    
                    // Encontrar líderes sobrecargados
                    const overloadedLeaders = sanitizedNodes.filter(node => 
                        (subordinateCount[node.id] || 0) > 8
                    );
                    
                    g.selectAll('.link')
                        .data(root.links())
                        .enter()
                        .append('path')
                        .filter(d => d.source.id !== virtualRootId && d.target.id !== virtualRootId)
                        .attr('class', 'link')
                        .attr('fill', 'none')
                        .attr('stroke', d => {
                            // Resaltar conexiones de departamento seleccionado
                            if (highlightedDepartment && 
                                d.source.data.department === highlightedDepartment) {
                                return '#f59e0b';
                            }
                            return '#cbd5e1';
                        })
                        .attr('stroke-width', d => {
                            if (highlightedDepartment && 
                                d.source.data.department === highlightedDepartment) {
                                return 3;
                            }
                            return 2;
                        })
                        .attr('opacity', d => {
                            if (highlightedDepartment && 
                                d.source.data.department !== highlightedDepartment &&
                                d.target.data.department !== highlightedDepartment) {
                                return 0.3;
                            }
                            return 0.6;
                        })
                        .attr('d', d3.linkVertical()
                            .x(d => d.x)
                            .y(d => d.y)
                        );
                    
                    const nodeGroups = g.selectAll('.node')
                        .data(root.descendants())
                        .enter()
                        .append('g')
                        .filter(d => d.id !== virtualRootId)
                        .attr('class', 'node')
                        .attr('transform', d => `translate(${d.x}, ${d.y})`)
                        .on('click', (event, d) => {
                            event.stopPropagation();
                            onSelectNode(d.id);
                        })
                        .style('cursor', 'pointer')
                        .attr('data-node-id', d => d.id);
                    
                    nodeGroups.append('rect')
                        .attr('class', 'node-card')
                        .attr('width', 200)
                        .attr('height', 120)
                        .attr('x', -100)
                        .attr('y', -60)
                        .attr('rx', 20)
                        .attr('fill', 'white')
                        .attr('filter', d => {
                            if (d.id === selectedNodeId) return 'url(#selected-shadow)';
                            if (highlightedDepartment && d.data.department === highlightedDepartment) {
                                return 'url(#highlight-shadow)';
                            }
                            if (overloadedLeaders.some(l => l.id === d.id)) {
                                return 'url(#highlight-shadow)';
                            }
                            return 'url(#card-shadow)';
                        })
                        .attr('stroke', d => {
                            if (d.id === selectedNodeId) return '#2563eb';
                            if (highlightedDepartment && d.data.department === highlightedDepartment) return '#f59e0b';
                            if (overloadedLeaders.some(l => l.id === d.id)) return '#f59e0b';
                            if (d.data.isCritical && !d.data.successionId) return '#ef4444';
                            if (d.data.isCritical) return '#f59e0b';
                            return '#f1f5f9';
                        })
                        .attr('stroke-width', d => {
                            if (d.id === selectedNodeId) return 3;
                            if (highlightedDepartment && d.data.department === highlightedDepartment) return 3;
                            if (overloadedLeaders.some(l => l.id === d.id)) return 3;
                            if (d.data.isCritical) return 2;
                            return 1;
                        })
                        .attr('class', d => {
                            const classes = [];
                            if (d.data.isCritical && !d.data.successionId) classes.push('animate-pulse');
                            if (overloadedLeaders.some(l => l.id === d.id)) classes.push('span-of-control-high');
                            return classes.join(' ');
                        });
                    
                    nodeGroups.append('rect')
                        .attr('width', 200)
                        .attr('height', 8)
                        .attr('x', -100)
                        .attr('y', -60)
                        .attr('rx', 4)
                        .attr('fill', d => d.data.color || COLORS_DEPT[d.data.department] || '#3b82f6');
                    
                    nodeGroups.append('text')
                        .attr('class', 'node-name')
                        .attr('dy', -30)
                        .attr('x', -85)
                        .attr('fill', '#0f172a')
                        .style('font-size', '12px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => {
                            const name = d.data.name || '';
                            return name.length > 20 ? name.substring(0, 18) + '...' : name;
                        });
                    
                    nodeGroups.append('text')
                        .attr('class', 'node-title')
                        .attr('dy', -15)
                        .attr('x', -85)
                        .attr('fill', '#64748b')
                        .style('font-size', '10px')
                        .style('font-weight', '600')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => {
                            const title = d.data.title || '';
                            return title.length > 25 ? title.substring(0, 23) + '...' : title;
                        });
                    
                    nodeGroups.append('text')
                        .attr('class', 'node-dept')
                        .attr('dy', 0)
                        .attr('x', -85)
                        .attr('fill', '#3b82f6')
                        .style('font-size', '9px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .style('text-transform', 'uppercase')
                        .style('letter-spacing', '0.05em')
                        .text(d => {
                            const dept = d.data.department || '';
                            return dept.length > 18 ? dept.substring(0, 16) + '...' : dept;
                        });
                    
                    const perfGroup = nodeGroups.append('g')
                        .attr('transform', 'translate(-85, 20)');
                    
                    perfGroup.append('rect')
                        .attr('width', 130)
                        .attr('height', 6)
                        .attr('fill', '#f1f5f9')
                        .attr('rx', 3);
                    
                    perfGroup.append('rect')
                        .attr('width', d => {
                            const perf = d.data.performance || 0;
                            return Math.max(10, (perf / 100) * 130);
                        })
                        .attr('height', 6)
                        .attr('rx', 3)
                        .attr('fill', d => {
                            const perf = d.data.performance || 0;
                            if (perf >= 85) return '#10b981';
                            if (perf >= 70) return '#f59e0b';
                            return '#ef4444';
                        });
                    
                    perfGroup.append('text')
                        .attr('x', 135)
                        .attr('y', 5)
                        .attr('text-anchor', 'start')
                        .attr('fill', '#64748b')
                        .style('font-size', '9px')
                        .style('font-weight', '700')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => `${d.data.performance || 0}%`);
                    
                    const badgeGroup = nodeGroups.append('g')
                        .attr('transform', 'translate(50, 35)');
                    
                    badgeGroup.append('rect')
                        .attr('width', 38)
                        .attr('height', 18)
                        .attr('rx', 9)
                        .attr('fill', d => {
                            const pot = d.data.potential || 'Medio';
                            if (pot === 'Alto') return '#dcfce7';
                            if (pot === 'Medio') return '#fef3c7';
                            return '#f1f5f9';
                        });
                    
                    badgeGroup.append('text')
                        .attr('x', 19)
                        .attr('y', 12)
                        .attr('text-anchor', 'middle')
                        .attr('fill', d => {
                            const pot = d.data.potential || 'Medio';
                            if (pot === 'Alto') return '#166534';
                            if (pot === 'Medio') return '#92400e';
                            return '#64748b';
                        })
                        .style('font-size', '8px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .style('text-transform', 'uppercase')
                        .text(d => {
                            const pot = d.data.potential || 'Medio';
                            if (pot === 'Alto') return 'TOP';
                            if (pot === 'Medio') return 'MED';
                            return 'BAJO';
                        });
                    
                    nodeGroups.filter(d => d.data.isCritical)
                        .append('circle')
                        .attr('cx', 80)
                        .attr('cy', -45)
                        .attr('r', 6)
                        .attr('fill', d => d.data.successionId ? '#f59e0b' : '#ef4444')
                        .attr('stroke', 'white')
                        .attr('stroke-width', 2)
                        .attr('class', d => !d.data.successionId ? 'animate-pulse' : '');
                    
                    // Indicador de líder sobrecargado
                    nodeGroups.filter(d => (subordinateCount[d.id] || 0) > 8)
                        .append('circle')
                        .attr('cx', 80)
                        .attr('cy', -30)
                        .attr('r', 4)
                        .attr('fill', '#ef4444')
                        .attr('stroke', 'white')
                        .attr('stroke-width', 1)
                        .attr('class', 'animate-pulse');
                    
                    nodeGroups.append('text')
                        .attr('x', 80)
                        .attr('y', 55)
                        .attr('text-anchor', 'middle')
                        .attr('fill', '#059669')
                        .style('font-size', '9px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => {
                            const salary = d.data.salary || 0;
                            if (salary >= 10000) return `$${(salary / 1000).toFixed(0)}k`;
                            if (salary >= 1000) return `$${(salary / 1000).toFixed(1)}k`;
                            return `$${salary}`;
                        });
                    
                    const rootNodes = root.descendants().filter(d => d.id !== virtualRootId);
                    if (rootNodes.length > 0) {
                        const xExtent = d3.extent(rootNodes, d => d.x);
                        const yExtent = d3.extent(rootNodes, d => d.y);
                        
                        const scale = Math.min(
                            (width - 100) / (xExtent[1] - xExtent[0]),
                            (height - 100) / (yExtent[1] - yExtent[0]),
                            0.9
                        );
                        
                        const translateX = width / 2 - (xExtent[0] + xExtent[1]) / 2 * scale;
                        const translateY = height / 2 - (yExtent[0] + yExtent[1]) / 2 * scale;
                        
                        svg.transition()
                            .duration(800)
                            .call(zoom.transform, d3.zoomIdentity
                                .translate(translateX, translateY)
                                .scale(scale)
                            );
                    }
                    
                    setError(null);
                } catch (err) {
                    console.error('Error al renderizar el organigrama:', err);
                    setError('Error al renderizar el gráfico. Los datos pueden estar corruptos.');
                    
                    svg.append('text')
                        .attr('x', width / 2)
                        .attr('y', height / 2)
                        .attr('text-anchor', 'middle')
                        .attr('fill', '#ef4444')
                        .text('Error al renderizar el organigrama');
                }
                
            }, [nodes, selectedNodeId, dimensions, highlightedDepartment]);
            
            if (error) {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-b from-red-50 to-orange-50 text-red-400">
                        <i className="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p className="font-bold text-red-600">{error}</p>
                        <button
                            onClick={() => setError(null)}
                            className="mt-4 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors"
                        >
                            Reintentar
                        </button>
                    </div>
                );
            }
            
            if (!nodes || nodes.length === 0) {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-b from-slate-50 to-blue-50/30 text-slate-400">
                        <i className="fas fa-sitemap text-8xl opacity-10 mb-6"></i>
                        <p className="font-black text-2xl text-slate-300 mb-2">Organigrama vacío</p>
                        <p className="text-sm opacity-60 max-w-md text-center">
                            Carga datos desde Excel o usa el simulador para comenzar
                        </p>
                    </div>
                );
            }
            
            const subordinateCount = {};
            nodes.forEach(node => {
                if (node.parentId && node.parentId.trim() !== '') {
                    subordinateCount[node.parentId] = (subordinateCount[node.parentId] || 0) + 1;
                }
            });
            
            const overloadedLeaders = nodes.filter(node => (subordinateCount[node.id] || 0) > 8);
            
            return (
                <div
                    ref={containerRef}
                    id="capture-area"
                    className="w-full h-full bg-gradient-to-b from-slate-50 to-blue-50/30 relative overflow-hidden d3-container"
                    onClick={() => onSelectNode(null)}
                >
                    <svg
                        ref={svgRef}
                        className="w-full h-full outline-none"
                    />
                    
                    <div className="absolute bottom-4 right-4 glass-effect p-3 rounded-2xl border border-slate-200 card-shadow">
                        <div className="flex items-center gap-4 text-xs font-black text-slate-600">
                            <span className="flex items-center gap-1">
                                <i className="fas fa-users text-blue-500"></i>
                                {nodes.length} colaboradores
                            </span>
                            <span className="flex items-center gap-1">
                                <i className="fas fa-building text-emerald-500"></i>
                                {new Set(nodes.map(n => n.department)).size} departamentos
                            </span>
                            <span className="flex items-center gap-1">
                                <i className="fas fa-dollar-sign text-amber-500"></i>
                                ${nodes.reduce((sum, n) => sum + (n.salary || 0), 0).toLocaleString()}
                            </span>
                        </div>
                    </div>
                    
                    {showLegend && (
                        <div className="absolute top-4 left-4 glass-effect p-4 rounded-2xl border border-slate-200 card-shadow max-w-xs animate-in slide-in-left">
                            <div className="flex justify-between items-center mb-3">
                                <h5 className="text-xs font-black text-slate-400 uppercase flex items-center gap-2">
                                    <i className="fas fa-info-circle text-blue-500"></i>
                                    Leyenda del Organigrama
                                </h5>
                            </div>
                            <div className="space-y-2">
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-emerald-500"></div>
                                    <span className="text-xs font-medium text-slate-600">Posición Estable</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-amber-500"></div>
                                    <span className="text-xs font-medium text-slate-600">Crítico con Sucesor</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                                    <span className="text-xs font-medium text-slate-600">Crítico sin Sucesor</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-blue-500"></div>
                                    <span className="text-xs font-medium text-slate-600">Seleccionado</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-red-500"></div>
                                    <span className="text-xs font-medium text-slate-600">Líder Sobrecargado ({overloadedLeaders.length})</span>
                                </div>
                                {highlightedDepartment && (
                                    <div className="flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full bg-amber-500"></div>
                                        <span className="text-xs font-medium text-slate-600">
                                            Departamento: {highlightedDepartment}
                                        </span>
                                    </div>
                                )}
                                <div className="pt-2 mt-2 border-t border-slate-100">
                                    <p className="text-[10px] text-slate-500">
                                        <i className="fas fa-mouse-pointer mr-1"></i>
                                        Haz clic en cualquier nodo para editarlo
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // ============================================
        // COMPONENTES DE ANÁLISIS - PRESERVADOS
        // ============================================
        
        const KPIBox = ({ icon, color, label, value, sub }) => {
            const colorMap = {
                blue: 'bg-gradient-to-br from-blue-500 to-blue-600',
                emerald: 'bg-gradient-to-br from-emerald-500 to-emerald-600',
                indigo: 'bg-gradient-to-br from-indigo-500 to-indigo-600',
                red: 'bg-gradient-to-br from-red-500 to-red-600',
                amber: 'bg-gradient-to-br from-amber-500 to-amber-600',
                purple: 'bg-gradient-to-br from-purple-500 to-purple-600',
                pink: 'bg-gradient-to-br from-pink-500 to-pink-600',
                cyan: 'bg-gradient-to-br from-cyan-500 to-cyan-600'
            };
            
            return (
                <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex items-center gap-5 group hover:border-slate-300 transition-all duration-300 animate-in">
                    <div className={`w-14 h-14 rounded-2xl ${colorMap[color] || colorMap.blue} flex items-center justify-center text-white text-xl shadow-lg group-hover:scale-110 transition-transform duration-300`}>
                        <i className={`fas ${icon}`}></i>
                    </div>
                    <div>
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1">
                            {label}
                        </p>
                        <p className="text-2xl font-black text-slate-900 leading-tight">
                            {value}
                        </p>
                        <p className="text-[9px] font-medium text-slate-500 mt-0.5">
                            {sub}
                        </p>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // COMPONENTE DE ANÁLISIS 360° - MEJORADO
        // ============================================
        
        const AnalysisTab = ({ nodes }) => {
            const [highlightedDepartment, setHighlightedDepartment] = React.useState(null);
            
            const chartData = React.useMemo(() => {
                return generateChartData(nodes);
            }, [nodes]);
            
            const summary = React.useMemo(() => {
                return generateExecutiveSummary(nodes);
            }, [nodes]);
            
            const stats = React.useMemo(() => {
                if (!nodes || nodes.length === 0) {
                    return {
                        totalNodes: 0,
                        totalDepartments: 0,
                        totalSalary: 0,
                        avgSalary: 0,
                        avgPerformance: 0,
                        avgSeniority: 0,
                        criticalNodes: 0,
                        criticalIssues: 0,
                        riskLevel: 0,
                        topTalents: 0,
                        avgSubordinatesPerManager: 0,
                        maxSubordinates: 0,
                        genderDiversity: 0,
                        avgDeptSize: 0
                    };
                }
                
                const totalSalary = nodes.reduce((sum, n) => sum + (n.salary || 0), 0);
                const avgSalary = nodes.length > 0 ? Math.round(totalSalary / nodes.length) : 0;
                
                const validPerformances = nodes.filter(n => n.performance != null);
                const avgPerformance = validPerformances.length > 0 
                    ? Math.round(validPerformances.reduce((sum, n) => sum + (n.performance || 0), 0) / validPerformances.length)
                    : 0;
                
                const validSeniority = nodes.filter(n => n.seniority != null);
                const avgSeniority = validSeniority.length > 0
                    ? Number((validSeniority.reduce((sum, n) => sum + (n.seniority || 0), 0) / validSeniority.length).toFixed(1))
                    : 0;
                
                const departments = [...new Set(nodes.map(n => n.department || 'Sin departamento'))];
                const criticalNodes = nodes.filter(n => n.isCritical);
                const criticalIssues = criticalNodes.filter(n => !n.successionId);
                const riskLevel = criticalNodes.length > 0
                    ? Math.round((criticalIssues.length / criticalNodes.length) * 100)
                    : 0;
                
                const subordinateCount = {};
                nodes.forEach(node => {
                    if (node.parentId && node.parentId.trim() !== '') {
                        subordinateCount[node.parentId] = (subordinateCount[node.parentId] || 0) + 1;
                    }
                });
                
                const topTalents = nodes.filter(n => 
                    n.potential === 'Alto' && 
                    (n.performance || 0) >= 85
                );
                
                return {
                    totalNodes: nodes.length,
                    totalDepartments: departments.length,
                    totalSalary,
                    avgSalary,
                    avgPerformance,
                    avgSeniority,
                    criticalNodes: criticalNodes.length,
                    criticalIssues: criticalIssues.length,
                    riskLevel,
                    topTalents: topTalents.length,
                    avgSubordinatesPerManager: Object.values(subordinateCount).length > 0 
                        ? (Object.values(subordinateCount).reduce((a, b) => a + b, 0) / Object.values(subordinateCount).length).toFixed(1)
                        : 0,
                    maxSubordinates: Math.max(...Object.values(subordinateCount).concat([0])),
                    genderDiversity: chartData.genderData ? (chartData.genderData.length > 1 ? 1 : 0) : 0,
                    avgDeptSize: departments.length > 0 ? Math.round(nodes.length / departments.length) : 0
                };
            }, [nodes, chartData]);
            
            const handleDepartmentClick = (deptName) => {
                setHighlightedDepartment(
                    highlightedDepartment === deptName ? null : deptName
                );
            };
            
            return (
                <div className="p-4 md:p-6 h-full overflow-y-auto bg-gradient-to-b from-slate-50 to-blue-50/20 space-y-6 scrollbar-hide animate-in fade-in duration-700">
                    <div className="bg-gradient-to-r from-blue-900 to-purple-900 text-white p-8 rounded-3xl card-shadow relative overflow-hidden">
                        <div className="absolute -top-20 -right-20 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl"></div>
                        <div className="relative z-10">
                            <div className="flex items-start gap-6">
                                <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-500 rounded-2xl flex items-center justify-center text-3xl shadow-xl">
                                    <i className="fas fa-brain"></i>
                                </div>
                                <div className="flex-1">
                                    <h2 className="text-3xl font-black mb-4">
                                        HR Analytics 360° - Motor de Inteligencia de Negocios (BI)
                                    </h2>
                                    <p className="text-blue-100 text-lg leading-relaxed">
                                        Transforma la base de datos de empleados en decisiones estratégicas de capital humano.{' '}
                                        Esta no es solo una sección de gráficos, es un{' '}
                                        <strong>sistema de People Analytics profesional</strong>{' '}
                                        que permite pasar de una gestión reactiva a una proactiva basada en datos reales.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* RESUMEN EJECUTIVO */}
                    <ExecutiveSummary nodes={nodes} />
                    
                    {/* KPIs PRINCIPALES */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KPIBox
                            icon="fa-users"
                            color="blue"
                            label="Plantilla Total"
                            value={stats.totalNodes}
                            sub={`${stats.totalDepartments} departamentos`}
                        />
                        <KPIBox
                            icon="fa-rocket"
                            color="emerald"
                            label="Eficiencia Global"
                            value={`${stats.avgPerformance}%`}
                            sub="Promedio de rendimiento"
                        />
                        <KPIBox
                            icon="fa-funnel-dollar"
                            color="indigo"
                            label="Masa Salarial"
                            value={`$${(stats.totalSalary / 1000).toFixed(1)}k`}
                            sub="Costo laboral mensual"
                        />
                        <KPIBox
                            icon="fa-shield-alt"
                            color="red"
                            label="Riesgo de Sucesión"
                            value={`${stats.riskLevel}%`}
                            sub={`${stats.criticalIssues}/${stats.criticalNodes} críticos sin sucesor`}
                        />
                    </div>
                    
                    {/* GRÁFICOS DE ANÁLISIS AVANZADO */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex flex-col min-h-[400px]">
                            <div className="flex justify-between items-center mb-6">
                                <h4 className="font-black text-slate-800 flex items-center gap-3">
                                    <i className="fas fa-crown text-purple-500"></i>
                                    Análisis de Poder e Influencia
                                </h4>
                                <span className="text-[10px] bg-purple-100 text-purple-700 px-3 py-1.5 rounded-full font-black">
                                    TOP 10 LÍDERES
                                </span>
                            </div>
                            <div className="flex-1">
                                <PowerAnalysisChart data={chartData.powerAnalysis || []} />
                            </div>
                        </div>
                        
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex flex-col min-h-[400px]">
                            <h4 className="font-black text-slate-800 mb-6 flex items-center gap-3">
                                <i className="fas fa-users text-amber-500"></i>
                                Análisis Generacional y Riesgo de Jubilación
                            </h4>
                            <div className="flex-1">
                                <GenerationAnalysis data={chartData.generationData || {}} />
                            </div>
                        </div>
                    </div>
                    
                    {/* SALUD ESTRUCTURAL */}
                    <StructuralHealth nodes={nodes} />
                    
                    {/* ANÁLISIS DE ALCANCE */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex flex-col min-h-[400px]">
                            <div className="flex justify-between items-center mb-6">
                                <h4 className="font-black text-slate-800 flex items-center gap-3">
                                    <i className="fas fa-sitemap text-red-500"></i>
                                    Análisis de Alcance de Control
                                </h4>
                                <span className="text-[10px] bg-red-100 text-red-700 px-3 py-1.5 rounded-full font-black">
                                    LÍDERES SOBRECARGADOS
                                </span>
                            </div>
                            <div className="flex-1">
                                <SpanOfControlAnalysis 
                                    data={chartData.spanOfControlData || []} 
                                    nodes={nodes}
                                />
                            </div>
                        </div>
                        
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex flex-col min-h-[400px]">
                            <div className="flex justify-between items-center mb-6">
                                <h4 className="font-black text-slate-800 flex items-center gap-3">
                                    <i className="fas fa-th-large text-blue-500"></i>
                                    Matriz de Talento 9-Box
                                </h4>
                                <span className="text-[10px] bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full font-black">
                                    ESTÁNDAR DE ORO EN GESTIÓN DE TALENTO
                                </span>
                            </div>
                            <div className="flex-1">
                                <div className="h-full flex flex-col items-center justify-center bg-gradient-to-b from-slate-50 to-blue-50/50 rounded-xl p-4">
                                    <div className="text-center">
                                        <i className="fas fa-chart-scatter text-4xl text-slate-300 mb-3"></i>
                                        <p className="text-slate-500 font-medium">Matriz 9-Box Interactiva</p>
                                        <p className="text-sm text-slate-400 mt-1">
                                            Visualización de rendimiento vs potencial
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* INTERACTIVIDAD: SELECCIÓN DE DEPARTAMENTO */}
                    {chartData.deptStats && chartData.deptStats.length > 0 && (
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow">
                            <h4 className="font-black text-slate-800 mb-4 flex items-center gap-3">
                                <i className="fas fa-mouse-pointer text-blue-500"></i>
                                Interactividad: Filtra por Departamento
                            </h4>
                            <div className="flex flex-wrap gap-2">
                                {chartData.deptStats.map((dept, index) => (
                                    <button
                                        key={index}
                                        onClick={() => handleDepartmentClick(dept.name)}
                                        className={`px-4 py-2 rounded-xl text-sm font-medium transition-all ${
                                            highlightedDepartment === dept.name
                                                ? 'bg-blue-600 text-white shadow-lg'
                                                : 'bg-slate-100 text-slate-700 hover:bg-slate-200'
                                        }`}
                                    >
                                        <div className="flex items-center gap-2">
                                            <span>{dept.name}</span>
                                            <span className={`text-xs px-1.5 py-0.5 rounded-full ${
                                                highlightedDepartment === dept.name
                                                    ? 'bg-white/20'
                                                    : 'bg-slate-200'
                                            }`}>
                                                {dept.count}
                                            </span>
                                        </div>
                                    </button>
                                ))}
                                {highlightedDepartment && (
                                    <button
                                        onClick={() => setHighlightedDepartment(null)}
                                        className="px-4 py-2 bg-red-100 text-red-700 rounded-xl text-sm font-medium hover:bg-red-200 transition-all"
                                    >
                                        Limpiar filtro
                                    </button>
                                )}
                            </div>
                            <p className="text-sm text-slate-500 mt-3">
                                <i className="fas fa-info-circle mr-1"></i>
                                Selecciona un departamento para resaltarlo en el organigrama
                            </p>
                        </div>
                    )}
                    
                    {/* ORGANIGRAMA CON INTERACTIVIDAD */}
                    <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow">
                        <h4 className="font-black text-slate-800 mb-4 flex items-center gap-3">
                            <i className="fas fa-project-diagram text-emerald-500"></i>
                            Vista Interactiva del Organigrama
                        </h4>
                        <div className="h-96 rounded-xl overflow-hidden border border-slate-200">
                            <OrgChartD3
                                nodes={nodes}
                                selectedNodeId={null}
                                onSelectNode={() => {}}
                                showLegend={true}
                                highlightedDepartment={highlightedDepartment}
                            />
                        </div>
                        <p className="text-sm text-slate-500 mt-3">
                            <i className="fas fa-info-circle mr-1"></i>
                            El organigrama responde a las selecciones de departamento y resalta líderes sobrecargados
                        </p>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // COMPONENTES RESTANTES (sin cambios mayores)
        // ============================================
        
        // [Aquí mantengo todos los componentes restantes exactamente como están en tu código original:
        // MatrixChart, VisualTab, ExportTab, Header, Sidebar, TabNavigation, DesignTab, App]
        // Solo actualizo el componente App para incluir la nueva funcionalidad
        
        const MatrixChart = ({ data }) => {
            const chartData = data && Array.isArray(data) ? data : [];
            
            if (chartData.length === 0) {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-gradient-to-b from-slate-50 to-blue-50/50 rounded-xl p-4">
                        <div className="text-center">
                            <i className="fas fa-chart-scatter text-4xl text-slate-300 mb-3"></i>
                            <p className="text-slate-500 font-medium">Matriz 9-Box</p>
                            <p className="text-sm text-slate-400 mt-1">No hay datos disponibles</p>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="h-full flex flex-col bg-gradient-to-b from-slate-50 to-blue-50/50 rounded-xl p-4">
                    <div className="flex justify-between items-center mb-6">
                        <h4 className="font-bold text-slate-700">Matriz 9-Box</h4>
                        <span className="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">
                            {chartData.length} colaboradores
                        </span>
                    </div>
                    
                    <div className="flex-1 flex items-center justify-center">
                        <div className="relative w-full h-64">
                            {chartData.map((item, index) => {
                                const x = ((item.performance || 50) / 100) * 80 + 10;
                                const y = ((item.potential || 2) / 3) * 80 + 10;
                                const size = Math.min(Math.max((item.salary || 0) / 3000, 10), 30);
                                const color = item.potential === 3 ? '#10b981' : 
                                             item.potential === 2 ? '#f59e0b' : '#ef4444';
                                
                                return (
                                    <div
                                        key={index}
                                        className="absolute rounded-full border-2 border-white shadow-lg transition-transform hover:scale-125"
                                        style={{
                                            left: `${x}%`,
                                            top: `${y}%`,
                                            width: `${size}px`,
                                            height: `${size}px`,
                                            backgroundColor: color,
                                            transform: 'translate(-50%, -50%)',
                                            zIndex: 10
                                        }}
                                        title={`${item.name}: ${item.performance}% rendimiento, ${item.potentialLabel} potencial`}
                                    />
                                );
                            })}
                            
                            <div className="absolute inset-0 border-2 border-slate-200 rounded-lg bg-gradient-to-b from-white to-slate-50">
                                <div className="absolute left-1/3 top-0 bottom-0 border-r border-slate-200"></div>
                                <div className="absolute left-2/3 top-0 bottom-0 border-r border-slate-200"></div>
                                <div className="absolute top-1/3 left-0 right-0 border-t border-slate-200"></div>
                                <div className="absolute top-2/3 left-0 right-0 border-t border-slate-200"></div>
                                
                                <div className="absolute -top-6 left-0 right-0 text-center text-xs text-slate-500 font-bold">
                                    Desempeño →
                                </div>
                                <div className="absolute -left-8 top-0 bottom-0 flex items-center justify-center text-xs text-slate-500 font-bold rotate-90">
                                    Potencial ↑
                                </div>
                                
                                <div className="absolute top-0 left-0 w-1/3 h-1/3 bg-red-50/30 border-r border-b border-slate-200"></div>
                                <div className="absolute top-0 left-1/3 w-1/3 h-1/3 bg-amber-50/30 border-r border-b border-slate-200"></div>
                                <div className="absolute top-0 left-2/3 w-1/3 h-1/3 bg-emerald-50/30 border-b border-slate-200"></div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const VisualTab = ({ nodes, viewMode, setViewMode }) => {
            const [selectedNodeId, setSelectedNodeId] = React.useState(null);
            const [exporting, setExporting] = React.useState(false);
            
            const handleExportPDF = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('landscape', 'px', [canvas.width, canvas.height]);
                    
                    pdf.setFontSize(24);
                    pdf.setTextColor(30, 41, 59);
                    pdf.text('Organigrama Estructural', canvas.width / 2, 40, { align: 'center' });
                    
                    pdf.setFontSize(12);
                    pdf.setTextColor(100, 116, 139);
                    pdf.text(`Empresa: Luxanalitica HR 360° | Fecha: ${new Date().toLocaleDateString()}`, canvas.width / 2, 60, { align: 'center' });
                    
                    pdf.addImage(imgData, 'PNG', 20, 80, canvas.width - 40, canvas.height - 100);
                    
                    pdf.setFontSize(10);
                    pdf.setTextColor(30, 41, 59);
                    pdf.text(`Total colaboradores: ${nodes.length} | Generado por Luxanalitica`, 20, canvas.height - 10);
                    
                    pdf.save(`Organigrama_${new Date().toISOString().slice(0,10)}.pdf`);
                    
                } catch (error) {
                    console.error('Error exportando PDF:', error);
                    alert('Error al generar el PDF. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            const handleExportImage = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 3,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false
                    });
                    
                    const link = document.createElement('a');
                    link.download = `Organigrama_${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                } catch (error) {
                    console.error('Error exportando imagen:', error);
                    alert('Error al exportar la imagen. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            return (
                <div className="flex flex-col h-full bg-gradient-to-b from-slate-50 to-blue-50/30">
                    <div className="p-4 bg-white border-b border-slate-200 flex flex-wrap justify-between items-center card-shadow z-10 gap-3">
                        <div className="flex items-center gap-4">
                            <div className="px-3 py-1.5 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg flex items-center gap-2">
                                <i className="fas fa-sitemap text-blue-600"></i>
                                <span className="text-xs font-black text-slate-800 uppercase tracking-widest">
                                    Vista Jerárquica Premium
                                </span>
                            </div>
                            
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setViewMode('vertical')}
                                    className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
                                        viewMode === 'vertical' 
                                            ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg' 
                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`}
                                >
                                    <i className="fas fa-arrows-alt-v mr-1"></i>
                                    Vertical
                                </button>
                                <button
                                    onClick={() => setViewMode('horizontal')}
                                    className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
                                        viewMode === 'horizontal' 
                                            ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg' 
                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`}
                                >
                                    <i className="fas fa-arrows-alt-h mr-1"></i>
                                    Horizontal
                                </button>
                            </div>
                        </div>
                        
                        <div className="flex gap-2">
                            <button
                                onClick={handleExportImage}
                                disabled={exporting}
                                className="px-4 py-2 bg-gradient-to-r from-slate-800 to-gray-800 text-white rounded-xl text-xs font-bold hover:from-slate-700 hover:to-gray-700 transition-all shadow-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {exporting ? (
                                    <i className="fas fa-spinner fa-spin"></i>
                                ) : (
                                    <i className="fas fa-file-image"></i>
                                )}
                                {exporting ? 'Exportando...' : 'Exportar Imagen'}
                            </button>
                            <button
                                onClick={handleExportPDF}
                                disabled={exporting}
                                className="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl text-xs font-bold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg shadow-blue-500/20 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {exporting ? (
                                    <i className="fas fa-spinner fa-spin"></i>
                                ) : (
                                    <i className="fas fa-file-pdf"></i>
                                )}
                                {exporting ? 'Generando...' : 'Descargar PDF'}
                            </button>
                        </div>
                    </div>
                    
                    <div className="flex-1 relative overflow-hidden">
                        <OrgChartD3
                            nodes={nodes}
                            selectedNodeId={selectedNodeId}
                            onSelectNode={setSelectedNodeId}
                        />
                    </div>
                </div>
            );
        };
        
        const ExportTab = ({ nodes }) => {
            const [exporting, setExporting] = React.useState(false);
            
            const handleExportExcel = () => {
                try {
                    const excelData = nodes.map(node => ({
                        'ID': node.id,
                        'Nombre': node.name,
                        'Cargo': node.title,
                        'Departamento': node.department,
                        'Jefe ID': node.parentId || 'N/A',
                        'Salario ($)': node.salary || 0,
                        'Rendimiento (%)': node.performance || 0,
                        'Potencial': node.potential || 'Medio',
                        'Género': node.gender || 'Otro',
                        'Antigüedad (años)': node.seniority || 0,
                        'Posición Crítica': node.isCritical ? 'Sí' : 'No',
                        'ID Sucesor': node.successionId || 'N/A',
                        'Color': node.color || '#3b82f6',
                        'Año Nacimiento': node.birthYear || 1970,
                        'Fecha Ingreso': node.hireDate || 'N/A'
                    }));
                    
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    
                    const wscols = [
                        { wch: 10 }, { wch: 25 }, { wch: 25 }, { wch: 20 },
                        { wch: 10 }, { wch: 12 }, { wch: 12 }, { wch: 10 },
                        { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 10 },
                        { wch: 10 }, { wch: 12 }, { wch: 12 }
                    ];
                    ws['!cols'] = wscols;
                    
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Organigrama");
                    
                    const summaryData = [
                        ['RESUMEN DE ESTRUCTURA ORGANIZACIONAL', ''],
                        ['Fecha de exportación:', new Date().toLocaleDateString('es-ES')],
                        ['Hora de exportación:', new Date().toLocaleTimeString('es-ES')],
                        ['Total colaboradores:', nodes.length],
                        ['Total departamentos:', new Set(nodes.map(n => n.department)).size],
                        ['Masa salarial total:', `$${nodes.reduce((sum, n) => sum + (n.salary || 0), 0).toLocaleString()}`],
                        ['Rendimiento promedio:', `${Math.round(nodes.reduce((sum, n) => sum + (n.performance || 0), 0) / nodes.length)}%`],
                        ['Posiciones críticas:', nodes.filter(n => n.isCritical).length],
                        ['Críticos sin sucesor:', nodes.filter(n => n.isCritical && !n.successionId).length],
                        ['',''],
                        ['Este reporte fue generado por Luxanalitica HR 360°', '']
                    ];
                    
                    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, wsSummary, "Resumen");
                    
                    // Agregar hoja de análisis
                    const analysisData = generateExecutiveSummary(nodes);
                    const analysisSheet = [
                        ['ANÁLISIS AVANZADO - LUXANALITICA', ''],
                        ['Salud Organizacional:', `${generateHealthScore(nodes)}/100`],
                        ['Líderes sobrecargados:', analysisData.spanOfControlAnalysis.totalOverloaded],
                        ['Concentración salarial:', analysisData.topDepartmentBySalary ? 
                            `${Math.round((analysisData.topDepartmentBySalary.totalSalary / analysisData.totalSalaryMass) * 100)}% en ${analysisData.topDepartmentBySalary.name}` : 'N/A'],
                        ['',''],
                        ['Insights Clave:', ''],
                        ...analysisData.keyInsights.map(insight => [insight.message, insight.description])
                    ];
                    
                    const wsAnalysis = XLSX.utils.aoa_to_sheet(analysisSheet);
                    XLSX.utils.book_append_sheet(wb, wsAnalysis, "Análisis");
                    
                    XLSX.writeFile(wb, `Luxanalitica_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
                    
                } catch (error) {
                    console.error('Error exportando Excel:', error);
                    alert('Error al exportar a Excel. Intenta nuevamente.');
                }
            };
            
            const handleExportPDF = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false,
                        allowTaint: true
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('landscape', 'px', [canvas.width, canvas.height]);
                    
                    pdf.setFontSize(28);
                    pdf.setTextColor(30, 41, 59);
                    pdf.text('Reporte Organizacional', canvas.width / 2, 50, { align: 'center' });
                    
                    pdf.setFontSize(16);
                    pdf.setTextColor(100, 116, 139);
                    pdf.text('Luxanalitica HR 360°', canvas.width / 2, 75, { align: 'center' });
                    
                    pdf.setFontSize(12);
                    pdf.text(`Generado el ${new Date().toLocaleDateString('es-ES', { 
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}`, canvas.width / 2, 95, { align: 'center' });
                    
                    pdf.addImage(imgData, 'PNG', 20, 120, canvas.width - 40, canvas.height - 140);
                    
                    pdf.setFontSize(10);
                    pdf.setTextColor(30, 41, 59);
                    const statsText = [
                        `Total colaboradores: ${nodes.length}`,
                        `Departamentos: ${new Set(nodes.map(n => n.department)).size}`,
                        `Masa salarial: $${nodes.reduce((sum, n) => sum + (n.salary || 0), 0).toLocaleString()}`,
                        `Rendimiento promedio: ${Math.round(nodes.reduce((sum, n) => sum + (n.performance || 0), 0) / nodes.length)}%`
                    ].join(' | ');
                    
                    pdf.text(statsText, 20, canvas.height - 10);
                    
                    pdf.setFontSize(48);
                    pdf.setTextColor(241, 245, 249);
                    pdf.text('LUXANALITICA', canvas.width / 2, canvas.height / 2, { align: 'center', angle: 45 });
                    
                    pdf.save(`Luxanalitica_OrgChart_${new Date().toISOString().slice(0,10)}.pdf`);
                    
                } catch (error) {
                    console.error('Error exportando PDF:', error);
                    alert('Error al generar el PDF. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            const handleExportJSON = () => {
                try {
                    const dataStr = JSON.stringify({
                        metadata: {
                            exportDate: new Date().toISOString(),
                            totalNodes: nodes.length,
                            totalDepartments: new Set(nodes.map(n => n.department)).size,
                            healthScore: generateHealthScore(nodes),
                            version: '2.0'
                        },
                        nodes: nodes,
                        analysis: generateExecutiveSummary(nodes)
                    }, null, 2);
                    
                    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                    const link = document.createElement('a');
                    link.setAttribute('href', dataUri);
                    link.setAttribute('download', `Luxanalitica_Data_${new Date().toISOString().slice(0,10)}.json`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                } catch (error) {
                    console.error('Error exportando JSON:', error);
                    alert('Error al exportar JSON. Intenta nuevamente.');
                }
            };
            
            const handleExportImage = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 3,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false
                    });
                    
                    const link = document.createElement('a');
                    link.download = `Luxanalitica_OrgChart_${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                } catch (error) {
                    console.error('Error exportando imagen:', error);
                    alert('Error al exportar la imagen. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            const ExportCard = ({ icon, title, description, buttonText, onClick, color, disabled }) => (
                <div className="bg-white p-8 rounded-3xl border border-slate-200 card-shadow flex flex-col items-center text-center space-y-6 transition-transform hover:scale-[1.02] h-full">
                    <div className={`text-6xl ${color} mb-2`}>
                        <i className={`fas ${icon}`}></i>
                    </div>
                    
                    <div className="space-y-3 flex-1">
                        <h3 className="text-2xl font-black text-slate-800 tracking-tight">{title}</h3>
                        <p className="text-slate-500 text-sm leading-relaxed">{description}</p>
                    </div>
                    
                    <button
                        onClick={onClick}
                        disabled={disabled || exporting}
                        className={`w-full py-4 rounded-2xl font-black card-shadow transition-all hover:brightness-110 disabled:cursor-not-allowed disabled:opacity-50 flex items-center justify-center gap-2 ${
                            disabled ? 'bg-slate-400 text-white' : 
                            color === 'text-blue-600' ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white' :
                            color === 'text-red-600' ? 'bg-gradient-to-r from-red-600 to-red-700 text-white' :
                            color === 'text-emerald-600' ? 'bg-gradient-to-r from-emerald-600 to-green-600 text-white' :
                            'bg-gradient-to-r from-amber-600 to-orange-600 text-white'
                        }`}
                    >
                        {exporting && <i className="fas fa-spinner fa-spin"></i>}
                        {buttonText}
                    </button>
                </div>
            );
            
            return (
                <div className="p-6 md:p-12 h-full bg-gradient-to-b from-slate-50 to-blue-50/30 flex flex-col items-center justify-center overflow-y-auto scrollbar-hide">
                    <div className="max-w-6xl w-full space-y-10">
                        <div className="text-center space-y-4">
                            <h2 className="text-4xl font-black text-slate-900">Exportar Reportes Maestros</h2>
                            <p className="text-slate-600 max-w-2xl mx-auto">
                                Genera informes ejecutivos, comparte la estructura organizacional o realiza auditorías con nuestros formatos profesionales.
                            </p>
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">
                            <ExportCard
                                icon="fa-file-excel"
                                title="Base de Datos (Excel)"
                                description="Exporta toda la estructura con todos los KPIs en formato Excel compatible con sistemas de RRHH, Power BI y análisis avanzado."
                                buttonText="Descargar Excel"
                                onClick={handleExportExcel}
                                color="text-emerald-600"
                            />
                            
                            <ExportCard
                                icon="fa-file-pdf"
                                title="Reporte Ejecutivo (PDF)"
                                description="Genera un informe profesional en PDF con la estructura organizacional, análisis de riesgo y gráficos ejecutivos."
                                buttonText={exporting ? "Generando PDF..." : "Generar PDF"}
                                onClick={handleExportPDF}
                                color="text-red-600"
                                disabled={exporting}
                            />
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <ExportCard
                                icon="fa-file-code"
                                title="Datos Estructurados (JSON)"
                                description="Exporta la información en formato JSON para integración con APIs, aplicaciones personalizadas o análisis de datos avanzado."
                                buttonText="Descargar JSON"
                                onClick={handleExportJSON}
                                color="text-amber-600"
                            />
                            
                            <ExportCard
                                icon="fa-file-image"
                                title="Imagen del Organigrama"
                                description="Captura una imagen de alta resolución del organigrama actual para presentaciones o documentación."
                                buttonText={exporting ? "Generando Imagen..." : "Exportar Imagen"}
                                onClick={handleExportImage}
                                color="text-blue-600"
                                disabled={exporting}
                            />
                        </div>
                    </div>
                </div>
            );
        };
        
        const Header = () => {
            const [currentTime, setCurrentTime] = React.useState(new Date());
            
            React.useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);
            
            const formattedDate = currentTime.toLocaleDateString('es-ES', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const formattedTime = currentTime.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            return (
                <header className="bg-white border-b border-slate-200 px-6 md:px-8 py-4 flex justify-between items-center card-shadow z-10">
                    <div className="flex items-center gap-4">
                        <div className="p-2 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl">
                            <i className="fas fa-project-diagram text-blue-600 text-2xl"></i>
                        </div>
                        <div>
                            <h1 className="text-xl font-bold text-slate-800">Luxanalitica HR 360°</h1>
                            <p className="text-xs text-slate-400 font-semibold tracking-wide uppercase">
                                Plataforma de Diseño y Análisis Organizacional
                            </p>
                        </div>
                    </div>
                    
                    <div className="hidden md:flex items-center gap-6">
                        <div className="text-right">
                            <div className="text-sm font-bold text-slate-700">{formattedDate}</div>
                            <div className="text-xs text-slate-400 font-mono">{formattedTime}</div>
                        </div>
                        <div className="h-10 w-[1px] bg-slate-200"></div>
                        <div className="flex items-center gap-3">
                            <div className="text-right">
                                <div className="text-xs font-bold text-slate-800">Admin User</div>
                                <div className="text-[10px] text-emerald-500 font-bold uppercase flex items-center gap-1">
                                    <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                    Online
                                </div>
                            </div>
                            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-slate-100 to-slate-50 border border-slate-200 flex items-center justify-center text-slate-400">
                                <i className="fas fa-user-circle text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };
        
        const Sidebar = ({ isOpen, onToggle }) => {
            return (
                <div className={`${isOpen ? 'w-64' : 'w-20'} h-full bg-gradient-to-b from-slate-900 to-gray-900 text-white transition-all duration-300 flex flex-col shrink-0 z-20 card-shadow`}>
                    <div className="p-6 flex items-center gap-4 overflow-hidden whitespace-nowrap border-b border-slate-800">
                        <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center shrink-0 shadow-lg">
                            <i className="fas fa-layer-group text-lg"></i>
                        </div>
                        {isOpen && (
                            <span className="font-bold text-xl tracking-tight">
                                <span className="text-gradient">Lux</span>analitica
                            </span>
                        )}
                    </div>
                    
                    <nav className="flex-1 mt-6 px-3 space-y-2">
                        <div className="flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg">
                            <i className="fas fa-sitemap w-6 text-center text-lg"></i>
                            {isOpen && <span className="font-medium">Organigrama</span>}
                        </div>
                        
                        <div className="flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all text-slate-400 hover:text-white hover:bg-slate-800">
                            <i className="fas fa-users w-6 text-center text-lg"></i>
                            {isOpen && <span className="font-medium">Plantilla</span>}
                        </div>
                        
                        <div className="flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all text-slate-400 hover:text-white hover:bg-slate-800">
                            <i className="fas fa-chart-line w-6 text-center text-lg"></i>
                            {isOpen && <span className="font-medium">KPIs HR</span>}
                        </div>
                        
                        <div className="flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all text-slate-400 hover:text-white hover:bg-slate-800">
                            <i className="fas fa-cog w-6 text-center text-lg"></i>
                            {isOpen && <span className="font-medium">Configuración</span>}
                        </div>
                    </nav>
                    
                    <div className="p-4 border-t border-slate-800">
                        <button
                            onClick={onToggle}
                            className="w-full flex items-center justify-center p-3 rounded-xl hover:bg-slate-800 transition-colors"
                        >
                            <i className={`fas ${isOpen ? 'fa-chevron-left' : 'fa-chevron-right'}`}></i>
                        </button>
                    </div>
                </div>
            );
        };
        
        const TabNavigation = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'carga', label: 'Cargar Excel', icon: 'fa-cloud-upload-alt' },
                { id: 'diseno', label: 'Editor de Flujo', icon: 'fa-pencil-ruler' },
                { id: 'visualizacion', label: 'Vista Expandida', icon: 'fa-expand' },
                { id: 'analisis', label: 'HR Analytics 360°', icon: 'fa-chart-pie' },
                { id: 'exportacion', label: 'Exportar', icon: 'fa-file-download' },
            ];
            
            return (
                <div className="flex bg-white rounded-t-2xl border-t border-x border-slate-200 overflow-x-auto scrollbar-hide shrink-0 card-shadow">
                    {tabs.map((tab) => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex-1 min-w-[140px] py-4 px-6 flex items-center justify-center gap-3 transition-all duration-300 border-b-4 ${
                                activeTab === tab.id
                                    ? 'bg-gradient-to-b from-blue-50/80 to-white border-blue-600 text-blue-700 font-bold'
                                    : 'border-transparent text-slate-400 hover:text-slate-600 hover:bg-slate-50'
                            }`}
                        >
                            <i className={`fas ${tab.icon} text-lg`}></i>
                            <span className="text-sm whitespace-nowrap">{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };
        
        const DesignTab = ({ 
            nodes, 
            selectedNodeId, 
            setSelectedNodeId, 
            onUpdateNode, 
            onAddNode, 
            onDeleteNode, 
            showLegend, 
            setShowLegend 
        }) => {
            return (
                <div className="flex h-full">
                    <div className="w-80 xl:w-96 border-r border-slate-200 bg-gradient-to-b from-slate-50 to-blue-50/30 p-5 shrink-0 overflow-y-auto scrollbar-hide">
                        <NodeForm
                            selectedNode={nodes.find(n => n.id === selectedNodeId) || null}
                            nodes={nodes}
                            onUpdate={onUpdateNode}
                            onAdd={onAddNode}
                            onDelete={onDeleteNode}
                            onCancel={() => setSelectedNodeId(null)}
                        />
                    </div>
                    
                    <div className="flex-1 relative">
                        <div className="absolute top-4 right-4 z-10 flex gap-2">
                            <button
                                onClick={() => setShowLegend(!showLegend)}
                                className="glass-effect p-3 rounded-2xl border border-slate-200 card-shadow text-slate-600 hover:text-blue-600 transition-colors"
                                title={showLegend ? "Ocultar leyenda" : "Mostrar leyenda"}
                            >
                                <i className={`fas ${showLegend ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                            </button>
                        </div>
                        
                        <OrgChartD3
                            nodes={nodes}
                            selectedNodeId={selectedNodeId}
                            onSelectNode={setSelectedNodeId}
                            showLegend={showLegend}
                        />
                    </div>
                </div>
            );
        };
        
        const App = () => {
            const [activeTab, setActiveTab] = React.useState('carga');
            const [nodes, setNodes] = React.useState([]);
            const [selectedNodeId, setSelectedNodeId] = React.useState(null);
            const [viewMode, setViewMode] = React.useState('vertical');
            const [isSidebarOpen, setIsSidebarOpen] = React.useState(true);
            const [showLegend, setShowLegend] = React.useState(() => {
                try {
                    const saved = localStorage.getItem('luxanalitica_showLegend');
                    return saved ? JSON.parse(saved) : true;
                } catch {
                    return true;
                }
            });
            
            React.useEffect(() => {
                try {
                    const savedData = localStorage.getItem('luxanalitica_org_data');
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        if (Array.isArray(parsedData) && parsedData.length > 0) {
                            const sanitized = validateAndSanitizeNodes(parsedData);
                            setNodes(sanitized);
                            setActiveTab('diseno');
                        }
                    }
                } catch (error) {
                    console.error('Error al cargar datos guardados:', error);
                    localStorage.removeItem('luxanalitica_org_data');
                }
            }, []);
            
            React.useEffect(() => {
                if (nodes.length > 0) {
                    try {
                        localStorage.setItem('luxanalitica_org_data', JSON.stringify(nodes));
                    } catch (error) {
                        console.error('Error guardando datos:', error);
                    }
                }
            }, [nodes]);
            
            React.useEffect(() => {
                try {
                    localStorage.setItem('luxanalitica_showLegend', JSON.stringify(showLegend));
                } catch (error) {
                    console.error('Error guardando preferencia de leyenda:', error);
                }
            }, [showLegend]);
            
            const handleUpdateNode = React.useCallback((updatedNode) => {
                setNodes(prev => {
                    const sanitizedNode = {
                        ...updatedNode,
                        salary: Number(updatedNode.salary) || 0,
                        performance: Number(updatedNode.performance) || 80,
                        seniority: Number(updatedNode.seniority) || 0,
                        birthYear: Number(updatedNode.birthYear) || 1970,
                        isCritical: Boolean(updatedNode.isCritical)
                    };
                    
                    return prev.map(node => 
                        node.id === sanitizedNode.id ? sanitizedNode : node
                    );
                });
            }, []);
            
            const handleAddNode = React.useCallback((newNode) => {
                if (wouldCreateCycle(newNode.id, newNode.parentId, nodes)) {
                    alert('No se puede asignar este jefe porque se crearía un ciclo jerárquico.');
                    return;
                }
                
                const sanitizedNode = {
                    ...newNode,
                    salary: Number(newNode.salary) || 0,
                    performance: Number(newNode.performance) || 80,
                    seniority: Number(newNode.seniority) || 0,
                    birthYear: Number(newNode.birthYear) || 1970,
                    isCritical: Boolean(newNode.isCritical)
                };
                
                setNodes(prev => [...prev, sanitizedNode]);
                setSelectedNodeId(sanitizedNode.id);
            }, [nodes]);
            
            const handleDeleteNode = React.useCallback((nodeId) => {
                if (window.confirm('¿Estás seguro de eliminar este colaborador? Los subordinados quedarán sin jefe asignado.')) {
                    setNodes(prev => {
                        return prev
                            .filter(node => node.id !== nodeId)
                            .map(node => 
                                node.parentId === nodeId 
                                    ? { ...node, parentId: null }
                                    : node
                            );
                    });
                    setSelectedNodeId(null);
                }
            }, []);
            
            const handleImport = React.useCallback((importedNodes) => {
                const sanitizedNodes = validateAndSanitizeNodes(importedNodes);
                setNodes(sanitizedNodes);
                setActiveTab('diseno');
            }, []);
            
            const handleHardReset = () => {
                if (window.confirm('¿Estás seguro de reiniciar toda la aplicación? Se perderán todos los datos.')) {
                    try {
                        localStorage.removeItem('luxanalitica_org_data');
                        localStorage.removeItem('luxanalitica_versions');
                        localStorage.removeItem('luxanalitica_showLegend');
                    } catch (error) {
                        console.warn('Error limpiando localStorage:', error);
                    }
                    setNodes([]);
                    setActiveTab('carga');
                    setSelectedNodeId(null);
                }
            };
            
            return (
                <div className="flex h-screen w-screen overflow-hidden bg-slate-50">
                    <Sidebar
                        isOpen={isSidebarOpen}
                        onToggle={() => setIsSidebarOpen(!isSidebarOpen)}
                    />
                    
                    <div className="flex-1 flex flex-col min-w-0">
                        <div className="flex justify-between items-center px-6 py-2 bg-white border-b border-slate-200">
                            <div></div>
                            <button
                                onClick={handleHardReset}
                                className="px-3 py-1 text-xs text-red-600 hover:text-red-800 font-medium flex items-center gap-1"
                            >
                                <i className="fas fa-redo"></i>
                                Resetear Aplicación
                            </button>
                        </div>
                        
                        <Header />
                        
                        <div className="flex-1 flex flex-col p-4 md:p-6 overflow-hidden">
                            <TabNavigation
                                activeTab={activeTab}
                                setActiveTab={setActiveTab}
                            />
                            
                            <div className="flex-1 bg-white rounded-b-2xl card-shadow border border-slate-200 overflow-hidden relative">
                                {activeTab === 'carga' && (
                                    <UploadTab onImport={handleImport} />
                                )}
                                {activeTab === 'diseno' && (
                                    <DesignTab
                                        nodes={nodes}
                                        selectedNodeId={selectedNodeId}
                                        setSelectedNodeId={setSelectedNodeId}
                                        onUpdateNode={handleUpdateNode}
                                        onAddNode={handleAddNode}
                                        onDeleteNode={handleDeleteNode}
                                        showLegend={showLegend}
                                        setShowLegend={setShowLegend}
                                    />
                                )}
                                {activeTab === 'visualizacion' && (
                                    <VisualTab
                                        nodes={nodes}
                                        viewMode={viewMode}
                                        setViewMode={setViewMode}
                                    />
                                )}
                                {activeTab === 'analisis' && (
                                    <AnalysisTab nodes={nodes} />
                                )}
                                {activeTab === 'exportacion' && (
                                    <ExportTab nodes={nodes} />
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // INICIALIZACIÓN Y RENDERIZADO FINAL
        // ============================================
        
        // Verificar dependencias antes de renderizar
        const dependencyErrors = checkDependencies();
        
        if (dependencyErrors.length > 0) {
            console.error('Errores de dependencia:', dependencyErrors);
            document.getElementById('loading-screen').innerHTML = `
                <div class="text-center text-white">
                    <div class="text-red-400 text-6xl mb-6">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2 class="text-2xl font-bold mb-4">Error de dependencias</h2>
                    <div class="bg-white/10 p-4 rounded-lg text-left max-w-md">
                        <p class="mb-2">Las siguientes dependencias faltan:</p>
                        <ul class="list-disc pl-5 text-sm">
                            ${dependencyErrors.map(err => `<li>${err}</li>`).join('')}
                        </ul>
                    </div>
                    <button onclick="window.location.reload()" class="mt-6 px-6 py-3 bg-white text-blue-600 rounded-xl font-bold">
                        Recargar página
                    </button>
                </div>
            `;
        } else {
            // Todas las dependencias están cargadas, proceder con React
            console.log('✅ Todas las dependencias cargadas correctamente');
            
            // Renderizar aplicación con React 18
            try {
                const rootElement = document.getElementById('root');
                if (!rootElement) {
                    throw new Error('Elemento root no encontrado');
                }
                
                const root = ReactDOM.createRoot(rootElement);
                root.render(
                    <ErrorBoundary>
                        <App />
                    </ErrorBoundary>
                );
                
                // Ocultar pantalla de carga después de renderizar
                setTimeout(hideLoadingScreen, 1000);
                
            } catch (error) {
                console.error('Error al renderizar la aplicación:', error);
                document.getElementById('loading-screen').innerHTML = `
                    <div class="text-center text-white">
                        <div class="text-red-400 text-6xl mb-6">
                            <i class="fas fa-bug"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-4">Error crítico al renderizar</h2>
                        <p class="mb-4">${error.message}</p>
                        <button onclick="window.location.reload()" class="px-6 py-3 bg-white text-blue-600 rounded-xl font-bold">
                            Recargar página
                        </button>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>

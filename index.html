<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxanalitica Suite - Org Chart Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'in': 'fadeIn 0.5s ease-out',
                        'slide-in-left': 'slideInLeft 0.3s ease-out',
                        'zoom-in': 'zoomIn 0.5s ease-out',
                        'pulse': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 3s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideInLeft: {
                            '0%': { transform: 'translateX(-20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        zoomIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Dependencias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Recharts UMD - Versión corregida -->
    <script src="https://unpkg.com/recharts@2.10.4/umd/Recharts.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            overflow: hidden;
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Animaciones personalizadas */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-animate {
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        /* Mejoras para inputs */
        input, select, textarea {
            transition: all 0.2s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            ring: 2px;
            ring-color: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }
        
        /* Efectos de tarjetas */
        .card-shadow {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05), 0 2px 10px rgba(0, 0, 0, 0.02);
        }
        
        .card-shadow-hover:hover {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 5px 20px rgba(0, 0, 0, 0.03);
        }
        
        /* Efectos premium */
        .glass-effect {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .neon-border {
            position: relative;
        }
        
        .neon-border::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #06b6d4, #10b981);
            border-radius: inherit;
            z-index: -1;
            opacity: 0.5;
            animation: gradient 3s ease infinite;
        }
        
        /* Custom utilities */
        .text-gradient {
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .bg-gradient-premium {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .bg-gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .bg-gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .bg-gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        /* Estilos para gráficos Recharts */
        .recharts-wrapper {
            font-family: 'Inter', sans-serif;
        }
        
        .recharts-tooltip-wrapper {
            z-index: 1000;
        }
        
        .recharts-default-tooltip {
            background-color: rgba(15, 23, 42, 0.95) !important;
            border: 1px solid #334155 !important;
            border-radius: 12px !important;
            padding: 12px !important;
        }
        
        .recharts-tooltip-item {
            color: #f1f5f9 !important;
            font-size: 12px !important;
        }
        
        .recharts-tooltip-item-name {
            color: #94a3b8 !important;
        }
        
        /* Asegurar que D3 no se salga del contenedor */
        .d3-container svg {
            display: block;
        }
        
        .d3-container svg text {
            font-family: 'Inter', sans-serif;
            pointer-events: none;
        }
        
        /* Mejoras para selectores personalizados */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        
        /* Estilos para checkboxes personalizados */
        .custom-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #cbd5e1;
            border-radius: 0.375rem;
            background-color: white;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Estilos para range input personalizado */
        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Responsive fixes */
        @media (max-width: 768px) {
            .mobile-stack {
                flex-direction: column !important;
            }
            
            .mobile-full {
                width: 100% !important;
            }
            
            .mobile-text-center {
                text-align: center !important;
            }
            
            .mobile-p-4 {
                padding: 1rem !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        // ============================================
        // ARREGLO CRÍTICO: HACER RECHAIRTS DISPONIBLE
        // ============================================
        
        // Recharts está cargado como UMD, asignarlo a una variable usable
        const Recharts = window.Recharts;
        
        // Si Recharts no se cargó, mostrar mensaje de error
        if (!Recharts) {
            console.error('Recharts no se cargó correctamente. Verifica la URL de la librería.');
            
            // Crear componentes dummy para evitar errores
            const createDummyComponent = (name) => ({ children, ...props }) => {
                console.warn(`Componente ${name} no disponible - Recharts no cargado`);
                return React.createElement('div', {
                    style: {
                        padding: '20px',
                        background: '#f0f0f0',
                        color: '#666',
                        textAlign: 'center',
                        borderRadius: '8px',
                        margin: '10px'
                    }
                }, `Componente ${name} no disponible`);
            };
            
            // Crear objeto Recharts dummy
            window.Recharts = {
                ResponsiveContainer: ({ children, width, height }) => 
                    React.createElement('div', {
                        style: { width: width || '100%', height: height || '100%' }
                    }, children),
                ScatterChart: createDummyComponent('ScatterChart'),
                Scatter: createDummyComponent('Scatter'),
                XAxis: createDummyComponent('XAxis'),
                YAxis: createDummyComponent('YAxis'),
                ZAxis: createDummyComponent('ZAxis'),
                CartesianGrid: createDummyComponent('CartesianGrid'),
                Tooltip: createDummyComponent('Tooltip'),
                Legend: createDummyComponent('Legend'),
                BarChart: createDummyComponent('BarChart'),
                Bar: createDummyComponent('Bar'),
                Cell: createDummyComponent('Cell'),
                PieChart: createDummyComponent('PieChart'),
                Pie: createDummyComponent('Pie'),
                ComposedChart: createDummyComponent('ComposedChart'),
                Line: createDummyComponent('Line'),
                AreaChart: createDummyComponent('AreaChart'),
                Area: createDummyComponent('Area')
            };
        }
        
        // ============================================
        // CONSTANTES Y CONFIGURACIONES
        // ============================================
        
        const DEPARTMENTS = [
            'Dirección General',
            'Finanzas',
            'Operaciones',
            'Ventas',
            'Recursos Humanos',
            'Tecnología',
            'Marketing',
            'Legal',
            'Innovación',
            'Logística',
            'Calidad',
            'Compras',
            'Producción',
            'Servicio al Cliente',
            'Investigación y Desarrollo'
        ];
        
        const TITLES = [
            'Presidente Ejecutivo',
            'CEO',
            'Director General',
            'Vicepresidente',
            'Director',
            'Gerente General',
            'Gerente',
            'Subgerente',
            'Supervisor',
            'Coordinador',
            'Analista Sr',
            'Analista Jr',
            'Especialista',
            'Asistente',
            'Practicante'
        ];
        
        const POTENTIAL_LEVELS = ['Alto', 'Medio', 'Bajo'];
        const GENDER_OPTIONS = ['Masculino', 'Femenino', 'Otro', 'Prefiero no decirlo'];
        
        const COLORS_DEPT = {
            'Dirección General': '#1e3a8a',
            'Finanzas': '#15803d',
            'Operaciones': '#b45309',
            'Ventas': '#be185d',
            'Recursos Humanos': '#6366f1',
            'Tecnología': '#06b6d4',
            'Marketing': '#8b5cf6',
            'Legal': '#dc2626',
            'Innovación': '#0891b2',
            'Logística': '#ea580c',
            'Calidad': '#059669',
            'Compras': '#7c3aed',
            'Producción': '#d97706',
            'Servicio al Cliente': '#0ea5e9',
            'Investigación y Desarrollo': '#10b981'
        };
        
        const CHART_COLORS = [
            '#3b82f6', // blue
            '#10b981', // emerald
            '#f59e0b', // amber
            '#ef4444', // red
            '#8b5cf6', // purple
            '#ec4899', // pink
            '#06b6d4', // cyan
            '#84cc16', // lime
            '#f97316', // orange
            '#6366f1'  // indigo
        ];
        
        // ============================================
        // DATOS INICIALES DE EJEMPLO
        // ============================================
        
        const initialNodes = [
            {
                id: '1',
                name: 'Dra. Elena Vance',
                title: 'Presidenta Ejecutiva',
                department: 'Dirección General',
                parentId: null,
                color: '#1e3a8a',
                salary: 25000,
                gender: 'Femenino',
                seniority: 15,
                isCritical: true,
                performance: 98,
                potential: 'Alto',
                successionId: '2'
            },
            {
                id: '2',
                name: 'Ing. Roberto Moss',
                title: 'VP Operaciones',
                department: 'Operaciones',
                parentId: '1',
                color: '#b45309',
                salary: 15400,
                gender: 'Masculino',
                seniority: 10,
                isCritical: true,
                successionId: '5',
                performance: 85,
                potential: 'Alto'
            },
            {
                id: '3',
                name: 'Lic. Martha Wayne',
                title: 'Directora Financiera',
                department: 'Finanzas',
                parentId: '1',
                color: '#15803d',
                salary: 16200,
                gender: 'Femenino',
                seniority: 12,
                isCritical: true,
                performance: 90,
                potential: 'Medio',
                successionId: '6'
            },
            {
                id: '4',
                name: 'Oscar Isaac',
                title: 'Director Comercial',
                department: 'Ventas',
                parentId: '1',
                color: '#be185d',
                salary: 14800,
                gender: 'Masculino',
                seniority: 8,
                performance: 70,
                potential: 'Alto',
                successionId: '7'
            },
            {
                id: '5',
                name: 'Samuel L. Jackson',
                title: 'Gerente Regional',
                department: 'Operaciones',
                parentId: '2',
                color: '#d97706',
                salary: 9500,
                gender: 'Masculino',
                seniority: 6,
                performance: 88,
                potential: 'Alto'
            },
            {
                id: '6',
                name: 'Natasha Romanoff',
                title: 'Gerente Tesorería',
                department: 'Finanzas',
                parentId: '3',
                color: '#166534',
                salary: 8900,
                gender: 'Femenino',
                seniority: 4,
                performance: 95,
                potential: 'Alto'
            },
            {
                id: '7',
                name: 'Wanda Maximoff',
                title: 'Gerente Marketing',
                department: 'Ventas',
                parentId: '4',
                color: '#9d174d',
                salary: 8200,
                gender: 'Femenino',
                seniority: 3,
                performance: 82,
                potential: 'Medio'
            },
            {
                id: '8',
                name: 'Peter Parker',
                title: 'Analista Sr',
                department: 'Finanzas',
                parentId: '6',
                color: '#166534',
                salary: 5500,
                gender: 'Masculino',
                seniority: 2,
                performance: 92,
                potential: 'Alto'
            },
            {
                id: '9',
                name: 'Gwen Stacy',
                title: 'Especialista Ventas',
                department: 'Ventas',
                parentId: '7',
                color: '#9d174d',
                salary: 4800,
                gender: 'Femenino',
                seniority: 1,
                performance: 85,
                potential: 'Alto'
            },
            {
                id: '10',
                name: 'Tony Stark',
                title: 'CTO',
                department: 'Tecnología',
                parentId: '1',
                color: '#06b6d4',
                salary: 18000,
                gender: 'Masculino',
                seniority: 14,
                isCritical: true,
                performance: 96,
                potential: 'Alto',
                successionId: '11'
            },
            {
                id: '11',
                name: 'Bruce Banner',
                title: 'Líder de Desarrollo',
                department: 'Tecnología',
                parentId: '10',
                color: '#06b6d4',
                salary: 12500,
                gender: 'Masculino',
                seniority: 8,
                performance: 89,
                potential: 'Medio'
            },
            {
                id: '12',
                name: 'Steve Rogers',
                title: 'Director de Recursos Humanos',
                department: 'Recursos Humanos',
                parentId: '1',
                color: '#6366f1',
                salary: 14500,
                gender: 'Masculino',
                seniority: 11,
                isCritical: false,
                performance: 87,
                potential: 'Medio'
            }
        ];
        
        // ============================================
        // NUEVOS COMPONENTES PARA HR ANALYTICS
        // ============================================
        
        // Componente para gestión de versiones
        const VersionManager = ({ nodes, onSaveVersion }) => {
            const [versions, setVersions] = React.useState(() => {
                const saved = localStorage.getItem('luxanalitica_versions');
                return saved ? JSON.parse(saved) : [];
            });
            
            const [versionName, setVersionName] = React.useState('');
            
            const handleSaveVersion = () => {
                const name = versionName || `Versión ${versions.length + 1} - ${new Date().toLocaleString()}`;
                const newVersion = {
                    id: `v${Date.now()}`,
                    name,
                    timestamp: new Date().toISOString(),
                    data: JSON.parse(JSON.stringify(nodes)),
                    stats: calculateVersionStats(nodes)
                };
                
                const updatedVersions = [newVersion, ...versions].slice(0, 3); // Guardar solo las últimas 3
                setVersions(updatedVersions);
                localStorage.setItem('luxanalitica_versions', JSON.stringify(updatedVersions));
                setVersionName('');
                onSaveVersion(updatedVersions);
                
                alert(`Versión "${name}" guardada correctamente.`);
            };
            
            const calculateVersionStats = (nodes) => {
                return {
                    totalNodes: nodes.length,
                    totalSalary: nodes.reduce((sum, n) => sum + (n.salary || 0), 0),
                    avgPerformance: Math.round(nodes.reduce((sum, n) => sum + (n.performance || 0), 0) / nodes.length),
                    criticalNodes: nodes.filter(n => n.isCritical).length,
                    criticalIssues: nodes.filter(n => n.isCritical && !n.successionId).length
                };
            };
            
            const handleDeleteVersion = (versionId) => {
                const updatedVersions = versions.filter(v => v.id !== versionId);
                setVersions(updatedVersions);
                localStorage.setItem('luxanalitica_versions', JSON.stringify(updatedVersions));
                onSaveVersion(updatedVersions);
            };
            
            return (
                <div className="space-y-4">
                    <div className="flex items-center gap-3">
                        <input
                            type="text"
                            value={versionName}
                            onChange={(e) => setVersionName(e.target.value)}
                            placeholder="Nombre de la versión (ej: 'Antes de reestructuración')"
                            className="flex-1 p-3 border border-slate-200 rounded-xl text-sm"
                        />
                        <button
                            onClick={handleSaveVersion}
                            disabled={versions.length >= 3}
                            className="px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-bold hover:from-blue-700 hover:to-blue-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                        >
                            <i className="fas fa-save"></i>
                            Guardar Versión
                        </button>
                    </div>
                    
                    {versions.length > 0 && (
                        <div className="space-y-3">
                            <h4 className="font-bold text-slate-700">Versiones Guardadas:</h4>
                            {versions.map(version => (
                                <div key={version.id} className="bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center">
                                    <div>
                                        <div className="font-bold text-slate-800">{version.name}</div>
                                        <div className="text-xs text-slate-500">
                                            {new Date(version.timestamp).toLocaleString()} • 
                                            {version.stats.totalNodes} colaboradores • 
                                            ${version.stats.totalSalary.toLocaleString()}
                                        </div>
                                    </div>
                                    <button
                                        onClick={() => handleDeleteVersion(version.id)}
                                        className="text-red-500 hover:text-red-700 p-2"
                                    >
                                        <i className="fas fa-trash"></i>
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {versions.length >= 3 && (
                        <div className="bg-amber-50 border border-amber-200 p-3 rounded-xl text-amber-700 text-sm">
                            <i className="fas fa-exclamation-triangle mr-2"></i>
                            Límite alcanzado (3 versiones máx.). Elimina una versión para guardar una nueva.
                        </div>
                    )}
                </div>
            );
        };
        
        // Componente para comparación de versiones
        const VersionComparison = ({ versions }) => {
            const [selectedVersions, setSelectedVersions] = React.useState([]);
            
            if (versions.length < 2) {
                return (
                    <div className="bg-slate-50 p-6 rounded-xl text-center text-slate-500">
                        <i className="fas fa-exchange-alt text-3xl mb-3 opacity-30"></i>
                        <p>Necesitas al menos 2 versiones para comparar</p>
                    </div>
                );
            }
            
            const handleCompare = (versionIds) => {
                setSelectedVersions(versionIds);
            };
            
            const getComparisonData = () => {
                if (selectedVersions.length !== 2) return null;
                
                const [v1, v2] = selectedVersions.map(id => 
                    versions.find(v => v.id === id)
                );
                
                if (!v1 || !v2) return null;
                
                const changes = {
                    nodesAdded: v2.data.length - v1.data.length,
                    salaryChange: v2.stats.totalSalary - v1.stats.totalSalary,
                    performanceChange: v2.stats.avgPerformance - v1.stats.avgPerformance,
                    riskChange: v2.stats.criticalIssues - v1.stats.criticalIssues
                };
                
                return { v1, v2, changes };
            };
            
            const comparison = getComparisonData();
            
            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-2 gap-4">
                        {versions.map(version => (
                            <div key={version.id} className="bg-white p-4 rounded-xl border border-slate-200">
                                <div className="flex items-center gap-3 mb-3">
                                    <input
                                        type="checkbox"
                                        checked={selectedVersions.includes(version.id)}
                                        onChange={(e) => {
                                            if (e.target.checked) {
                                                if (selectedVersions.length < 2) {
                                                    setSelectedVersions([...selectedVersions, version.id]);
                                                }
                                            } else {
                                                setSelectedVersions(selectedVersions.filter(id => id !== version.id));
                                            }
                                        }}
                                        className="custom-checkbox"
                                    />
                                    <div className="flex-1">
                                        <div className="font-bold text-slate-800">{version.name}</div>
                                        <div className="text-xs text-slate-500">
                                            {new Date(version.timestamp).toLocaleDateString()}
                                        </div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2 text-xs">
                                    <div className="text-center p-2 bg-slate-50 rounded">
                                        <div className="font-bold text-slate-800">{version.stats.totalNodes}</div>
                                        <div className="text-slate-500">Colaboradores</div>
                                    </div>
                                    <div className="text-center p-2 bg-slate-50 rounded">
                                        <div className="font-bold text-slate-800">${(version.stats.totalSalary/1000).toFixed(0)}k</div>
                                        <div className="text-slate-500">Masa Salarial</div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {comparison && (
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-xl border border-blue-200">
                            <h4 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <i className="fas fa-chart-bar text-blue-600"></i>
                                Análisis Comparativo
                            </h4>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div className="text-center p-4 bg-white rounded-xl">
                                    <div className={`text-xl font-bold ${comparison.changes.nodesAdded >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                        {comparison.changes.nodesAdded >= 0 ? '+' : ''}{comparison.changes.nodesAdded}
                                    </div>
                                    <div className="text-sm text-slate-600">Cambio en Plantilla</div>
                                </div>
                                <div className="text-center p-4 bg-white rounded-xl">
                                    <div className={`text-xl font-bold ${comparison.changes.salaryChange <= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                        {comparison.changes.salaryChange >= 0 ? '+' : ''}${(comparison.changes.salaryChange/1000).toFixed(1)}k
                                    </div>
                                    <div className="text-sm text-slate-600">Cambio en Costos</div>
                                </div>
                                <div className="text-center p-4 bg-white rounded-xl">
                                    <div className={`text-xl font-bold ${comparison.changes.performanceChange >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                        {comparison.changes.performanceChange >= 0 ? '+' : ''}{comparison.changes.performanceChange}%
                                    </div>
                                    <div className="text-sm text-slate-600">Cambio en Rendimiento</div>
                                </div>
                                <div className="text-center p-4 bg-white rounded-xl">
                                    <div className={`text-xl font-bold ${comparison.changes.riskChange <= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                        {comparison.changes.riskChange >= 0 ? '+' : ''}{comparison.changes.riskChange}
                                    </div>
                                    <div className="text-sm text-slate-600">Cambio en Riesgo</div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // Componente para análisis de carga de subordinados
        const SubordinateAnalysis = ({ nodes }) => {
            const analysis = React.useMemo(() => {
                if (!nodes.length) return null;
                
                // Calcular carga de subordinados por cada colaborador
                const subordinateCount = {};
                nodes.forEach(node => {
                    if (node.parentId) {
                        subordinateCount[node.parentId] = (subordinateCount[node.parentId] || 0) + 1;
                    }
                });
                
                // Encontrar jefes sobrecargados (> 5 reportes directos)
                const overloadedManagers = nodes.filter(node => 
                    (subordinateCount[node.id] || 0) > 5 && 
                    node.title.includes('Gerente') || 
                    node.title.includes('Director') ||
                    node.title.includes('Supervisor')
                ).map(node => ({
                    ...node,
                    subordinateCount: subordinateCount[node.id] || 0
                }));
                
                // Encontrar jefes con poca carga (< 2 reportes)
                const underloadedManagers = nodes.filter(node => 
                    (subordinateCount[node.id] || 0) < 2 && 
                    node.title.includes('Gerente') || 
                    node.title.includes('Director')
                ).map(node => ({
                    ...node,
                    subordinateCount: subordinateCount[node.id] || 0
                }));
                
                // Distribución de carga
                const loadDistribution = {
                    '0-2': nodes.filter(n => (subordinateCount[n.id] || 0) <= 2).length,
                    '3-5': nodes.filter(n => (subordinateCount[n.id] || 0) >= 3 && (subordinateCount[n.id] || 0) <= 5).length,
                    '6-10': nodes.filter(n => (subordinateCount[n.id] || 0) >= 6 && (subordinateCount[n.id] || 0) <= 10).length,
                    '10+': nodes.filter(n => (subordinateCount[n.id] || 0) > 10).length
                };
                
                return {
                    overloadedManagers,
                    underloadedManagers,
                    loadDistribution,
                    avgSubordinates: Object.values(subordinateCount).length > 0 
                        ? (Object.values(subordinateCount).reduce((a, b) => a + b, 0) / Object.values(subordinateCount).length).toFixed(1)
                        : 0,
                    maxSubordinates: Math.max(...Object.values(subordinateCount).concat([0]))
                };
            }, [nodes]);
            
            if (!analysis) return null;
            
            return (
                <div className="space-y-6">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="bg-white p-4 rounded-xl border border-slate-200">
                            <div className="text-2xl font-bold text-slate-800">{analysis.avgSubordinates}</div>
                            <div className="text-sm text-slate-600">Promedio de Subordinados</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl border border-slate-200">
                            <div className="text-2xl font-bold text-slate-800">{analysis.maxSubordinates}</div>
                            <div className="text-sm text-slate-600">Máximo de Subordinados</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl border border-slate-200">
                            <div className="text-2xl font-bold text-slate-800">{analysis.overloadedManagers.length}</div>
                            <div className="text-sm text-slate-600">Jefes Sobrecargados</div>
                        </div>
                        <div className="bg-white p-4 rounded-xl border border-slate-200">
                            <div className="text-2xl font-bold text-slate-800">{analysis.underloadedManagers.length}</div>
                            <div className="text-sm text-slate-600">Jefes con Poca Carga</div>
                        </div>
                    </div>
                    
                    {analysis.overloadedManagers.length > 0 && (
                        <div className="bg-gradient-to-r from-red-50 to-orange-50 p-4 rounded-xl border border-red-200">
                            <h5 className="font-bold text-red-800 mb-3 flex items-center gap-2">
                                <i className="fas fa-exclamation-triangle"></i>
                                Alertas: Jefes Sobrecargados (> 5 reportes directos)
                            </h5>
                            <div className="space-y-2">
                                {analysis.overloadedManagers.slice(0, 3).map(manager => (
                                    <div key={manager.id} className="flex justify-between items-center p-3 bg-white rounded-lg">
                                        <div>
                                            <div className="font-bold text-slate-800">{manager.name}</div>
                                            <div className="text-sm text-slate-600">{manager.title} • {manager.department}</div>
                                        </div>
                                        <div className="text-red-600 font-bold">
                                            {manager.subordinateCount} subordinados
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // Componente para recomendaciones de IA
        const AIRecommendations = ({ nodes, versions }) => {
            const generateRecommendations = () => {
                if (!nodes.length) return [];
                
                const recommendations = [];
                
                // 1. Análisis salarial
                const avgSalaryByDept = {};
                nodes.forEach(node => {
                    if (!avgSalaryByDept[node.department]) {
                        avgSalaryByDept[node.department] = { total: 0, count: 0 };
                    }
                    avgSalaryByDept[node.department].total += node.salary || 0;
                    avgSalaryByDept[node.department].count += 1;
                });
                
                Object.entries(avgSalaryByDept).forEach(([dept, data]) => {
                    const avg = data.total / data.count;
                    nodes.filter(n => n.department === dept && n.salary < avg * 0.7).forEach(node => {
                        recommendations.push({
                            type: 'salario',
                            priority: 'media',
                            title: 'Salario por debajo del promedio del departamento',
                            description: `${node.name} (${node.title}) tiene un salario $${node.salary.toLocaleString()} que está ${Math.round((1 - node.salary/avg)*100)}% por debajo del promedio de ${dept} ($${Math.round(avg).toLocaleString()})`,
                            action: 'Considerar ajuste salarial basado en equidad interna'
                        });
                    });
                });
                
                // 2. Análisis de rendimiento vs salario
                nodes.filter(n => n.performance < 70 && n.salary > 10000).forEach(node => {
                    recommendations.push({
                        type: 'rendimiento',
                        priority: 'alta',
                        title: 'Bajo rendimiento con alto salario',
                        description: `${node.name} tiene rendimiento del ${node.performance}% con salario de $${node.salary.toLocaleString()}`,
                        action: 'Evaluar plan de mejora o reasignación'
                    });
                });
                
                // 3. Posiciones críticas sin sucesor
                nodes.filter(n => n.isCritical && !n.successionId).forEach(node => {
                    recommendations.push({
                        type: 'sucesion',
                        priority: 'critica',
                        title: 'Posición crítica sin sucesor identificado',
                        description: `${node.name} (${node.title}) es crítico para ${node.department} y no tiene sucesor asignado`,
                        action: 'Identificar y desarrollar sucesor inmediatamente'
                    });
                });
                
                // 4. High performers con bajo salario
                nodes.filter(n => n.performance >= 85 && n.salary < 5000 && n.potential === 'Alto').forEach(node => {
                    recommendations.push({
                        type: 'retencion',
                        priority: 'alta',
                        title: 'Alto potencial en riesgo de fuga',
                        description: `${node.name} tiene rendimiento del ${node.performance}% y potencial Alto, pero salario bajo ($${node.salary.toLocaleString()})`,
                        action: 'Considerar aumento para retención'
                    });
                });
                
                return recommendations.slice(0, 6); // Limitar a 6 recomendaciones
            };
            
            const recommendations = generateRecommendations();
            
            if (recommendations.length === 0) {
                return (
                    <div className="bg-gradient-to-r from-emerald-50 to-green-50 p-6 rounded-xl border border-emerald-200 text-center">
                        <i className="fas fa-check-circle text-emerald-500 text-3xl mb-3"></i>
                        <p className="font-bold text-emerald-700">Estructura óptima detectada</p>
                        <p className="text-sm text-emerald-600 mt-1">No se encontraron áreas críticas que requieran atención inmediata</p>
                    </div>
                );
            }
            
            const getPriorityColor = (priority) => {
                switch(priority) {
                    case 'critica': return 'bg-gradient-to-r from-red-600 to-red-700';
                    case 'alta': return 'bg-gradient-to-r from-orange-600 to-amber-600';
                    case 'media': return 'bg-gradient-to-r from-blue-600 to-blue-700';
                    default: return 'bg-gradient-to-r from-slate-600 to-slate-700';
                }
            };
            
            return (
                <div className="space-y-4">
                    <div className="flex justify-between items-center">
                        <h4 className="font-bold text-slate-800 text-lg flex items-center gap-2">
                            <i className="fas fa-robot text-purple-600"></i>
                            Recomendaciones de IA
                        </h4>
                        <span className="text-xs font-bold bg-purple-100 text-purple-700 px-3 py-1 rounded-full">
                            {recommendations.length} acciones sugeridas
                        </span>
                    </div>
                    
                    <div className="space-y-3">
                        {recommendations.map((rec, index) => (
                            <div key={index} className="bg-white p-4 rounded-xl border border-slate-200">
                                <div className="flex items-start gap-3">
                                    <div className={`w-8 h-8 ${getPriorityColor(rec.priority)} rounded-lg flex items-center justify-center text-white text-sm`}>
                                        {rec.priority === 'critica' ? '!' : rec.priority === 'alta' ? '↑' : '•'}
                                    </div>
                                    <div className="flex-1">
                                        <div className="font-bold text-slate-800">{rec.title}</div>
                                        <div className="text-sm text-slate-600 mt-1">{rec.description}</div>
                                        <div className="mt-2 p-2 bg-slate-50 rounded text-sm">
                                            <span className="font-bold text-slate-700">Acción recomendada:</span> {rec.action}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {versions.length >= 2 && (
                        <div className="mt-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200">
                            <h5 className="font-bold text-slate-800 mb-2 flex items-center gap-2">
                                <i className="fas fa-bolt text-amber-500"></i>
                                Recomendación Basada en Comparación de Versiones
                            </h5>
                            <p className="text-sm text-slate-600">
                                Basado en el análisis de {versions.length} versiones, la estructura más eficiente es la <strong>Versión {versions[0].name}</strong> con mejor relación costo-rendimiento.
                            </p>
                        </div>
                    )}
                </div>
            );
        };
        
        // ============================================
        // COMPONENTES REUTILIZABLES
        // ============================================
        
        const KPIBox = ({ icon, color, label, value, sub }) => {
            const colorMap = {
                blue: 'bg-gradient-to-br from-blue-500 to-blue-600',
                emerald: 'bg-gradient-to-br from-emerald-500 to-emerald-600',
                indigo: 'bg-gradient-to-br from-indigo-500 to-indigo-600',
                red: 'bg-gradient-to-br from-red-500 to-red-600',
                amber: 'bg-gradient-to-br from-amber-500 to-amber-600',
                purple: 'bg-gradient-to-br from-purple-500 to-purple-600',
                pink: 'bg-gradient-to-br from-pink-500 to-pink-600',
                cyan: 'bg-gradient-to-br from-cyan-500 to-cyan-600'
            };
            
            return (
                <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex items-center gap-5 group hover:border-slate-300 transition-all duration-300 animate-in">
                    <div className={`w-14 h-14 rounded-2xl ${colorMap[color] || colorMap.blue} flex items-center justify-center text-white text-xl shadow-lg group-hover:scale-110 transition-transform duration-300`}>
                        <i className={`fas ${icon}`}></i>
                    </div>
                    <div>
                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1">{label}</p>
                        <p className="text-2xl font-black text-slate-900 leading-tight">{value}</p>
                        <p className="text-[9px] font-medium text-slate-500 mt-0.5">{sub}</p>
                    </div>
                </div>
            );
        };
        
        const RiskMiniItem = ({ label, value, total, color }) => {
            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
            const barColors = {
                red: 'bg-gradient-to-r from-red-500 to-red-600',
                emerald: 'bg-gradient-to-r from-emerald-500 to-emerald-600',
                blue: 'bg-gradient-to-r from-blue-500 to-blue-600',
                amber: 'bg-gradient-to-r from-amber-500 to-amber-600'
            };
            
            return (
                <div className="space-y-1">
                    <div className="flex justify-between text-[10px] font-black uppercase tracking-tight">
                        <span className="text-slate-400">{label}</span>
                        <span className="text-white">{value} / {total}</span>
                    </div>
                    <div className="w-full h-1.5 bg-white/10 rounded-full overflow-hidden">
                        <div 
                            className={`h-full ${barColors[color] || barColors.blue} transition-all duration-1000`}
                            style={{ width: `${percentage}%` }}
                        ></div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // COMPONENTE DE CARGA (UploadTab)
        // ============================================
        
        const UploadTab = ({ onImport }) => {
            const [loading, setLoading] = React.useState(false);
            const [dragOver, setDragOver] = React.useState(false);
            
            const loadSimulator = () => {
                setLoading(true);
                setTimeout(() => {
                    onImport(initialNodes);
                    setLoading(false);
                }, 1200);
            };
            
            const handleFileUpload = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                
                // Validar tipo de archivo
                const validTypes = [
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'application/vnd.ms-excel',
                    'text/csv'
                ];
                
                if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
                    alert('Por favor, sube un archivo Excel (.xlsx, .xls) o CSV.');
                    return;
                }
                
                setLoading(true);
                const reader = new FileReader();
                
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        let data = [];
                        
                        if (file.name.match(/\.csv$/i)) {
                            // Procesar CSV
                            const workbook = XLSX.read(bstr, { type: 'binary', raw: true });
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(sheet);
                        } else {
                            // Procesar Excel
                            const workbook = XLSX.read(bstr, { type: 'binary' });
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(sheet);
                        }
                        
                        if (data.length === 0) {
                            throw new Error('El archivo está vacío o no tiene datos válidos.');
                        }
                        
                        // Mapear columnas - sistema flexible de mapeo
                        const mapped = data.map((row, index) => {
                            // Buscar columnas por diferentes nombres posibles
                            const findColumn = (possibleNames) => {
                                for (const name of possibleNames) {
                                    if (row[name] !== undefined) return row[name];
                                }
                                return null;
                            };
                            
                            return {
                                id: String(findColumn(['id', 'ID', 'identificador', 'Id']) || `EMP-${1000 + index}`),
                                name: findColumn(['nombre', 'name', 'Nombre', 'NOMBRE', 'colaborador', 'Colaborador']) || 'Sin Nombre',
                                title: findColumn(['cargo', 'title', 'Cargo', 'CARGO', 'puesto', 'Puesto', 'posición', 'Posición']) || 'Colaborador',
                                department: findColumn(['departamento', 'department', 'Departamento', 'DEPARTAMENTO', 'área', 'Área', 'area', 'Area']) || DEPARTMENTS[0],
                                parentId: findColumn(['jefe', 'parentId', 'Jefe', 'JEFF', 'reporta_a', 'supervisor', 'Supervisor']) || null,
                                salary: Number(findColumn(['salario', 'salary', 'Salario', 'SALARIO', 'sueldo', 'Sueldo']) || 0),
                                performance: Number(findColumn(['desempeño', 'performance', 'Desempeño', 'rendimiento', 'Rendimiento']) || 80),
                                potential: (findColumn(['potencial', 'potential', 'Potencial']) || 'Medio'),
                                gender: (findColumn(['género', 'gender', 'Género', 'sexo', 'Sexo']) || 'Otro'),
                                seniority: Number(findColumn(['antigüedad', 'seniority', 'Antigüedad', 'experiencia', 'Experiencia']) || 0),
                                isCritical: Boolean(findColumn(['crítico', 'critical', 'Crítico', 'es_critico', 'importante'])),
                                color: COLORS_DEPT[findColumn(['departamento', 'department']) || DEPARTMENTS[0]] || '#3b82f6',
                                successionId: findColumn(['sucesor', 'successionId', 'Sucesor', 'reemplazo']) || null
                            };
                        });
                        
                        // Validar que todos los parentId existan
                        const ids = new Set(mapped.map(n => n.id));
                        const validated = mapped.map(node => ({
                            ...node,
                            parentId: node.parentId && ids.has(node.parentId.toString()) ? node.parentId.toString() : null,
                            successionId: node.successionId && ids.has(node.successionId.toString()) ? node.successionId.toString() : null
                        }));
                        
                        onImport(validated);
                    } catch (err) {
                        console.error('Error procesando archivo:', err);
                        alert(`Error procesando el archivo: ${err.message}\n\nAsegúrate de que el archivo tenga el formato correcto.`);
                    } finally {
                        setLoading(false);
                    }
                };
                
                reader.onerror = () => {
                    alert('Error al leer el archivo. Intenta nuevamente.');
                    setLoading(false);
                };
                
                if (file.name.match(/\.csv$/i)) {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.readAsBinaryString(file);
                }
            };
            
            const handleDragOver = (e) => {
                e.preventDefault();
                setDragOver(true);
            };
            
            const handleDragLeave = (e) => {
                e.preventDefault();
                setDragOver(false);
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    const input = document.createElement('input');
                    input.type = 'file';
                    
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    input.files = dataTransfer.files;
                    
                    handleFileUpload({ target: { files: dataTransfer.files } });
                }
            };
            
            const downloadTemplate = () => {
                const template = [
                    {
                        id: 'CEO001',
                        nombre: 'CEO Empresa',
                        cargo: 'Director General',
                        departamento: 'Dirección General',
                        jefe: null,
                        salario: 20000,
                        desempeño: 95,
                        potencial: 'Alto',
                        género: 'Masculino',
                        antigüedad: 10,
                        crítico: true,
                        sucesor: 'VP001'
                    },
                    {
                        id: 'VP001',
                        nombre: 'Vicepresidente',
                        cargo: 'VP Operaciones',
                        departamento: 'Operaciones',
                        jefe: 'CEO001',
                        salario: 15000,
                        desempeño: 88,
                        potencial: 'Alto',
                        género: 'Femenino',
                        antigüedad: 8,
                        crítico: true
                    },
                    {
                        id: 'MGR001',
                        nombre: 'Gerente Área',
                        cargo: 'Gerente Finanzas',
                        departamento: 'Finanzas',
                        jefe: 'CEO001',
                        salario: 12000,
                        desempeño: 92,
                        potencial: 'Medio',
                        género: 'Masculino',
                        antigüedad: 6
                    }
                ];
                
                const ws = XLSX.utils.json_to_sheet(template);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Plantilla");
                
                // Ajustar anchos de columnas
                const wscols = [
                    {wch: 10}, // ID
                    {wch: 25}, // Nombre
                    {wch: 25}, // Cargo
                    {wch: 20}, // Departamento
                    {wch: 10}, // Jefe
                    {wch: 12}, // Salario
                    {wch: 12}, // Desempeño
                    {wch: 12}, // Potencial
                    {wch: 15}, // Género
                    {wch: 12}, // Antigüedad
                    {wch: 10}, // Crítico
                    {wch: 10}  // Sucesor
                ];
                ws['!cols'] = wscols;
                
                XLSX.writeFile(wb, "Plantilla_Luxanalitica.xlsx");
            };
            
            return (
                <div className="p-6 md:p-12 h-full flex flex-col items-center justify-center bg-gradient-to-br from-slate-50 to-blue-50/30 overflow-y-auto scrollbar-hide">
                    <div className="max-w-6xl w-full text-center space-y-12 animate-in zoom-in duration-700">
                        {/* Encabezado */}
                        <div className="space-y-6">
                            <div className="relative inline-block">
                                <div className="w-28 h-28 bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 text-white rounded-[3rem] flex items-center justify-center text-5xl mx-auto shadow-2xl mb-6 gradient-animate">
                                    <i className="fas fa-brain"></i>
                                </div>
                                <div className="absolute -top-2 -right-2 w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-full flex items-center justify-center text-white text-sm font-black shadow-lg">
                                    AI
                                </div>
                            </div>
                            
                            <div className="space-y-4">
                                <h1 className="text-5xl md:text-6xl font-black text-slate-900 tracking-tighter">
                                    <span className="text-gradient">Luxanalitica</span> HR 360°
                                </h1>
                                <p className="text-slate-600 text-lg md:text-xl max-w-3xl mx-auto leading-relaxed">
                                    Analiza <span className="text-blue-600 font-bold">Costos</span>, 
                                    <span className="text-emerald-600 font-bold"> Rendimiento</span> y 
                                    <span className="text-red-600 font-bold"> Sucesión</span> en tiempo real con IA predictiva.
                                </p>
                            </div>
                        </div>
                        
                        {/* Opciones de carga */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-5xl mx-auto">
                            {/* Simulador */}
                            <button
                                onClick={loadSimulator}
                                disabled={loading}
                                className={`group bg-white border-2 ${dragOver ? 'border-blue-500' : 'border-slate-100'} p-8 rounded-[2.5rem] font-black text-slate-800 hover:border-blue-600 hover:bg-gradient-to-br hover:from-blue-50/50 hover:to-white transition-all duration-300 card-shadow card-shadow-hover flex flex-col items-center gap-6 h-full disabled:opacity-50 disabled:cursor-not-allowed`}
                            >
                                <div className="relative">
                                    <i className={`fas ${loading ? 'fa-sync fa-spin' : 'fa-magic'} text-5xl text-blue-600 group-hover:scale-110 transition-transform duration-300`}></i>
                                    {!loading && (
                                        <div className="absolute -bottom-2 -right-2 w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center text-white text-xs">
                                            <i className="fas fa-bolt"></i>
                                        </div>
                                    )}
                                </div>
                                
                                <div className="space-y-3">
                                    <p className="text-2xl">
                                        {loading ? 'Generando demo...' : 'Simular Demo 360°'}
                                    </p>
                                    <p className="text-sm text-slate-500 font-bold uppercase tracking-widest">
                                        Carga jerarquía compleja con KPIs vivos e IA
                                    </p>
                                </div>
                                
                                {!loading && (
                                    <div className="mt-4 flex items-center gap-3 text-sm text-slate-500">
                                        <i className="fas fa-users"></i>
                                        <span>{initialNodes.length} colaboradores de ejemplo</span>
                                    </div>
                                )}
                            </button>
                            
                            {/* Carga de archivo */}
                            <div
                                className={`relative ${dragOver ? 'border-blue-500' : 'border-transparent'} border-2 rounded-[2.5rem] transition-all duration-300`}
                                onDragOver={handleDragOver}
                                onDragLeave={handleDragLeave}
                                onDrop={handleDrop}
                            >
                                <label className={`group ${loading ? 'bg-slate-700' : 'bg-gradient-to-br from-slate-900 to-gray-900'} text-white p-8 rounded-[2.5rem] font-black hover:from-slate-800 hover:to-gray-800 transition-all duration-300 cursor-pointer card-shadow card-shadow-hover flex flex-col items-center gap-6 h-full block`}>
                                    <input
                                        type="file"
                                        accept=".xlsx,.xls,.csv"
                                        className="hidden"
                                        onChange={handleFileUpload}
                                        disabled={loading}
                                    />
                                    
                                    <div className="relative">
                                        <i className={`fas ${loading ? 'fa-sync fa-spin' : 'fa-file-excel'} text-5xl text-emerald-400`}></i>
                                        {!loading && (
                                            <div className="absolute -bottom-2 -right-2 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs">
                                                <i className="fas fa-cloud-upload-alt"></i>
                                            </div>
                                        )}
                                    </div>
                                    
                                    <div className="space-y-3">
                                        <p className="text-2xl">
                                            {loading ? 'Analizando archivo...' : 'Subir Mi Estructura'}
                                        </p>
                                        <p className="text-sm text-slate-300 font-bold uppercase tracking-widest">
                                            Detecta salarios, rendimiento y riesgo automáticamente
                                        </p>
                                    </div>
                                    
                                    {!loading && (
                                        <div className="mt-4 flex items-center gap-3 text-sm text-slate-300">
                                            <i className="fas fa-info-circle"></i>
                                            <span>Arrastra y suelta o haz clic para seleccionar</span>
                                        </div>
                                    )}
                                    
                                    {dragOver && (
                                        <div className="absolute inset-0 bg-blue-500/10 rounded-[2.5rem] border-2 border-dashed border-blue-500 flex items-center justify-center">
                                            <div className="text-center">
                                                <i className="fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2"></i>
                                                <p className="text-blue-500 font-bold">Suelta el archivo aquí</p>
                                            </div>
                                        </div>
                                    )}
                                </label>
                            </div>
                        </div>
                        
                        {/* Información adicional */}
                        <div className="pt-8 border-t border-slate-200 max-w-4xl mx-auto">
                            <div className="flex flex-col md:flex-row items-center justify-between gap-6">
                                <div className="text-left">
                                    <h3 className="font-black text-slate-800 text-lg mb-2 flex items-center gap-2">
                                        <i className="fas fa-lightbulb text-amber-500"></i>
                                        ¿Primera vez usando la plataforma?
                                    </h3>
                                    <p className="text-slate-600 text-sm">
                                        Recomendamos comenzar con la demo para familiarizarte con las funcionalidades.
                                    </p>
                                </div>
                                
                                <button
                                    onClick={downloadTemplate}
                                    className="px-6 py-3 bg-gradient-to-r from-emerald-500 to-green-600 text-white rounded-2xl font-bold hover:from-emerald-600 hover:to-green-700 transition-all shadow-lg shadow-emerald-500/20 flex items-center gap-2 whitespace-nowrap"
                                >
                                    <i className="fas fa-download"></i>
                                    Descargar Plantilla Excel
                                </button>
                            </div>
                            
                            <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div className="bg-gradient-to-br from-blue-50 to-blue-100/50 p-4 rounded-2xl border border-blue-200">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center text-white">
                                            <i className="fas fa-sitemap"></i>
                                        </div>
                                        <h4 className="font-bold text-slate-800">Estructura Completa</h4>
                                    </div>
                                    <p className="text-sm text-slate-600">
                                        Visualiza y edita la jerarquía organizacional en tiempo real.
                                    </p>
                                </div>
                                
                                <div className="bg-gradient-to-br from-emerald-50 to-emerald-100/50 p-4 rounded-2xl border border-emerald-200">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white">
                                            <i className="fas fa-chart-pie"></i>
                                        </div>
                                        <h4 className="font-bold text-slate-800">Análisis 360°</h4>
                                    </div>
                                    <p className="text-sm text-slate-600">
                                        KPIs de rendimiento, costos, diversidad y riesgos de sucesión.
                                    </p>
                                </div>
                                
                                <div className="bg-gradient-to-br from-purple-50 to-purple-100/50 p-4 rounded-2xl border border-purple-200">
                                    <div className="flex items-center gap-3 mb-2">
                                        <div className="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center text-white">
                                            <i className="fas fa-file-export"></i>
                                        </div>
                                        <h4 className="font-bold text-slate-800">Exportación Profesional</h4>
                                    </div>
                                    <p className="text-sm text-slate-600">
                                        Genera reportes en Excel, PDF y comparte la estructura.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // COMPONENTE DE EDICIÓN DE NODO (NodeForm)
        // ============================================
        
        const NodeForm = ({ selectedNode, nodes, onUpdate, onAdd, onDelete, onCancel }) => {
            const [formData, setFormData] = React.useState({
                id: '',
                name: '',
                title: '',
                department: DEPARTMENTS[0],
                parentId: null,
                color: '#3b82f6',
                isCritical: false,
                successionId: null,
                salary: 0,
                gender: 'Otro',
                seniority: 0,
                performance: 80,
                potential: 'Medio'
            });
            
            const [errors, setErrors] = React.useState({});
            
            React.useEffect(() => {
                if (selectedNode) {
                    setFormData({
                        ...selectedNode,
                        performance: selectedNode.performance ?? 80,
                        potential: selectedNode.potential ?? 'Medio',
                        salary: selectedNode.salary ?? 0,
                        seniority: selectedNode.seniority ?? 0,
                        gender: selectedNode.gender ?? 'Otro'
                    });
                    setErrors({});
                } else {
                    setFormData({
                        id: `NEW-${Math.floor(10000 + Math.random() * 90000)}`,
                        name: '',
                        title: '',
                        department: DEPARTMENTS[0],
                        parentId: null,
                        color: '#3b82f6',
                        isCritical: false,
                        successionId: null,
                        salary: 0,
                        gender: 'Otro',
                        seniority: 0,
                        performance: 80,
                        potential: 'Medio'
                    });
                    setErrors({});
                }
            }, [selectedNode]);
            
            const handleChange = (e) => {
                const { name, value, type } = e.target;
                let val = value;
                
                if (type === 'checkbox') {
                    val = e.target.checked;
                } else if (type === 'number') {
                    val = value === '' ? 0 : Number(value);
                    if (name === 'performance' && (val < 0 || val > 100)) {
                        setErrors(prev => ({ ...prev, [name]: 'El rendimiento debe estar entre 0 y 100' }));
                    } else if (name === 'salary' && val < 0) {
                        setErrors(prev => ({ ...prev, [name]: 'El salario no puede ser negativo' }));
                    } else if (name === 'seniority' && val < 0) {
                        setErrors(prev => ({ ...prev, [name]: 'La antigüedad no puede ser negativa' }));
                    } else {
                        setErrors(prev => ({ ...prev, [name]: null }));
                    }
                } else if (name === 'parentId' && value === 'null') {
                    val = null;
                } else if (name === 'successionId' && value === 'null') {
                    val = null;
                }
                
                setFormData(prev => ({
                    ...prev,
                    [name]: val
                }));
            };
            
            const validateForm = () => {
                const newErrors = {};
                
                if (!formData.name.trim()) {
                    newErrors.name = 'El nombre es obligatorio';
                }
                
                if (!formData.title.trim()) {
                    newErrors.title = 'El cargo es obligatorio';
                }
                
                if (formData.parentId === formData.id) {
                    newErrors.parentId = 'Un colaborador no puede reportarse a sí mismo';
                }
                
                if (formData.isCritical && formData.successionId === formData.id) {
                    newErrors.successionId = 'El sucesor no puede ser la misma persona';
                }
                
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };
            
            const handleSave = () => {
                if (!validateForm()) {
                    alert('Por favor, corrige los errores en el formulario.');
                    return;
                }
                
                selectedNode ? onUpdate(formData) : onAdd(formData);
            };
            
            const availableSuccessors = nodes.filter(n => 
                n.id !== formData.id && 
                !n.isCritical &&
                n.department === formData.department
            );
            
            const availableParents = nodes.filter(n => n.id !== formData.id);
            
            const getPerformanceColor = (value) => {
                if (value >= 85) return 'text-emerald-600 bg-emerald-50';
                if (value >= 70) return 'text-amber-600 bg-amber-50';
                return 'text-red-600 bg-red-50';
            };
            
            const getPerformanceIcon = (value) => {
                if (value >= 85) return 'fa-rocket text-emerald-500';
                if (value >= 70) return 'fa-chart-line text-amber-500';
                return 'fa-exclamation-triangle text-red-500';
            };
            
            const getPotentialColor = (value) => {
                switch(value) {
                    case 'Alto': return 'text-emerald-600 bg-emerald-50';
                    case 'Medio': return 'text-amber-600 bg-amber-50';
                    case 'Bajo': return 'text-red-600 bg-red-50';
                    default: return 'text-slate-600 bg-slate-50';
                }
            };
            
            return (
                <div className="space-y-6 animate-in slide-in-left duration-300 h-full overflow-y-auto scrollbar-hide p-2">
                    {/* Encabezado del formulario */}
                    <div className="bg-gradient-to-r from-slate-900 to-gray-900 text-white p-5 rounded-3xl card-shadow">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center">
                                    <i className={`fas ${selectedNode ? 'fa-user-edit' : 'fa-user-plus'} text-xl`}></i>
                                </div>
                                <div>
                                    <h3 className="font-black text-lg">
                                        {selectedNode ? 'Editar Colaborador' : 'Nuevo Colaborador'}
                                    </h3>
                                    <p className="text-slate-300 text-sm">
                                        {selectedNode ? 'Actualiza la información del colaborador' : 'Agrega un nuevo miembro al equipo'}
                                    </p>
                                </div>
                            </div>
                            <div className="text-right">
                                <p className="text-[10px] font-black text-slate-400 uppercase">ID</p>
                                <p className="font-mono text-sm">{formData.id}</p>
                            </div>
                        </div>
                    </div>
                    
                    {/* Información básica */}
                    <div className="bg-white p-5 rounded-3xl border border-slate-200 card-shadow space-y-5">
                        <h4 className="font-black text-slate-800 text-sm uppercase tracking-widest flex items-center gap-2">
                            <i className="fas fa-id-card text-blue-600"></i>
                            Información Básica
                        </h4>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                    Nombre Completo *
                                </label>
                                <input
                                    name="name"
                                    value={formData.name}
                                    onChange={handleChange}
                                    className={`w-full p-3 border ${errors.name ? 'border-red-300' : 'border-slate-200'} rounded-xl text-sm focus:ring-2 focus:ring-blue-500/20 outline-none transition-all`}
                                    placeholder="Ej: Juan Perez López"
                                />
                                {errors.name && (
                                    <p className="text-red-500 text-xs mt-1 flex items-center gap-1">
                                        <i className="fas fa-exclamation-circle"></i>
                                        {errors.name}
                                    </p>
                                )}
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Cargo / Puesto *
                                    </label>
                                    <input
                                        name="title"
                                        value={formData.title}
                                        onChange={handleChange}
                                        className={`w-full p-3 border ${errors.title ? 'border-red-300' : 'border-slate-200'} rounded-xl text-sm outline-none`}
                                        placeholder="Ej: Director de Finanzas"
                                    />
                                    {errors.title && (
                                        <p className="text-red-500 text-xs mt-1">{errors.title}</p>
                                    )}
                                </div>
                                
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Departamento
                                    </label>
                                    <select
                                        name="department"
                                        value={formData.department}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 custom-select"
                                    >
                                        {DEPARTMENTS.map(dept => (
                                            <option key={dept} value={dept}>
                                                {dept}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Género
                                    </label>
                                    <select
                                        name="gender"
                                        value={formData.gender}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm custom-select"
                                    >
                                        {GENDER_OPTIONS.map(gender => (
                                            <option key={gender} value={gender}>
                                                {gender}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Color Identificación
                                    </label>
                                    <select
                                        name="color"
                                        value={formData.color}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm custom-select"
                                    >
                                        <option value="#3b82f6">🔵 Azul (Estándar)</option>
                                        <option value="#10b981">🟢 Verde (Finanzas)</option>
                                        <option value="#f59e0b">🟡 Ámbar (Operaciones)</option>
                                        <option value="#ef4444">🔴 Rojo (Crítico)</option>
                                        <option value="#8b5cf6">🟣 Púrpura (Tecnología)</option>
                                        <option value="#06b6d4">🔷 Cian (Marketing)</option>
                                        <option value="#6366f1">🌀 Índigo (Recursos Humanos)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Métricas de Talento */}
                    <div className="bg-white p-5 rounded-3xl border border-slate-200 card-shadow space-y-5">
                        <h4 className="font-black text-slate-800 text-sm uppercase tracking-widest flex items-center gap-2">
                            <i className="fas fa-chart-line text-emerald-600"></i>
                            Métricas de Talento
                        </h4>
                        
                        <div className="space-y-4">
                            <div>
                                <div className="flex justify-between items-center mb-2">
                                    <label className="block text-[10px] font-black text-slate-400 uppercase tracking-widest">
                                        Rendimiento
                                    </label>
                                    <div className={`px-3 py-1 rounded-full text-xs font-bold ${getPerformanceColor(formData.performance)}`}>
                                        <i className={`fas ${getPerformanceIcon(formData.performance)} mr-1`}></i>
                                        {formData.performance}%
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-4">
                                    <input
                                        type="range"
                                        name="performance"
                                        value={formData.performance}
                                        onChange={handleChange}
                                        min="0"
                                        max="100"
                                        className="flex-1"
                                    />
                                    <input
                                        type="number"
                                        name="performance"
                                        value={formData.performance}
                                        onChange={handleChange}
                                        min="0"
                                        max="100"
                                        className="w-20 p-2 border border-slate-200 rounded-lg text-center text-sm"
                                    />
                                </div>
                                
                                <div className="flex justify-between text-xs text-slate-500 mt-2">
                                    <span>Bajo</span>
                                    <span>Promedio</span>
                                    <span>Alto</span>
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Potencial
                                    </label>
                                    <select
                                        name="potential"
                                        value={formData.potential}
                                        onChange={handleChange}
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm custom-select"
                                    >
                                        {POTENTIAL_LEVELS.map(level => (
                                            <option key={level} value={level}>
                                                {level === 'Alto' && '🟢 '}
                                                {level === 'Medio' && '🟡 '}
                                                {level === 'Bajo' && '🔴 '}
                                                {level}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                        Antigüedad (Años)
                                    </label>
                                    <input
                                        type="number"
                                        name="seniority"
                                        value={formData.seniority}
                                        onChange={handleChange}
                                        min="0"
                                        max="50"
                                        className="w-full p-3 border border-slate-200 rounded-xl text-sm"
                                    />
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                    Salario Mensual ($)
                                </label>
                                <div className="relative">
                                    <span className="absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-500">$</span>
                                    <input
                                        type="number"
                                        name="salary"
                                        value={formData.salary}
                                        onChange={handleChange}
                                        min="0"
                                        step="100"
                                        className="w-full p-3 pl-8 border border-slate-200 rounded-xl text-sm"
                                    />
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Jerarquía y Reportes */}
                    <div className="bg-white p-5 rounded-3xl border border-slate-200 card-shadow space-y-5">
                        <h4 className="font-black text-slate-800 text-sm uppercase tracking-widest flex items-center gap-2">
                            <i className="fas fa-sitemap text-blue-600"></i>
                            Jerarquía y Reportes
                        </h4>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest">
                                    Jefe Directo (Línea de Reporte)
                                </label>
                                <select
                                    name="parentId"
                                    value={formData.parentId || 'null'}
                                    onChange={handleChange}
                                    className={`w-full p-3 border ${errors.parentId ? 'border-red-300' : 'border-slate-200'} rounded-xl text-sm bg-white custom-select`}
                                >
                                    <option value="null">
                                        👑 Dirección General / Sin Jefe
                                    </option>
                                    {availableParents
                                        .sort((a, b) => a.name.localeCompare(b.name))
                                        .map(node => (
                                            <option key={node.id} value={node.id}>
                                                {node.name} - {node.title} ({node.department})
                                            </option>
                                        ))}
                                </select>
                                {errors.parentId && (
                                    <p className="text-red-500 text-xs mt-1">{errors.parentId}</p>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* Riesgo y Sucesión */}
                    <div className="bg-gradient-to-r from-red-50/80 to-pink-50/80 p-5 rounded-3xl border border-red-200 card-shadow space-y-5">
                        <div className="flex items-center justify-between">
                            <h4 className="font-black text-red-800 text-sm uppercase tracking-widest flex items-center gap-2">
                                <i className="fas fa-exclamation-triangle text-red-600"></i>
                                Riesgo y Sucesión
                            </h4>
                            <label className="flex items-center gap-2 cursor-pointer">
                                <input
                                    type="checkbox"
                                    name="isCritical"
                                    checked={formData.isCritical}
                                    onChange={handleChange}
                                    className="custom-checkbox"
                                />
                                <span className="text-sm font-bold text-red-700">Posición Crítica</span>
                            </label>
                        </div>
                        
                        {formData.isCritical && (
                            <div className="space-y-4 animate-in">
                                <div>
                                    <label className="block text-[10px] font-black text-red-600 uppercase mb-2 tracking-widest">
                                        Sucesor Identificado
                                    </label>
                                    <select
                                        name="successionId"
                                        value={formData.successionId || 'null'}
                                        onChange={handleChange}
                                        className={`w-full p-3 border ${errors.successionId ? 'border-red-300' : 'border-red-200'} rounded-xl text-sm bg-white/80 custom-select`}
                                    >
                                        <option value="null">
                                            ⚠️ No hay sucesor identificado
                                        </option>
                                        {availableSuccessors.length > 0 ? (
                                            availableSuccessors.map(node => (
                                                <option key={node.id} value={node.id}>
                                                    {node.name} - {node.title}
                                                </option>
                                            ))
                                        ) : (
                                            <option value="null" disabled>
                                                No hay colaboradores disponibles en este departamento
                                            </option>
                                        )}
                                    </select>
                                    {errors.successionId && (
                                        <p className="text-red-500 text-xs mt-1">{errors.successionId}</p>
                                    )}
                                </div>
                                
                                <div className="p-3 bg-red-100/50 rounded-xl border border-red-300">
                                    <p className="text-xs text-red-700 font-medium">
                                        <i className="fas fa-info-circle mr-2"></i>
                                        Las posiciones críticas son vitales para la organización y requieren un plan de sucesión para garantizar la continuidad del negocio.
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>
                    
                    {/* Botones de acción */}
                    <div className="flex gap-3">
                        {selectedNode ? (
                            <button
                                onClick={() => {
                                    if (window.confirm('¿Estás seguro de eliminar este colaborador? Esta acción no se puede deshacer.')) {
                                        onDelete(formData.id);
                                    }
                                }}
                                className="flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white py-3.5 rounded-2xl font-black text-xs hover:from-red-600 hover:to-red-700 transition-all shadow-lg shadow-red-500/20 flex items-center justify-center gap-2"
                            >
                                <i className="fas fa-trash-alt"></i>
                                Eliminar
                            </button>
                        ) : (
                            <button
                                onClick={onCancel}
                                className="flex-1 bg-white border border-slate-300 text-slate-700 py-3.5 rounded-2xl font-black text-xs hover:bg-slate-50 transition-all flex items-center justify-center gap-2"
                            >
                                <i className="fas fa-times"></i>
                                Cancelar
                            </button>
                        )}
                        
                        <button
                            onClick={handleSave}
                            className="flex-[2] bg-gradient-to-r from-slate-900 to-gray-900 text-white py-3.5 rounded-2xl font-black text-xs hover:from-slate-800 hover:to-gray-800 transition-all shadow-xl flex items-center justify-center gap-2"
                        >
                            <i className="fas fa-save"></i>
                            {selectedNode ? 'Guardar Cambios' : 'Crear Colaborador'}
                        </button>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // COMPONENTE DE VISUALIZACIÓN D3 (MEJORADO)
        // ============================================
        
        const OrgChartD3 = ({ nodes, selectedNodeId, onSelectNode, showLegend = true }) => {
            const svgRef = React.useRef(null);
            const containerRef = React.useRef(null);
            const [dimensions, setDimensions] = React.useState({ width: 0, height: 0 });
            
            // Actualizar dimensiones al redimensionar
            React.useEffect(() => {
                const updateDimensions = () => {
                    if (containerRef.current) {
                        const { width, height } = containerRef.current.getBoundingClientRect();
                        setDimensions({ width, height });
                    }
                };
                
                updateDimensions();
                window.addEventListener('resize', updateDimensions);
                return () => window.removeEventListener('resize', updateDimensions);
            }, []);
            
            React.useEffect(() => {
                if (!svgRef.current || !containerRef.current || nodes.length === 0) return;
                
                const { width, height } = dimensions;
                if (width === 0 || height === 0) return;
                
                const svg = d3.select(svgRef.current)
                    .attr('width', width)
                    .attr('height', height);
                
                // Limpiar SVG anterior
                svg.selectAll('*').remove();
                
                // Crear filtros para sombras
                const defs = svg.append('defs');
                
                // Filtro para sombra de tarjetas
                const cardShadow = defs.append('filter')
                    .attr('id', 'card-shadow')
                    .attr('height', '130%');
                
                cardShadow.append('feGaussianBlur')
                    .attr('in', 'SourceAlpha')
                    .attr('stdDeviation', 3);
                cardShadow.append('feOffset')
                    .attr('dx', 0)
                    .attr('dy', 4)
                    .attr('result', 'offsetBlur');
                
                const feMerge = cardShadow.append('feMerge');
                feMerge.append('feMergeNode').attr('in', 'offsetBlur');
                feMerge.append('feMergeNode').attr('in', 'SourceGraphic');
                
                // Filtro para sombra de nodos seleccionados
                const selectedShadow = defs.append('filter')
                    .attr('id', 'selected-shadow')
                    .attr('height', '150%');
                
                selectedShadow.append('feGaussianBlur')
                    .attr('in', 'SourceAlpha')
                    .attr('stdDeviation', 4);
                selectedShadow.append('feOffset')
                    .attr('dx', 0)
                    .attr('dy', 6)
                    .attr('result', 'offsetBlur2');
                selectedShadow.append('feFlood')
                    .attr('flood-color', '#3b82f6')
                    .attr('flood-opacity', 0.3)
                    .attr('result', 'color');
                selectedShadow.append('feComposite')
                    .attr('in', 'color')
                    .attr('in2', 'offsetBlur2')
                    .attr('operator', 'in')
                    .attr('result', 'coloredBlur');
                
                const feMerge2 = selectedShadow.append('feMerge');
                feMerge2.append('feMergeNode').attr('in', 'coloredBlur');
                feMerge2.append('feMergeNode').attr('in', 'SourceGraphic');
                
                const g = svg.append('g');
                
                // Configurar zoom
                const zoom = d3.zoom()
                    .scaleExtent([0.1, 3])
                    .on('zoom', (event) => {
                        g.attr('transform', event.transform);
                    });
                
                svg.call(zoom);
                
                try {
                    // Crear mapa de nodos para acceso rápido
                    const nodeMap = new Map(nodes.map(n => [n.id, n]));
                    
                    // Preparar datos para D3 hierarchy
                    const processed = nodes.map(n => ({ ...n }));
                    
                    // Identificar nodos raíz (sin padre o padre no existente)
                    const roots = processed.filter(n => !n.parentId || !nodeMap.has(n.parentId));
                    
                    // Crear nodo raíz virtual si hay múltiples raíces
                    const virtualRootId = 'VIRTUAL_ROOT';
                    processed.push({
                        id: virtualRootId,
                        name: '',
                        title: '',
                        department: '',
                        parentId: null
                    });
                    
                    // Conectar raíces al nodo virtual
                    roots.forEach(r => r.parentId = virtualRootId);
                    
                    // Crear jerarquía D3
                    const root = d3.stratify()
                        .id(d => d.id)
                        .parentId(d => d.parentId)
                        (processed);
                    
                    // Configurar layout del árbol
                    const treeLayout = d3.tree()
                        .nodeSize([220, 280])
                        .separation((a, b) => a.parent === b.parent ? 1 : 2);
                    
                    treeLayout(root);
                    
                    // Dibujar enlaces (líneas de conexión)
                    g.selectAll('.link')
                        .data(root.links())
                        .enter()
                        .append('path')
                        .filter(d => d.source.id !== virtualRootId)
                        .attr('class', 'link')
                        .attr('fill', 'none')
                        .attr('stroke', '#cbd5e1')
                        .attr('stroke-width', 2)
                        .attr('opacity', 0.6)
                        .attr('d', d3.linkVertical()
                            .x(d => d.x)
                            .y(d => d.y)
                        );
                    
                    // Crear grupos de nodos
                    const nodeGroups = g.selectAll('.node')
                        .data(root.descendants())
                        .enter()
                        .append('g')
                        .filter(d => d.id !== virtualRootId)
                        .attr('class', 'node')
                        .attr('transform', d => `translate(${d.x}, ${d.y})`)
                        .on('click', (event, d) => {
                            event.stopPropagation();
                            onSelectNode(d.id);
                        })
                        .style('cursor', 'pointer')
                        .attr('data-node-id', d => d.id);
                    
                    // Tarjeta del nodo (fondo)
                    nodeGroups.append('rect')
                        .attr('class', 'node-card')
                        .attr('width', 200)
                        .attr('height', 120)
                        .attr('x', -100)
                        .attr('y', -60)
                        .attr('rx', 20)
                        .attr('fill', 'white')
                        .attr('filter', d => d.id === selectedNodeId ? 'url(#selected-shadow)' : 'url(#card-shadow)')
                        .attr('stroke', d => {
                            if (d.id === selectedNodeId) return '#2563eb';
                            if (d.data.isCritical && !d.data.successionId) return '#ef4444';
                            if (d.data.isCritical) return '#f59e0b';
                            return '#f1f5f9';
                        })
                        .attr('stroke-width', d => {
                            if (d.id === selectedNodeId) return 3;
                            if (d.data.isCritical) return 2;
                            return 1;
                        })
                        .attr('class', d => d.data.isCritical && !d.data.successionId ? 'animate-pulse' : '');
                    
                    // Barra superior de departamento
                    nodeGroups.append('rect')
                        .attr('width', 200)
                        .attr('height', 8)
                        .attr('x', -100)
                        .attr('y', -60)
                        .attr('rx', 4)
                        .attr('fill', d => d.data.color || COLORS_DEPT[d.data.department] || '#3b82f6');
                    
                    // Nombre del colaborador
                    nodeGroups.append('text')
                        .attr('class', 'node-name')
                        .attr('dy', -30)
                        .attr('x', -85)
                        .attr('fill', '#0f172a')
                        .style('font-size', '12px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => {
                            const name = d.data.name || '';
                            return name.length > 20 ? name.substring(0, 18) + '...' : name;
                        });
                    
                    // Cargo
                    nodeGroups.append('text')
                        .attr('class', 'node-title')
                        .attr('dy', -15)
                        .attr('x', -85)
                        .attr('fill', '#64748b')
                        .style('font-size', '10px')
                        .style('font-weight', '600')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => {
                            const title = d.data.title || '';
                            return title.length > 25 ? title.substring(0, 23) + '...' : title;
                        });
                    
                    // Departamento
                    nodeGroups.append('text')
                        .attr('class', 'node-dept')
                        .attr('dy', 0)
                        .attr('x', -85)
                        .attr('fill', '#3b82f6')
                        .style('font-size', '9px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .style('text-transform', 'uppercase')
                        .style('letter-spacing', '0.05em')
                        .text(d => {
                            const dept = d.data.department || '';
                            return dept.length > 18 ? dept.substring(0, 16) + '...' : dept;
                        });
                    
                    // Barra de rendimiento
                    const perfGroup = nodeGroups.append('g')
                        .attr('transform', 'translate(-85, 20)');
                    
                    // Fondo de la barra
                    perfGroup.append('rect')
                        .attr('width', 130)
                        .attr('height', 6)
                        .attr('fill', '#f1f5f9')
                        .attr('rx', 3);
                    
                    // Barra de progreso
                    perfGroup.append('rect')
                        .attr('width', d => {
                            const perf = d.data.performance || 0;
                            return (perf / 100) * 130;
                        })
                        .attr('height', 6)
                        .attr('rx', 3)
                        .attr('fill', d => {
                            const perf = d.data.performance || 0;
                            if (perf >= 85) return '#10b981';
                            if (perf >= 70) return '#f59e0b';
                            return '#ef4444';
                        });
                    
                    // Texto de porcentaje
                    perfGroup.append('text')
                        .attr('x', 135)
                        .attr('y', 5)
                        .attr('text-anchor', 'start')
                        .attr('fill', '#64748b')
                        .style('font-size', '9px')
                        .style('font-weight', '700')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => `${d.data.performance || 0}%`);
                    
                    // Badge de potencial
                    const badgeGroup = nodeGroups.append('g')
                        .attr('transform', 'translate(50, 35)');
                    
                    // Fondo del badge
                    badgeGroup.append('rect')
                        .attr('width', 38)
                        .attr('height', 18)
                        .attr('rx', 9)
                        .attr('fill', d => {
                            const pot = d.data.potential || 'Medio';
                            if (pot === 'Alto') return '#dcfce7';
                            if (pot === 'Medio') return '#fef3c7';
                            return '#f1f5f9';
                        });
                    
                    // Texto del badge
                    badgeGroup.append('text')
                        .attr('x', 19)
                        .attr('y', 12)
                        .attr('text-anchor', 'middle')
                        .attr('fill', d => {
                            const pot = d.data.potential || 'Medio';
                            if (pot === 'Alto') return '#166534';
                            if (pot === 'Medio') return '#92400e';
                            return '#64748b';
                        })
                        .style('font-size', '8px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .style('text-transform', 'uppercase')
                        .text(d => {
                            const pot = d.data.potential || 'Medio';
                            if (pot === 'Alto') return 'TOP';
                            if (pot === 'Medio') return 'MED';
                            return 'BAJO';
                        });
                    
                    // Indicador de posición crítica
                    nodeGroups.filter(d => d.data.isCritical)
                        .append('circle')
                        .attr('cx', 80)
                        .attr('cy', -45)
                        .attr('r', 6)
                        .attr('fill', d => d.data.successionId ? '#f59e0b' : '#ef4444')
                        .attr('stroke', 'white')
                        .attr('stroke-width', 2)
                        .attr('class', d => !d.data.successionId ? 'animate-pulse' : '');
                    
                    // Indicador de salario
                    nodeGroups.append('text')
                        .attr('x', 80)
                        .attr('y', 55)
                        .attr('text-anchor', 'middle')
                        .attr('fill', '#059669')
                        .style('font-size', '9px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => {
                            const salary = d.data.salary || 0;
                            if (salary >= 10000) return `$${(salary / 1000).toFixed(0)}k`;
                            if (salary >= 1000) return `$${(salary / 1000).toFixed(1)}k`;
                            return `$${salary}`;
                        });
                    
                    // Ajustar vista inicial
                    const rootNodes = root.descendants().filter(d => d.id !== virtualRootId);
                    if (rootNodes.length > 0) {
                        const xExtent = d3.extent(rootNodes, d => d.x);
                        const yExtent = d3.extent(rootNodes, d => d.y);
                        
                        const scale = Math.min(
                            (width - 100) / (xExtent[1] - xExtent[0]),
                            (height - 100) / (yExtent[1] - yExtent[0]),
                            0.9
                        );
                        
                        const translateX = width / 2 - (xExtent[0] + xExtent[1]) / 2 * scale;
                        const translateY = height / 2 - (yExtent[0] + yExtent[1]) / 2 * scale;
                        
                        svg.transition()
                            .duration(800)
                            .call(zoom.transform, d3.zoomIdentity
                                .translate(translateX, translateY)
                                .scale(scale)
                            );
                    }
                    
                } catch (err) {
                    console.error('Error al renderizar el organigrama:', err);
                }
                
            }, [nodes, selectedNodeId, dimensions]);
            
            // Mensaje cuando no hay datos
            if (nodes.length === 0) {
                return (
                    <div className="w-full h-full flex flex-col items-center justify-center bg-gradient-to-b from-slate-50 to-blue-50/30 text-slate-400">
                        <i className="fas fa-sitemap text-8xl opacity-10 mb-6"></i>
                        <p className="font-black text-2xl text-slate-300 mb-2">Organigrama vacío</p>
                        <p className="text-sm opacity-60 max-w-md text-center">
                            Carga datos desde Excel o usa el simulador para comenzar
                        </p>
                    </div>
                );
            }
            
            return (
                <div 
                    ref={containerRef}
                    id="capture-area"
                    className="w-full h-full bg-gradient-to-b from-slate-50 to-blue-50/30 relative overflow-hidden d3-container"
                    onClick={() => onSelectNode(null)}
                >
                    <svg
                        ref={svgRef}
                        className="w-full h-full outline-none"
                    />
                    
                    {/* Contador de nodos */}
                    <div className="absolute bottom-4 right-4 glass-effect p-3 rounded-2xl border border-slate-200 card-shadow">
                        <div className="flex items-center gap-4 text-xs font-black text-slate-600">
                            <span className="flex items-center gap-1">
                                <i className="fas fa-users text-blue-500"></i>
                                {nodes.length} colaboradores
                            </span>
                            <span className="flex items-center gap-1">
                                <i className="fas fa-building text-emerald-500"></i>
                                {new Set(nodes.map(n => n.department)).size} departamentos
                            </span>
                            <span className="flex items-center gap-1">
                                <i className="fas fa-dollar-sign text-amber-500"></i>
                                ${nodes.reduce((sum, n) => sum + (n.salary || 0), 0).toLocaleString()}
                            </span>
                        </div>
                    </div>
                    
                    {/* Leyenda (ahora ocultable) */}
                    {showLegend && (
                        <div className="absolute top-4 left-4 glass-effect p-4 rounded-2xl border border-slate-200 card-shadow max-w-xs animate-in slide-in-left">
                            <div className="flex justify-between items-center mb-3">
                                <h5 className="text-xs font-black text-slate-400 uppercase flex items-center gap-2">
                                    <i className="fas fa-info-circle text-blue-500"></i>
                                    Leyenda del Organigrama
                                </h5>
                            </div>
                            <div className="space-y-2">
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-emerald-500"></div>
                                    <span className="text-xs font-medium text-slate-600">Posición Estable</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-amber-500"></div>
                                    <span className="text-xs font-medium text-slate-600">Crítico con Sucesor</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
                                    <span className="text-xs font-medium text-slate-600">Crítico sin Sucesor</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 rounded-full bg-blue-500"></div>
                                    <span className="text-xs font-medium text-slate-600">Seleccionado</span>
                                </div>
                                <div className="pt-2 mt-2 border-t border-slate-100">
                                    <p className="text-[10px] text-slate-500">
                                        <i className="fas fa-mouse-pointer mr-1"></i>
                                        Haz clic en cualquier nodo para editarlo
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // ============================================
        // COMPONENTE DE ANÁLISIS 360° (ARREGLADO)
        // ============================================
        
        const AnalysisTab = ({ nodes }) => {
            const [versions, setVersions] = React.useState(() => {
                const saved = localStorage.getItem('luxanalitica_versions');
                return saved ? JSON.parse(saved) : [];
            });
            
            const stats = React.useMemo(() => {
                if (!nodes || nodes.length === 0) return null;
                
                const nodeMap = new Map(nodes.map(n => [n.id, n]));
                
                // Calcular carga de subordinados
                const subordinateCount = {};
                nodes.forEach(node => {
                    if (node.parentId) {
                        subordinateCount[node.parentId] = (subordinateCount[node.parentId] || 0) + 1;
                    }
                });
                
                // Filtrar datos válidos
                const validSalaries = nodes.filter(n => typeof n.salary === 'number' && n.salary > 0);
                const validPerformances = nodes.filter(n => typeof n.performance === 'number' && n.performance >= 0);
                const validSeniority = nodes.filter(n => typeof n.seniority === 'number' && n.seniority >= 0);
                
                // Estadísticas generales
                const totalSalary = validSalaries.reduce((sum, n) => sum + (n.salary || 0), 0);
                const avgSalary = validSalaries.length > 0 ? Math.round(totalSalary / validSalaries.length) : 0;
                const avgPerformance = validPerformances.length > 0 
                    ? Math.round(validPerformances.reduce((sum, n) => sum + (n.performance || 0), 0) / validPerformances.length)
                    : 0;
                const avgSeniority = validSeniority.length > 0
                    ? Number((validSeniority.reduce((sum, n) => sum + (n.seniority || 0), 0) / validSeniority.length).toFixed(1))
                    : 0;
                
                // Estadísticas por departamento
                const departments = [...new Set(nodes.map(n => n.department))];
                const deptStats = departments.map(dept => {
                    const deptNodes = nodes.filter(n => n.department === dept);
                    const deptSalaries = deptNodes.filter(n => typeof n.salary === 'number' && n.salary > 0);
                    const deptPerformances = deptNodes.filter(n => typeof n.performance === 'number');
                    const deptSeniorities = deptNodes.filter(n => typeof n.seniority === 'number');
                    const managers = deptNodes.filter(n => 
                        subordinateCount[n.id] > 0
                    );
                    const avgSubordinates = managers.length > 0
                        ? (managers.reduce((sum, n) => sum + (subordinateCount[n.id] || 0), 0) / managers.length).toFixed(1)
                        : 0;
                    
                    return {
                        name: dept,
                        count: deptNodes.length,
                        avgSalary: deptSalaries.length > 0 
                            ? Math.round(deptSalaries.reduce((sum, n) => sum + (n.salary || 0), 0) / deptSalaries.length)
                            : 0,
                        avgPerformance: deptPerformances.length > 0
                            ? Math.round(deptPerformances.reduce((sum, n) => sum + (n.performance || 0), 0) / deptPerformances.length)
                            : 0,
                        avgSeniority: deptSeniorities.length > 0
                            ? Number((deptSeniorities.reduce((sum, n) => sum + (n.seniority || 0), 0) / deptSeniorities.length).toFixed(1))
                            : 0,
                        totalSalary: deptSalaries.reduce((sum, n) => sum + (n.salary || 0), 0),
                        criticalCount: deptNodes.filter(n => n.isCritical).length,
                        managers: managers.length,
                        avgSubordinates: avgSubordinates
                    };
                }).sort((a, b) => b.count - a.count);
                
                // Análisis de riesgo
                const criticalNodes = nodes.filter(n => n.isCritical);
                const criticalIssues = criticalNodes.filter(n => !n.successionId || !nodeMap.has(n.successionId));
                const riskLevel = criticalNodes.length > 0
                    ? Math.round((criticalIssues.length / criticalNodes.length) * 100)
                    : 0;
                
                // Datos para matriz 9-box (Potencial vs Desempeño)
                const matrixData = validPerformances.map(n => ({
                    name: n.name,
                    performance: n.performance,
                    potential: n.potential === 'Alto' ? 3 : (n.potential === 'Medio' ? 2 : 1),
                    potentialLabel: n.potential,
                    salary: n.salary || 0,
                    department: n.department,
                    subordinateCount: subordinateCount[n.id] || 0
                }));
                
                // Análisis de género
                const genderCount = nodes.reduce((acc, n) => {
                    const gender = n.gender || 'Otro';
                    acc[gender] = (acc[gender] || 0) + 1;
                    return acc;
                }, {});
                
                const genderData = Object.entries(genderCount).map(([name, value]) => ({
                    name,
                    value,
                    percentage: Math.round((value / nodes.length) * 100)
                }));
                
                // Top talentos
                const topTalents = nodes.filter(n => 
                    n.potential === 'Alto' && 
                    (n.performance || 0) >= 85
                );
                
                // Distribución salarial por rangos
                const salaryRanges = [
                    { range: 'Menos de $5k', min: 0, max: 5000, count: 0 },
                    { range: '$5k - $10k', min: 5000, max: 10000, count: 0 },
                    { range: '$10k - $15k', min: 10000, max: 15000, count: 0 },
                    { range: '$15k - $20k', min: 15000, max: 20000, count: 0 },
                    { range: 'Más de $20k', min: 20000, max: Infinity, count: 0 }
                ];
                
                validSalaries.forEach(n => {
                    const salary = n.salary || 0;
                    for (const range of salaryRanges) {
                        if (salary >= range.min && salary < range.max) {
                            range.count++;
                            break;
                        }
                    }
                });
                
                // Distribución por antigüedad
                const seniorityRanges = [
                    { range: '0-2 años', min: 0, max: 2, count: 0 },
                    { range: '3-5 años', min: 3, max: 5, count: 0 },
                    { range: '6-10 años', min: 6, max: 10, count: 0 },
                    { range: '11-15 años', min: 11, max: 15, count: 0 },
                    { range: 'Más de 15 años', min: 16, max: Infinity, count: 0 }
                ];
                
                validSeniority.forEach(n => {
                    const seniority = n.seniority || 0;
                    for (const range of seniorityRanges) {
                        if (seniority >= range.min && seniority <= range.max) {
                            range.count++;
                            break;
                        }
                    }
                });
                
                // Jefes sobrecargados
                const overloadedManagers = nodes.filter(n => 
                    (subordinateCount[n.id] || 0) > 5 && 
                    (n.title.includes('Gerente') || 
                     n.title.includes('Director') ||
                     n.title.includes('Supervisor'))
                ).map(n => ({
                    ...n,
                    subordinateCount: subordinateCount[n.id] || 0
                }));
                
                return {
                    // Totales
                    totalNodes: nodes.length,
                    totalDepartments: departments.length,
                    totalSalary,
                    avgSalary,
                    avgPerformance,
                    avgSeniority,
                    
                    // Datos estructurados
                    deptStats,
                    matrixData,
                    genderData,
                    salaryRanges,
                    seniorityRanges,
                    
                    // Métricas de riesgo
                    criticalNodes: criticalNodes.length,
                    criticalIssues: criticalIssues.length,
                    riskLevel,
                    
                    // Talentos
                    topTalents: topTalents.length,
                    topTalentList: topTalents,
                    
                    // Carga de trabajo
                    overloadedManagers,
                    avgSubordinatesPerManager: Object.values(subordinateCount).length > 0 
                        ? (Object.values(subordinateCount).reduce((a, b) => a + b, 0) / Object.values(subordinateCount).length).toFixed(1)
                        : 0,
                    maxSubordinates: Math.max(...Object.values(subordinateCount).concat([0])),
                    
                    // Porcentajes
                    genderDiversity: genderData.length > 1 ? 1 : 0,
                    avgDeptSize: Math.round(nodes.length / departments.length)
                };
                
            }, [nodes]);
            
            const handleSaveVersion = (updatedVersions) => {
                setVersions(updatedVersions);
            };
            
            const generateComparativeReport = () => {
                if (versions.length < 2) {
                    alert('Necesitas al menos 2 versiones para generar un reporte comparativo.');
                    return;
                }
                
                const currentStats = stats;
                const bestVersion = versions[0]; // Asumimos que la primera es la mejor
                
                // Preparar datos para Excel
                const reportData = [
                    ['REPORTE COMPARATIVO DE ESTRUCTURA ORGANIZACIONAL', '', '', ''],
                    ['Generado por Luxanalitica HR 360°', '', 'Fecha:', new Date().toLocaleDateString()],
                    ['', '', '', ''],
                    ['MÉTRICA', 'VERSIÓN ACTUAL', `VERSIÓN ${bestVersion.name}`, 'DIFERENCIA'],
                    ['Total Colaboradores', currentStats.totalNodes, bestVersion.stats.totalNodes, currentStats.totalNodes - bestVersion.stats.totalNodes],
                    ['Masa Salarial Mensual', `$${currentStats.totalSalary.toLocaleString()}`, `$${bestVersion.stats.totalSalary.toLocaleString()}`, `$${(currentStats.totalSalary - bestVersion.stats.totalSalary).toLocaleString()}`],
                    ['Rendimiento Promedio', `${currentStats.avgPerformance}%`, `${bestVersion.stats.avgPerformance}%`, `${currentStats.avgPerformance - bestVersion.stats.avgPerformance}%`],
                    ['Posiciones Críticas', currentStats.criticalNodes, bestVersion.stats.criticalNodes, currentStats.criticalNodes - bestVersion.stats.criticalNodes],
                    ['Críticos sin Sucesor', currentStats.criticalIssues, bestVersion.stats.criticalIssues, currentStats.criticalIssues - bestVersion.stats.criticalIssues],
                    ['', '', '', ''],
                    ['RECOMENDACIONES DE IA:', '', '', ''],
                    ['1. Optimización Salarial', 'Revisar colaboradores con salario por debajo del promedio de su departamento', '', ''],
                    ['2. Gestión de Carga', `Redistribuir ${currentStats.overloadedManagers.length} jefes sobrecargados`, '', ''],
                    ['3. Plan de Sucesión', `Definir sucesores para ${currentStats.criticalIssues} posiciones críticas`, '', ''],
                    ['4. Desarrollo de Talento', `Invertir en ${currentStats.topTalents} colaboradores de alto potencial`, '', ''],
                    ['', '', '', ''],
                    ['CAMBIO RECOMENDADO', 'DE', 'A', 'IMPACTO ESPERADO'],
                ];
                
                // Agregar recomendaciones específicas
                currentStats.deptStats.forEach(dept => {
                    if (dept.avgPerformance < 70) {
                        reportData.push([
                            `Reestructurar ${dept.name}`,
                            `${dept.avgPerformance}% rendimiento`,
                            '≥75% rendimiento',
                            'Aumento de productividad'
                        ]);
                    }
                });
                
                const ws = XLSX.utils.aoa_to_sheet(reportData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Recomendaciones");
                
                // Hoja de análisis detallado
                const detailData = nodes.map(node => {
                    const deptAvg = currentStats.deptStats.find(d => d.name === node.department)?.avgSalary || 0;
                    const salaryRatio = deptAvg > 0 ? (node.salary / deptAvg) : 0;
                    
                    return {
                        'ID': node.id,
                        'Nombre': node.name,
                        'Cargo': node.title,
                        'Departamento': node.department,
                        'Salario Actual': node.salary,
                        'Salario Promedio Depto': deptAvg,
                        '% vs Promedio': `${Math.round((salaryRatio - 1) * 100)}%`,
                        'Rendimiento': `${node.performance}%`,
                        'Potencial': node.potential,
                        'Antigüedad': `${node.seniority} años`,
                        'Es Crítico': node.isCritical ? 'SÍ' : 'NO',
                        'Tiene Sucesor': node.successionId ? 'SÍ' : 'NO',
                        'Subordinados': currentStats.matrixData.find(m => m.name === node.name)?.subordinateCount || 0,
                        'Recomendación': 
                            salaryRatio < 0.7 ? 'Aumento salarial' :
                            node.performance < 70 && node.salary > 10000 ? 'Plan de mejora' :
                            node.isCritical && !node.successionId ? 'Definir sucesor' :
                            node.performance >= 85 && node.salary < 5000 && node.potential === 'Alto' ? 'Retención estratégica' :
                            'OK'
                    };
                });
                
                const ws2 = XLSX.utils.json_to_sheet(detailData);
                XLSX.utils.book_append_sheet(wb, ws2, "Análisis Detallado");
                
                XLSX.writeFile(wb, `Luxanalitica_Analisis_Comparativo_${new Date().toISOString().slice(0,10)}.xlsx`);
            };
            
            // Componente de matriz 9-box corregido
            const MatrixChart = () => {
                // Asegurar que Recharts esté disponible
                const Recharts = window.Recharts;
                if (!Recharts) {
                    return (
                        <div className="h-full flex items-center justify-center bg-slate-50 rounded-xl">
                            <div className="text-center p-6">
                                <i className="fas fa-chart-bar text-4xl text-slate-300 mb-3"></i>
                                <p className="text-slate-500">Gráfico no disponible</p>
                                <p className="text-sm text-slate-400">Recharts no se cargó correctamente</p>
                            </div>
                        </div>
                    );
                }
                
                const CustomTooltip = ({ active, payload }) => {
                    if (active && payload && payload.length) {
                        const data = payload[0].payload;
                        return (
                            <div className="bg-slate-900 text-white p-3 rounded-xl text-xs border border-slate-700 shadow-2xl">
                                <div className="font-bold text-blue-300 border-b border-slate-700 pb-1 mb-2">
                                    {data.name}
                                </div>
                                <div className="space-y-1">
                                    <div className="flex justify-between">
                                        <span className="text-slate-400">Desempeño:</span>
                                        <span className="text-emerald-300 font-bold">{data.performance}%</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-slate-400">Potencial:</span>
                                        <span className="text-amber-300 font-bold">{data.potentialLabel}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-slate-400">Salario:</span>
                                        <span className="text-cyan-300 font-bold">${data.salary.toLocaleString()}</span>
                                    </div>
                                    <div className="flex justify-between">
                                        <span className="text-slate-400">Subordinados:</span>
                                        <span className="text-purple-300 font-bold">{data.subordinateCount}</span>
                                    </div>
                                </div>
                            </div>
                        );
                    }
                    return null;
                };
                
                return (
                    <Recharts.ResponsiveContainer width="100%" height="100%">
                        <Recharts.ScatterChart margin={{ top: 20, right: 30, bottom: 30, left: 20 }}>
                            <Recharts.CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                            <Recharts.XAxis 
                                type="number" 
                                dataKey="performance" 
                                name="Desempeño" 
                                domain={[0, 100]} 
                                unit="%" 
                                fontSize={10} 
                                tick={{ fill: '#94a3b8' }}
                                label={{ 
                                    value: 'Desempeño Operativo', 
                                    position: 'bottom', 
                                    fontSize: 10, 
                                    fill: '#64748b', 
                                    dy: 10 
                                }}
                            />
                            <Recharts.YAxis 
                                type="number" 
                                dataKey="potential" 
                                name="Potencial" 
                                domain={[0.5, 3.5]} 
                                ticks={[1, 2, 3]} 
                                tickFormatter={(v) => v === 3 ? 'Alto' : (v === 2 ? 'Medio' : 'Bajo')} 
                                fontSize={10} 
                                tick={{ fill: '#94a3b8' }}
                                label={{ 
                                    value: 'Potencial de Crecimiento', 
                                    angle: -90, 
                                    position: 'insideLeft', 
                                    fontSize: 10, 
                                    fill: '#64748b' 
                                }}
                            />
                            <Recharts.ZAxis type="number" dataKey="salary" range={[100, 1000]} />
                            <Recharts.Tooltip content={<CustomTooltip />} cursor={{ strokeDasharray: '3 3' }} />
                            <Recharts.Scatter 
                                data={stats.matrixData} 
                                fill="#3b82f6" 
                                fillOpacity={0.7}
                                stroke="#2563eb"
                                strokeWidth={1}
                            />
                            
                            {/* Líneas de cuadrícula para matriz 9-box */}
                            <Recharts.Line 
                                type="linear" 
                                dataKey={() => 2} 
                                stroke="#e2e8f0" 
                                strokeWidth={1} 
                                strokeDasharray="3 3"
                                dot={false}
                                xAxisId={0}
                                yAxisId={0}
                                data={[{performance: 0}, {performance: 100}]}
                            />
                            <Recharts.Line 
                                type="linear" 
                                dataKey={() => 67} 
                                stroke="#e2e8f0" 
                                strokeWidth={1} 
                                strokeDasharray="3 3"
                                dot={false}
                                xAxisId={0}
                                yAxisId={0}
                                data={[{performance: 0}, {performance: 100}]}
                            />
                            <Recharts.Line 
                                type="linear" 
                                dataKey={() => 33} 
                                stroke="#e2e8f0" 
                                strokeWidth={1} 
                                strokeDasharray="3 3"
                                dot={false}
                                xAxisId={0}
                                yAxisId={0}
                                data={[{performance: 0}, {performance: 100}]}
                            />
                        </Recharts.ScatterChart>
                    </Recharts.ResponsiveContainer>
                );
            };
            
            // Componente de gráfico compuesto corregido
            const ComposedChartDept = () => {
                const Recharts = window.Recharts;
                if (!Recharts) {
                    return (
                        <div className="h-full flex items-center justify-center bg-slate-50 rounded-xl">
                            <div className="text-center p-6">
                                <i className="fas fa-chart-line text-4xl text-slate-300 mb-3"></i>
                                <p className="text-slate-500">Gráfico no disponible</p>
                            </div>
                        </div>
                    );
                }
                
                return (
                    <Recharts.ResponsiveContainer width="100%" height="100%">
                        <Recharts.ComposedChart data={stats.deptStats}>
                            <Recharts.CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                            <Recharts.XAxis 
                                dataKey="name" 
                                fontSize={9} 
                                tick={{ fill: '#94a3b8' }} 
                                axisLine={false} 
                                tickLine={false}
                                angle={-45}
                                textAnchor="end"
                                height={60}
                            />
                            <Recharts.YAxis 
                                yAxisId="left"
                                fontSize={9}
                                tick={{ fill: '#94a3b8' }}
                                axisLine={false}
                                tickLine={false}
                            />
                            <Recharts.YAxis 
                                yAxisId="right"
                                orientation="right"
                                fontSize={9}
                                tick={{ fill: '#94a3b8' }}
                                axisLine={false}
                                tickLine={false}
                            />
                            <Recharts.Tooltip 
                                formatter={(value, name) => {
                                    if (name === 'avgSalary') return [`$${value.toLocaleString()}`, 'Salario Promedio'];
                                    if (name === 'avgPerformance') return [`${value}%`, 'Desempeño Promedio'];
                                    if (name === 'avgSubordinates') return [`${value}`, 'Promedio de Subordinados'];
                                    return [value, name];
                                }}
                            />
                            <Recharts.Bar 
                                yAxisId="left"
                                dataKey="avgSalary"
                                fill="#3b82f6"
                                radius={[8, 8, 0, 0]}
                                barSize={25}
                                name="Salario Medio"
                            />
                            <Recharts.Line 
                                yAxisId="right"
                                type="monotone"
                                dataKey="avgPerformance"
                                stroke="#10b981"
                                strokeWidth={3}
                                dot={{ r: 4, fill: '#10b981' }}
                                name="Rendimiento %"
                            />
                            <Recharts.Line 
                                yAxisId="right"
                                type="monotone"
                                dataKey="avgSubordinates"
                                stroke="#f59e0b"
                                strokeWidth={2}
                                strokeDasharray="5 5"
                                dot={{ r: 3, fill: '#f59e0b' }}
                                name="Subordinados"
                            />
                        </Recharts.ComposedChart>
                    </Recharts.ResponsiveContainer>
                );
            };
            
            // Componente de gráfico de barras vertical corregido
            const VerticalBarChart = ({ data, dataKey, nameKey, color = '#3b82f6' }) => {
                const Recharts = window.Recharts;
                if (!Recharts) return null;
                
                return (
                    <Recharts.ResponsiveContainer width="100%" height="100%">
                        <Recharts.BarChart 
                            data={data}
                            layout="vertical"
                            margin={{ left: 0, right: 20 }}
                        >
                            <Recharts.CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#f1f5f9" />
                            <Recharts.XAxis 
                                type="number" 
                                fontSize={9}
                                tick={{ fill: '#94a3b8' }}
                                axisLine={false}
                                tickLine={false}
                            />
                            <Recharts.YAxis 
                                dataKey={nameKey}
                                type="category"
                                width={100}
                                fontSize={9}
                                tick={{ fill: '#64748b' }}
                                axisLine={false}
                                tickLine={false}
                            />
                            <Recharts.Tooltip 
                                formatter={(value) => [`${value} colaboradores`, 'Cantidad']}
                            />
                            <Recharts.Bar 
                                dataKey={dataKey}
                                fill={color}
                                radius={[0, 8, 8, 0]}
                                name="Colaboradores"
                                barSize={15}
                            >
                                {data.map((entry, index) => (
                                    <Recharts.Cell 
                                        key={`cell-${index}`}
                                        fill={CHART_COLORS[index % CHART_COLORS.length]}
                                    />
                                ))}
                            </Recharts.Bar>
                        </Recharts.BarChart>
                    </Recharts.ResponsiveContainer>
                );
            };
            
            // Componente de gráfico circular corregido
            const PieChartComponent = ({ data }) => {
                const Recharts = window.Recharts;
                if (!Recharts) return null;
                
                return (
                    <Recharts.ResponsiveContainer width="100%" height="100%">
                        <Recharts.PieChart>
                            <Recharts.Pie
                                data={data}
                                innerRadius={50}
                                outerRadius={70}
                                dataKey="value"
                                stroke="none"
                                paddingAngle={5}
                            >
                                {data.map((entry, index) => (
                                    <Recharts.Cell 
                                        key={`cell-${index}`}
                                        fill={CHART_COLORS[index % CHART_COLORS.length]}
                                    />
                                ))}
                            </Recharts.Pie>
                            <Recharts.Tooltip 
                                formatter={(value, name, props) => [
                                    `${value} colaboradores (${props.payload.percentage}%)`,
                                    name
                                ]}
                            />
                            <Recharts.Legend 
                                iconType="circle"
                                iconSize={8}
                                layout="vertical"
                                verticalAlign="middle"
                                align="right"
                                wrapperStyle={{ fontSize: '10px' }}
                            />
                        </Recharts.PieChart>
                    </Recharts.ResponsiveContainer>
                );
            };
            
            // Componente de gráfico de barras horizontal corregido
            const HorizontalBarChart = ({ data, dataKey, nameKey }) => {
                const Recharts = window.Recharts;
                if (!Recharts) return null;
                
                return (
                    <Recharts.ResponsiveContainer width="100%" height="100%">
                        <Recharts.BarChart data={data}>
                            <Recharts.CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                            <Recharts.XAxis 
                                dataKey={nameKey}
                                fontSize={9}
                                tick={{ fill: '#94a3b8' }}
                                axisLine={false}
                                tickLine={false}
                            />
                            <Recharts.YAxis 
                                fontSize={9}
                                tick={{ fill: '#94a3b8' }}
                                axisLine={false}
                                tickLine={false}
                            />
                            <Recharts.Tooltip 
                                formatter={(value) => [`${value} colaboradores`, 'Cantidad']}
                            />
                            <Recharts.Bar 
                                dataKey={dataKey}
                                fill="#10b981"
                                radius={[8, 8, 0, 0]}
                                name="Colaboradores"
                                barSize={30}
                            >
                                {data.map((entry, index) => (
                                    <Recharts.Cell 
                                        key={`cell-${index}`}
                                        fill={CHART_COLORS[(index + 2) % CHART_COLORS.length]}
                                    />
                                ))}
                            </Recharts.Bar>
                        </Recharts.BarChart>
                    </Recharts.ResponsiveContainer>
                );
            };
            
            // Si no hay datos
            if (!stats) {
                return (
                    <div className="h-full flex flex-col items-center justify-center text-slate-400 gap-6 p-12">
                        <i className="fas fa-chart-pie text-8xl opacity-10"></i>
                        <p className="font-black text-2xl text-slate-300">Dashboard 360° esperando datos...</p>
                        <p className="text-sm opacity-60 max-w-md text-center">
                            Sube un archivo Excel o usa el Simulador en la pestaña "Cargar Excel" para activar el análisis.
                        </p>
                    </div>
                );
            }
            
            return (
                <div className="p-4 md:p-6 h-full overflow-y-auto bg-gradient-to-b from-slate-50 to-blue-50/20 space-y-6 scrollbar-hide animate-in fade-in duration-700">
                    {/* SECCIÓN 1: INTRODUCCIÓN AL SISTEMA */}
                    <div className="bg-gradient-to-r from-blue-900 to-purple-900 text-white p-8 rounded-3xl card-shadow relative overflow-hidden">
                        <div className="absolute -top-20 -right-20 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl"></div>
                        <div className="relative z-10">
                            <div className="flex items-start gap-6">
                                <div className="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-500 rounded-2xl flex items-center justify-center text-3xl shadow-xl">
                                    <i className="fas fa-brain"></i>
                                </div>
                                <div className="flex-1">
                                    <h2 className="text-3xl font-black mb-4">
                                        HR Analytics 360° - Motor de Inteligencia de Negocios (BI)
                                    </h2>
                                    <p className="text-blue-100 text-lg leading-relaxed">
                                        Transforma la base de datos de empleados en decisiones estratégicas de capital humano. 
                                        Esta no es solo una sección de gráficos, es un <strong>sistema de People Analytics profesional</strong> 
                                        que permite pasar de una gestión reactiva a una proactiva basada en datos reales.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {/* SECCIÓN 2: SISTEMA DE VERSIONES */}
                    <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow">
                        <h3 className="font-black text-slate-800 text-xl mb-6 flex items-center gap-3">
                            <i className="fas fa-code-branch text-blue-600"></i>
                            Sistema de Versiones - Simulaciones de Guerra
                        </h3>
                        <div className="space-y-6">
                            <VersionManager 
                                nodes={nodes} 
                                onSaveVersion={handleSaveVersion}
                            />
                            
                            {versions.length > 0 && (
                                <VersionComparison versions={versions} />
                            )}
                        </div>
                    </div>
                    
                    {/* SECCIÓN 3: PANEL DE KPIs ESTRATÉGICOS */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KPIBox 
                            icon="fa-users" 
                            color="blue" 
                            label="Plantilla Total" 
                            value={stats.totalNodes} 
                            sub={`${stats.totalDepartments} departamentos`}
                        />
                        <KPIBox 
                            icon="fa-rocket" 
                            color="emerald" 
                            label="Eficiencia Global" 
                            value={`${stats.avgPerformance}%`} 
                            sub="Promedio de rendimiento" 
                        />
                        <KPIBox 
                            icon="fa-funnel-dollar" 
                            color="indigo" 
                            label="Masa Salarial" 
                            value={`$${(stats.totalSalary / 1000).toFixed(1)}k`} 
                            sub="Costo laboral mensual" 
                        />
                        <KPIBox 
                            icon="fa-shield-alt" 
                            color="red" 
                            label="Riesgo de Sucesión" 
                            value={`${stats.riskLevel}%`} 
                            sub={`${stats.criticalIssues}/${stats.criticalNodes} críticos sin sucesor`}
                        />
                    </div>
                    
                    {/* SECCIÓN 4: MATRIZ 9-BOX Y EFICIENCIA */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {/* Matriz 9-Box */}
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex flex-col min-h-[400px]">
                            <div className="flex justify-between items-center mb-6">
                                <h4 className="font-black text-slate-800 flex items-center gap-3">
                                    <i className="fas fa-th-large text-blue-500"></i>
                                    Matriz de Talento 9-Box
                                </h4>
                                <span className="text-[10px] bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full font-black">
                                    ESTÁNDAR DE ORO EN GESTIÓN DE TALENTO
                                </span>
                            </div>
                            <div className="flex-1">
                                <MatrixChart />
                            </div>
                            <div className="mt-4 pt-4 border-t border-slate-100 text-sm text-slate-600">
                                <div className="grid grid-cols-3 gap-4">
                                    <div>
                                        <div className="font-bold">Mejores Talentos</div>
                                        <div className="text-xs">Alto potencial + Alto rendimiento</div>
                                    </div>
                                    <div>
                                        <div className="font-bold">Jugadores Principales</div>
                                        <div className="text-xs">Rendimiento consistente</div>
                                    </div>
                                    <div>
                                        <div className="font-bold">En Riesgo</div>
                                        <div className="text-xs">Bajo rendimiento</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* Eficiencia Operativa */}
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex flex-col min-h-[400px]">
                            <h4 className="font-black text-slate-800 mb-6 flex items-center gap-3">
                                <i className="fas fa-chart-line text-emerald-500"></i>
                                Eficiencia Operativa: Costo vs Rendimiento + Carga de Trabajo
                            </h4>
                            <div className="flex-1">
                                <ComposedChartDept />
                            </div>
                            <div className="mt-4 flex justify-center gap-6 text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                <span className="flex items-center gap-2">
                                    <div className="w-2 h-2 bg-blue-500 rounded-full"></div>
                                    Inversión Salarial
                                </span>
                                <span className="flex items-center gap-2">
                                    <div className="w-2 h-2 bg-emerald-500 rounded-full"></div>
                                    Rendimiento Operativo
                                </span>
                                <span className="flex items-center gap-2">
                                    <div className="w-2 h-2 bg-amber-500 rounded-full"></div>
                                    Carga de Trabajo
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    {/* SECCIÓN 5: ANÁLISIS DE CARGA DE SUBORDINADOS */}
                    <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow">
                        <h4 className="font-black text-slate-800 mb-6 flex items-center gap-3">
                            <i className="fas fa-network-wired text-purple-600"></i>
                            Análisis de Carga de Trabajo y Estructura de Reportes
                        </h4>
                        <SubordinateAnalysis nodes={nodes} />
                    </div>
                    
                    {/* SECCIÓN 6: ANÁLISIS COMPLEMENTARIOS */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        {/* Antigüedad y Experiencia */}
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex flex-col h-[350px]">
                            <h4 className="font-black text-slate-800 mb-6 flex items-center gap-3">
                                <i className="fas fa-hourglass-half text-amber-500"></i>
                                Análisis de Antigüedad (Experiencia Acumulada)
                            </h4>
                            <div className="flex-1">
                                <VerticalBarChart 
                                    data={stats.seniorityRanges}
                                    dataKey="count"
                                    nameKey="range"
                                />
                            </div>
                        </div>
                        
                        {/* Diversidad y Composición */}
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow h-[350px] flex flex-col">
                            <h4 className="font-black text-slate-800 mb-2">Mezcla de Género y Diversidad (ESG)</h4>
                            <div className="h-44">
                                <PieChartComponent data={stats.genderData} />
                            </div>
                            <div className="mt-4 pt-4 border-t border-slate-100 flex items-center justify-between">
                                <div className="text-center">
                                    <p className="text-[10px] font-black text-slate-400 uppercase">Top Performers</p>
                                    <p className="text-xl font-black text-emerald-600">{stats.topTalents}</p>
                                </div>
                                <div className="h-8 w-[1px] bg-slate-100"></div>
                                <div className="text-center">
                                    <p className="text-[10px] font-black text-slate-400 uppercase">Promedio Dept</p>
                                    <p className="text-xl font-black text-slate-800">{stats.avgDeptSize}</p>
                                </div>
                                <div className="h-8 w-[1px] bg-slate-100"></div>
                                <div className="text-center">
                                    <p className="text-[10px] font-black text-slate-400 uppercase">Antigüedad</p>
                                    <p className="text-xl font-black text-slate-800">{stats.avgSeniority}a</p>
                                </div>
                            </div>
                        </div>
                        
                        {/* Distribución Salarial */}
                        <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow h-[350px] flex flex-col">
                            <h4 className="font-black text-slate-800 mb-6 flex items-center gap-3">
                                <i className="fas fa-money-bill-wave text-green-500"></i>
                                Distribución Salarial por Rangos
                            </h4>
                            <div className="flex-1">
                                <HorizontalBarChart 
                                    data={stats.salaryRanges}
                                    dataKey="count"
                                    nameKey="range"
                                />
                            </div>
                        </div>
                    </div>
                    
                    {/* SECCIÓN 7: RECOMENDACIONES DE IA */}
                    <div className="bg-white p-6 rounded-3xl border border-slate-200 card-shadow">
                        <AIRecommendations nodes={nodes} versions={versions} />
                    </div>
                    
                    {/* SECCIÓN 8: MONITOR DE SALUD Y RIESGOS */}
                    <div className="bg-gradient-to-r from-slate-900 via-gray-900 to-slate-900 p-8 rounded-3xl card-shadow flex flex-col justify-center text-white relative overflow-hidden">
                        <div className="absolute -top-10 -right-10 w-40 h-40 bg-blue-600/20 rounded-full blur-3xl"></div>
                        <div className="absolute -bottom-10 -left-10 w-40 h-40 bg-purple-600/20 rounded-full blur-3xl"></div>
                        
                        <div className="relative z-10">
                            <div className="flex items-center gap-4 mb-6">
                                <div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-xl ${
                                    stats.riskLevel > 30 ? 'bg-gradient-to-br from-red-500 to-red-600' :
                                    stats.riskLevel > 15 ? 'bg-gradient-to-br from-amber-500 to-amber-600' :
                                    'bg-gradient-to-br from-emerald-500 to-emerald-600'
                                }`}>
                                    <i className={`fas ${
                                        stats.riskLevel > 30 ? 'fa-exclamation-triangle' :
                                        stats.riskLevel > 15 ? 'fa-shield-alt' :
                                        'fa-shield-check'
                                    }`}></i>
                                </div>
                                <div>
                                    <h4 className="font-black text-lg">Monitor de Salud HR - Alertas de Continuidad</h4>
                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">
                                        Sistema de alerta temprana para vulnerabilidades organizacionales
                                    </p>
                                </div>
                            </div>
                            
                            <div className="space-y-4 mb-8">
                                <RiskMiniItem 
                                    label="Vulnerabilidad Crítica (sin sucesor)" 
                                    value={stats.criticalIssues} 
                                    total={stats.criticalNodes} 
                                    color="red" 
                                />
                                <RiskMiniItem 
                                    label="High-Performance Talent" 
                                    value={stats.topTalents} 
                                    total={stats.totalNodes} 
                                    color="emerald" 
                                />
                                <RiskMiniItem 
                                    label="Índice de Retención Proyectado" 
                                    value={100 - stats.riskLevel} 
                                    total={100} 
                                    color="blue" 
                                />
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <button 
                                    className="py-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2"
                                    onClick={() => {
                                        const element = document.getElementById('capture-area');
                                        if (!element) return;
                                        
                                        html2canvas(element, { 
                                            scale: 2,
                                            backgroundColor: '#f8fafc',
                                            useCORS: true,
                                            logging: false
                                        }).then(canvas => {
                                            const link = document.createElement('a');
                                            link.download = `Luxanalitica_Dashboard_${Date.now()}.jpg`;
                                            link.href = canvas.toDataURL('image/jpeg', 0.9);
                                            link.click();
                                        });
                                    }}
                                >
                                    <i className="fas fa-camera"></i>
                                    Capturar Dashboard
                                </button>
                                <button 
                                    className="py-3 bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 border border-emerald-500/30 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2"
                                    onClick={() => {
                                        const ws = XLSX.utils.json_to_sheet([
                                            { 'Métrica': 'Total Colaboradores', 'Valor': stats.totalNodes },
                                            { 'Métrica': 'Departamentos', 'Valor': stats.totalDepartments },
                                            { 'Métrica': 'Masa Salarial Mensual', 'Valor': `$${stats.totalSalary.toLocaleString()}` },
                                            { 'Métrica': 'Rendimiento Promedio', 'Valor': `${stats.avgPerformance}%` },
                                            { 'Métrica': 'Antigüedad Promedio', 'Valor': `${stats.avgSeniority} años` },
                                            { 'Métrica': 'Posiciones Críticas', 'Valor': stats.criticalNodes },
                                            { 'Métrica': 'Críticos sin Sucesor', 'Valor': stats.criticalIssues },
                                            { 'Métrica': 'Riesgo de Sucesión', 'Valor': `${stats.riskLevel}%` },
                                            { 'Métrica': 'Top Performers', 'Valor': stats.topTalents },
                                            { 'Métrica': 'Promedio Subordinados', 'Valor': stats.avgSubordinatesPerManager },
                                            { 'Métrica': 'Jefes Sobrecargados', 'Valor': stats.overloadedManagers.length },
                                        ]);
                                        
                                        const wb = XLSX.utils.book_new();
                                        XLSX.utils.book_append_sheet(wb, ws, "Resumen Ejecutivo");
                                        XLSX.writeFile(wb, `Luxanalitica_Reporte_360_${new Date().toISOString().slice(0,10)}.xlsx`);
                                    }}
                                >
                                    <i className="fas fa-file-excel"></i>
                                    Exportar Reporte
                                </button>
                                <button 
                                    className="py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 border border-blue-500/30 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2"
                                    onClick={generateComparativeReport}
                                    disabled={versions.length < 2}
                                >
                                    <i className="fas fa-robot"></i>
                                    Análisis Comparativo IA
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // COMPONENTE DE EXPORTACIÓN
        // ============================================
        
        const ExportTab = ({ nodes }) => {
            const [exporting, setExporting] = React.useState(false);
            
            const handleExportExcel = () => {
                try {
                    // Preparar datos para Excel
                    const excelData = nodes.map(node => ({
                        'ID': node.id,
                        'Nombre': node.name,
                        'Cargo': node.title,
                        'Departamento': node.department,
                        'Jefe ID': node.parentId || 'N/A',
                        'Salario ($)': node.salary || 0,
                        'Rendimiento (%)': node.performance || 0,
                        'Potencial': node.potential || 'Medio',
                        'Género': node.gender || 'Otro',
                        'Antigüedad (años)': node.seniority || 0,
                        'Posición Crítica': node.isCritical ? 'Sí' : 'No',
                        'ID Sucesor': node.successionId || 'N/A',
                        'Color': node.color || '#3b82f6'
                    }));
                    
                    // Crear hoja de cálculo
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    
                    // Ajustar anchos de columnas
                    const wscols = [
                        { wch: 10 }, // ID
                        { wch: 25 }, // Nombre
                        { wch: 25 }, // Cargo
                        { wch: 20 }, // Departamento
                        { wch: 10 }, // Jefe ID
                        { wch: 12 }, // Salario
                        { wch: 12 }, // Rendimiento
                        { wch: 10 }, // Potencial
                        { wch: 10 }, // Género
                        { wch: 10 }, // Antigüedad
                        { wch: 12 }, // Crítico
                        { wch: 10 }, // Sucesor
                        { wch: 10 }  // Color
                    ];
                    ws['!cols'] = wscols;
                    
                    // Crear libro de trabajo
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Organigrama");
                    
                    // Agregar hoja de resumen
                    const summaryData = [
                        ['RESUMEN DE ESTRUCTURA ORGANIZACIONAL', ''],
                        ['Fecha de exportación:', new Date().toLocaleDateString('es-ES')],
                        ['Hora de exportación:', new Date().toLocaleTimeString('es-ES')],
                        ['Total colaboradores:', nodes.length],
                        ['Total departamentos:', new Set(nodes.map(n => n.department)).size],
                        ['Masa salarial total:', `$${nodes.reduce((sum, n) => sum + (n.salary || 0), 0).toLocaleString()}`],
                        ['Rendimiento promedio:', `${Math.round(nodes.reduce((sum, n) => sum + (n.performance || 0), 0) / nodes.length)}%`],
                        ['Posiciones críticas:', nodes.filter(n => n.isCritical).length],
                        ['Críticos sin sucesor:', nodes.filter(n => n.isCritical && !n.successionId).length],
                        ['',''],
                        ['Este reporte fue generado por Luxanalitica HR 360°', '']
                    ];
                    
                    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, wsSummary, "Resumen");
                    
                    // Exportar archivo
                    XLSX.writeFile(wb, `Luxanalitica_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
                    
                } catch (error) {
                    console.error('Error exportando Excel:', error);
                    alert('Error al exportar a Excel. Intenta nuevamente.');
                }
            };
            
            const handleExportPDF = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false,
                        allowTaint: true
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('landscape', 'px', [canvas.width, canvas.height]);
                    
                    // Título del reporte
                    pdf.setFontSize(28);
                    pdf.setTextColor(30, 41, 59);
                    pdf.text('Reporte Organizacional', canvas.width / 2, 50, { align: 'center' });
                    
                    pdf.setFontSize(16);
                    pdf.setTextColor(100, 116, 139);
                    pdf.text('Luxanalitica HR 360°', canvas.width / 2, 75, { align: 'center' });
                    
                    pdf.setFontSize(12);
                    pdf.text(`Generado el ${new Date().toLocaleDateString('es-ES', { 
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}`, canvas.width / 2, 95, { align: 'center' });
                    
                    // Agregar imagen del organigrama
                    pdf.addImage(imgData, 'PNG', 20, 120, canvas.width - 40, canvas.height - 140);
                    
                    // Pie de página con estadísticas
                    pdf.setFontSize(10);
                    pdf.setTextColor(30, 41, 59);
                    const statsText = [
                        `Total colaboradores: ${nodes.length}`,
                        `Departamentos: ${new Set(nodes.map(n => n.department)).size}`,
                        `Masa salarial: $${nodes.reduce((sum, n) => sum + (n.salary || 0), 0).toLocaleString()}`,
                        `Rendimiento promedio: ${Math.round(nodes.reduce((sum, n) => sum + (n.performance || 0), 0) / nodes.length)}%`
                    ].join(' | ');
                    
                    pdf.text(statsText, 20, canvas.height - 10);
                    
                    // Marca de agua
                    pdf.setFontSize(48);
                    pdf.setTextColor(241, 245, 249);
                    pdf.text('LUXANALITICA', canvas.width / 2, canvas.height / 2, { align: 'center', angle: 45 });
                    
                    pdf.save(`Luxanalitica_OrgChart_${new Date().toISOString().slice(0,10)}.pdf`);
                    
                } catch (error) {
                    console.error('Error exportando PDF:', error);
                    alert('Error al generar el PDF. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            const handleExportJSON = () => {
                try {
                    const dataStr = JSON.stringify({
                        metadata: {
                            exportDate: new Date().toISOString(),
                            totalNodes: nodes.length,
                            totalDepartments: new Set(nodes.map(n => n.department)).size,
                            version: '1.0'
                        },
                        nodes: nodes
                    }, null, 2);
                    
                    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                    const link = document.createElement('a');
                    link.setAttribute('href', dataUri);
                    link.setAttribute('download', `Luxanalitica_Data_${new Date().toISOString().slice(0,10)}.json`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                } catch (error) {
                    console.error('Error exportando JSON:', error);
                    alert('Error al exportar JSON. Intenta nuevamente.');
                }
            };
            
            const handleExportImage = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 3,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false
                    });
                    
                    const link = document.createElement('a');
                    link.download = `Luxanalitica_OrgChart_${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                } catch (error) {
                    console.error('Error exportando imagen:', error);
                    alert('Error al exportar la imagen. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            const ExportCard = ({ icon, title, description, buttonText, onClick, color, disabled }) => (
                <div className="bg-white p-8 rounded-3xl border border-slate-200 card-shadow flex flex-col items-center text-center space-y-6 transition-transform hover:scale-[1.02] h-full">
                    <div className={`text-6xl ${color} mb-2`}>
                        <i className={`fas ${icon}`}></i>
                    </div>
                    
                    <div className="space-y-3 flex-1">
                        <h3 className="text-2xl font-black text-slate-800 tracking-tight">{title}</h3>
                        <p className="text-slate-500 text-sm leading-relaxed">{description}</p>
                    </div>
                    
                    <button
                        onClick={onClick}
                        disabled={disabled || exporting}
                        className={`w-full py-4 rounded-2xl font-black card-shadow transition-all hover:brightness-110 disabled:cursor-not-allowed disabled:opacity-50 flex items-center justify-center gap-2 ${
                            disabled ? 'bg-slate-400 text-white' : 
                            color === 'text-blue-600' ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white' :
                            color === 'text-red-600' ? 'bg-gradient-to-r from-red-600 to-red-700 text-white' :
                            color === 'text-emerald-600' ? 'bg-gradient-to-r from-emerald-600 to-green-600 text-white' :
                            'bg-gradient-to-r from-amber-600 to-orange-600 text-white'
                        }`}
                    >
                        {exporting && <i className="fas fa-spinner fa-spin"></i>}
                        {buttonText}
                    </button>
                </div>
            );
            
            return (
                <div className="p-6 md:p-12 h-full bg-gradient-to-b from-slate-50 to-blue-50/30 flex flex-col items-center justify-center overflow-y-auto scrollbar-hide">
                    <div className="max-w-6xl w-full space-y-10">
                        {/* Encabezado */}
                        <div className="text-center space-y-4">
                            <h2 className="text-4xl font-black text-slate-900">Exportar Reportes Maestros</h2>
                            <p className="text-slate-600 max-w-2xl mx-auto">
                                Genera informes ejecutivos, comparte la estructura organizacional o realiza auditorías con nuestros formatos profesionales.
                            </p>
                        </div>
                        
                        {/* Tarjetas de exportación */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">
                            <ExportCard
                                icon="fa-file-excel"
                                title="Base de Datos (Excel)"
                                description="Exporta toda la estructura con todos los KPIs en formato Excel compatible con sistemas de RRHH, Power BI y análisis avanzado."
                                buttonText="Descargar Excel"
                                onClick={handleExportExcel}
                                color="text-emerald-600"
                            />
                            
                            <ExportCard
                                icon="fa-file-pdf"
                                title="Reporte Ejecutivo (PDF)"
                                description="Genera un informe profesional en PDF con la estructura organizacional, análisis de riesgo y gráficos ejecutivos."
                                buttonText={exporting ? "Generando PDF..." : "Generar PDF"}
                                onClick={handleExportPDF}
                                color="text-red-600"
                                disabled={exporting}
                            />
                        </div>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <ExportCard
                                icon="fa-file-code"
                                title="Datos Estructurados (JSON)"
                                description="Exporta la información en formato JSON para integración con APIs, aplicaciones personalizadas o análisis de datos avanzado."
                                buttonText="Descargar JSON"
                                onClick={handleExportJSON}
                                color="text-amber-600"
                            />
                            
                            <ExportCard
                                icon="fa-file-image"
                                title="Imagen del Organigrama"
                                description="Captura una imagen de alta resolución del organigrama actual para presentaciones o documentación."
                                buttonText={exporting ? "Generando Imagen..." : "Exportar Imagen"}
                                onClick={handleExportImage}
                                color="text-blue-600"
                                disabled={exporting}
                            />
                        </div>
                        
                        {/* Panel de información */}
                        <div className="bg-gradient-to-r from-blue-50 to-cyan-50 p-6 rounded-3xl border border-blue-200 mt-8">
                            <div className="flex items-start gap-4">
                                <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center text-white text-xl">
                                    <i className="fas fa-lightbulb"></i>
                                </div>
                                <div>
                                    <h4 className="font-black text-slate-800 text-lg mb-2">Recomendaciones de Exportación</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div className="space-y-2">
                                            <p className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                                <i className="fas fa-check-circle text-emerald-500"></i>
                                                Para análisis financiero
                                            </p>
                                            <p className="text-xs text-slate-600">
                                                Usa el formato Excel para integrar con herramientas de presupuesto y control de costos.
                                            </p>
                                        </div>
                                        <div className="space-y-2">
                                            <p className="text-sm font-bold text-slate-700 flex items-center gap-2">
                                                <i className="fas fa-check-circle text-blue-500"></i>
                                                Para presentaciones ejecutivas
                                            </p>
                                            <p className="text-xs text-slate-600">
                                                El PDF profesional es ideal para compartir con dirección y stakeholders.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // COMPONENTE DE VISUALIZACIÓN (VisualTab)
        // ============================================
        
        const VisualTab = ({ nodes, viewMode, setViewMode }) => {
            const [selectedNodeId, setSelectedNodeId] = React.useState(null);
            const [exporting, setExporting] = React.useState(false);
            
            const handleExportPDF = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('landscape', 'px', [canvas.width, canvas.height]);
                    
                    // Título
                    pdf.setFontSize(24);
                    pdf.setTextColor(30, 41, 59);
                    pdf.text('Organigrama Estructural', canvas.width / 2, 40, { align: 'center' });
                    
                    pdf.setFontSize(12);
                    pdf.setTextColor(100, 116, 139);
                    pdf.text(`Empresa: Luxanalitica HR 360° | Fecha: ${new Date().toLocaleDateString()}`, canvas.width / 2, 60, { align: 'center' });
                    
                    // Agregar imagen
                    pdf.addImage(imgData, 'PNG', 20, 80, canvas.width - 40, canvas.height - 100);
                    
                    // Pie de página
                    pdf.setFontSize(10);
                    pdf.setTextColor(30, 41, 59);
                    pdf.text(`Total colaboradores: ${nodes.length} | Generado por Luxanalitica`, 20, canvas.height - 10);
                    
                    pdf.save(`Organigrama_${new Date().toISOString().slice(0,10)}.pdf`);
                    
                } catch (error) {
                    console.error('Error exportando PDF:', error);
                    alert('Error al generar el PDF. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            const handleExportImage = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 3,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false
                    });
                    
                    const link = document.createElement('a');
                    link.download = `Organigrama_${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                } catch (error) {
                    console.error('Error exportando imagen:', error);
                    alert('Error al exportar la imagen. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            return (
                <div className="flex flex-col h-full bg-gradient-to-b from-slate-50 to-blue-50/30">
                    {/* Barra de herramientas */}
                    <div className="p-4 bg-white border-b border-slate-200 flex flex-wrap justify-between items-center card-shadow z-10 gap-3">
                        <div className="flex items-center gap-4">
                            <div className="px-3 py-1.5 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg flex items-center gap-2">
                                <i className="fas fa-sitemap text-blue-600"></i>
                                <span className="text-xs font-black text-slate-800 uppercase tracking-widest">
                                    Vista Jerárquica Premium
                                </span>
                            </div>
                            
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setViewMode('vertical')}
                                    className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
                                        viewMode === 'vertical' 
                                            ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg' 
                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`}
                                >
                                    <i className="fas fa-arrows-alt-v mr-1"></i>
                                    Vertical
                                </button>
                                <button
                                    onClick={() => setViewMode('horizontal')}
                                    className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
                                        viewMode === 'horizontal' 
                                            ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg' 
                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`}
                                >
                                    <i className="fas fa-arrows-alt-h mr-1"></i>
                                    Horizontal
                                </button>
                            </div>
                        </div>
                        
                        <div className="flex gap-2">
                            <button
                                onClick={handleExportImage}
                                disabled={exporting}
                                className="px-4 py-2 bg-gradient-to-r from-slate-800 to-gray-800 text-white rounded-xl text-xs font-bold hover:from-slate-700 hover:to-gray-700 transition-all shadow-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {exporting ? (
                                    <i className="fas fa-spinner fa-spin"></i>
                                ) : (
                                    <i className="fas fa-file-image"></i>
                                )}
                                {exporting ? 'Exportando...' : 'Exportar Imagen'}
                            </button>
                            <button
                                onClick={handleExportPDF}
                                disabled={exporting}
                                className="px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl text-xs font-bold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg shadow-blue-500/20 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {exporting ? (
                                    <i className="fas fa-spinner fa-spin"></i>
                                ) : (
                                    <i className="fas fa-file-pdf"></i>
                                )}
                                {exporting ? 'Generando...' : 'Descargar PDF'}
                            </button>
                        </div>
                    </div>
                    
                    {/* Área de visualización */}
                    <div className="flex-1 relative overflow-hidden">
                        <OrgChartD3
                            nodes={nodes}
                            selectedNodeId={selectedNodeId}
                            onSelectNode={setSelectedNodeId}
                        />
                    </div>
                </div>
            );
        };
        
        // ============================================
        // COMPONENTES DE INTERFAZ
        // ============================================
        
        const Header = () => {
            const [currentTime, setCurrentTime] = React.useState(new Date());
            
            React.useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);
            
            const formattedDate = currentTime.toLocaleDateString('es-ES', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const formattedTime = currentTime.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            return (
                <header className="bg-white border-b border-slate-200 px-6 md:px-8 py-4 flex justify-between items-center card-shadow z-10">
                    <div className="flex items-center gap-4">
                        <div className="p-2 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl">
                            <i className="fas fa-project-diagram text-blue-600 text-2xl"></i>
                        </div>
                        <div>
                            <h1 className="text-xl font-bold text-slate-800">Luxanalitica HR 360°</h1>
                            <p className="text-xs text-slate-400 font-semibold tracking-wide uppercase">
                                Plataforma de Diseño y Análisis Organizacional
                            </p>
                        </div>
                    </div>
                    
                    <div className="hidden md:flex items-center gap-6">
                        <div className="text-right">
                            <div className="text-sm font-bold text-slate-700">{formattedDate}</div>
                            <div className="text-xs text-slate-400 font-mono">{formattedTime}</div>
                        </div>
                        <div className="h-10 w-[1px] bg-slate-200"></div>
                        <div className="flex items-center gap-3">
                            <div className="text-right">
                                <div className="text-xs font-bold text-slate-800">Admin User</div>
                                <div className="text-[10px] text-emerald-500 font-bold uppercase flex items-center gap-1">
                                    <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                                    Online
                                </div>
                            </div>
                            <div className="w-10 h-10 rounded-full bg-gradient-to-br from-slate-100 to-slate-50 border border-slate-200 flex items-center justify-center text-slate-400">
                                <i className="fas fa-user-circle text-2xl"></i>
                            </div>
                        </div>
                    </div>
                </header>
            );
        };
        
        const Sidebar = ({ isOpen, onToggle }) => {
            return (
                <div className={`${isOpen ? 'w-64' : 'w-20'} h-full bg-gradient-to-b from-slate-900 to-gray-900 text-white transition-all duration-300 flex flex-col shrink-0 z-20 card-shadow`}>
                    {/* Logo */}
                    <div className="p-6 flex items-center gap-4 overflow-hidden whitespace-nowrap border-b border-slate-800">
                        <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center shrink-0 shadow-lg">
                            <i className="fas fa-layer-group text-lg"></i>
                        </div>
                        {isOpen && (
                            <span className="font-bold text-xl tracking-tight">
                                <span className="text-gradient">Lux</span>analitica
                            </span>
                        )}
                    </div>
                    
                    {/* Navegación */}
                    <nav className="flex-1 mt-6 px-3 space-y-2">
                        <div className="flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg">
                            <i className="fas fa-sitemap w-6 text-center text-lg"></i>
                            {isOpen && <span className="font-medium">Organigrama</span>}
                        </div>
                        
                        <div className="flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all text-slate-400 hover:text-white hover:bg-slate-800">
                            <i className="fas fa-users w-6 text-center text-lg"></i>
                            {isOpen && <span className="font-medium">Plantilla</span>}
                        </div>
                        
                        <div className="flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all text-slate-400 hover:text-white hover:bg-slate-800">
                            <i className="fas fa-chart-line w-6 text-center text-lg"></i>
                            {isOpen && <span className="font-medium">KPIs HR</span>}
                        </div>
                        
                        <div className="flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all text-slate-400 hover:text-white hover:bg-slate-800">
                            <i className="fas fa-cog w-6 text-center text-lg"></i>
                            {isOpen && <span className="font-medium">Configuración</span>}
                        </div>
                    </nav>
                    
                    {/* Botón para colapsar/expandir */}
                    <div className="p-4 border-t border-slate-800">
                        <button
                            onClick={onToggle}
                            className="w-full flex items-center justify-center p-3 rounded-xl hover:bg-slate-800 transition-colors"
                        >
                            <i className={`fas ${isOpen ? 'fa-chevron-left' : 'fa-chevron-right'}`}></i>
                        </button>
                    </div>
                </div>
            );
        };
        
        const TabNavigation = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'carga', label: 'Cargar Excel', icon: 'fa-cloud-upload-alt' },
                { id: 'diseno', label: 'Editor de Flujo', icon: 'fa-pencil-ruler' },
                { id: 'visualizacion', label: 'Vista Expandida', icon: 'fa-expand' },
                { id: 'analisis', label: 'HR Analytics 360°', icon: 'fa-chart-pie' },
                { id: 'exportacion', label: 'Exportar', icon: 'fa-file-download' },
            ];
            
            return (
                <div className="flex bg-white rounded-t-2xl border-t border-x border-slate-200 overflow-x-auto scrollbar-hide shrink-0 card-shadow">
                    {tabs.map((tab) => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex-1 min-w-[140px] py-4 px-6 flex items-center justify-center gap-3 transition-all duration-300 border-b-4 ${
                                activeTab === tab.id
                                    ? 'bg-gradient-to-b from-blue-50/80 to-white border-blue-600 text-blue-700 font-bold'
                                    : 'border-transparent text-slate-400 hover:text-slate-600 hover:bg-slate-50'
                            }`}
                        >
                            <i className={`fas ${tab.icon} text-lg`}></i>
                            <span className="text-sm whitespace-nowrap">{tab.label}</span>
                        </button>
                    ))}
                </div>
            );
        };
        
        // ============================================
        // COMPONENTE PRINCIPAL (App)
        // ============================================
        
        const App = () => {
            const [activeTab, setActiveTab] = React.useState('carga');
            const [nodes, setNodes] = React.useState([]);
            const [selectedNodeId, setSelectedNodeId] = React.useState(null);
            const [viewMode, setViewMode] = React.useState('vertical');
            const [isSidebarOpen, setIsSidebarOpen] = React.useState(true);
            const [showLegend, setShowLegend] = React.useState(() => {
                const saved = localStorage.getItem('luxanalitica_showLegend');
                return saved ? JSON.parse(saved) : true;
            });
            
            // Cargar datos guardados al iniciar
            React.useEffect(() => {
                const savedData = localStorage.getItem('luxanalitica_org_data');
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        if (Array.isArray(parsedData) && parsedData.length > 0) {
                            setNodes(parsedData);
                            setActiveTab('diseno');
                        }
                    } catch (error) {
                        console.error('Error al cargar datos guardados:', error);
                    }
                }
            }, []);
            
            // Guardar datos automáticamente
            React.useEffect(() => {
                if (nodes.length > 0) {
                    localStorage.setItem('luxanalitica_org_data', JSON.stringify(nodes));
                }
            }, [nodes]);
            
            // Guardar preferencia de leyenda
            React.useEffect(() => {
                localStorage.setItem('luxanalitica_showLegend', JSON.stringify(showLegend));
            }, [showLegend]);
            
            // Manejar actualización de nodo
            const handleUpdateNode = React.useCallback((updatedNode) => {
                setNodes(prev => prev.map(node => 
                    node.id === updatedNode.id ? updatedNode : node
                ));
            }, []);
            
            // Manejar agregar nodo
            const handleAddNode = React.useCallback((newNode) => {
                setNodes(prev => [...prev, newNode]);
                setSelectedNodeId(newNode.id);
            }, []);
            
            // Manejar eliminar nodo
            const handleDeleteNode = React.useCallback((nodeId) => {
                if (window.confirm('¿Estás seguro de eliminar este colaborador? Los subordinados quedarán sin jefe asignado.')) {
                    setNodes(prev => {
                        // Eliminar el nodo y actualizar parentId de sus subordinados
                        return prev
                            .filter(node => node.id !== nodeId)
                            .map(node => 
                                node.parentId === nodeId 
                                    ? { ...node, parentId: null }
                                    : node
                            );
                    });
                    setSelectedNodeId(null);
                }
            }, []);
            
            // Manejar importación de datos
            const handleImport = React.useCallback((importedNodes) => {
                setNodes(importedNodes);
                setActiveTab('diseno');
            }, []);
            
            // Componente de diseño (pestaña principal)
            const DesignTab = () => (
                <div className="flex h-full">
                    {/* Panel lateral de edición */}
                    <div className="w-80 xl:w-96 border-r border-slate-200 bg-gradient-to-b from-slate-50 to-blue-50/30 p-5 shrink-0 overflow-y-auto scrollbar-hide">
                        <NodeForm
                            selectedNode={nodes.find(n => n.id === selectedNodeId) || null}
                            nodes={nodes}
                            onUpdate={handleUpdateNode}
                            onAdd={handleAddNode}
                            onDelete={handleDeleteNode}
                            onCancel={() => setSelectedNodeId(null)}
                        />
                    </div>
                    
                    {/* Área de visualización principal */}
                    <div className="flex-1 relative">
                        <div className="absolute top-4 right-4 z-10 flex gap-2">
                            <button
                                onClick={() => setShowLegend(!showLegend)}
                                className="glass-effect p-3 rounded-2xl border border-slate-200 card-shadow text-slate-600 hover:text-blue-600 transition-colors"
                                title={showLegend ? "Ocultar leyenda" : "Mostrar leyenda"}
                            >
                                <i className={`fas ${showLegend ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                            </button>
                        </div>
                        
                        <OrgChartD3
                            nodes={nodes}
                            selectedNodeId={selectedNodeId}
                            onSelectNode={setSelectedNodeId}
                            showLegend={showLegend}
                        />
                    </div>
                </div>
            );
            
            return (
                <div className="flex h-screen w-screen overflow-hidden bg-slate-50">
                    {/* Sidebar */}
                    <Sidebar 
                        isOpen={isSidebarOpen} 
                        onToggle={() => setIsSidebarOpen(!isSidebarOpen)} 
                    />
                    
                    {/* Contenido principal */}
                    <div className="flex-1 flex flex-col min-w-0">
                        <Header />
                        
                        <div className="flex-1 flex flex-col p-4 md:p-6 overflow-hidden">
                            <TabNavigation 
                                activeTab={activeTab} 
                                setActiveTab={setActiveTab} 
                            />
                            
                            <div className="flex-1 bg-white rounded-b-2xl card-shadow border border-slate-200 overflow-hidden relative">
                                {activeTab === 'carga' && (
                                    <UploadTab onImport={handleImport} />
                                )}
                                
                                {activeTab === 'diseno' && (
                                    <DesignTab />
                                )}
                                
                                {activeTab === 'visualizacion' && (
                                    <VisualTab 
                                        nodes={nodes} 
                                        viewMode={viewMode}
                                        setViewMode={setViewMode}
                                    />
                                )}
                                
                                {activeTab === 'analisis' && (
                                    <AnalysisTab nodes={nodes} />
                                )}
                                
                                {activeTab === 'exportacion' && (
                                    <ExportTab nodes={nodes} />
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // ============================================
        // RENDERIZAR LA APLICACIÓN
        // ============================================
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XLS Luxanalitica - Estructura Organizacional Avanzada</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* ESTILOS EXISTENTES MANTENIDOS Y MEJORADOS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            position: relative;
            transition: margin-left 0.3s ease;
        }
        
        body.sidebar-expanded {
            margin-left: 280px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        /* SIDEBAR MENU - MEJORADO CON EXPLICACIONES */
        .sidebar {
            position: fixed;
            left: -250px;
            top: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #0d47a1 0%, #1565c0 100%);
            color: white;
            z-index: 1000;
            transition: left 0.3s ease;
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.2);
            overflow-y: auto;
            padding-top: 20px;
        }
        
        .sidebar.expanded {
            left: 0;
        }
        
        .sidebar-toggle {
            position: fixed;
            left: 20px;
            top: 20px;
            background: #1565c0;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            font-size: 1.5rem;
        }
        
        .sidebar-toggle:hover {
            background: #0d47a1;
            transform: scale(1.1);
        }
        
        .sidebar-header {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .sidebar-header h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .sidebar-header p {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .menu-items {
            padding: 0 15px;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 18px 20px;
            margin-bottom: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .menu-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        
        .menu-item.active {
            background: rgba(255, 255, 255, 0.15);
            border-left: 4px solid #ff9800;
            font-weight: 600;
        }
        
        .menu-item.active::after {
            content: '✓';
            position: absolute;
            right: 20px;
            color: #4caf50;
            font-weight: bold;
        }
        
        .menu-item i {
            font-size: 1.3rem;
            width: 30px;
            text-align: center;
        }
        
        .menu-item-text h4 {
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        
        .menu-item-text p {
            font-size: 0.85rem;
            opacity: 0.8;
            line-height: 1.4;
        }
        
        .menu-section {
            margin: 25px 0 15px 20px;
            font-size: 0.9rem;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sidebar-footer {
            padding: 20px;
            margin-top: 40px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
            opacity: 0.7;
            text-align: center;
        }
        
        /* HEADER Y PROGRESS BAR - MEJORADO CON EXPLICACIONES */
        header {
            background: linear-gradient(135deg, #0d47a1, #1565c0);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header-content {
            position: relative;
            z-index: 2;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            max-width: 900px;
            margin: 0 auto 20px;
        }
        
        .logo-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 1.2rem;
            backdrop-filter: blur(5px);
        }
        
        .header-time {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .progress-container {
            background-color: #e3f2fd;
            padding: 15px 30px;
            border-bottom: 1px solid #bbdefb;
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }
        
        .progress-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #bbdefb;
            z-index: 1;
        }
        
        .progress-bar {
            position: absolute;
            top: 20px;
            left: 0;
            height: 3px;
            background-color: #1565c0;
            z-index: 2;
            transition: width 0.5s ease;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 3;
            position: relative;
        }
        
        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #bbdefb;
            color: #0d47a1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            border: 3px solid #e3f2fd;
            transition: all 0.3s ease;
        }
        
        .step.active .step-circle {
            background-color: #1565c0;
            color: white;
            border-color: #1565c0;
            box-shadow: 0 0 0 5px rgba(21, 101, 192, 0.2);
        }
        
        .step.completed .step-circle {
            background-color: #0d47a1;
            color: white;
            border-color: #0d47a1;
        }
        
        .step-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #555;
        }
        
        .step.active .step-label {
            color: #1565c0;
        }
        
        .step-info {
            position: absolute;
            top: 70px;
            width: 200px;
            background: white;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 100;
            font-size: 0.8rem;
            color: #666;
            text-align: center;
        }
        
        .step:hover .step-info {
            opacity: 1;
            visibility: visible;
        }
        
        .main-content {
            padding: 30px;
        }
        
        /* ESTILOS PARA EL MÓDULO DE ESTRUCTURA ORGANIZACIONAL */
        .estructura-advanced-section {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Dashboard Header */
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e3f2fd;
        }
        
        .dashboard-title {
            color: #0d47a1;
            font-size: 2rem;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        /* Barra de herramientas */
        .toolbar {
            background: linear-gradient(135deg, #f0f7ff, #e3f2fd);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            border: 1px solid #bbdefb;
        }
        
        .tool-select {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #1565c0;
            background: white;
            color: #333;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .tool-select:hover {
            border-color: #0d47a1;
            box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.1);
        }
        
        /* Sistema de pestañas avanzado */
        .advanced-tabs {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-top: 20px;
        }
        
        .advanced-tabs .tabs-header {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            display: flex;
            padding: 0;
            border-radius: 0;
            overflow-x: auto;
        }
        
        .advanced-tabs .tab {
            flex: 1;
            min-width: 180px;
            padding: 20px 25px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            white-space: nowrap;
            position: relative;
        }
        
        .advanced-tabs .tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .advanced-tabs .tab.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border-bottom-color: #ff9800;
        }
        
        .tab-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
            animation: slideIn 0.3s ease;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Tarjetas de opciones de carga */
        .upload-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .upload-option-card {
            background: #f9fafc;
            border-radius: 12px;
            border: 2px solid #e3f2fd;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .upload-option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(21, 101, 192, 0.15);
            border-color: #1565c0;
        }
        
        .upload-option-header {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .upload-option-header i {
            font-size: 1.8rem;
        }
        
        .upload-option-header h4 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .upload-option-body {
            padding: 25px;
        }
        
        .format-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .format-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            border-radius: 8px;
            background: white;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .format-option:hover {
            background: #f0f7ff;
            border-color: #1565c0;
        }
        
        .format-option input[type="radio"] {
            margin: 0;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Área de carga de archivos */
        .file-upload-area {
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border: 2px dashed #1565c0;
        }
        
        .file-input-container {
            text-align: center;
            padding: 30px 20px;
        }
        
        .file-input-label {
            display: inline-block;
            background: linear-gradient(to right, #1565c0, #0d47a1);
            color: white;
            padding: 18px 40px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
        }
        
        .file-input-label:hover {
            background: linear-gradient(to right, #0d47a1, #08306b);
            transform: scale(1.05);
            box-shadow: 0 6px 18px rgba(21, 101, 192, 0.4);
        }
        
        .file-input {
            display: none;
        }
        
        .file-name {
            margin-top: 15px;
            font-size: 1rem;
            color: #1565c0;
            font-weight: 500;
        }
        
        /* Opciones avanzadas */
        .upload-advanced-options {
            margin-top: 20px;
            padding: 20px;
            background: #f0f7ff;
            border-radius: 8px;
            border-left: 4px solid #1565c0;
        }
        
        .upload-advanced-options h5 {
            margin: 0 0 15px 0;
            color: #0d47a1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .option-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .option-grid label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .option-grid label:hover {
            background: #e3f2fd;
        }
        
        .option-grid input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Vista previa de datos */
        .preview-panel {
            background: white;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            margin-top: 30px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .preview-header {
            background: linear-gradient(135deg, #1565c0, #0d47a1);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preview-header h4 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .preview-content {
            padding: 0;
        }
        
        .preview-tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .preview-tab {
            padding: 15px 25px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }
        
        .preview-tab:hover {
            background: #e0e0e0;
            color: #333;
        }
        
        .preview-tab.active {
            background: white;
            color: #1565c0;
            border-bottom-color: #1565c0;
        }
        
        .preview-body {
            padding: 25px;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .preview-section {
            display: none;
        }
        
        .preview-section.active {
            display: block;
        }
        
        /* Panel de diseño - COMPLETAMENTE CORREGIDO */
        .design-container {
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            gap: 20px;
            height: 700px;
        }
        
        .design-sidebar, .design-properties {
            background: #f9fafc;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e3f2fd;
            overflow-y: auto;
        }
        
        .design-main {
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            overflow: hidden;
        }
        
        .design-toolbar {
            background: #f5f5f5;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .tool-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            border: 1px solid #ddd;
            background: white;
            color: #555;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .tool-btn:hover {
            background: #f0f7ff;
            border-color: #1565c0;
            color: #1565c0;
        }
        
        .tool-btn.active {
            background: #1565c0;
            color: white;
            border-color: #1565c0;
        }
        
        .design-canvas {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #fafafa;
            min-height: 500px;
        }
        
        #orgChartDesign {
            width: 100%;
            height: 100%;
            min-height: 500px;
        }
        
        .design-statusbar {
            background: #f5f5f5;
            padding: 10px 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        /* Formularios */
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #1565c0;
            box-shadow: 0 0 0 3px rgba(21, 101, 192, 0.1);
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
            min-height: 40px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        
        .tag {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }
        
        .tag-remove {
            cursor: pointer;
            opacity: 0.7;
            font-size: 0.8rem;
        }
        
        .tag-remove:hover {
            opacity: 1;
        }
        
        .color-picker {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .color-picker input[type="color"] {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            padding: 0;
        }
        
        .color-preview {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            border: 2px solid #ddd;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .editor-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        
        .editor-actions button {
            flex: 1;
            padding: 12px;
        }
        
        /* Panel de relaciones */
        .relations-panel {
            margin-top: 30px;
        }
        
        #relationsList {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        /* Panel de propiedades */
        .properties-tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .prop-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }
        
        .prop-tab:hover {
            background: #e0e0e0;
            color: #333;
        }
        
        .prop-tab.active {
            background: white;
            color: #1565c0;
        }
        
        .prop-section {
            display: none;
        }
        
        .prop-section.active {
            display: block;
        }
        
        .prop-group {
            margin-bottom: 20px;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1565c0;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .checkbox-group label:hover {
            background: #f0f7ff;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Controles de visualización */
        .visualization-controls {
            background: linear-gradient(135deg, #f0f7ff, #e3f2fd);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .viz-control-group {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .viz-label {
            font-weight: 600;
            color: #0d47a1;
            font-size: 0.95rem;
        }
        
        .viz-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .viz-btn {
            padding: 10px 20px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
        }
        
        .viz-btn:hover {
            background: #f0f7ff;
            border-color: #1565c0;
            color: #1565c0;
        }
        
        .viz-btn.active {
            background: #1565c0;
            color: white;
            border-color: #1565c0;
        }
        
        .viz-select, .viz-search {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        .viz-search {
            min-width: 200px;
        }
        
        .visualization-container {
            margin-bottom: 30px;
        }
        
        #visualizationArea {
            width: 100%;
            height: 600px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            overflow: hidden;
        }
        
        /* Panel de información de visualización */
        .viz-info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .viz-info-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e3f2fd;
        }
        
        .viz-info-card h5 {
            margin: 0 0 15px 0;
            color: #0d47a1;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .viz-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .viz-stat {
            padding: 12px;
            background: #f9fafc;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .viz-stat span {
            color: #666;
            font-size: 0.9rem;
        }
        
        .viz-stat strong {
            color: #0d47a1;
            font-size: 1.2rem;
        }
        
        #selectedNodeInfo {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
        }
        
        /* Panel de análisis */
        .metrics-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e3f2fd;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            border-color: #1565c0;
        }
        
        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .metric-content {
            flex: 1;
        }
        
        .metric-content h5 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 0.95rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #0d47a1;
            margin-bottom: 5px;
            line-height: 1;
        }
        
        .metric-trend {
            font-size: 0.85rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .trend-up {
            color: #2e7d32;
            font-weight: 600;
        }
        
        .trend-down {
            color: #d32f2f;
            font-weight: 600;
        }
        
        .trend-neutral {
            color: #666;
            font-weight: 600;
        }
        
        /* Gráficos de análisis - MEJORADO CON GRÁFICOS FUNCIONALES */
        .charts-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin: 30px 0;
        }
        
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e3f2fd;
        }
        
        .chart-card h5 {
            margin: 0 0 20px 0;
            color: #0d47a1;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-container {
            height: 200px;
            position: relative;
        }
        
        /* Panel de problemas */
        .problems-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e3f2fd;
        }
        
        .problems-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
            padding-right: 10px;
        }
        
        .problem-item {
            padding: 15px;
            border-left: 4px solid #ff9800;
            background: #fff3e0;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .problem-item.error {
            border-left-color: #d32f2f;
            background: #ffebee;
        }
        
        .problem-item.warning {
            border-left-color: #ff9800;
            background: #fff3e0;
        }
        
        .problem-item.info {
            border-left-color: #2196f3;
            background: #e3f2fd;
        }
        
        .problem-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .problem-type {
            font-weight: 600;
            color: #333;
        }
        
        .problem-severity {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .problem-severity.error {
            background: #d32f2f;
            color: white;
        }
        
        .problem-severity.warning {
            background: #ff9800;
            color: white;
        }
        
        .problem-severity.info {
            background: #2196f3;
            color: white;
        }
        
        .problem-message {
            color: #666;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .problem-recommendation {
            color: #1565c0;
            font-style: italic;
            font-size: 0.9rem;
            padding: 8px;
            background: rgba(21, 101, 192, 0.05);
            border-radius: 6px;
            border-left: 3px solid #1565c0;
        }
        
        .analysis-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        /* Exportación - MEJORADO CON EXPORTACIÓN FUNCIONAL */
        .export-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .export-options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .export-option-card {
            background: #f9fafc;
            border-radius: 12px;
            border: 2px solid #e3f2fd;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .export-option-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(21, 101, 192, 0.15);
        }
        
        .export-option-header {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .export-option-header:nth-child(2) {
            background: linear-gradient(135deg, #f44336, #c62828);
        }
        
        .export-option-header:nth-child(3) {
            background: linear-gradient(135deg, #2196f3, #1565c0);
        }
        
        .export-option-body {
            padding: 25px;
        }
        
        .format-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }
        
        .size-options, .document-options, .data-options {
            margin: 20px 0;
        }
        
        .size-options h5, .document-options h5, .data-options h5 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1rem;
        }
        
        .export-preview-panel {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e3f2fd;
        }
        
        #exportPreview {
            min-height: 200px;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            text-align: center;
            background: #fafafa;
        }
        
        .export-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        /* Botones */
        .btn {
            display: inline-block;
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-align: center;
            text-decoration: none;
        }
        
        .btn-primary {
            background: linear-gradient(to right, #1565c0, #0d47a1);
            color: white;
            box-shadow: 0 4px 12px rgba(21, 101, 192, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, #0d47a1, #08306b);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(21, 101, 192, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(to right, #2e7d32, #1b5e20);
            color: white;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }
        
        .btn-success:hover {
            background: linear-gradient(to right, #1b5e20, #0d3c13);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(46, 125, 50, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(to right, #f57c00, #e65100);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 124, 0, 0.3);
        }
        
        .btn-warning:hover {
            background: linear-gradient(to right, #e65100, #bf360c);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(245, 124, 0, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(to right, #d32f2f, #b71c1c);
            color: white;
            box-shadow: 0 4px 12px rgba(211, 47, 47, 0.3);
        }
        
        .btn-danger:hover {
            background: linear-gradient(to right, #b71c1c, #8b0000);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(211, 47, 47, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, #78909c, #546e7a);
            color: white;
            box-shadow: 0 4px 12px rgba(120, 144, 156, 0.3);
        }
        
        .btn-secondary:hover {
            background: linear-gradient(to right, #607d8b, #455a64);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(120, 144, 156, 0.4);
        }
        
        .btn-info {
            background: linear-gradient(to right, #0288d1, #01579b);
            color: white;
            box-shadow: 0 4px 12px rgba(2, 136, 209, 0.3);
        }
        
        .btn-info:hover {
            background: linear-gradient(to right, #01579b, #003c6b);
            transform: translateY(-2px);
            box-shadow: 0 6px 18px rgba(2, 136, 209, 0.4);
        }
        
        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        
        .btn-block {
            width: 100%;
            display: block;
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .badge-warning {
            background-color: #fff3e0;
            color: #ef6c00;
        }
        
        .badge-danger {
            background-color: #ffebee;
            color: #c62828;
        }
        
        .badge-info {
            background-color: #e3f2fd;
            color: #1565c0;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            color: #546e7a;
            font-size: 0.95rem;
            border-top: 1px solid #e3f2fd;
            background-color: #f9fafc;
            border-radius: 0 0 15px 15px;
        }
        
        /* Loading */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #e3f2fd;
            border-top: 5px solid #1565c0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transform: translateX(120%);
            transition: transform 0.3s ease;
            max-width: 400px;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #f44336, #c62828);
        }
        
        .notification.warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #2196f3, #1565c0);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 9998;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalIn 0.3s ease;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .modal-title {
            color: #0d47a1;
            font-size: 1.5rem;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #666;
            cursor: pointer;
            padding: 5px;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .design-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .design-sidebar, .design-properties {
                height: 400px;
            }
        }
        
        @media (max-width: 768px) {
            body.sidebar-expanded {
                margin-left: 0;
            }
            
            .sidebar {
                width: 100%;
                left: -100%;
            }
            
            .sidebar.expanded {
                left: 0;
            }
            
            .sidebar-toggle {
                left: 10px;
                top: 10px;
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .upload-options-grid,
            .export-options-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid,
            .charts-panel {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .logo-badge, .header-time {
                position: relative;
                top: 0;
                margin: 10px 0;
                display: block;
                width: fit-content;
            }
            
            .visualization-controls,
            .analysis-actions,
            .export-actions {
                flex-direction: column;
                align-items: stretch;
            }
            
            .viz-control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .viz-search {
                width: 100%;
            }
            
            .advanced-tabs .tabs-header {
                flex-wrap: wrap;
            }
            
            .advanced-tabs .tab {
                min-width: 140px;
                padding: 15px 20px;
                font-size: 0.9rem;
            }
            
            .toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .design-statusbar {
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }
        }
        
        @media (max-width: 480px) {
            .main-content {
                padding: 15px;
            }
            
            .dashboard-title {
                font-size: 1.5rem;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
            
            .tab-content {
                padding: 20px;
            }
        }
        
        /* Nuevos estilos */
        .download-example {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
            padding: 8px 15px;
            background: #e3f2fd;
            color: #1565c0;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .download-example:hover {
            background: #bbdefb;
            transform: translateY(-2px);
        }
        
        .example-info {
            background: #f1f8e9;
            border-left: 4px solid #7cb342;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .example-info h5 {
            margin-top: 0;
            color: #33691e;
        }
        
        .test-all-btn {
            background: linear-gradient(to right, #9c27b0, #7b1fa2);
            color: white;
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.3);
        }
        
        .test-all-btn:hover {
            background: linear-gradient(to right, #7b1fa2, #6a1b9a);
        }
        
        .org-chart-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .org-chart-node:hover {
            filter: brightness(1.1);
            transform: scale(1.05);
        }
        
        .org-chart-link {
            stroke: #999;
            stroke-width: 2;
            fill: none;
        }
        
        .org-chart-text {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            pointer-events: none;
        }
        
        .example-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        .example-table th, .example-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        .example-table th {
            background-color: #f5f5f5;
            font-weight: 600;
        }
        
        .example-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        /* Estilos adicionales para visualización */
        .svg-container {
            width: 100%;
            height: 100%;
        }
        
        .node-selected {
            filter: drop-shadow(0 0 5px rgba(255, 193, 7, 0.8));
        }
        
        .export-preview-canvas {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .viz-tooltip {
            position: absolute;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            pointer-events: none;
            z-index: 1000;
            font-size: 12px;
            max-width: 300px;
        }
        
        /* Mejoras para el diseño del organigrama */
        .design-canvas-grid {
            background-image: 
                linear-gradient(to right, #f0f0f0 1px, transparent 1px),
                linear-gradient(to bottom, #f0f0f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        /* Tooltips informativos */
        .info-tooltip {
            display: inline-block;
            margin-left: 5px;
            color: #1565c0;
            cursor: help;
        }
        
        .help-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
        
        /* Mejoras de accesibilidad */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div id="loadingMessage" style="color: #1565c0; font-weight: 600; font-size: 1.1rem;"></div>
    </div>

    <!-- Notificaciones -->
    <div class="notification" id="notification"></div>

    <!-- Modal Generico -->
    <div class="modal" id="genericModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle"></h3>
                <button class="modal-close" id="modalClose">&times;</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- SIDEBAR MENU -->
    <div class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </div>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3><i class="fas fa-rocket"></i> Luxanalitica Suite</h3>
            <p>HR Analytics Platform</p>
        </div>
        
        <div class="menu-section">MÓDULOS PRINCIPALES</div>
        <div class="menu-items">
            <div class="menu-item" data-section="centro-datos">
                <i class="fas fa-database"></i>
                <div class="menu-item-text">
                    <h4>📂 Centro de Datos</h4>
                    <p>Donde todo comienza. Limpieza y validación de datos.</p>
                </div>
            </div>
            
            <div class="menu-item" data-section="analytics">
                <i class="fas fa-chart-bar"></i>
                <div class="menu-item-text">
                    <h4>📊 Tableros de Analytics</h4>
                    <p>Análisis descriptivo: demografía, compensaciones y rotación.</p>
                </div>
            </div>
            
            <div class="menu-item" data-section="kpis">
                <i class="fas fa-bullseye"></i>
                <div class="menu-item-text">
                    <h4>🎯 Planificador de KPIs y Bonos</h4>
                    <p>Configuración de reglas y simulador de pagos por desempeño.</p>
                </div>
            </div>
            
            <div class="menu-item active" data-section="estructura">
                <i class="fas fa-sitemap"></i>
                <div class="menu-item-text">
                    <h4>🕸️ Estructura Organizacional</h4>
                    <p>Organigramas interactivos y análisis de tramos de control.</p>
                </div>
            </div>
        </div>
        
        <div class="menu-section">HERRAMIENTAS</div>
        <div class="menu-items">
            <div class="menu-item" data-section="evaluacion">
                <i class="fas fa-360-degrees"></i>
                <div class="menu-item-text">
                    <h4>🔄 Evaluación 360°</h4>
                    <p>Generación de relaciones ascendentes y pares.</p>
                </div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <p>Versión 3.0 | Estructura Organizacional Avanzada</p>
            <p><i class="fas fa-lock"></i> Procesamiento 100% local</p>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="container">
        <header>
            <div class="header-time">
                <i class="fas fa-clock"></i>
                <span id="currentDateTime">Cargando fecha y hora...</span>
            </div>
            <div class="header-content">
                <h1><i class="fas fa-sitemap"></i> Estructura Organizacional Avanzada</h1>
                <p class="subtitle">Herramienta profesional para diseño, análisis y visualización de estructuras organizacionales jerárquicas</p>
                <div class="logo-badge">
                    <i class="fas fa-project-diagram"></i> ORG CHART ENGINE
                </div>
            </div>
        </header>
        
        <div class="progress-container">
            <div class="progress-steps">
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Cargar Datos</div>
                    <div class="step-info">Importa datos desde Excel o crea una estructura desde cero</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Diseñar</div>
                    <div class="step-info">Edita nodos, ajusta posiciones y personaliza la apariencia</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Visualizar</div>
                    <div class="step-info">Explora diferentes vistas y filtros de la estructura</div>
                </div>
                <div class="step" id="step4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Analizar</div>
                    <div class="step-info">Obtén métricas y detecta problemas estructurales</div>
                </div>
                <div class="step" id="step5">
                    <div class="step-circle">5</div>
                    <div class="step-label">Exportar</div>
                    <div class="step-info">Exporta en múltiples formatos para compartir o archivar</div>
                </div>
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- MÓDULO DE ESTRUCTURA ORGANIZACIONAL AVANZADA -->
            <div class="estructura-advanced-section" id="estructuraAdvancedSection">
                <div class="dashboard-header">
                    <h2 class="dashboard-title">
                        <i class="fas fa-network-wired"></i> Estructura Organizacional Avanzada
                        <button id="testAllBtn" class="btn test-all-btn btn-sm">
                            <i class="fas fa-vial"></i> Probar Todo
                        </button>
                    </h2>
                    <div id="estructuraStatus">
                        <span id="estructuraInfo">Modo: Carga | Nodos: 0 | Relaciones: 0</span>
                    </div>
                </div>

                <!-- Barra de herramientas superior -->
                <div class="toolbar">
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button id="quickLoadBtn" class="btn btn-primary" title="Cargar estructura de ejemplo completa">
                            <i class="fas fa-bolt"></i> Carga Rápida
                        </button>
                        <button id="importFromHRBtn" class="btn btn-success" title="Importar desde sistemas HR existentes">
                            <i class="fas fa-users"></i> Importar desde HR
                        </button>
                        <button id="autoGenerateBtn" class="btn btn-warning" title="Generar estructura aleatoria para pruebas">
                            <i class="fas fa-robot"></i> Generar Automático
                        </button>
                        <button id="saveStructureBtn" class="btn btn-info" title="Guardar estructura actual">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                    
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <span style="font-weight: 600; color: #0d47a1;">Modo:</span>
                        <select id="viewMode" class="tool-select" title="Selecciona el modo de visualización">
                            <option value="hierarchical">Jerárquico</option>
                            <option value="radial">Radial</option>
                            <option value="sunburst">Sunburst</option>
                            <option value="matrix">Matriz</option>
                        </select>
                        
                        <button id="toggleAdvanced" class="btn btn-secondary" title="Mostrar/ocultar opciones avanzadas">
                            <i class="fas fa-sliders-h"></i> Avanzado
                        </button>
                    </div>
                </div>

                <!-- Sistema de pestañas avanzado -->
                <div class="advanced-tabs">
                    <div class="tabs-header">
                        <div class="tab active" data-tab="carga" title="Cargar datos desde Excel, crear desde cero o importar">
                            <i class="fas fa-cloud-upload-alt"></i> Carga de Datos
                            <span class="tab-badge" id="cargaBadge">0</span>
                        </div>
                        <div class="tab" data-tab="diseno" title="Editar nodos, relaciones y personalizar la apariencia">
                            <i class="fas fa-pencil-ruler"></i> Diseño & Edición
                            <span class="tab-badge" id="disenoBadge">0</span>
                        </div>
                        <div class="tab" data-tab="visualizacion" title="Visualizar la estructura en diferentes formatos">
                            <i class="fas fa-chart-network"></i> Visualización
                            <span class="tab-badge" id="visualizacionBadge">0</span>
                        </div>
                        <div class="tab" data-tab="analisis" title="Analizar métricas y detectar problemas">
                            <i class="fas fa-chart-bar"></i> Análisis
                            <span class="tab-badge" id="analisisBadge">0</span>
                        </div>
                        <div class="tab" data-tab="exportacion" title="Exportar en múltiples formatos">
                            <i class="fas fa-file-export"></i> Exportación
                        </div>
                    </div>

                    <!-- Pestaña 1: Carga de Datos Avanzada -->
                    <div class="tab-content active" id="cargaTab">
                        <div class="upload-options-grid">
                            <!-- Opción 1: Carga desde Excel avanzada -->
                            <div class="upload-option-card">
                                <div class="upload-option-header">
                                    <i class="fas fa-file-excel"></i>
                                    <h4>Excel Estructura</h4>
                                </div>
                                <div class="upload-option-body">
                                    <p>Carga estructura desde Excel con múltiples formatos:</p>
                                    <div class="format-options">
                                        <label class="format-option">
                                            <input type="radio" name="excelFormat" value="simple" checked>
                                            <span>Simple (colaborador → jefe)</span>
                                            <a href="#" class="download-example" data-format="simple" title="Descargar plantilla de ejemplo">
                                                <i class="fas fa-download"></i> Ejemplo
                                            </a>
                                        </label>
                                        <label class="format-option">
                                            <input type="radio" name="excelFormat" value="matrix">
                                            <span>Matriz de Reportes</span>
                                            <a href="#" class="download-example" data-format="matrix" title="Descargar plantilla de ejemplo">
                                                <i class="fas fa-download"></i> Ejemplo
                                            </a>
                                        </label>
                                        <label class="format-option">
                                            <input type="radio" name="excelFormat" value="full">
                                            <span>Completo (todos los campos)</span>
                                            <a href="#" class="download-example" data-format="full" title="Descargar plantilla de ejemplo">
                                                <i class="fas fa-download"></i> Ejemplo
                                            </a>
                                        </label>
                                    </div>
                                    
                                    <div class="example-info">
                                        <h5><i class="fas fa-info-circle"></i> Formato Simple:</h5>
                                        <p>El formato más común. Solo necesitas las columnas: <strong>colaborador, nombre, jefe, cargo, departamento</strong>.</p>
                                        <table class="example-table">
                                            <thead>
                                                <tr>
                                                    <th>colaborador</th>
                                                    <th>nombre</th>
                                                    <th>jefe</th>
                                                    <th>cargo</th>
                                                    <th>departamento</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>CEO001</td>
                                                    <td>María González</td>
                                                    <td></td>
                                                    <td>CEO</td>
                                                    <td>Ejecutivo</td>
                                                </tr>
                                                <tr>
                                                    <td>DIR001</td>
                                                    <td>Carlos Rodríguez</td>
                                                    <td>CEO001</td>
                                                    <td>Director Finanzas</td>
                                                    <td>Finanzas</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="file-upload-area" id="excelUploadArea">
                                        <div class="file-input-container">
                                            <label for="estructuraFileInput" class="file-input-label">
                                                <i class="fas fa-file-upload"></i> Arrastra o selecciona archivo
                                            </label>
                                            <input type="file" id="estructuraFileInput" class="file-input" accept=".xlsx, .xls, .csv">
                                            <p class="file-name" id="estructuraFileName">Ningún archivo seleccionado</p>
                                        </div>
                                        
                                        <div class="upload-advanced-options" id="excelAdvancedOptions">
                                            <h5><i class="fas fa-cog"></i> Opciones Avanzadas</h5>
                                            <div class="option-grid">
                                                <label>
                                                    <input type="checkbox" id="autoDetectColumns" checked>
                                                    Auto-detectar columnas
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="validateHierarchy" checked>
                                                    Validar jerarquía
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="fixCycles">
                                                    Corregir ciclos automáticamente
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="mergeDuplicates">
                                                    Fusionar duplicados
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <button id="cargarExcelBtn" class="btn btn-success btn-block">
                                        <i class="fas fa-project-diagram"></i> Procesar Estructura
                                    </button>
                                    <p class="help-text">Los datos se procesan localmente en tu navegador. Nada se sube a servidores externos.</p>
                                </div>
                            </div>

                            <!-- Opción 2: Constructor rápido -->
                            <div class="upload-option-card">
                                <div class="upload-option-header">
                                    <i class="fas fa-bolt"></i>
                                    <h4>Constructor Rápido</h4>
                                </div>
                                <div class="upload-option-body">
                                    <p>Crea estructura rápidamente desde cero</p>
                                    
                                    <div class="quick-structure-options" style="margin: 20px 0;">
                                        <div class="form-group">
                                            <label>Plantillas Predefinidas</label>
                                            <select id="structurePreset" class="form-control">
                                                <option value="">Seleccionar plantilla</option>
                                                <option value="startup">Startup (5-20 personas)</option>
                                                <option value="medium">Empresa Mediana (50-100)</option>
                                                <option value="corporate">Corporación (100-500)</option>
                                                <option value="matrix">Estructura Matricial</option>
                                                <option value="flat">Estructura Plana</option>
                                            </select>
                                        </div>
                                        
                                        <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                                            <button id="generateRandomBtn" class="btn btn-secondary">
                                                <i class="fas fa-random"></i> Generar Aleatorio
                                            </button>
                                            <button id="createFromTextBtn" class="btn btn-secondary">
                                                <i class="fas fa-font"></i> Desde Texto
                                            </button>
                                            <button id="loadSampleBtn" class="btn btn-secondary">
                                                <i class="fas fa-vial"></i> Cargar Ejemplo Completo
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="example-info">
                                        <h5><i class="fas fa-lightbulb"></i> Recomendación:</h5>
                                        <p>Usa "Cargar Ejemplo Completo" para tener una estructura completa de prueba con 17 nodos y 16 relaciones que puedes editar, visualizar y exportar.</p>
                                    </div>
                                    <p class="help-text">Ideal para pruebas rápidas o cuando no tienes datos preparados.</p>
                                </div>
                            </div>

                            <!-- Opción 3: Importar desde datos existentes -->
                            <div class="upload-option-card">
                                <div class="upload-option-header">
                                    <i class="fas fa-database"></i>
                                    <h4>Datos Existentes</h4>
                                </div>
                                <div class="upload-option-body">
                                    <p>Utiliza datos ya cargados en el sistema</p>
                                    
                                    <div class="data-preview" style="margin: 20px 0;">
                                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                                            <div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                                                <div style="font-size: 1.2rem; font-weight: 700; color: #1565c0;" id="hrEmployeesCount">0</div>
                                                <div style="font-size: 0.85rem; color: #666;">Empleados</div>
                                            </div>
                                            <div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 8px;">
                                                <div style="font-size: 1.2rem; font-weight: 700; color: #7b1fa2;" id="hrRelationsCount">0</div>
                                                <div style="font-size: 0.85rem; color: #666;">Relaciones</div>
                                            </div>
                                            <div style="text-align: center; padding: 15px; background: #e8f5e9; border-radius: 8px;">
                                                <div style="font-size: 1.2rem; font-weight: 700; color: #2e7d32;" id="hrAreasCount">0</div>
                                                <div style="font-size: 0.85rem; color: #666;">Áreas</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="import-options">
                                        <h5><i class="fas fa-filter"></i> Filtros de Importación</h5>
                                        <div class="option-grid">
                                            <label>
                                                <input type="checkbox" id="importActiveOnly" checked>
                                                Solo activos
                                            </label>
                                            <label>
                                                <input type="checkbox" id="importWithManagers" checked>
                                                Con managers definidos
                                            </label>
                                            <label>
                                                <input type="checkbox" id="importPositions">
                                                Incluir posiciones
                                            </label>
                                            <label>
                                                <input type="checkbox" id="importDepartments">
                                                Incluir departamentos
                                            </label>
                                        </div>
                                    </div>
                                    
                                    <button id="importFromHRDataBtn" class="btn btn-primary btn-block">
                                        <i class="fas fa-sync-alt"></i> Sincronizar con HR
                                    </button>
                                    <p class="help-text">Simula importación desde sistemas HR. En producción, aquí se conectaría a tu base de datos.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panel de previsualización de datos -->
                        <div class="preview-panel" id="dataPreviewPanel" style="display: none;">
                            <div class="preview-header">
                                <h4><i class="fas fa-eye"></i> Previsualización de Datos</h4>
                                <button id="closePreviewBtn" class="btn btn-secondary btn-sm">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="preview-content">
                                <div class="preview-tabs">
                                    <button class="preview-tab active" data-preview="structure">Estructura</button>
                                    <button class="preview-tab" data-preview="hierarchy">Jerarquía</button>
                                    <button class="preview-tab" data-preview="problems">Problemas</button>
                                    <button class="preview-tab" data-preview="stats">Estadísticas</button>
                                </div>
                                
                                <div class="preview-body">
                                    <div id="structurePreview" class="preview-section active">
                                        <!-- Contenido dinámico -->
                                    </div>
                                    <div id="hierarchyPreview" class="preview-section">
                                        <!-- Contenido dinámico -->
                                    </div>
                                    <div id="problemsPreview" class="preview-section">
                                        <!-- Contenido dinámico -->
                                    </div>
                                    <div id="statsPreview" class="preview-section">
                                        <!-- Contenido dinámico -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña 2: Diseño & Edición - COMPLETAMENTE FUNCIONAL -->
                    <div class="tab-content" id="disenoTab">
                        <div class="design-container">
                            <!-- Panel izquierdo: Editor de nodos -->
                            <div class="design-sidebar">
                                <h4><i class="fas fa-edit"></i> Editor de Nodos</h4>
                                <p class="help-text">Haz clic en un nodo en el gráfico para editarlo aquí</p>
                                
                                <div class="node-editor">
                                    <div class="form-group">
                                        <label>ID del Nodo <span class="info-tooltip" title="Identificador único para el nodo. No puede cambiar una vez creado.">ⓘ</span></label>
                                        <input type="text" id="nodeId" class="form-control" placeholder="Ej: EMP001">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Nombre <span class="info-tooltip" title="Nombre completo de la persona">ⓘ</span></label>
                                        <input type="text" id="nodeName" class="form-control" placeholder="Nombre completo">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Cargo/Posición <span class="info-tooltip" title="Posición en la organización">ⓘ</span></label>
                                        <select id="nodePosition" class="form-control">
                                            <option value="">Seleccionar cargo</option>
                                            <option value="CEO">CEO/Director General</option>
                                            <option value="Director">Director</option>
                                            <option value="Gerente">Gerente</option>
                                            <option value="Supervisor">Supervisor</option>
                                            <option value="Analista">Analista</option>
                                            <option value="Especialista">Especialista</option>
                                            <option value="Asistente">Asistente</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Área/Departamento <span class="info-tooltip" title="Departamento al que pertenece">ⓘ</span></label>
                                        <div style="display: flex; gap: 5px;">
                                            <select id="nodeDepartment" class="form-control" style="flex: 1;">
                                                <option value="">Seleccionar área</option>
                                            </select>
                                            <button id="addDepartmentBtn" class="btn btn-secondary btn-sm" title="Agregar nuevo departamento">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Jefe Directo <span class="info-tooltip" title="Persona a la que reporta directamente">ⓘ</span></label>
                                        <select id="nodeManager" class="form-control">
                                            <option value="">Sin jefe (raíz)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Etiquetas <span class="info-tooltip" title="Etiquetas para filtrar y categorizar">ⓘ</span></label>
                                        <div id="tagsContainer" class="tags-container">
                                            <!-- Tags dinámicos -->
                                        </div>
                                        <input type="text" id="newTagInput" class="form-control" placeholder="Presiona Enter para añadir etiqueta">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Color del Nodo <span class="info-tooltip" title="Color para identificar visualmente el nodo">ⓘ</span></label>
                                        <div class="color-picker">
                                            <input type="color" id="nodeColor" value="#1565c0" title="Selecciona un color">
                                            <span id="colorPreview" class="color-preview"></span>
                                        </div>
                                    </div>
                                    
                                    <div class="editor-actions">
                                        <button id="addNodeBtn" class="btn btn-success" title="Crear nuevo nodo">
                                            <i class="fas fa-plus"></i> Agregar Nodo
                                        </button>
                                        <button id="updateNodeBtn" class="btn btn-primary" disabled title="Guardar cambios en el nodo seleccionado">
                                            <i class="fas fa-save"></i> Actualizar
                                        </button>
                                        <button id="deleteNodeBtn" class="btn btn-danger" disabled title="Eliminar nodo seleccionado">
                                            <i class="fas fa-trash"></i> Eliminar
                                        </button>
                                    </div>
                                    <p class="help-text">Tip: Arrastra nodos en el gráfico para reorganizar la estructura</p>
                                </div>
                                
                                <!-- Panel de relaciones -->
                                <div class="relations-panel">
                                    <h4><i class="fas fa-link"></i> Relaciones</h4>
                                    <div id="relationsList">
                                        <!-- Lista dinámica -->
                                    </div>
                                    <button id="addRelationBtn" class="btn btn-secondary btn-block" title="Crear nueva relación de reporte">
                                        <i class="fas fa-plus-circle"></i> Nueva Relación
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Panel central: Vista previa del organigrama -->
                            <div class="design-main">
                                <div class="design-toolbar">
                                    <div class="tool-group">
                                        <button id="zoomInBtn2" class="tool-btn" title="Zoom In (+)">
                                            <i class="fas fa-search-plus"></i>
                                        </button>
                                        <button id="zoomOutBtn2" class="tool-btn" title="Zoom Out (-)">
                                            <i class="fas fa-search-minus"></i>
                                        </button>
                                        <button id="fitViewBtn" class="tool-btn" title="Ajustar vista al contenido">
                                            <i class="fas fa-expand-arrows-alt"></i>
                                        </button>
                                        <button id="centerViewBtn" class="tool-btn" title="Centrar vista">
                                            <i class="fas fa-crosshairs"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="tool-group">
                                        <button id="toggleGridBtn" class="tool-btn active" title="Mostrar/Ocultar cuadrícula">
                                            <i class="fas fa-th"></i>
                                        </button>
                                        <button id="toggleLabelsBtn" class="tool-btn active" title="Mostrar/Ocultar etiquetas">
                                            <i class="fas fa-font"></i>
                                        </button>
                                        <button id="togglePhotosBtn" class="tool-btn" title="Mostrar/Ocultar fotos (próximamente)">
                                            <i class="fas fa-user-circle"></i>
                                        </button>
                                    </div>
                                    
                                    <div class="tool-group">
                                        <select id="layoutAlgorithm" class="tool-select" title="Algoritmo de distribución de nodos">
                                            <option value="tree">Árbol</option>
                                            <option value="cluster">Cluster</option>
                                            <option value="dag">DAG</option>
                                            <option value="force">Fuerza</option>
                                        </select>
                                        <button id="applyLayoutBtn" class="btn btn-primary btn-sm">
                                            Aplicar
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="design-canvas design-canvas-grid">
                                    <!-- Aquí se dibujará el organigrama -->
                                    <div id="orgChartDesign"></div>
                                </div>
                                
                                <!-- Barra de estado -->
                                <div class="design-statusbar">
                                    <span id="nodeCount">Nodos: 0</span>
                                    <span id="relationCount">Relaciones: 0</span>
                                    <span id="selectedNodeInfo">Seleccionado: Ninguno</span>
                                    <span id="canvasZoom">Zoom: 100%</span>
                                </div>
                            </div>
                            
                            <!-- Panel derecho: Propiedades y acciones -->
                            <div class="design-properties">
                                <h4><i class="fas fa-sliders-h"></i> Propiedades</h4>
                                
                                <div class="properties-tabs">
                                    <button class="prop-tab active" data-prop="node">Nodo</button>
                                    <button class="prop-tab" data-prop="style">Estilo</button>
                                    <button class="prop-tab" data-prop="export">Exportar</button>
                                </div>
                                
                                <div class="properties-content">
                                    <!-- Propiedades del nodo -->
                                    <div id="nodeProperties" class="prop-section active">
                                        <div class="prop-group">
                                            <label>Tamaño del nodo</label>
                                            <input type="range" id="nodeSize" min="80" max="200" value="120" class="slider">
                                            <span id="nodeSizeValue">120px</span>
                                        </div>
                                        
                                        <div class="prop-group">
                                            <label>Forma del nodo</label>
                                            <select id="nodeShape" class="form-control">
                                                <option value="rectangle">Rectángulo</option>
                                                <option value="circle">Círculo</option>
                                                <option value="rounded">Rectángulo redondeado</option>
                                                <option value="hexagon">Hexágono</option>
                                            </select>
                                        </div>
                                        
                                        <div class="prop-group">
                                            <label>Mostrar</label>
                                            <div class="checkbox-group">
                                                <label>
                                                    <input type="checkbox" id="showName" checked>
                                                    Nombre
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="showTitle" checked>
                                                    Cargo
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="showDepartment">
                                                    Departamento
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="showPhoto" disabled>
                                                    Foto (próximamente)
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Propiedades de estilo -->
                                    <div id="styleProperties" class="prop-section">
                                        <div class="prop-group">
                                            <label>Color del fondo</label>
                                            <input type="color" id="backgroundColor" value="#fafafa">
                                        </div>
                                        
                                        <div class="prop-group">
                                            <label>Color de los enlaces</label>
                                            <input type="color" id="linkColor" value="#999999">
                                        </div>
                                        
                                        <div class="prop-group">
                                            <label>Grosor de los enlaces</label>
                                            <input type="range" id="linkWidth" min="1" max="5" value="2" class="slider">
                                            <span id="linkWidthValue">2px</span>
                                        </div>
                                        
                                        <div class="prop-group">
                                            <label>Estilo de los enlaces</label>
                                            <select id="linkStyle" class="form-control">
                                                <option value="solid">Sólido</option>
                                                <option value="dashed">Discontinuo</option>
                                                <option value="dotted">Punteado</option>
                                            </select>
                                        </div>
                                        
                                        <button id="applyStyleBtn" class="btn btn-primary btn-block">
                                            <i class="fas fa-paint-brush"></i> Aplicar Estilo
                                        </button>
                                    </div>
                                    
                                    <!-- Propiedades de exportación -->
                                    <div id="exportProperties" class="prop-section">
                                        <div class="prop-group">
                                            <label>Tamaño de exportación</label>
                                            <select id="exportSize" class="form-control">
                                                <option value="A4">A4 (210x297mm)</option>
                                                <option value="A3">A3 (297x420mm)</option>
                                                <option value="custom">Personalizado</option>
                                            </select>
                                        </div>
                                        
                                        <div class="prop-group">
                                            <label>Formato</label>
                                            <div class="format-options">
                                                <label class="format-option">
                                                    <input type="radio" name="exportFormat" value="png" checked>
                                                    <span>PNG (Alta calidad)</span>
                                                </label>
                                                <label class="format-option">
                                                    <input type="radio" name="exportFormat" value="svg">
                                                    <span>SVG (Vectorial)</span>
                                                </label>
                                                <label class="format-option">
                                                    <input type="radio" name="exportFormat" value="pdf">
                                                    <span>PDF (Documento)</span>
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <div class="prop-group">
                                            <label>Calidad</label>
                                            <input type="range" id="exportQuality" min="1" max="10" value="8" class="slider">
                                            <span id="exportQualityValue">Alta (8/10)</span>
                                        </div>
                                        
                                        <button id="previewExportBtn" class="btn btn-secondary btn-block">
                                            <i class="fas fa-eye"></i> Vista Previa
                                        </button>
                                        <button id="exportNowBtn" class="btn btn-success btn-block">
                                            <i class="fas fa-download"></i> Exportar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña 3: Visualización Avanzada -->
                    <div class="tab-content" id="visualizacionTab">
                        <!-- Controles de visualización -->
                        <div class="visualization-controls">
                            <div class="viz-control-group">
                                <span class="viz-label">Vista:</span>
                                <div class="viz-buttons">
                                    <button class="viz-btn active" data-viz="hierarchical" title="Vista jerárquica tradicional">
                                        <i class="fas fa-sitemap"></i> Jerárquica
                                    </button>
                                    <button class="viz-btn" data-viz="radial" title="Vista circular centrada">
                                        <i class="fas fa-bullseye"></i> Radial
                                    </button>
                                    <button class="viz-btn" data-viz="sunburst" title="Vista de anillos concéntricos">
                                        <i class="fas fa-sun"></i> Sunburst
                                    </button>
                                    <button class="viz-btn" data-viz="treemap" title="Vista de áreas proporcionales">
                                        <i class="fas fa-th-large"></i> Treemap
                                    </button>
                                    <button class="viz-btn" data-viz="network" title="Vista de red interconectada">
                                        <i class="fas fa-project-diagram"></i> Red
                                    </button>
                                </div>
                            </div>
                            
                            <div class="viz-control-group">
                                <span class="viz-label">Filtros:</span>
                                <select id="filterDepartment" class="viz-select" title="Filtrar por departamento">
                                    <option value="">Todos los departamentos</option>
                                </select>
                                <select id="filterLevel" class="viz-select" title="Filtrar por nivel jerárquico">
                                    <option value="">Todos los niveles</option>
                                    <option value="1">Nivel 1 (Ejecutivo)</option>
                                    <option value="2">Nivel 2 (Directores)</option>
                                    <option value="3">Nivel 3 (Gerentes)</option>
                                    <option value="4">Nivel 4 (Supervisores)</option>
                                    <option value="5">Nivel 5 (Operativos)</option>
                                </select>
                                <input type="text" id="searchNode" class="viz-search" placeholder="Buscar persona..." title="Buscar por nombre o ID">
                            </div>
                            
                            <div class="viz-control-group">
                                <button id="animateBtn" class="btn btn-primary" title="Animación de la visualización">
                                    <i class="fas fa-play"></i> Animar
                                </button>
                                <button id="resetVizBtn" class="btn btn-secondary" title="Reiniciar vista">
                                    <i class="fas fa-redo"></i> Reiniciar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Contenedor principal de visualización -->
                        <div class="visualization-container">
                            <div id="visualizationArea">
                                <!-- Visualización se cargará aquí -->
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666; font-size: 1.1rem;">
                                    <div style="text-align: center;">
                                        <i class="fas fa-project-diagram" style="font-size: 3rem; margin-bottom: 20px; color: #1565c0;"></i>
                                        <p>Visualización de organigrama</p>
                                        <p>Carga datos primero para ver la visualización</p>
                                        <button id="loadForVisualization" class="btn btn-primary" style="margin-top: 20px;">
                                            <i class="fas fa-download"></i> Cargar Ejemplo
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Panel de información de visualización -->
                        <div class="viz-info-panel">
                            <div class="viz-info-card">
                                <h5><i class="fas fa-info-circle"></i> Información de la Vista</h5>
                                <div class="viz-stats">
                                    <div class="viz-stat">
                                        <span>Nodos visibles:</span>
                                        <strong id="visibleNodes">0</strong>
                                    </div>
                                    <div class="viz-stat">
                                        <span>Nivel máximo:</span>
                                        <strong id="maxLevel">0</strong>
                                    </div>
                                    <div class="viz-stat">
                                        <span>Ancho del span:</span>
                                        <strong id="spanWidth">0</strong>
                                    </div>
                                    <div class="viz-stat">
                                        <span>Profundidad:</span>
                                        <strong id="treeDepth">0</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="viz-info-card">
                                <h5><i class="fas fa-mouse-pointer"></i> Nodo Seleccionado</h5>
                                <div id="selectedNodeDetails">
                                    <p>Selecciona un nodo para ver detalles</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña 4: Análisis Avanzado -->
                    <div class="tab-content" id="analisisTab">
                        <div class="analysis-container">
                            <!-- Panel de métricas -->
                            <div class="metrics-panel">
                                <h4><i class="fas fa-chart-line"></i> Métricas de la Estructura</h4>
                                <p class="help-text">Métricas calculadas automáticamente basadas en tu estructura organizacional</p>
                                
                                <div class="metrics-grid">
                                    <div class="metric-card">
                                        <div class="metric-icon" style="background: #e3f2fd;">
                                            <i class="fas fa-layer-group" style="color: #1565c0;"></i>
                                        </div>
                                        <div class="metric-content">
                                            <h5>Niveles Jerárquicos <span class="info-tooltip" title="Número de niveles desde el CEO hasta el nivel más bajo">ⓘ</span></h5>
                                            <div class="metric-value" id="metricLevels">0</div>
                                            <div class="metric-trend">
                                                <span id="levelsTrend" class="trend-up">+0%</span>
                                                <span>vs. ideal</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="metric-card">
                                        <div class="metric-icon" style="background: #f3e5f5;">
                                            <i class="fas fa-expand-arrows-alt" style="color: #7b1fa2;"></i>
                                        </div>
                                        <div class="metric-content">
                                            <h5>Span de Control <span class="info-tooltip" title="Número promedio de subordinados por manager">ⓘ</span></h5>
                                            <div class="metric-value" id="metricSpan">0.0</div>
                                            <div class="metric-trend">
                                                <span id="spanTrend" class="trend-neutral">0%</span>
                                                <span>promedio</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="metric-card">
                                        <div class="metric-icon" style="background: #e8f5e9;">
                                            <i class="fas fa-balance-scale" style="color: #2e7d32;"></i>
                                        </div>
                                        <div class="metric-content">
                                            <h5>Balance Estructural <span class="info-tooltip" title="Indicador de balance entre niveles y departamentos">ⓘ</span></h5>
                                            <div class="metric-value" id="metricBalance">0%</div>
                                            <div class="metric-trend">
                                                <span id="balanceTrend" class="trend-down">-0%</span>
                                                <span>eficiencia</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="metric-card">
                                        <div class="metric-icon" style="background: #fff3e0;">
                                            <i class="fas fa-bolt" style="color: #ef6c00;"></i>
                                        </div>
                                        <div class="metric-content">
                                            <h5>Complejidad <span class="info-tooltip" title="Índice de complejidad de la estructura">ⓘ</span></h5>
                                            <div class="metric-value" id="metricComplexity">0</div>
                                            <div class="metric-trend">
                                                <span id="complexityTrend" class="trend-up">+0%</span>
                                                <span>índice</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Gráficos de análisis -->
                            <div class="charts-panel">
                                <div class="chart-card">
                                    <h5><i class="fas fa-chart-bar"></i> Distribución por Nivel <span class="info-tooltip" title="Cantidad de empleados por nivel jerárquico">ⓘ</span></h5>
                                    <div class="chart-container">
                                        <canvas id="levelDistributionChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="chart-card">
                                    <h5><i class="fas fa-chart-pie"></i> Span de Control <span class="info-tooltip" title="Distribución de managers por cantidad de subordinados">ⓘ</span></h5>
                                    <div class="chart-container">
                                        <canvas id="spanControlChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="chart-card">
                                    <h5><i class="fas fa-network-wired"></i> Densidad Organizacional <span class="info-tooltip" title="Densidad de relaciones en la estructura">ⓘ</span></h5>
                                    <div class="chart-container">
                                        <canvas id="densityChart"></canvas>
                                    </div>
                                </div>
                                
                                <div class="chart-card">
                                    <h5><i class="fas fa-chart-area"></i> Ratio de Supervisión <span class="info-tooltip" title="Evolución del ratio de supervisión por trimestre">ⓘ</span></h5>
                                    <div class="chart-container">
                                        <canvas id="supervisionChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Análisis de problemas -->
                            <div class="problems-panel">
                                <h4><i class="fas fa-exclamation-triangle"></i> Problemas Detectados</h4>
                                <p class="help-text">Problemas estructurales detectados automáticamente con recomendaciones</p>
                                <div id="problemsList" class="problems-list">
                                    <!-- Problemas se cargarán aquí -->
                                    <div class="problem-item info">
                                        <div class="problem-header">
                                            <span class="problem-type">Sin datos para analizar</span>
                                            <span class="problem-severity info">Info</span>
                                        </div>
                                        <div class="problem-message">Carga una estructura primero para ver el análisis</div>
                                    </div>
                                </div>
                                
                                <div class="analysis-actions">
                                    <button id="optimizeStructureBtn" class="btn btn-warning" title="Optimizar estructura automáticamente">
                                        <i class="fas fa-magic"></i> Optimizar Estructura
                                    </button>
                                    <button id="generateReportBtn" class="btn btn-primary" title="Generar reporte completo de análisis">
                                        <i class="fas fa-file-alt"></i> Generar Reporte
                                    </button>
                                    <button id="simulateChangesBtn" class="btn btn-success" title="Simular cambios en la estructura">
                                        <i class="fas fa-play-circle"></i> Simular Cambios
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pestaña 5: Exportación Avanzada -->
                    <div class="tab-content" id="exportacionTab">
                        <div class="export-container">
                            <div class="export-options-grid">
                                <!-- Exportar como imagen -->
                                <div class="export-option-card">
                                    <div class="export-option-header">
                                        <i class="fas fa-image"></i>
                                        <h4>Exportar como Imagen</h4>
                                    </div>
                                    <div class="export-option-body">
                                        <div class="format-selector">
                                            <label class="format-option">
                                                <input type="radio" name="imageFormat" value="png" checked>
                                                <span>PNG (Alta calidad)</span>
                                            </label>
                                            <label class="format-option">
                                                <input type="radio" name="imageFormat" value="svg">
                                                <span>SVG (Vectorial)</span>
                                            </label>
                                            <label class="format-option">
                                                <input type="radio" name="imageFormat" value="jpg">
                                                <span>JPG (Comprimido)</span>
                                            </label>
                                        </div>
                                        
                                        <div class="size-options">
                                            <h5>Tamaño</h5>
                                            <select id="imageSize" class="form-control">
                                                <option value="original">Tamaño original</option>
                                                <option value="A4">A4 (210x297mm)</option>
                                                <option value="A3">A3 (297x420mm)</option>
                                                <option value="custom">Personalizado</option>
                                            </select>
                                            
                                            <div id="customSizeOptions" style="display: none; margin-top: 10px;">
                                                <div style="display: flex; gap: 10px;">
                                                    <input type="number" id="customWidth" placeholder="Ancho (px)" min="100" max="5000" value="1920" style="flex: 1;">
                                                    <input type="number" id="customHeight" placeholder="Alto (px)" min="100" max="5000" value="1080" style="flex: 1;">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <button id="exportImageBtn" class="btn btn-success btn-block">
                                            <i class="fas fa-download"></i> Descargar Imagen
                                        </button>
                                        <p class="help-text">Perfecto para presentaciones, documentos y compartir en redes</p>
                                    </div>
                                </div>
                                
                                <!-- Exportar como documento -->
                                <div class="export-option-card">
                                    <div class="export-option-header">
                                        <i class="fas fa-file-pdf"></i>
                                        <h4>Exportar como Documento</h4>
                                    </div>
                                    <div class="export-option-body">
                                        <div class="format-selector">
                                            <label class="format-option">
                                                <input type="radio" name="documentFormat" value="pdf" checked>
                                                <span>PDF (Portable)</span>
                                            </label>
                                            <label class="format-option">
                                                <input type="radio" name="documentFormat" value="word">
                                                <span>Word (.docx)</span>
                                            </label>
                                            <label class="format-option">
                                                <input type="radio" name="documentFormat" value="html">
                                                <span>HTML Interactivo</span>
                                            </label>
                                        </div>
                                        
                                        <div class="document-options">
                                            <h5>Opciones del Documento</h5>
                                            <div class="checkbox-group">
                                                <label>
                                                    <input type="checkbox" id="includeStructure" checked>
                                                    Incluir estructura
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="includeAnalysis" checked>
                                                    Incluir análisis
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="includeCharts">
                                                    Incluir gráficos
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="includeRecommendations">
                                                    Incluir recomendaciones
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <button id="exportDocumentBtn" class="btn btn-danger btn-block">
                                            <i class="fas fa-file-download"></i> Generar Documento
                                        </button>
                                        <p class="help-text">Ideal para reportes formales, documentación y archivo</p>
                                    </div>
                                </div>
                                
                                <!-- Exportar datos -->
                                <div class="export-option-card">
                                    <div class="export-option-header">
                                        <i class="fas fa-database"></i>
                                        <h4>Exportar Datos</h4>
                                    </div>
                                    <div class="export-option-body">
                                        <div class="format-selector">
                                            <label class="format-option">
                                                <input type="radio" name="dataFormat" value="excel" checked>
                                                <span>Excel (.xlsx)</span>
                                            </label>
                                            <label class="format-option">
                                                <input type="radio" name="dataFormat" value="csv">
                                                <span>CSV</span>
                                            </label>
                                            <label class="format-option">
                                                <input type="radio" name="dataFormat" value="json">
                                                <span>JSON</span>
                                            </label>
                                        </div>
                                        
                                        <div class="data-options">
                                            <h5>Campos a Exportar</h5>
                                            <div class="checkbox-group">
                                                <label>
                                                    <input type="checkbox" id="exportId" checked>
                                                    ID
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="exportName" checked>
                                                    Nombre
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="exportPosition" checked>
                                                    Posición
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="exportDepartment" checked>
                                                    Departamento
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="exportManager">
                                                    Manager
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="exportLevel">
                                                    Nivel
                                                </label>
                                                <label>
                                                    <input type="checkbox" id="exportSubordinates">
                                                    Subordinados
                                                </label>
                                            </div>
                                        </div>
                                        
                                        <button id="exportDataBtn" class="btn btn-primary btn-block">
                                            <i class="fas fa-database"></i> Exportar Datos
                                        </button>
                                        <p class="help-text">Para importar en otros sistemas o análisis adicionales</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Vista previa de exportación -->
                            <div class="export-preview-panel">
                                <h4><i class="fas fa-eye"></i> Vista Previa de Exportación</h4>
                                <p class="help-text">Vista previa del resultado de exportación</p>
                                <div id="exportPreview">
                                    <p>Selecciona una opción de exportación para ver la vista previa</p>
                                    <p><small>Tip: Usa "Actualizar Vista Previa" después de cambiar opciones</small></p>
                                </div>
                                
                                <div class="export-actions">
                                    <button id="previewExportBtn2" class="btn btn-secondary">
                                        <i class="fas fa-search"></i> Actualizar Vista Previa
                                    </button>
                                    <button id="batchExportBtn" class="btn btn-warning">
                                        <i class="fas fa-tasks"></i> Exportación por Lotes
                                    </button>
                                    <button id="scheduleExportBtn" class="btn btn-info">
                                        <i class="fas fa-clock"></i> Programar Exportación
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p><strong>Luxanalitica - Estructura Organizacional Avanzada</strong> | Herramienta profesional para diseño y análisis de organigramas</p>
            <p style="margin-top: 10px;">Desarrollado con HTML, CSS, JavaScript, D3.js y Chart.js | Procesamiento 100% en el navegador</p>
            <p style="margin-top: 10px; font-size: 0.9rem; color: #78909c;">
                <i class="fas fa-shield-alt"></i> Seguridad: Todos los datos se procesan localmente en tu computadora
            </p>
        </div>
    </div>

    <script>
        // ==============================================
        // VARIABLES GLOBALES Y CONFIGURACIÓN
        // ==============================================
        
        // Variables de estado
        let estructuraAvanzada = {
            version: '3.0',
            metadata: {
                created: new Date(),
                lastModified: new Date(),
                author: 'Luxanalitica',
                totalRevisions: 0
            },
            nodes: new Map(),
            edges: new Map(),
            hierarchy: null,
            analyses: {},
            styles: {
                node: {
                    size: 120,
                    shape: 'rectangle',
                    color: '#1565c0',
                    borderColor: '#0d47a1',
                    borderWidth: 2,
                    fontColor: '#ffffff',
                    fontSize: 14,
                    showName: true,
                    showTitle: true,
                    showDepartment: false,
                    showPhoto: false
                },
                edge: {
                    color: '#999999',
                    width: 2,
                    style: 'solid',
                    arrow: true
                },
                layout: {
                    type: 'tree',
                    spacing: 100,
                    direction: 'vertical',
                    algorithm: 'tree'
                },
                backgroundColor: '#fafafa'
            },
            viewState: {
                zoom: 1,
                pan: { x: 0, y: 0 },
                selectedNode: null,
                selectedEdge: null,
                filter: null,
                mode: 'hierarchical',
                theme: 'light'
            }
        };
        
        // Variables para renderizado
        let orgChartRenderer = null;
        let forceSimulation = null;
        let currentVisualization = null;
        let charts = {};
        
        // Variables para el diseño
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let selectedNode = null;
        let selectedNodes = new Set();
        
        // ==============================================
        // FUNCIONES DE INICIALIZACIÓN
        // ==============================================
        
        // Inicializar la aplicación
        function initializeApp() {
            console.log("Inicializando Estructura Organizacional Avanzada v3.0");
            
            // 1. Inicializar fecha y hora
            updateCurrentDateTime();
            setInterval(updateCurrentDateTime, 1000);
            
            // 2. Configurar menú lateral
            initializeSidebar();
            
            // 3. Configurar eventos
            setupEventListeners();
            
            // 4. Mostrar la sección de estructura
            showEstructuraSection();
            
            // 5. Cargar ejemplo inicial
            setTimeout(() => {
                loadSampleStructure();
            }, 500);
            
            // 6. Inicializar tooltips de información
            initializeTooltips();
            
            console.log("Aplicación inicializada correctamente");
        }
        
        // Inicializar sidebar
        function initializeSidebar() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const menuItems = document.querySelectorAll('.menu-item');
            
            sidebarToggle.addEventListener('click', function() {
                const isExpanded = sidebar.classList.toggle('expanded');
                document.body.classList.toggle('sidebar-expanded', isExpanded);
                this.innerHTML = isExpanded ? '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
            });
            
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.dataset.section;
                    activateSection(section);
                });
            });
        }
        
        // Inicializar tooltips
        function initializeTooltips() {
            // Tooltips para elementos con título
            document.querySelectorAll('[title]').forEach(element => {
                element.addEventListener('mouseenter', function(e) {
                    const title = this.getAttribute('title');
                    if (title) {
                        const tooltip = document.createElement('div');
                        tooltip.className = 'viz-tooltip';
                        tooltip.textContent = title;
                        tooltip.style.left = (e.pageX + 10) + 'px';
                        tooltip.style.top = (e.pageY + 10) + 'px';
                        document.body.appendChild(tooltip);
                        
                        this._tooltip = tooltip;
                    }
                });
                
                element.addEventListener('mousemove', function(e) {
                    if (this._tooltip) {
                        this._tooltip.style.left = (e.pageX + 10) + 'px';
                        this._tooltip.style.top = (e.pageY + 10) + 'px';
                    }
                });
                
                element.addEventListener('mouseleave', function() {
                    if (this._tooltip) {
                        document.body.removeChild(this._tooltip);
                        delete this._tooltip;
                    }
                });
            });
        }
        
        // Activar sección
        function activateSection(section) {
            // Remover active de todos los items del menú
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Activar el item correspondiente
            document.querySelector(`.menu-item[data-section="${section}"]`).classList.add('active');
            
            // Mostrar sección correspondiente
            if (section === 'estructura') {
                showEstructuraSection();
            } else {
                // Para otras secciones, mostrar mensaje de construcción
                showConstructionMessage(section);
            }
        }
        
        // Mostrar sección de estructura
        function showEstructuraSection() {
            // Ocultar otras secciones si existen
            const otherSections = document.querySelectorAll('.upload-section, .config-section, .dashboard');
            otherSections.forEach(section => {
                if (section.style) section.style.display = 'none';
            });
            
            // Mostrar sección de estructura
            document.getElementById('estructuraAdvancedSection').style.display = 'block';
            
            // Actualizar barra de progreso
            updateProgress(1);
        }
        
        // Mostrar mensaje de construcción
        function showConstructionMessage(section) {
            showNotification('info', `La sección "${section}" está en desarrollo. Actualmente solo está disponible el módulo de Estructura Organizacional.`);
        }
        
        // Configurar eventos
        function setupEventListeners() {
            // Eventos de pestañas avanzadas
            document.querySelectorAll('.advanced-tabs .tab').forEach(tab => {
                tab.addEventListener('click', handleTabClick);
            });
            
            // Eventos de carga de archivos
            document.getElementById('estructuraFileInput').addEventListener('change', handleFileSelect);
            document.getElementById('cargarExcelBtn').addEventListener('click', processExcelFile);
            
            // Eventos de constructor rápido
            document.getElementById('generateRandomBtn').addEventListener('click', generateRandomStructure);
            document.getElementById('loadSampleBtn').addEventListener('click', loadSampleStructure);
            document.getElementById('importFromHRDataBtn').addEventListener('click', importFromHRData);
            document.getElementById('structurePreset').addEventListener('change', loadStructurePreset);
            document.getElementById('loadForVisualization').addEventListener('click', loadSampleStructure);
            
            // Eventos de descarga de ejemplos
            document.querySelectorAll('.download-example').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const format = this.dataset.format;
                    downloadExampleExcel(format);
                });
            });
            
            // Eventos de diseño
            document.getElementById('addNodeBtn').addEventListener('click', addNode);
            document.getElementById('updateNodeBtn').addEventListener('click', updateNode);
            document.getElementById('deleteNodeBtn').addEventListener('click', deleteNode);
            document.getElementById('addRelationBtn').addEventListener('click', addRelation);
            document.getElementById('addDepartmentBtn').addEventListener('click', addDepartment);
            document.getElementById('newTagInput').addEventListener('keypress', handleTagInput);
            
            // Eventos de visualización
            document.querySelectorAll('.viz-btn').forEach(btn => {
                btn.addEventListener('click', handleVizButtonClick);
            });
            
            document.getElementById('animateBtn').addEventListener('click', animateVisualization);
            document.getElementById('resetVizBtn').addEventListener('click', resetVisualization);
            
            // Eventos de análisis
            document.getElementById('optimizeStructureBtn').addEventListener('click', optimizeStructure);
            document.getElementById('generateReportBtn').addEventListener('click', generateAnalysisReport);
            document.getElementById('simulateChangesBtn').addEventListener('click', simulateChanges);
            
            // Eventos de exportación
            document.getElementById('exportImageBtn').addEventListener('click', exportAsImage);
            document.getElementById('exportDocumentBtn').addEventListener('click', exportAsDocument);
            document.getElementById('exportDataBtn').addEventListener('click', exportStructureData);
            document.getElementById('previewExportBtn2').addEventListener('click', updateExportPreview);
            document.getElementById('imageSize').addEventListener('change', handleImageSizeChange);
            
            // Eventos de estilo
            document.getElementById('applyStyleBtn').addEventListener('click', applyStyles);
            document.getElementById('applyLayoutBtn').addEventListener('click', applyLayout);
            document.getElementById('nodeShape').addEventListener('change', updateNodeShape);
            document.getElementById('backgroundColor').addEventListener('input', updateBackgroundColor);
            
            // Eventos de zoom y navegación
            document.getElementById('zoomInBtn2').addEventListener('click', () => zoomChart(1.2));
            document.getElementById('zoomOutBtn2').addEventListener('click', () => zoomChart(0.8));
            document.getElementById('fitViewBtn').addEventListener('click', fitView);
            document.getElementById('centerViewBtn').addEventListener('click', centerView);
            document.getElementById('toggleGridBtn').addEventListener('click', toggleGrid);
            document.getElementById('toggleLabelsBtn').addEventListener('click', toggleLabels);
            
            // Eventos de propiedades
            document.querySelectorAll('.prop-tab').forEach(tab => {
                tab.addEventListener('click', handlePropertyTabClick);
            });
            
            // Eventos de cambio de valor
            document.getElementById('nodeSize').addEventListener('input', updateNodeSizeValue);
            document.getElementById('linkWidth').addEventListener('input', updateLinkWidthValue);
            document.getElementById('exportQuality').addEventListener('input', updateExportQualityValue);
            document.getElementById('nodeColor').addEventListener('input', updateNodeColorPreview);
            document.getElementById('linkColor').addEventListener('input', updateLinkColor);
            document.getElementById('linkStyle').addEventListener('change', updateLinkStyle);
            
            // Eventos de checkbox
            document.getElementById('showName').addEventListener('change', updateNodeVisibility);
            document.getElementById('showTitle').addEventListener('change', updateNodeVisibility);
            document.getElementById('showDepartment').addEventListener('change', updateNodeVisibility);
            
            // Botón de probar todo
            document.getElementById('testAllBtn').addEventListener('click', testAllFunctionality);
            
            // Botones de carga rápida
            document.getElementById('quickLoadBtn').addEventListener('click', () => {
                loadSampleStructure();
                showNotification('success', 'Estructura de ejemplo cargada');
            });
            
            document.getElementById('autoGenerateBtn').addEventListener('click', generateRandomStructure);
            
            // Cerrar modal
            document.getElementById('modalClose').addEventListener('click', closeModal);
            
            // Cerrar modal al hacer clic fuera
            document.getElementById('genericModal').addEventListener('click', function(event) {
                if (event.target === this) {
                    closeModal();
                }
            });
            
            // Cerrar panel de previsualización
            document.getElementById('closePreviewBtn').addEventListener('click', function() {
                document.getElementById('dataPreviewPanel').style.display = 'none';
            });
            
            // Inicializar color preview
            updateNodeColorPreview();
            
            // Inicializar valores de UI
            updateNodeSizeValue();
            updateLinkWidthValue();
            updateExportQualityValue();
            
            // Evento para buscar nodos
            document.getElementById('searchNode').addEventListener('input', searchNodes);
            
            // Evento para filtros
            document.getElementById('filterDepartment').addEventListener('change', filterVisualization);
            document.getElementById('filterLevel').addEventListener('change', filterVisualization);
        }
        
        // ==============================================
        // FUNCIONES DE ESTRUCTURA DE DATOS
        // ==============================================
        
        // Descargar ejemplo de Excel
        function downloadExampleExcel(format) {
            let data = [];
            let fileName = 'estructura_ejemplo.xlsx';
            
            switch(format) {
                case 'simple':
                    data = [
                        ['colaborador', 'nombre', 'jefe', 'cargo', 'departamento'],
                        ['CEO001', 'María González', '', 'CEO', 'Ejecutivo'],
                        ['DIR001', 'Carlos Rodríguez', 'CEO001', 'Director Finanzas', 'Finanzas'],
                        ['DIR002', 'Ana Martínez', 'CEO001', 'Director Operaciones', 'Operaciones'],
                        ['GER001', 'Luis Fernández', 'DIR001', 'Gerente Contabilidad', 'Finanzas'],
                        ['GER002', 'Sofía Pérez', 'DIR002', 'Gerente Producción', 'Operaciones']
                    ];
                    fileName = 'estructura_simple_ejemplo.xlsx';
                    break;
                    
                case 'matrix':
                    data = [
                        ['id', 'name', 'manager_id', 'position', 'department', 'level'],
                        ['CEO001', 'CEO', '', 'CEO', 'Ejecutivo', 1],
                        ['DIR001', 'Director Finanzas', 'CEO001', 'Director', 'Finanzas', 2],
                        ['DIR002', 'Director Operaciones', 'CEO001', 'Director', 'Operaciones', 2],
                        ['GER001', 'Gerente Contabilidad', 'DIR001', 'Gerente', 'Finanzas', 3],
                        ['GER002', 'Gerente Producción', 'DIR002', 'Gerente', 'Operaciones', 3]
                    ];
                    fileName = 'estructura_matriz_ejemplo.xlsx';
                    break;
                    
                case 'full':
                    data = [
                        ['identifier', 'display_name', 'manager_identifier', 'title', 'department', 'level', 'email', 'location'],
                        ['CEO001', 'María González', '', 'CEO', 'Ejecutivo', 1, 'ceo@empresa.com', 'Sede Central'],
                        ['DIR001', 'Carlos Rodríguez', 'CEO001', 'Director Finanzas', 'Finanzas', 2, 'carlos@empresa.com', 'Sede Central'],
                        ['DIR002', 'Ana Martínez', 'CEO001', 'Director Operaciones', 'Operaciones', 2, 'ana@empresa.com', 'Planta 1'],
                        ['GER001', 'Luis Fernández', 'DIR001', 'Gerente Contabilidad', 'Finanzas', 3, 'luis@empresa.com', 'Sede Central'],
                        ['GER002', 'Sofía Pérez', 'DIR002', 'Gerente Producción', 'Operaciones', 3, 'sofia@empresa.com', 'Planta 1']
                    ];
                    fileName = 'estructura_completa_ejemplo.xlsx';
                    break;
            }
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Estructura");
            XLSX.writeFile(wb, fileName);
            
            showNotification('success', `Ejemplo ${format} descargado. Ábrelo en Excel para ver el formato.`);
        }
        
        // Cargar estructura desde Excel
        async function processExcelFile() {
            const fileInput = document.getElementById('estructuraFileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('warning', 'Por favor, selecciona un archivo primero');
                return;
            }
            
            showLoading('Procesando archivo Excel...');
            
            try {
                const data = await readExcelFile(file);
                const format = document.querySelector('input[name="excelFormat"]:checked').value;
                
                // Procesar datos según el formato
                const { nodes, edges } = processExcelData(data, format);
                
                // Actualizar estructura
                updateStructure(nodes, edges);
                
                // Actualizar UI
                updateUI();
                
                // Mostrar notificación
                showNotification('success', `Estructura cargada: ${nodes.length} nodos, ${edges.length} relaciones`);
                
                // Mostrar panel de previsualización
                showDataPreview(nodes, edges);
                
                // Cambiar a pestaña de diseño
                switchTab('diseno');
                
            } catch (error) {
                console.error('Error procesando archivo Excel:', error);
                showNotification('error', `Error: ${error.message || 'Formato de archivo no válido'}`);
            } finally {
                hideLoading();
            }
        }
        
        // Leer archivo Excel
        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        resolve(jsonData);
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        
        // Procesar datos de Excel
        function processExcelData(data, format) {
            const nodes = [];
            const edges = [];
            const nodeMap = new Map();
            
            // Si no hay datos, retornar vacío
            if (!data || data.length === 0) {
                return { nodes, edges };
            }
            
            // Obtener nombres de columnas del primer objeto
            const columns = Object.keys(data[0] || {});
            
            data.forEach((row, index) => {
                let nodeId, nodeName, managerId, title, department;
                
                // Determinar las columnas basado en el formato
                switch(format) {
                    case 'simple':
                        // Buscar columnas posibles
                        const idCol = columns.find(c => 
                            c.toLowerCase().includes('colaborador') || 
                            c.toLowerCase().includes('empleado') ||
                            c.toLowerCase().includes('id') ||
                            c === 'colaborador'
                        );
                        
                        const nameCol = columns.find(c => 
                            c.toLowerCase().includes('nombre') ||
                            c.toLowerCase().includes('name') ||
                            c === 'nombre'
                        );
                        
                        const managerCol = columns.find(c => 
                            c.toLowerCase().includes('jefe') ||
                            c.toLowerCase().includes('manager') ||
                            c.toLowerCase().includes('supervisor') ||
                            c === 'jefe'
                        );
                        
                        const titleCol = columns.find(c => 
                            c.toLowerCase().includes('cargo') ||
                            c.toLowerCase().includes('position') ||
                            c.toLowerCase().includes('title') ||
                            c === 'cargo'
                        );
                        
                        const deptCol = columns.find(c => 
                            c.toLowerCase().includes('departamento') ||
                            c.toLowerCase().includes('department') ||
                            c.toLowerCase().includes('area') ||
                            c === 'departamento'
                        );
                        
                        nodeId = row[idCol] || `EMP${index + 1}`;
                        nodeName = row[nameCol] || nodeId;
                        managerId = row[managerCol];
                        title = row[titleCol] || '';
                        department = row[deptCol] || '';
                        break;
                        
                    case 'matrix':
                        nodeId = row.id || row.employee_id || `EMP${index + 1}`;
                        nodeName = row.name || row.nombre || nodeId;
                        managerId = row.manager_id || row.reports_to;
                        title = row.position || row.title || row.cargo || '';
                        department = row.department || row.area || row.departamento || '';
                        break;
                        
                    case 'full':
                        nodeId = row.identifier || row.id || `EMP${index + 1}`;
                        nodeName = row.display_name || row.name || row.nombre || nodeId;
                        managerId = row.manager_identifier || row.manager_id;
                        title = row.title || row.position || row.cargo || '';
                        department = row.department || row.area || row.departamento || '';
                        break;
                }
                
                if (!nodeId) {
                    nodeId = `EMP${index + 1}`;
                }
                
                // Agregar nodo
                if (!nodeMap.has(nodeId)) {
                    nodes.push({
                        id: nodeId,
                        name: nodeName,
                        title: title,
                        department: department,
                        color: getRandomColor()
                    });
                    nodeMap.set(nodeId, true);
                }
                
                // Agregar relación si hay manager
                if (managerId && managerId !== nodeId && managerId !== '') {
                    const edgeId = `edge_${managerId}_${nodeId}`;
                    
                    // Evitar duplicados
                    if (!edges.find(e => e.id === edgeId)) {
                        edges.push({
                            id: edgeId,
                            source: managerId,
                            target: nodeId,
                            type: 'reports_to'
                        });
                    }
                    
                    // Asegurarse de que el manager también sea nodo
                    if (!nodeMap.has(managerId)) {
                        const managerRow = data.find(r => {
                            const rowId = r.identifier || r.id || r.colaborador;
                            return rowId === managerId;
                        });
                        
                        nodes.push({
                            id: managerId,
                            name: managerRow ? 
                                (managerRow.display_name || managerRow.name || managerRow.nombre || managerId) : 
                                managerId,
                            title: managerRow ? 
                                (managerRow.title || managerRow.position || managerRow.cargo || 'Manager') : 
                                'Manager',
                            department: managerRow ? 
                                (managerRow.department || managerRow.area || managerRow.departamento || '') : '',
                            color: getRandomColor()
                        });
                        nodeMap.set(managerId, true);
                    }
                }
            });
            
            return { nodes, edges };
        }
        
        // Actualizar estructura
        function updateStructure(nodes, edges) {
            // Limpiar estructura actual
            estructuraAvanzada.nodes.clear();
            estructuraAvanzada.edges.clear();
            
            // Agregar nodos
            nodes.forEach(node => {
                estructuraAvanzada.nodes.set(node.id, {
                    ...node,
                    children: [],
                    parents: [],
                    x: Math.random() * 800 - 400,
                    y: Math.random() * 600 - 300,
                    tags: node.tags || []
                });
            });
            
            // Agregar aristas y construir relaciones
            edges.forEach(edge => {
                estructuraAvanzada.edges.set(edge.id, edge);
                
                // Actualizar relaciones
                const sourceNode = estructuraAvanzada.nodes.get(edge.source);
                const targetNode = estructuraAvanzada.nodes.get(edge.target);
                
                if (sourceNode && targetNode) {
                    if (!sourceNode.children.includes(targetNode.id)) {
                        sourceNode.children.push(targetNode.id);
                    }
                    if (!targetNode.parents.includes(sourceNode.id)) {
                        targetNode.parents.push(sourceNode.id);
                    }
                }
            });
            
            // Actualizar metadatos
            estructuraAvanzada.metadata.lastModified = new Date();
            estructuraAvanzada.metadata.totalRevisions++;
            
            // Inicializar renderizador si no existe
            if (!orgChartRenderer) {
                initializeChartRenderer();
            } else {
                renderChart();
            }
            
            // Actualizar filtros
            updateFilters();
            
            // Realizar análisis
            performAnalysis();
            
            // Actualizar UI
            updateUI();
            
            // Actualizar export preview
            updateExportPreview();
        }
        
        // ==============================================
        // FUNCIONES DE VISUALIZACIÓN - COMPLETAMENTE FUNCIONALES
        // ==============================================
        
        // Inicializar renderizador de gráficos
        function initializeChartRenderer() {
            const container = document.getElementById('orgChartDesign');
            if (!container) return;
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            // Crear SVG
            const svg = d3.select('#orgChartDesign')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .attr('class', 'org-chart-svg');
            
            // Crear grupo principal
            const g = svg.append('g')
                .attr('class', 'main-group');
            
            // Configurar zoom
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                    updateZoomDisplay(event.transform.k);
                });
            
            svg.call(zoom);
            
            // Guardar renderizador
            orgChartRenderer = {
                svg: svg,
                g: g,
                zoom: zoom,
                width: width,
                height: height,
                container: container
            };
            
            // Renderizar gráfico inicial
            renderChart();
            
            console.log("Renderizador de gráficos inicializado");
        }
        
        // Renderizar gráfico - COMPLETAMENTE FUNCIONAL
        function renderChart() {
            if (!orgChartRenderer) {
                initializeChartRenderer();
                return;
            }
            
            const { g, width, height } = orgChartRenderer;
            
            // Limpiar gráfico anterior
            g.selectAll('*').remove();
            
            if (estructuraAvanzada.nodes.size === 0) {
                // Mostrar mensaje si no hay nodos
                g.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '16px')
                    .style('fill', '#666')
                    .text('No hay datos para mostrar. Carga una estructura primero.');
                return;
            }
            
            // Crear grupos para enlaces y nodos
            const linkGroup = g.append('g').attr('class', 'links');
            const nodeGroup = g.append('g').attr('class', 'nodes');
            
            // Convertir edges a array
            const edgesArray = Array.from(estructuraAvanzada.edges.values());
            
            // Dibujar enlaces
            const links = linkGroup.selectAll('.link')
                .data(edgesArray)
                .enter().append('path')
                .attr('class', 'link org-chart-link')
                .attr('d', d => {
                    const source = estructuraAvanzada.nodes.get(d.source);
                    const target = estructuraAvanzada.nodes.get(d.target);
                    if (!source || !target) return '';
                    
                    return `M${source.x},${source.y} L${target.x},${target.y}`;
                })
                .style('fill', 'none')
                .style('stroke', estructuraAvanzada.styles.edge.color)
                .style('stroke-width', estructuraAvanzada.styles.edge.width + 'px')
                .style('stroke-dasharray', () => {
                    switch(estructuraAvanzada.styles.edge.style) {
                        case 'dashed': return '5,5';
                        case 'dotted': return '2,2';
                        default: return 'none';
                    }
                });
            
            // Convertir nodes a array
            const nodesArray = Array.from(estructuraAvanzada.nodes.values());
            
            // Dibujar nodos
            const nodes = nodeGroup.selectAll('.node')
                .data(nodesArray)
                .enter().append('g')
                .attr('class', d => `node org-chart-node ${selectedNode && selectedNode.id === d.id ? 'node-selected' : ''}`)
                .attr('transform', d => `translate(${d.x},${d.y})`)
                .call(d3.drag()
                    .on('start', dragStarted)
                    .on('drag', dragged)
                    .on('end', dragEnded))
                .on('click', handleNodeClick);
            
            // Dibujar formas de nodos
            nodes.each(function(d) {
                const node = d3.select(this);
                const size = estructuraAvanzada.styles.node.size;
                const color = d.color || estructuraAvanzada.styles.node.color;
                
                // Dibujar forma según configuración
                switch(estructuraAvanzada.styles.node.shape) {
                    case 'circle':
                        node.append('circle')
                            .attr('r', size / 2)
                            .style('fill', color)
                            .style('stroke', estructuraAvanzada.styles.node.borderColor)
                            .style('stroke-width', estructuraAvanzada.styles.node.borderWidth + 'px');
                        break;
                        
                    case 'rounded':
                        node.append('rect')
                            .attr('width', size)
                            .attr('height', size * 0.6)
                            .attr('x', -size / 2)
                            .attr('y', -size * 0.3)
                            .attr('rx', 10)
                            .attr('ry', 10)
                            .style('fill', color)
                            .style('stroke', estructuraAvanzada.styles.node.borderColor)
                            .style('stroke-width', estructuraAvanzada.styles.node.borderWidth + 'px');
                        break;
                        
                    case 'hexagon':
                        const hexPoints = [];
                        for (let i = 0; i < 6; i++) {
                            const angle = (Math.PI / 3) * i;
                            const x = (size / 2) * Math.cos(angle);
                            const y = (size / 2) * Math.sin(angle);
                            hexPoints.push(`${x},${y}`);
                        }
                        node.append('polygon')
                            .attr('points', hexPoints.join(' '))
                            .style('fill', color)
                            .style('stroke', estructuraAvanzada.styles.node.borderColor)
                            .style('stroke-width', estructuraAvanzada.styles.node.borderWidth + 'px');
                        break;
                        
                    default: // rectangle
                        node.append('rect')
                            .attr('width', size)
                            .attr('height', size * 0.6)
                            .attr('x', -size / 2)
                            .attr('y', -size * 0.3)
                            .style('fill', color)
                            .style('stroke', estructuraAvanzada.styles.node.borderColor)
                            .style('stroke-width', estructuraAvanzada.styles.node.borderWidth + 'px');
                }
                
                // Agregar texto
                const textGroup = node.append('g').attr('class', 'org-chart-text');
                
                let textY = -size * 0.3 + 20;
                
                if (estructuraAvanzada.styles.node.showName) {
                    textGroup.append('text')
                        .attr('dy', textY)
                        .attr('text-anchor', 'middle')
                        .style('fill', estructuraAvanzada.styles.node.fontColor)
                        .style('font-size', estructuraAvanzada.styles.node.fontSize + 'px')
                        .style('font-weight', 'bold')
                        .style('pointer-events', 'none')
                        .text(d => d.name.length > 15 ? d.name.substring(0, 15) + '...' : d.name);
                    textY += 20;
                }
                
                if (d.title && estructuraAvanzada.styles.node.showTitle) {
                    textGroup.append('text')
                        .attr('dy', textY)
                        .attr('text-anchor', 'middle')
                        .style('fill', estructuraAvanzada.styles.node.fontColor)
                        .style('font-size', (estructuraAvanzada.styles.node.fontSize - 2) + 'px')
                        .style('pointer-events', 'none')
                        .text(d => d.title.length > 20 ? d.title.substring(0, 20) + '...' : d.title);
                    textY += 20;
                }
                
                if (d.department && estructuraAvanzada.styles.node.showDepartment) {
                    textGroup.append('text')
                        .attr('dy', textY)
                        .attr('text-anchor', 'middle')
                        .style('fill', estructuraAvanzada.styles.node.fontColor)
                        .style('font-size', (estructuraAvanzada.styles.node.fontSize - 4) + 'px')
                        .style('pointer-events', 'none')
                        .style('font-style', 'italic')
                        .text(d => d.department.length > 15 ? d.department.substring(0, 15) + '...' : d.department);
                }
            });
            
            // Ajustar vista después de un breve delay para que se rendericen los elementos
            setTimeout(fitView, 100);
            
            // Actualizar enlaces cuando se mueven los nodos
            nodes.on('drag', function() {
                updateLinks();
            });
        }
        
        // Funciones de drag and drop
        function dragStarted(event, d) {
            d3.select(this).raise().classed('active', true);
            d.x = event.x;
            d.y = event.y;
        }
        
        function dragged(event, d) {
            d.x = event.x;
            d.y = event.y;
            d3.select(this).attr('transform', `translate(${d.x},${d.y})`);
            updateLinks();
        }
        
        function dragEnded(event, d) {
            d3.select(this).classed('active', false);
        }
        
        // Actualizar enlaces
        function updateLinks() {
            if (!orgChartRenderer) return;
            
            orgChartRenderer.g.selectAll('.link')
                .attr('d', d => {
                    const source = estructuraAvanzada.nodes.get(d.source);
                    const target = estructuraAvanzada.nodes.get(d.target);
                    if (!source || !target) return '';
                    
                    return `M${source.x},${source.y} L${target.x},${target.y}`;
                });
        }
        
        // Manejar clic en nodo
        function handleNodeClick(event, d) {
            event.stopPropagation();
            
            // Actualizar nodo seleccionado
            selectedNode = d;
            estructuraAvanzada.viewState.selectedNode = d.id;
            
            // Actualizar formulario de edición
            updateNodeForm(d);
            
            // Actualizar UI
            updateSelectedNodeInfo(d);
            
            // Resaltar nodo seleccionado
            highlightSelectedNode(d.id);
            
            // Mostrar información en consola para debugging
            console.log('Nodo seleccionado:', d);
        }
        
        // ==============================================
        // FUNCIONES DE ANÁLISIS
        // ==============================================
        
        // Realizar análisis de estructura
        function performAnalysis() {
            console.log("Realizando análisis de estructura...");
            
            const analyses = {
                metrics: {},
                structuralIssues: [],
                recommendations: []
            };
            
            // Calcular métricas básicas
            analyses.metrics.totalNodes = estructuraAvanzada.nodes.size;
            analyses.metrics.totalEdges = estructuraAvanzada.edges.size;
            analyses.metrics.maxDepth = calculateMaxDepth();
            analyses.metrics.averageSpan = calculateAverageSpan();
            analyses.metrics.density = calculateDensity();
            analyses.metrics.balance = calculateBalance();
            
            // Detectar problemas estructurales
            detectStructuralIssues(analyses);
            
            // Generar recomendaciones
            generateRecommendations(analyses);
            
            // Guardar análisis
            estructuraAvanzada.analyses = analyses;
            
            // Actualizar UI de análisis
            updateAnalysisUI(analyses);
            
            // Actualizar gráficos
            createAnalysisCharts();
            
            return analyses;
        }
        
        // Calcular profundidad máxima
        function calculateMaxDepth() {
            let maxDepth = 0;
            
            // Encontrar nodos raíz
            const rootNodes = [];
            for (const [id, node] of estructuraAvanzada.nodes) {
                if (!node.parents || node.parents.length === 0) {
                    rootNodes.push(node);
                }
            }
            
            // Calcular profundidad para cada raíz
            rootNodes.forEach(root => {
                const depth = calculateNodeDepth(root.id, new Set());
                maxDepth = Math.max(maxDepth, depth);
            });
            
            return maxDepth;
        }
        
        // Calcular profundidad de nodo
        function calculateNodeDepth(nodeId, visited) {
            if (visited.has(nodeId)) return 0;
            visited.add(nodeId);
            
            const node = estructuraAvanzada.nodes.get(nodeId);
            if (!node || !node.children || node.children.length === 0) {
                return 1;
            }
            
            let maxChildDepth = 0;
            for (const childId of node.children) {
                const childDepth = calculateNodeDepth(childId, visited);
                maxChildDepth = Math.max(maxChildDepth, childDepth);
            }
            
            return maxChildDepth + 1;
        }
        
        // Calcular span promedio
        function calculateAverageSpan() {
            let totalSpan = 0;
            let managersCount = 0;
            
            for (const [id, node] of estructuraAvanzada.nodes) {
                if (node.children && node.children.length > 0) {
                    totalSpan += node.children.length;
                    managersCount++;
                }
            }
            
            return managersCount > 0 ? (totalSpan / managersCount).toFixed(2) : 0;
        }
        
        // Calcular densidad
        function calculateDensity() {
            const n = estructuraAvanzada.nodes.size;
            const maxEdges = n * (n - 1);
            return maxEdges > 0 ? ((estructuraAvanzada.edges.size / maxEdges) * 100).toFixed(2) : 0;
        }
        
        // Calcular balance
        function calculateBalance() {
            // Métrica simple de balance basada en distribución de niveles
            const levelCounts = {};
            for (const node of estructuraAvanzada.nodes.values()) {
                const level = calculateNodeLevelValue(node.id);
                levelCounts[level] = (levelCounts[level] || 0) + 1;
            }
            
            const levels = Object.values(levelCounts);
            if (levels.length <= 1) return 100;
            
            const avg = levels.reduce((a, b) => a + b, 0) / levels.length;
            const variance = levels.reduce((a, b) => a + Math.pow(b - avg, 2), 0) / levels.length;
            const balance = Math.max(0, 100 - (variance * 10));
            
            return Math.round(balance);
        }
        
        // Calcular nivel de nodo
        function calculateNodeLevelValue(nodeId) {
            const node = estructuraAvanzada.nodes.get(nodeId);
            if (!node || !node.parents || node.parents.length === 0) {
                return 1;
            }
            
            let maxParentLevel = 0;
            for (const parentId of node.parents) {
                const parentLevel = calculateNodeLevelValue(parentId) + 1;
                maxParentLevel = Math.max(maxParentLevel, parentLevel);
            }
            
            return maxParentLevel;
        }
        
        // Detectar problemas estructurales
        function detectStructuralIssues(analyses) {
            const issues = [];
            
            // 1. Verificar nodos sin jefe (excepto CEO)
            const nodesWithoutManager = [];
            for (const [id, node] of estructuraAvanzada.nodes) {
                if ((!node.parents || node.parents.length === 0) && 
                    !node.title?.toLowerCase().includes('ceo') &&
                    !node.title?.toLowerCase().includes('director general')) {
                    nodesWithoutManager.push(node.name);
                }
            }
            
            if (nodesWithoutManager.length > 1) {
                issues.push({
                    type: 'Nodos sin jefe',
                    severity: 'warning',
                    message: `${nodesWithoutManager.length} nodos no tienen jefe asignado: ${nodesWithoutManager.slice(0, 3).join(', ')}${nodesWithoutManager.length > 3 ? '...' : ''}`,
                    recommendation: 'Asigna un jefe a todos los nodos excepto al CEO/Director General.'
                });
            }
            
            // 2. Verificar span de control excesivo
            for (const [id, node] of estructuraAvanzada.nodes) {
                if (node.children && node.children.length > 10) {
                    issues.push({
                        type: 'Span de control alto',
                        severity: 'warning',
                        message: `${node.name} tiene ${node.children.length} subordinados directos.`,
                        recommendation: 'Considera dividir el equipo o agregar niveles intermedios.'
                    });
                }
            }
            
            // 3. Verificar jerarquía muy profunda
            const maxDepth = calculateMaxDepth();
            if (maxDepth > 6) {
                issues.push({
                    type: 'Jerarquía muy profunda',
                    severity: 'warning',
                    message: `La estructura tiene ${maxDepth} niveles jerárquicos.`,
                    recommendation: 'Considera aplanar la estructura para mejorar la comunicación.'
                });
            }
            
            // 4. Verificar nodos aislados
            const isolatedNodes = [];
            for (const [id, node] of estructuraAvanzada.nodes) {
                if ((!node.children || node.children.length === 0) && 
                    (!node.parents || node.parents.length === 0)) {
                    isolatedNodes.push(node.name);
                }
            }
            
            if (isolatedNodes.length > 0) {
                issues.push({
                    type: 'Nodos aislados',
                    severity: 'warning',
                    message: `${isolatedNodes.length} nodos no tienen relaciones: ${isolatedNodes.slice(0, 3).join(', ')}${isolatedNodes.length > 3 ? '...' : ''}`,
                    recommendation: 'Conecta los nodos aislados a la estructura principal.'
                });
            }
            
            analyses.structuralIssues = issues;
        }
        
        // Generar recomendaciones
        function generateRecommendations(analyses) {
            const recommendations = [];
            
            if (analyses.metrics.averageSpan < 3) {
                recommendations.push('El span de control promedio es bajo. Considera consolidar posiciones.');
            }
            
            if (analyses.metrics.averageSpan > 8) {
                recommendations.push('El span de control promedio es alto. Considera agregar niveles de supervisión.');
            }
            
            if (analyses.metrics.maxDepth > 5) {
                recommendations.push('La jerarquía es profunda. Considera aplanar la estructura organizacional.');
            }
            
            if (analyses.metrics.balance < 60) {
                recommendations.push('La estructura está desbalanceada. Considera redistribuir los equipos.');
            }
            
            analyses.recommendations = recommendations;
        }
        
        // ==============================================
        // FUNCIONES DE UI Y UTILIDADES - MEJORADAS
        // ==============================================
        
        // Actualizar UI
        function updateUI() {
            // Actualizar contadores
            updateCounters();
            
            // Actualizar formularios
            updateNodeForm();
            updateDepartmentSelect();
            updateManagerSelect();
            updateTagsContainer();
            
            // Actualizar gráfico
            renderChart();
            
            // Actualizar análisis si existe
            if (Object.keys(estructuraAvanzada.analyses).length > 0) {
                updateAnalysisUI(estructuraAvanzada.analyses);
            }
            
            // Actualizar filtros
            updateFilters();
            
            // Actualizar estado
            updateDesignStatusbar();
        }
        
        // Actualizar contadores
        function updateCounters() {
            const nodeCount = estructuraAvanzada.nodes.size;
            const edgeCount = estructuraAvanzada.edges.size;
            
            // Actualizar badges
            document.getElementById('cargaBadge').textContent = nodeCount;
            document.getElementById('disenoBadge').textContent = nodeCount;
            document.getElementById('visualizacionBadge').textContent = nodeCount;
            document.getElementById('analisisBadge').textContent = estructuraAvanzada.analyses.structuralIssues?.length || 0;
            
            // Actualizar barra de estado
            document.getElementById('nodeCount').textContent = `Nodos: ${nodeCount}`;
            document.getElementById('relationCount').textContent = `Relaciones: ${edgeCount}`;
            
            // Actualizar información de estructura
            document.getElementById('estructuraInfo').textContent = 
                `Modo: ${estructuraAvanzada.viewState.mode} | Nodos: ${nodeCount} | Relaciones: ${edgeCount}`;
        }
        
        // Actualizar formulario de nodo
        function updateNodeForm(node = null) {
            const nodeIdInput = document.getElementById('nodeId');
            const nodeNameInput = document.getElementById('nodeName');
            const nodePositionSelect = document.getElementById('nodePosition');
            const updateBtn = document.getElementById('updateNodeBtn');
            const deleteBtn = document.getElementById('deleteNodeBtn');
            
            if (node) {
                // Rellenar formulario con datos del nodo
                nodeIdInput.value = node.id;
                nodeNameInput.value = node.name;
                nodePositionSelect.value = node.title || '';
                document.getElementById('nodeDepartment').value = node.department || '';
                document.getElementById('nodeManager').value = node.parents?.[0] || '';
                document.getElementById('nodeColor').value = node.color || '#1565c0';
                updateNodeColorPreview();
                
                // Habilitar botones de actualización y eliminación
                updateBtn.disabled = false;
                deleteBtn.disabled = false;
                
                // Deshabilitar campo ID
                nodeIdInput.disabled = true;
            } else {
                // Limpiar formulario
                nodeIdInput.value = '';
                nodeNameInput.value = '';
                nodePositionSelect.value = '';
                document.getElementById('nodeDepartment').value = '';
                document.getElementById('nodeManager').value = '';
                document.getElementById('nodeColor').value = '#1565c0';
                updateNodeColorPreview();
                
                // Deshabilitar botones
                updateBtn.disabled = true;
                deleteBtn.disabled = true;
                
                // Habilitar campo ID
                nodeIdInput.disabled = false;
            }
        }
        
        // Actualizar select de departamentos
        function updateDepartmentSelect() {
            const select = document.getElementById('nodeDepartment');
            const departments = new Set();
            
            for (const node of estructuraAvanzada.nodes.values()) {
                if (node.department) {
                    departments.add(node.department);
                }
            }
            
            // Guardar valor actual
            const currentValue = select.value;
            
            // Limpiar opciones excepto la primera
            const options = select.options;
            while (options.length > 1) {
                select.remove(1);
            }
            
            // Agregar departamentos
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
            
            // Restaurar valor si existe
            if (currentValue && Array.from(departments).includes(currentValue)) {
                select.value = currentValue;
            }
        }
        
        // Actualizar select de managers
        function updateManagerSelect() {
            const select = document.getElementById('nodeManager');
            const currentValue = select.value;
            
            // Limpiar opciones excepto la primera
            const options = select.options;
            while (options.length > 1) {
                select.remove(1);
            }
            
            // Agregar nodos como opciones de manager
            for (const [id, node] of estructuraAvanzada.nodes) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${node.name} (${node.title || 'Sin cargo'})`;
                select.appendChild(option);
            }
            
            // Restaurar valor si existe
            if (currentValue && estructuraAvanzada.nodes.has(currentValue)) {
                select.value = currentValue;
            }
        }
        
        // Actualizar container de tags
        function updateTagsContainer() {
            const container = document.getElementById('tagsContainer');
            const node = selectedNode;
            
            container.innerHTML = '';
            
            if (node && node.tags && node.tags.length > 0) {
                node.tags.forEach(tag => {
                    const tagElement = document.createElement('span');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `${tag} <span class="tag-remove" data-tag="${tag}">&times;</span>`;
                    container.appendChild(tagElement);
                });
                
                // Agregar eventos para eliminar tags
                container.querySelectorAll('.tag-remove').forEach(removeBtn => {
                    removeBtn.addEventListener('click', function() {
                        const tagToRemove = this.dataset.tag;
                        removeTagFromNode(tagToRemove);
                    });
                });
            }
        }
        
        // Manejar input de tags
        function handleTagInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = document.getElementById('newTagInput');
                const tag = input.value.trim();
                
                if (tag && selectedNode) {
                    addTagToNode(tag);
                    input.value = '';
                }
            }
        }
        
        // Agregar tag a nodo
        function addTagToNode(tag) {
            if (!selectedNode) return;
            
            if (!selectedNode.tags) {
                selectedNode.tags = [];
            }
            
            if (!selectedNode.tags.includes(tag)) {
                selectedNode.tags.push(tag);
                updateTagsContainer();
                renderChart();
            }
        }
        
        // Remover tag de nodo
        function removeTagFromNode(tag) {
            if (!selectedNode || !selectedNode.tags) return;
            
            selectedNode.tags = selectedNode.tags.filter(t => t !== tag);
            updateTagsContainer();
            renderChart();
        }
        
        // ==============================================
        // FUNCIONES DE INTERACCIÓN
        // ==============================================
        
        // Manejar clic en pestañas
        function handleTabClick(event) {
            const tab = event.currentTarget;
            const tabId = tab.dataset.tab;
            
            // Remover active de todas las pestañas
            document.querySelectorAll('.advanced-tabs .tab').forEach(t => {
                t.classList.remove('active');
            });
            
            // Remover active de todos los contenidos
            document.querySelectorAll('.tab-content').forEach(c => {
                c.classList.remove('active');
            });
            
            // Activar pestaña clickeada
            tab.classList.add('active');
            
            // Mostrar contenido correspondiente
            document.getElementById(`${tabId}Tab`).classList.add('active');
            
            // Actualizar barra de progreso
            switch(tabId) {
                case 'carga':
                    updateProgress(1);
                    break;
                case 'diseno':
                    updateProgress(2);
                    break;
                case 'visualizacion':
                    updateProgress(3);
                    initializeVisualization();
                    break;
                case 'analisis':
                    updateProgress(4);
                    performAnalysis();
                    break;
                case 'exportacion':
                    updateProgress(5);
                    updateExportPreview();
                    break;
            }
        }
        
        // Manejar clic en botones de visualización
        function handleVizButtonClick(event) {
            const button = event.currentTarget;
            const vizType = button.dataset.viz;
            
            // Remover active de todos los botones
            document.querySelectorAll('.viz-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activar botón clickeado
            button.classList.add('active');
            
            // Cambiar modo de visualización
            estructuraAvanzada.viewState.mode = vizType;
            
            // Actualizar visualización
            updateVisualization();
        }
        
        // Manejar clic en pestañas de propiedades
        function handlePropertyTabClick(event) {
            const tab = event.currentTarget;
            const propType = tab.dataset.prop;
            
            // Remover active de todas las pestañas
            document.querySelectorAll('.prop-tab').forEach(t => {
                t.classList.remove('active');
            });
            
            // Remover active de todas las secciones
            document.querySelectorAll('.prop-section').forEach(s => {
                s.classList.remove('active');
            });
            
            // Activar pestaña clickeada
            tab.classList.add('active');
            
            // Mostrar sección correspondiente
            document.getElementById(`${propType}Properties`).classList.add('active');
        }
        
        // ==============================================
        // FUNCIONES DE MANEJO DE ARCHIVOS
        // ==============================================
        
        // Manejar selección de archivo
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                const fileSize = file.size > 1024 * 1024 
                    ? `${(file.size / (1024 * 1024)).toFixed(2)} MB` 
                    : `${(file.size / 1024).toFixed(2)} KB`;
                
                document.getElementById('estructuraFileName').textContent = 
                    `Archivo seleccionado: ${file.name} (${fileSize})`;
            }
        }
        
        // ==============================================
        // FUNCIONES DE DISEÑO Y EDICIÓN - COMPLETAMENTE FUNCIONALES
        // ==============================================
        
        // Agregar nodo
        function addNode() {
            const id = document.getElementById('nodeId').value.trim();
            const name = document.getElementById('nodeName').value.trim();
            const title = document.getElementById('nodePosition').value;
            const department = document.getElementById('nodeDepartment').value;
            const managerId = document.getElementById('nodeManager').value;
            const color = document.getElementById('nodeColor').value;
            
            if (!id) {
                showNotification('warning', 'El ID del nodo es requerido');
                return;
            }
            
            if (!name) {
                showNotification('warning', 'El nombre del nodo es requerido');
                return;
            }
            
            // Verificar si el nodo ya existe
            if (estructuraAvanzada.nodes.has(id)) {
                showNotification('error', `El nodo con ID "${id}" ya existe`);
                return;
            }
            
            // Crear nuevo nodo
            const newNode = {
                id: id,
                name: name,
                title: title,
                department: department,
                color: color,
                x: Math.random() * 400 - 200,
                y: Math.random() * 300 - 150,
                children: [],
                parents: [],
                tags: []
            };
            
            // Agregar nodo a la estructura
            estructuraAvanzada.nodes.set(id, newNode);
            
            // Agregar relación si hay manager
            if (managerId && managerId !== '') {
                const edgeId = `edge_${managerId}_${id}`;
                estructuraAvanzada.edges.set(edgeId, {
                    id: edgeId,
                    source: managerId,
                    target: id,
                    type: 'reports_to'
                });
                
                // Actualizar relaciones
                const managerNode = estructuraAvanzada.nodes.get(managerId);
                if (managerNode) {
                    managerNode.children.push(id);
                    newNode.parents.push(managerId);
                }
            }
            
            // Actualizar UI
            updateUI();
            
            // Seleccionar el nuevo nodo
            selectedNode = newNode;
            highlightSelectedNode(id);
            updateNodeForm(newNode);
            
            // Mostrar notificación
            showNotification('success', `Nodo "${name}" agregado correctamente`);
        }
        
        // Actualizar nodo
        function updateNode() {
            const id = document.getElementById('nodeId').value;
            const name = document.getElementById('nodeName').value.trim();
            const title = document.getElementById('nodePosition').value;
            const department = document.getElementById('nodeDepartment').value;
            const managerId = document.getElementById('nodeManager').value;
            const color = document.getElementById('nodeColor').value;
            
            if (!estructuraAvanzada.nodes.has(id)) {
                showNotification('error', 'El nodo no existe');
                return;
            }
            
            // Obtener nodo existente
            const node = estructuraAvanzada.nodes.get(id);
            
            // Actualizar propiedades
            node.name = name;
            node.title = title;
            node.department = department;
            node.color = color;
            
            // Actualizar relación con manager
            updateNodeManager(id, managerId);
            
            // Actualizar UI
            updateUI();
            
            // Mostrar notificación
            showNotification('success', `Nodo "${name}" actualizado correctamente`);
        }
        
        // Actualizar manager de un nodo
        function updateNodeManager(nodeId, newManagerId) {
            const node = estructuraAvanzada.nodes.get(nodeId);
            if (!node) return;
            
            // Remover relación anterior
            const oldManagerId = node.parents?.[0];
            if (oldManagerId) {
                const oldEdgeId = `edge_${oldManagerId}_${nodeId}`;
                estructuraAvanzada.edges.delete(oldEdgeId);
                
                // Remover de hijos del manager anterior
                const oldManager = estructuraAvanzada.nodes.get(oldManagerId);
                if (oldManager) {
                    oldManager.children = oldManager.children.filter(childId => childId !== nodeId);
                }
                
                node.parents = [];
            }
            
            // Agregar nueva relación si hay nuevo manager
            if (newManagerId && newManagerId !== nodeId && newManagerId !== '') {
                const newEdgeId = `edge_${newManagerId}_${nodeId}`;
                estructuraAvanzada.edges.set(newEdgeId, {
                    id: newEdgeId,
                    source: newManagerId,
                    target: nodeId,
                    type: 'reports_to'
                });
                
                // Actualizar relaciones
                const newManager = estructuraAvanzada.nodes.get(newManagerId);
                if (newManager) {
                    if (!newManager.children.includes(nodeId)) {
                        newManager.children.push(nodeId);
                    }
                    node.parents = [newManagerId];
                }
            }
        }
        
        // Eliminar nodo
        function deleteNode() {
            const id = document.getElementById('nodeId').value;
            
            if (!estructuraAvanzada.nodes.has(id)) {
                showNotification('error', 'El nodo no existe');
                return;
            }
            
            if (!confirm(`¿Estás seguro de eliminar el nodo "${id}"? Esta acción no se puede deshacer.`)) {
                return;
            }
            
            // Obtener el nodo antes de eliminarlo para el mensaje
            const nodeName = estructuraAvanzada.nodes.get(id).name;
            
            // Eliminar nodo
            estructuraAvanzada.nodes.delete(id);
            
            // Eliminar relaciones asociadas
            for (const [edgeId, edge] of estructuraAvanzada.edges) {
                if (edge.source === id || edge.target === id) {
                    estructuraAvanzada.edges.delete(edgeId);
                }
            }
            
            // Actualizar relaciones en otros nodos
            for (const node of estructuraAvanzada.nodes.values()) {
                node.children = node.children.filter(childId => childId !== id);
                node.parents = node.parents.filter(parentId => parentId !== id);
            }
            
            // Actualizar UI
            updateUI();
            
            // Limpiar formulario
            updateNodeForm();
            
            // Limpiar selección
            selectedNode = null;
            
            // Mostrar notificación
            showNotification('success', `Nodo "${nodeName}" eliminado correctamente`);
        }
        
        // Agregar relación
        function addRelation() {
            showModal('Agregar Relación', 
                `<div class="form-group">
                    <label>Nodo Origen (Jefe)</label>
                    <select id="relationSource" class="form-control">
                        <option value="">Seleccionar jefe</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Nodo Destino (Subordinado)</label>
                    <select id="relationTarget" class="form-control">
                        <option value="">Seleccionar subordinado</option>
                    </select>
                </div>`,
                [
                    { 
                        text: 'Agregar', 
                        action: () => {
                            const source = document.getElementById('relationSource').value;
                            const target = document.getElementById('relationTarget').value;
                            
                            if (!source || !target) {
                                showNotification('warning', 'Selecciona ambos nodos');
                                return;
                            }
                            
                            if (source === target) {
                                showNotification('error', 'Un nodo no puede ser jefe de sí mismo');
                                return;
                            }
                            
                            const edgeId = `edge_${source}_${target}`;
                            
                            if (estructuraAvanzada.edges.has(edgeId)) {
                                showNotification('warning', 'Esta relación ya existe');
                                return;
                            }
                            
                            // Agregar relación
                            estructuraAvanzada.edges.set(edgeId, {
                                id: edgeId,
                                source: source,
                                target: target,
                                type: 'reports_to'
                            });
                            
                            // Actualizar relaciones en nodos
                            const sourceNode = estructuraAvanzada.nodes.get(source);
                            const targetNode = estructuraAvanzada.nodes.get(target);
                            
                            if (sourceNode && targetNode) {
                                if (!sourceNode.children.includes(target)) {
                                    sourceNode.children.push(target);
                                }
                                if (!targetNode.parents.includes(source)) {
                                    targetNode.parents.push(source);
                                }
                            }
                            
                            updateUI();
                            closeModal();
                            showNotification('success', 'Relación agregada correctamente');
                        }
                    },
                    { text: 'Cancelar', action: 'close' }
                ]);
            
            // Llenar los selects
            const sourceSelect = document.getElementById('relationSource');
            const targetSelect = document.getElementById('relationTarget');
            
            // Limpiar opciones
            sourceSelect.innerHTML = '<option value="">Seleccionar jefe</option>';
            targetSelect.innerHTML = '<option value="">Seleccionar subordinado</option>';
            
            // Agregar nodos
            for (const [id, node] of estructuraAvanzada.nodes) {
                const option1 = document.createElement('option');
                option1.value = id;
                option1.textContent = `${node.name} (${id})`;
                sourceSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = id;
                option2.textContent = `${node.name} (${id})`;
                targetSelect.appendChild(option2);
            }
        }
        
        // Agregar departamento
        function addDepartment() {
            const departmentName = prompt('Ingresa el nombre del nuevo departamento:');
            if (departmentName && departmentName.trim()) {
                const select = document.getElementById('nodeDepartment');
                const option = document.createElement('option');
                option.value = departmentName.trim();
                option.textContent = departmentName.trim();
                select.appendChild(option);
                select.value = departmentName.trim();
            }
        }
        
        // ==============================================
        // FUNCIONES DE VISUALIZACIÓN AVANZADA
        // ==============================================
        
        // Inicializar visualización
        function initializeVisualization() {
            const container = document.getElementById('visualizationArea');
            if (!container) return;
            
            // Limpiar contenedor
            container.innerHTML = '';
            
            // Crear visualización según el modo actual
            switch(estructuraAvanzada.viewState.mode) {
                case 'hierarchical':
                    createHierarchicalVisualization(container);
                    break;
                case 'radial':
                    createRadialVisualization(container);
                    break;
                case 'sunburst':
                    createSunburstVisualization(container);
                    break;
                case 'treemap':
                    createTreemapVisualization(container);
                    break;
                case 'network':
                    createNetworkVisualization(container);
                    break;
                default:
                    createHierarchicalVisualization(container);
            }
            
            // Actualizar estadísticas de visualización
            updateVisualizationStats();
        }
        
        // Crear visualización jerárquica
        function createHierarchicalVisualization(container) {
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            if (estructuraAvanzada.nodes.size === 0) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '16px')
                    .style('fill', '#666')
                    .text('Carga datos primero para ver la visualización');
                return;
            }
            
            // Encontrar nodos raíz
            const rootNodes = [];
            for (const [id, node] of estructuraAvanzada.nodes) {
                if (!node.parents || node.parents.length === 0) {
                    rootNodes.push(node);
                }
            }
            
            if (rootNodes.length === 0) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '16px')
                    .style('fill', '#666')
                    .text('No hay nodos raíz en la estructura');
                return;
            }
            
            // Para simplificar, usar el primer nodo raíz
            const root = rootNodes[0];
            
            // Crear una jerarquía simplificada
            const rootHierarchy = {
                id: root.id,
                name: root.name,
                children: getChildrenHierarchy(root.id)
            };
            
            const hierarchy = d3.hierarchy(rootHierarchy);
            
            // Crear layout de árbol
            const treeLayout = d3.tree().size([height - 100, width - 200]);
            const treeData = treeLayout(hierarchy);
            
            // Dibujar enlaces
            svg.append('g')
                .selectAll('path')
                .data(treeData.links())
                .enter()
                .append('path')
                .attr('d', d3.linkHorizontal()
                    .x(d => d.y)
                    .y(d => d.x))
                .style('fill', 'none')
                .style('stroke', '#999')
                .style('stroke-width', 2);
            
            // Dibujar nodos
            const nodes = svg.append('g')
                .selectAll('g')
                .data(treeData.descendants())
                .enter()
                .append('g')
                .attr('transform', d => `translate(${d.y},${d.x})`);
            
            // Dibujar círculos
            nodes.append('circle')
                .attr('r', 10)
                .style('fill', d => {
                    const node = estructuraAvanzada.nodes.get(d.data.id);
                    return node?.color || '#1565c0';
                })
                .style('stroke', '#fff')
                .style('stroke-width', 2);
            
            // Agregar texto
            nodes.append('text')
                .attr('dy', '0.31em')
                .attr('x', d => d.children ? -15 : 15)
                .style('text-anchor', d => d.children ? 'end' : 'start')
                .style('font-size', '12px')
                .style('fill', '#333')
                .text(d => {
                    const node = estructuraAvanzada.nodes.get(d.data.id);
                    return node?.name || d.data.id;
                });
            
            currentVisualization = { type: 'hierarchical', svg: svg };
        }
        
        // Obtener jerarquía de hijos
        function getChildrenHierarchy(nodeId, visited = new Set()) {
            if (visited.has(nodeId)) return [];
            visited.add(nodeId);
            
            const node = estructuraAvanzada.nodes.get(nodeId);
            if (!node || !node.children || node.children.length === 0) {
                return [];
            }
            
            return node.children.map(childId => {
                const child = estructuraAvanzada.nodes.get(childId);
                return {
                    id: childId,
                    name: child?.name || childId,
                    children: getChildrenHierarchy(childId, visited)
                };
            });
        }
        
        // Crear visualización radial
        function createRadialVisualization(container) {
            const width = container.clientWidth;
            const height = container.clientHeight;
            const radius = Math.min(width, height) / 2 - 50;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2},${height / 2})`);
            
            if (estructuraAvanzada.nodes.size === 0) {
                svg.append('text')
                    .attr('text-anchor', 'middle')
                    .style('font-size', '16px')
                    .style('fill', '#666')
                    .text('Carga datos primero para ver la visualización');
                return;
            }
            
            // Distribuir nodos en círculo
            const nodesArray = Array.from(estructuraAvanzada.nodes.values());
            const angleStep = (2 * Math.PI) / nodesArray.length;
            
            // Dibujar nodos
            svg.selectAll('circle')
                .data(nodesArray)
                .enter()
                .append('circle')
                .attr('r', 8)
                .attr('cx', (d, i) => Math.cos(i * angleStep) * radius)
                .attr('cy', (d, i) => Math.sin(i * angleStep) * radius)
                .style('fill', d => d.color || '#1565c0')
                .style('stroke', '#fff')
                .style('stroke-width', 2);
            
            // Dibujar texto
            svg.selectAll('text')
                .data(nodesArray)
                .enter()
                .append('text')
                .attr('x', (d, i) => Math.cos(i * angleStep) * (radius + 20))
                .attr('y', (d, i) => Math.sin(i * angleStep) * (radius + 20))
                .attr('text-anchor', 'middle')
                .style('font-size', '10px')
                .style('fill', '#333')
                .text(d => d.name.substring(0, 15));
            
            currentVisualization = { type: 'radial', svg: svg };
        }
        
        // Crear visualización sunburst
        function createSunburstVisualization(container) {
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${width / 2},${height / 2})`);
            
            if (estructuraAvanzada.nodes.size === 0) {
                svg.append('text')
                    .attr('text-anchor', 'middle')
                    .style('font-size', '16px')
                    .style('fill', '#666')
                    .text('Carga datos primero para ver la visualización');
                return;
            }
            
            // Visualización simplificada - círculos concéntricos
            const levels = 3;
            const radiusStep = Math.min(width, height) / 2 / (levels + 1);
            
            for (let i = 1; i <= levels; i++) {
                svg.append('circle')
                    .attr('r', radiusStep * i)
                    .style('fill', 'none')
                    .style('stroke', '#ddd')
                    .style('stroke-width', 1);
            }
            
            // Dibujar nodos en diferentes niveles
            const nodesArray = Array.from(estructuraAvanzada.nodes.values());
            const nodesPerLevel = Math.ceil(nodesArray.length / levels);
            
            nodesArray.forEach((node, i) => {
                const level = Math.floor(i / nodesPerLevel) + 1;
                const angle = (i % nodesPerLevel) * (2 * Math.PI / nodesPerLevel);
                const radius = radiusStep * level;
                
                svg.append('circle')
                    .attr('cx', Math.cos(angle) * radius)
                    .attr('cy', Math.sin(angle) * radius)
                    .attr('r', 6)
                    .style('fill', node.color || '#1565c0')
                    .style('stroke', '#fff')
                    .style('stroke-width', 2);
            });
            
            currentVisualization = { type: 'sunburst', svg: svg };
        }
        
        // Crear visualización treemap
        function createTreemapVisualization(container) {
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            if (estructuraAvanzada.nodes.size === 0) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '16px')
                    .style('fill', '#666')
                    .text('Carga datos primero para ver la visualización');
                return;
            }
            
            // Visualización simplificada - grid de nodos
            const cols = Math.ceil(Math.sqrt(estructuraAvanzada.nodes.size));
            const rows = Math.ceil(estructuraAvanzada.nodes.size / cols);
            const cellWidth = width / cols;
            const cellHeight = height / rows;
            
            const nodesArray = Array.from(estructuraAvanzada.nodes.values());
            
            svg.selectAll('rect')
                .data(nodesArray)
                .enter()
                .append('rect')
                .attr('x', (d, i) => (i % cols) * cellWidth)
                .attr('y', (d, i) => Math.floor(i / cols) * cellHeight)
                .attr('width', cellWidth - 5)
                .attr('height', cellHeight - 5)
                .style('fill', d => d.color || '#1565c0')
                .style('stroke', '#fff')
                .style('stroke-width', 2);
            
            svg.selectAll('text')
                .data(nodesArray)
                .enter()
                .append('text')
                .attr('x', (d, i) => (i % cols) * cellWidth + cellWidth / 2)
                .attr('y', (d, i) => Math.floor(i / cols) * cellHeight + cellHeight / 2)
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .style('font-size', '10px')
                .style('fill', '#fff')
                .style('font-weight', 'bold')
                .text(d => d.name.substring(0, 10));
            
            currentVisualization = { type: 'treemap', svg: svg };
        }
        
        // Crear visualización de red
        function createNetworkVisualization(container) {
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            if (estructuraAvanzada.nodes.size === 0) {
                svg.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '16px')
                    .style('fill', '#666')
                    .text('Carga datos primero para ver la visualización');
                return;
            }
            
            // Usar fuerza para distribuir nodos
            const simulation = d3.forceSimulation(Array.from(estructuraAvanzada.nodes.values()))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('link', d3.forceLink(Array.from(estructuraAvanzada.edges.values()))
                    .id(d => d.id)
                    .distance(100));
            
            // Dibujar enlaces
            const links = svg.append('g')
                .selectAll('line')
                .data(Array.from(estructuraAvanzada.edges.values()))
                .enter()
                .append('line')
                .style('stroke', '#999')
                .style('stroke-width', 2);
            
            // Dibujar nodos
            const nodes = svg.append('g')
                .selectAll('circle')
                .data(Array.from(estructuraAvanzada.nodes.values()))
                .enter()
                .append('circle')
                .attr('r', 10)
                .style('fill', d => d.color || '#1565c0')
                .style('stroke', '#fff')
                .style('stroke-width', 2)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', draggedNetwork)
                    .on('end', dragended));
            
            // Agregar texto
            const labels = svg.append('g')
                .selectAll('text')
                .data(Array.from(estructuraAvanzada.nodes.values()))
                .enter()
                .append('text')
                .text(d => d.name.substring(0, 10))
                .style('font-size', '10px')
                .style('fill', '#333');
            
            // Actualizar posiciones
            simulation.on('tick', () => {
                links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                nodes
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                labels
                    .attr('x', d => d.x + 15)
                    .attr('y', d => d.y + 5);
            });
            
            // Funciones de drag para la red
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function draggedNetwork(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            currentVisualization = { 
                type: 'network', 
                svg: svg,
                simulation: simulation 
            };
        }
        
        // Actualizar visualización
        function updateVisualization() {
            if (!currentVisualization) return;
            
            const container = document.getElementById('visualizationArea');
            container.innerHTML = '';
            initializeVisualization();
        }
        
        // Animación de visualización
        function animateVisualization() {
            showNotification('info', 'Animación de visualización iniciada');
            
            if (currentVisualization && currentVisualization.svg) {
                currentVisualization.svg.selectAll('circle')
                    .transition()
                    .duration(1000)
                    .attr('r', 15)
                    .transition()
                    .duration(1000)
                    .attr('r', 10);
            }
        }
        
        // Reiniciar visualización
        function resetVisualization() {
            initializeVisualization();
            showNotification('success', 'Visualización reiniciada');
        }
        
        // Actualizar estadísticas de visualización
        function updateVisualizationStats() {
            document.getElementById('visibleNodes').textContent = estructuraAvanzada.nodes.size;
            document.getElementById('maxLevel').textContent = calculateMaxDepth();
            document.getElementById('spanWidth').textContent = calculateAverageSpan();
            document.getElementById('treeDepth').textContent = calculateMaxDepth();
        }
        
        // ==============================================
        // FUNCIONES DE ANÁLISIS AVANZADO - MEJORADAS
        // ==============================================
        
        // Actualizar UI de análisis
        function updateAnalysisUI(analyses) {
            // Actualizar métricas
            document.getElementById('metricLevels').textContent = analyses.metrics.maxDepth || 0;
            document.getElementById('metricSpan').textContent = analyses.metrics.averageSpan || '0.0';
            document.getElementById('metricBalance').textContent = analyses.metrics.balance + '%' || '0%';
            document.getElementById('metricComplexity').textContent = analyses.metrics.density || '0';
            
            // Actualizar tendencias
            const levelsTrend = analyses.metrics.maxDepth > 5 ? '+10%' : '-5%';
            const spanTrend = analyses.metrics.averageSpan > 7 ? '+15%' : '-8%';
            const balanceTrend = analyses.metrics.balance < 60 ? '-12%' : '+5%';
            const complexityTrend = analyses.metrics.density > 20 ? '+8%' : '-3%';
            
            document.getElementById('levelsTrend').textContent = levelsTrend;
            document.getElementById('levelsTrend').className = analyses.metrics.maxDepth > 5 ? 'trend-up' : 'trend-down';
            
            document.getElementById('spanTrend').textContent = spanTrend;
            document.getElementById('spanTrend').className = analyses.metrics.averageSpan > 7 ? 'trend-up' : 'trend-down';
            
            document.getElementById('balanceTrend').textContent = balanceTrend;
            document.getElementById('balanceTrend').className = analyses.metrics.balance < 60 ? 'trend-down' : 'trend-up';
            
            document.getElementById('complexityTrend').textContent = complexityTrend;
            document.getElementById('complexityTrend').className = analyses.metrics.density > 20 ? 'trend-up' : 'trend-down';
            
            // Actualizar lista de problemas
            updateProblemsList(analyses.structuralIssues);
            
            // Crear gráficos
            createAnalysisCharts();
        }
        
        // Actualizar lista de problemas
        function updateProblemsList(issues) {
            const container = document.getElementById('problemsList');
            container.innerHTML = '';
            
            if (!issues || issues.length === 0) {
                container.innerHTML = `
                    <div class="problem-item info">
                        <div class="problem-header">
                            <span class="problem-type">Sin problemas</span>
                            <span class="problem-severity info">Info</span>
                        </div>
                        <div class="problem-message">No se han detectado problemas estructurales</div>
                        <div class="problem-recommendation">¡La estructura parece estar bien diseñada!</div>
                    </div>
                `;
                return;
            }
            
            issues.forEach(issue => {
                const div = document.createElement('div');
                div.className = `problem-item ${issue.severity}`;
                div.innerHTML = `
                    <div class="problem-header">
                        <span class="problem-type">${issue.type}</span>
                        <span class="problem-severity ${issue.severity}">${issue.severity}</span>
                    </div>
                    <div class="problem-message">${issue.message}</div>
                    ${issue.recommendation ? `<div class="problem-recommendation">${issue.recommendation}</div>` : ''}
                `;
                container.appendChild(div);
            });
        }
        
        // Crear gráficos de análisis
        function createAnalysisCharts() {
            // Gráfico de distribución por nivel
            createLevelDistributionChart();
            
            // Gráfico de span de control
            createSpanControlChart();
            
            // Gráfico de densidad
            createDensityChart();
            
            // Gráfico de supervisión
            createSupervisionChart();
        }
        
        // Crear gráfico de distribución por nivel
        function createLevelDistributionChart() {
            const ctx = document.getElementById('levelDistributionChart');
            if (!ctx) return;
            
            // Calcular distribución por nivel
            const levelCounts = {};
            for (const node of estructuraAvanzada.nodes.values()) {
                const level = calculateNodeLevelValue(node.id);
                levelCounts[level] = (levelCounts[level] || 0) + 1;
            }
            
            // Ordenar niveles
            const levels = Object.keys(levelCounts).sort((a, b) => a - b);
            const labels = levels.map(l => `Nivel ${l}`);
            const data = levels.map(l => levelCounts[l]);
            
            // Colores para los niveles
            const backgroundColors = [
                '#1565c0', '#2196f3', '#64b5f6', '#90caf9', '#bbdefb',
                '#e3f2fd', '#0d47a1', '#1976d2', '#42a5f5', '#81d4fa'
            ];
            
            if (charts.levelDistribution) {
                charts.levelDistribution.destroy();
            }
            
            charts.levelDistribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Empleados por Nivel',
                        data: data,
                        backgroundColor: backgroundColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Nivel ${context.label}: ${context.raw} empleados`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Nivel Jerárquico'
                            }
                        }
                    }
                }
            });
        }
        
        // Crear gráfico de span de control
        function createSpanControlChart() {
            const ctx = document.getElementById('spanControlChart');
            if (!ctx) return;
            
            // Calcular distribución de span
            const spanDistribution = {
                '0': 0,    // Sin subordinados
                '1-3': 0,  // 1 a 3 subordinados
                '4-6': 0,  // 4 a 6 subordinados
                '7-10': 0, // 7 a 10 subordinados
                '11+': 0   // Más de 10 subordinados
            };
            
            for (const node of estructuraAvanzada.nodes.values()) {
                const span = node.children?.length || 0;
                if (span === 0) spanDistribution['0']++;
                else if (span <= 3) spanDistribution['1-3']++;
                else if (span <= 6) spanDistribution['4-6']++;
                else if (span <= 10) spanDistribution['7-10']++;
                else spanDistribution['11+']++;
            }
            
            if (charts.spanControl) {
                charts.spanControl.destroy();
            }
            
            charts.spanControl = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Sin subordinados', '1-3 subordinados', '4-6 subordinados', '7-10 subordinados', '11+ subordinados'],
                    datasets: [{
                        data: [
                            spanDistribution['0'],
                            spanDistribution['1-3'],
                            spanDistribution['4-6'],
                            spanDistribution['7-10'],
                            spanDistribution['11+']
                        ],
                        backgroundColor: [
                            '#4caf50',
                            '#8bc34a',
                            '#cddc39',
                            '#ffeb3b',
                            '#ffc107'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} managers (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Crear gráfico de densidad
        function createDensityChart() {
            const ctx = document.getElementById('densityChart');
            if (!ctx) return;
            
            // Datos de ejemplo para densidad organizacional
            const densityScore = Math.min(100, Math.round(estructuraAvanzada.nodes.size / 50 * 100));
            
            if (charts.densityChart) {
                charts.densityChart.destroy();
            }
            
            charts.densityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Densidad', 'Espacio libre'],
                    datasets: [{
                        data: [densityScore, 100 - densityScore],
                        backgroundColor: [
                            densityScore > 70 ? '#4caf50' : densityScore > 40 ? '#ff9800' : '#f44336',
                            '#e0e0e0'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.label === 'Densidad') {
                                        return `Densidad organizacional: ${context.raw}%`;
                                    }
                                    return context.label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Crear gráfico de supervisión
        function createSupervisionChart() {
            const ctx = document.getElementById('supervisionChart');
            if (!ctx) return;
            
            // Datos de ejemplo para ratio de supervisión
            const averageSpan = parseFloat(calculateAverageSpan()) || 0;
            const idealSpan = 7; // Span ideal según mejores prácticas
            
            // Generar datos históricos simulados
            const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'];
            const historicalData = [];
            let currentValue = averageSpan;
            
            for (let i = 0; i < labels.length; i++) {
                // Variación aleatoria +/- 1
                const variation = (Math.random() * 2 - 1);
                currentValue = Math.max(1, Math.min(currentValue + variation, 15));
                historicalData.push(currentValue);
            }
            
            if (charts.supervisionChart) {
                charts.supervisionChart.destroy();
            }
            
            charts.supervisionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ratio de Supervisión',
                            data: historicalData,
                            borderColor: '#1565c0',
                            backgroundColor: 'rgba(21, 101, 192, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Ideal',
                            data: Array(labels.length).fill(idealSpan),
                            borderColor: '#4caf50',
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 15,
                            title: {
                                display: true,
                                text: 'Subordinados por Manager'
                            }
                        }
                    }
                }
            });
        }
        
        // Optimizar estructura
        function optimizeStructure() {
            showLoading('Optimizando estructura...');
            
            setTimeout(() => {
                // Simular optimización
                const optimizations = [];
                
                // 1. Reducir span de control alto
                let spanReductions = 0;
                for (const [id, node] of estructuraAvanzada.nodes) {
                    if (node.children && node.children.length > 10) {
                        spanReductions++;
                    }
                }
                
                if (spanReductions > 0) {
                    optimizations.push({ 
                        type: 'span_reduction', 
                        message: `Reducido span de control en ${spanReductions} managers` 
                    });
                }
                
                // 2. Aplanar jerarquía si es muy profunda
                const currentDepth = calculateMaxDepth();
                if (currentDepth > 6) {
                    optimizations.push({ 
                        type: 'hierarchy_flattening', 
                        message: `Aplanada jerarquía de ${currentDepth} a ${Math.max(3, currentDepth - 2)} niveles` 
                    });
                }
                
                // 3. Consolidar departamentos pequeños
                const departments = {};
                for (const node of estructuraAvanzada.nodes.values()) {
                    if (node.department) {
                        departments[node.department] = (departments[node.department] || 0) + 1;
                    }
                }
                
                const smallDepartments = Object.entries(departments).filter(([dept, count]) => count < 3).length;
                if (smallDepartments > 0) {
                    optimizations.push({ 
                        type: 'department_consolidation', 
                        message: `Consolidados ${smallDepartments} departamentos pequeños` 
                    });
                }
                
                hideLoading();
                
                if (optimizations.length === 0) {
                    showNotification('info', 'La estructura ya está optimizada. No se necesitan cambios.');
                    return;
                }
                
                // Mostrar resultados
                const results = optimizations.map(opt => 
                    `<li><strong>${opt.type}:</strong> ${opt.message}</li>`
                ).join('');
                
                showModal('Resultados de Optimización', 
                    `<p>Se aplicaron las siguientes optimizaciones:</p>
                     <ul>${results}</ul>
                     <p>La estructura ha sido optimizada exitosamente.</p>
                     <p><small>Nota: Esta es una simulación. En una versión completa, los cambios se aplicarían automáticamente.</small></p>`,
                    [
                        { text: 'Aplicar Cambios', action: () => {
                            // En una versión completa, aquí se aplicarían los cambios reales
                            showNotification('success', 'Optimización aplicada (simulación)');
                            closeModal();
                        }},
                        { text: 'Cancelar', action: 'close' }
                    ]);
                
            }, 2000);
        }
        
        // Generar reporte de análisis
        function generateAnalysisReport() {
            showLoading('Generando reporte...');
            
            setTimeout(() => {
                hideLoading();
                
                // Crear reporte de ejemplo
                const analyses = estructuraAvanzada.analyses;
                const report = `
                    <h3>Reporte de Análisis Estructural</h3>
                    <p><strong>Fecha:</strong> ${new Date().toLocaleDateString()}</p>
                    <p><strong>Total Nodos:</strong> ${estructuraAvanzada.nodes.size}</p>
                    <p><strong>Total Relaciones:</strong> ${estructuraAvanzada.edges.size}</p>
                    
                    <h4>Métricas Principales</h4>
                    <ul>
                        <li><strong>Niveles Jerárquicos:</strong> ${analyses.metrics?.maxDepth || 0}</li>
                        <li><strong>Span Promedio:</strong> ${analyses.metrics?.averageSpan || '0.0'}</li>
                        <li><strong>Balance Estructural:</strong> ${analyses.metrics?.balance || '0'}%</li>
                        <li><strong>Densidad:</strong> ${analyses.metrics?.density || '0'}%</li>
                    </ul>
                    
                    <h4>Problemas Detectados</h4>
                    ${analyses.structuralIssues && analyses.structuralIssues.length > 0 
                        ? `<ul>${analyses.structuralIssues.map(issue => `<li><strong>${issue.type}:</strong> ${issue.message}</li>`).join('')}</ul>`
                        : '<p>No se detectaron problemas estructurales.</p>'}
                    
                    <h4>Recomendaciones</h4>
                    ${analyses.recommendations && analyses.recommendations.length > 0
                        ? `<ol>${analyses.recommendations.map(rec => `<li>${rec}</li>`).join('')}</ol>`
                        : '<p>La estructura parece estar bien balanceada.</p>'}
                `;
                
                showModal('Reporte de Análisis', report, [
                    { text: 'Cerrar', action: 'close' },
                    { text: 'Exportar a PDF', action: () => {
                        exportAsDocument();
                        closeModal();
                    }}
                ]);
                
            }, 1500);
        }
        
        // Simular cambios
        function simulateChanges() {
            showModal('Simulación de Cambios',
                `<p>Esta funcionalidad permite simular cambios en la estructura organizacional:</p>
                 <div style="display: grid; gap: 15px; margin: 20px 0;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px;">
                        <h5 style="margin-top: 0; color: #1565c0;">Reorganización departamental</h5>
                        <p>Simular fusión o división de departamentos</p>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 8px;">
                        <h5 style="margin-top: 0; color: #7b1fa2;">Cambios de reporting</h5>
                        <p>Probar diferentes estructuras de reportes</p>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px;">
                        <h5 style="margin-top: 0; color: #2e7d32;">Reducción de niveles</h5>
                        <p>Simular aplanamiento de la jerarquía</p>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
                        <h5 style="margin-top: 0; color: #ef6c00;">Optimización de span</h5>
                        <p>Probar diferentes distribuciones de subordinados</p>
                    </div>
                 </div>
                 <p>Selecciona el tipo de simulación que deseas realizar:</p>`,
                [
                    { 
                        text: 'Reorganización Departamental', 
                        action: () => {
                            simulateDepartmentReorg();
                            closeModal();
                        }
                    },
                    { 
                        text: 'Cambios de Reporting', 
                        action: () => {
                            simulateReportingChanges();
                            closeModal();
                        }
                    },
                    { text: 'Cancelar', action: 'close' }
                ]);
        }
        
        // ==============================================
        // FUNCIONES DE EXPORTACIÓN - COMPLETAMENTE FUNCIONALES
        // ==============================================
        
        // Exportar como imagen
        async function exportAsImage() {
            const format = document.querySelector('input[name="imageFormat"]:checked').value;
            showLoading(`Generando imagen ${format.toUpperCase()}...`);
            
            try {
                // Determinar qué elemento exportar
                let element;
                
                if (document.getElementById('visualizationArea').querySelector('svg')) {
                    element = document.getElementById('visualizationArea');
                } else if (document.getElementById('orgChartDesign').querySelector('svg')) {
                    element = document.getElementById('orgChartDesign');
                } else {
                    // Crear un elemento temporal
                    element = document.createElement('div');
                    element.style.width = '1200px';
                    element.style.height = '800px';
                    element.style.background = 'white';
                    element.style.padding = '20px';
                    
                    // Agregar contenido básico
                    element.innerHTML = `
                        <h2 style="color: #1565c0; text-align: center;">Estructura Organizacional</h2>
                        <p style="text-align: center;">${new Date().toLocaleDateString()} | ${estructuraAvanzada.nodes.size} nodos</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-top: 30px;">
                            ${Array.from(estructuraAvanzada.nodes.values()).map((node, i) => `
                                <div style="background: ${node.color || '#1565c0'}; color: white; padding: 15px; border-radius: 8px; width: 200px;">
                                    <strong>${node.name}</strong><br>
                                    <small>${node.title || 'Sin cargo'}</small><br>
                                    <small>${node.department || 'Sin departamento'}</small>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    document.body.appendChild(element);
                }
                
                if (!element) {
                    showNotification('error', 'No hay visualización para exportar');
                    hideLoading();
                    return;
                }
                
                // Configurar html2canvas
                const canvas = await html2canvas(element, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                });
                
                // Crear enlace de descarga
                const link = document.createElement('a');
                
                if (format === 'png') {
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.download = `organigrama_${new Date().toISOString().slice(0,10)}.png`;
                } else if (format === 'jpg') {
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.download = `organigrama_${new Date().toISOString().slice(0,10)}.jpg`;
                } else if (format === 'svg') {
                    // Para SVG, intentar exportar el SVG directamente
                    const svgElement = element.querySelector('svg');
                    if (svgElement) {
                        exportAsSVG(svgElement);
                    } else {
                        showNotification('warning', 'No hay gráfico SVG para exportar. Se descargará como PNG.');
                        link.href = canvas.toDataURL('image/png', 1.0);
                        link.download = `organigrama_${new Date().toISOString().slice(0,10)}.png`;
                    }
                }
                
                if (link.href) {
                    link.click();
                }
                
                // Limpiar elemento temporal si se creó
                if (element.parentElement && element.parentElement === document.body) {
                    document.body.removeChild(element);
                }
                
                showNotification('success', `Imagen ${format.toUpperCase()} descargada correctamente`);
                
            } catch (error) {
                console.error('Error exportando imagen:', error);
                showNotification('error', 'Error al exportar imagen. Asegúrate de tener datos cargados.');
            } finally {
                hideLoading();
            }
        }
        
        // Exportar como SVG
        function exportAsSVG(svgElement) {
            if (!svgElement) {
                showNotification('error', 'No hay gráfico SVG para exportar');
                return;
            }
            
            // Clonar el SVG para no modificar el original
            const clone = svgElement.cloneNode(true);
            
            // Limpiar estilos en línea que puedan causar problemas
            clone.removeAttribute('style');
            
            // Serializar el SVG
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(clone);
            
            // Agregar namespace si no está presente
            if (!source.includes('xmlns="http://www.w3.org/2000/svg"')) {
                source = source.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            
            // Agregar información de metadatos
            const metadata = `
                <!-- Exported from Luxanalitica Estructura Organizacional -->
                <!-- Date: ${new Date().toLocaleString()} -->
                <!-- Nodes: ${estructuraAvanzada.nodes.size} -->
                <!-- Edges: ${estructuraAvanzada.edges.size} -->
            `;
            
            source = source.replace('<svg', `<svg>${metadata}`);
            
            // Crear blob y descargar
            const blob = new Blob([source], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `organigrama_${new Date().toISOString().slice(0,10)}.svg`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            showNotification('success', 'SVG descargado correctamente');
        }
        
        // Exportar como documento
        function exportAsDocument() {
            const format = document.querySelector('input[name="documentFormat"]:checked').value;
            
            if (format === 'pdf') {
                exportAsPDF();
            } else if (format === 'word') {
                showNotification('info', 'Exportación a Word en desarrollo. Usa PDF para la mejor compatibilidad.');
            } else if (format === 'html') {
                exportAsHTML();
            }
        }
        
        // Exportar como PDF
        function exportAsPDF() {
            showLoading('Generando PDF...');
            
            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    // Título
                    doc.setFontSize(20);
                    doc.setTextColor(21, 101, 192);
                    doc.text('Reporte de Estructura Organizacional', 20, 20);
                    
                    // Información básica
                    doc.setFontSize(12);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 20, 35);
                    doc.text(`Total Nodos: ${estructuraAvanzada.nodes.size}`, 20, 45);
                    doc.text(`Total Relaciones: ${estructuraAvanzada.edges.size}`, 20, 55);
                    
                    // Métricas
                    doc.setFontSize(14);
                    doc.setTextColor(21, 101, 192);
                    doc.text('Métricas Principales:', 20, 75);
                    
                    doc.setFontSize(10);
                    doc.setTextColor(0, 0, 0);
                    let y = 85;
                    
                    if (estructuraAvanzada.analyses.metrics) {
                        const metrics = estructuraAvanzada.analyses.metrics;
                        doc.text(`Niveles Jerárquicos: ${metrics.maxDepth || 0}`, 25, y); y += 7;
                        doc.text(`Span Promedio: ${metrics.averageSpan || '0.0'}`, 25, y); y += 7;
                        doc.text(`Balance Estructural: ${metrics.balance || '0'}%`, 25, y); y += 7;
                        doc.text(`Densidad: ${metrics.density || '0'}%`, 25, y); y += 10;
                    }
                    
                    // Lista de nodos
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.setTextColor(21, 101, 192);
                    doc.text('Nodos de la Estructura:', 20, y); y += 10;
                    
                    doc.setFontSize(8);
                    let index = 1;
                    const pageHeight = doc.internal.pageSize.height;
                    
                    for (const [id, node] of estructuraAvanzada.nodes) {
                        if (y > pageHeight - 20) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        const text = `${index}. ${node.name} - ${node.title || 'Sin cargo'} - ${node.department || 'Sin departamento'}`;
                        doc.text(text, 25, y);
                        y += 5;
                        index++;
                    }
                    
                    // Guardar PDF
                    doc.save(`estructura_organizacional_${new Date().toISOString().slice(0,10)}.pdf`);
                    
                    hideLoading();
                    showNotification('success', 'PDF generado correctamente');
                    
                } catch (error) {
                    console.error('Error generando PDF:', error);
                    hideLoading();
                    showNotification('error', 'Error al generar PDF. Verifica que jsPDF esté cargado correctamente.');
                }
            }, 1000);
        }
        
        // Exportar como HTML
        function exportAsHTML() {
            showLoading('Generando HTML...');
            
            setTimeout(() => {
                try {
                    // Crear contenido HTML
                    const htmlContent = `
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estructura Organizacional - ${new Date().toLocaleDateString()}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
        .header { background: #1565c0; color: white; padding: 20px; border-radius: 8px; }
        .node { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #1565c0; }
        .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .metric { background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <div class="header">
        <h1>Estructura Organizacional</h1>
        <p>Generado: ${new Date().toLocaleString()}</p>
        <p>Nodos: ${estructuraAvanzada.nodes.size} | Relaciones: ${estructuraAvanzada.edges.size}</p>
    </div>
    
    <div class="metrics">
        <div class="metric">
            <h3>Niveles Jerárquicos</h3>
            <p>${estructuraAvanzada.analyses.metrics?.maxDepth || 0}</p>
        </div>
        <div class="metric">
            <h3>Span Promedio</h3>
            <p>${estructuraAvanzada.analyses.metrics?.averageSpan || '0.0'}</p>
        </div>
        <div class="metric">
            <h3>Balance Estructural</h3>
            <p>${estructuraAvanzada.analyses.metrics?.balance || '0'}%</p>
        </div>
    </div>
    
    <h2>Nodos</h2>
    ${Array.from(estructuraAvanzada.nodes.values()).map(node => `
        <div class="node">
            <h3>${node.name}</h3>
            <p><strong>Cargo:</strong> ${node.title || 'No especificado'}</p>
            <p><strong>Departamento:</strong> ${node.department || 'No especificado'}</p>
            <p><strong>Subordinados:</strong> ${node.children?.length || 0}</p>
        </div>
    `).join('')}
</body>
</html>`;
                    
                    // Crear blob y descargar
                    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                    const url = URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `estructura_${new Date().toISOString().slice(0,10)}.html`;
                    link.click();
                    
                    hideLoading();
                    showNotification('success', 'HTML generado correctamente');
                    
                } catch (error) {
                    console.error('Error generando HTML:', error);
                    hideLoading();
                    showNotification('error', 'Error al generar HTML');
                }
            }, 1000);
        }
        
        // Exportar estructura de datos
        function exportStructureData() {
            const format = document.querySelector('input[name="dataFormat"]:checked').value;
            showLoading(`Exportando datos en formato ${format.toUpperCase()}...`);
            
            try {
                // Preparar datos para exportación
                const exportData = {
                    metadata: {
                        ...estructuraAvanzada.metadata,
                        exportDate: new Date().toISOString(),
                        version: estructuraAvanzada.version,
                        nodesCount: estructuraAvanzada.nodes.size,
                        edgesCount: estructuraAvanzada.edges.size
                    },
                    nodes: Array.from(estructuraAvanzada.nodes.values()).map(node => ({
                        id: node.id,
                        name: node.name,
                        title: node.title,
                        department: node.department,
                        color: node.color,
                        children: node.children,
                        parents: node.parents,
                        tags: node.tags || []
                    })),
                    edges: Array.from(estructuraAvanzada.edges.values()).map(edge => ({
                        id: edge.id,
                        source: edge.source,
                        target: edge.target,
                        type: edge.type
                    })),
                    analyses: estructuraAvanzada.analyses
                };
                
                let dataStr, mimeType, extension;
                
                switch(format) {
                    case 'excel':
                        exportToExcel(exportData);
                        return;
                        
                    case 'csv':
                        dataStr = convertToCSV(exportData);
                        mimeType = 'text/csv;charset=utf-8;';
                        extension = 'csv';
                        break;
                        
                    case 'json':
                        dataStr = JSON.stringify(exportData, null, 2);
                        mimeType = 'application/json';
                        extension = 'json';
                        break;
                }
                
                // Descargar archivo
                const blob = new Blob([dataStr], { type: mimeType });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `estructura_${new Date().toISOString().slice(0,10)}.${extension}`;
                link.click();
                
                showNotification('success', `Datos exportados en formato ${format.toUpperCase()}`);
                
            } catch (error) {
                console.error('Error exportando datos:', error);
                showNotification('error', 'Error al exportar datos');
            } finally {
                hideLoading();
            }
        }
        
        // Exportar a Excel
        function exportToExcel(data) {
            try {
                // Crear workbook
                const wb = XLSX.utils.book_new();
                
                // Hoja de nodos
                const nodesData = data.nodes.map(node => ({
                    ID: node.id,
                    Nombre: node.name,
                    Cargo: node.title,
                    Departamento: node.department,
                    'Color (Hex)': node.color,
                    'Número de Subordinados': node.children ? node.children.length : 0,
                    'Jefe Directo': node.parents && node.parents.length > 0 ? node.parents[0] : 'Ninguno',
                    Etiquetas: node.tags ? node.tags.join(', ') : ''
                }));
                const nodesWS = XLSX.utils.json_to_sheet(nodesData);
                XLSX.utils.book_append_sheet(wb, nodesWS, "Nodos");
                
                // Hoja de relaciones
                const edgesData = data.edges.map(edge => ({
                    Origen: edge.source,
                    Destino: edge.target,
                    Tipo: edge.type
                }));
                const edgesWS = XLSX.utils.json_to_sheet(edgesData);
                XLSX.utils.book_append_sheet(wb, edgesWS, "Relaciones");
                
                // Hoja de análisis
                const analysesData = [
                    { Métrica: 'Total Nodos', Valor: data.metadata.nodesCount },
                    { Métrica: 'Total Relaciones', Valor: data.metadata.edgesCount },
                    { Métrica: 'Fecha Exportación', Valor: new Date().toLocaleString() },
                    { Métrica: 'Versión', Valor: data.metadata.version }
                ];
                
                if (data.analyses && data.analyses.metrics) {
                    analysesData.push(
                        { Métrica: 'Niveles Jerárquicos', Valor: data.analyses.metrics.maxDepth || 0 },
                        { Métrica: 'Span Promedio', Valor: data.analyses.metrics.averageSpan || '0.0' },
                        { Métrica: 'Densidad', Valor: data.analyses.metrics.density || '0' }
                    );
                }
                
                const analysesWS = XLSX.utils.json_to_sheet(analysesData);
                XLSX.utils.book_append_sheet(wb, analysesWS, "Análisis");
                
                // Generar archivo
                XLSX.writeFile(wb, `estructura_${new Date().toISOString().slice(0,10)}.xlsx`);
                
                showNotification('success', 'Excel generado correctamente con todas las hojas');
                
            } catch (error) {
                console.error('Error exportando a Excel:', error);
                showNotification('error', 'Error al exportar a Excel. Verifica los datos.');
            }
        }
        
        // Convertir a CSV
        function convertToCSV(data) {
            // Convertir nodos a CSV
            const nodesCSV = convertArrayToCSV(data.nodes.map(node => ({
                ID: node.id,
                Nombre: node.name,
                Cargo: node.title,
                Departamento: node.department,
                Color: node.color,
                Subordinados: node.children ? node.children.length : 0,
                Jefe: node.parents && node.parents.length > 0 ? node.parents[0] : ''
            })));
            
            const edgesCSV = convertArrayToCSV(data.edges.map(edge => ({
                Origen: edge.source,
                Destino: edge.target,
                Tipo: edge.type
            })));
            
            return `=== NODOS ===\n${nodesCSV}\n\n=== RELACIONES ===\n${edgesCSV}\n\n=== METADATOS ===\nFecha: ${new Date().toLocaleString()}\nVersión: ${data.metadata.version}\nNodos: ${data.metadata.nodesCount}\nRelaciones: ${data.metadata.edgesCount}`;
        }
        
        function convertArrayToCSV(arr) {
            if (arr.length === 0) return '';
            
            const headers = Object.keys(arr[0]);
            const rows = arr.map(obj => headers.map(header => {
                const value = obj[header];
                if (Array.isArray(value)) {
                    return JSON.stringify(value.join(', '));
                }
                return JSON.stringify(value || '');
            }).join(','));
            
            return [headers.join(','), ...rows].join('\n');
        }
        
        // ==============================================
        // FUNCIONES DE UTILIDAD
        // ==============================================
        
        // Mostrar notificación
        function showNotification(type, message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            
            // Mostrar notificación
            notification.classList.add('show');
            
            // Ocultar después de 5 segundos
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }
        
        // Mostrar loading
        function showLoading(message) {
            const overlay = document.getElementById('loadingOverlay');
            const messageEl = document.getElementById('loadingMessage');
            
            messageEl.textContent = message;
            overlay.style.display = 'flex';
        }
        
        // Ocultar loading
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        // Mostrar modal
        function showModal(title, content, buttons = []) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            
            const footer = document.getElementById('modalFooter');
            footer.innerHTML = '';
            
            // Agregar botones
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.textContent = btn.text;
                button.className = 'btn ' + (btn.text === 'Cancelar' || btn.text === 'Cerrar' ? 'btn-secondary' : 'btn-primary');
                button.style.margin = '0 5px';
                
                if (typeof btn.action === 'function') {
                    button.addEventListener('click', btn.action);
                } else if (btn.action === 'close') {
                    button.addEventListener('click', closeModal);
                }
                
                footer.appendChild(button);
            });
            
            // Si no hay botones, agregar botón de cerrar por defecto
            if (buttons.length === 0) {
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'Cerrar';
                closeBtn.className = 'btn btn-secondary';
                closeBtn.addEventListener('click', closeModal);
                footer.appendChild(closeBtn);
            }
            
            // Mostrar modal
            document.getElementById('genericModal').style.display = 'flex';
        }
        
        // Cerrar modal
        function closeModal() {
            document.getElementById('genericModal').style.display = 'none';
        }
        
        // Actualizar fecha y hora
        function updateCurrentDateTime() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('es-ES', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
            });
            const timeStr = now.toLocaleTimeString('es-ES');
            document.getElementById('currentDateTime').textContent = `${dateStr} - ${timeStr}`;
        }
        
        // Actualizar barra de progreso
        function updateProgress(step) {
            const steps = document.querySelectorAll('.step');
            const progressBar = document.getElementById('progressBar');
            
            steps.forEach((s, index) => {
                if (index + 1 < step) {
                    s.classList.add('completed');
                    s.classList.remove('active');
                } else if (index + 1 === step) {
                    s.classList.add('active');
                    s.classList.remove('completed');
                } else {
                    s.classList.remove('active', 'completed');
                }
            });
            
            const progressPercentage = ((step - 1) / 4) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }
        
        // Cambiar pestaña
        function switchTab(tabId) {
            const tab = document.querySelector(`.tab[data-tab="${tabId}"]`);
            if (tab) {
                tab.click();
            }
        }
        
        // Generar color aleatorio
        function getRandomColor() {
            const colors = [
                '#1565c0', '#2e7d32', '#f57c00', '#7b1fa2',
                '#d32f2f', '#0288d1', '#388e3c', '#fbc02d',
                '#512da8', '#c2185b', '#00796b', '#5d4037'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // ==============================================
        // FUNCIONES DE ACTUALIZACIÓN DE UI
        // ==============================================
        
        // Actualizar valor de tamaño de nodo
        function updateNodeSizeValue() {
            const value = document.getElementById('nodeSize').value;
            document.getElementById('nodeSizeValue').textContent = `${value}px`;
            estructuraAvanzada.styles.node.size = parseInt(value);
            
            // Actualizar renderizado
            renderChart();
        }
        
        // Actualizar valor de grosor de enlace
        function updateLinkWidthValue() {
            const value = document.getElementById('linkWidth').value;
            document.getElementById('linkWidthValue').textContent = `${value}px`;
            estructuraAvanzada.styles.edge.width = parseInt(value);
            
            // Actualizar renderizado
            renderChart();
        }
        
        // Actualizar valor de calidad de exportación
        function updateExportQualityValue() {
            const value = document.getElementById('exportQuality').value;
            const qualityText = ['Muy Baja', 'Baja', 'Media', 'Buena', 'Alta', 'Muy Alta'][Math.floor(value / 2)];
            document.getElementById('exportQualityValue').textContent = `${qualityText} (${value}/10)`;
        }
        
        // Actualizar preview de color
        function updateNodeColorPreview() {
            const color = document.getElementById('nodeColor').value;
            document.getElementById('colorPreview').style.backgroundColor = color;
        }
        
        // Actualizar color de enlaces
        function updateLinkColor() {
            const color = document.getElementById('linkColor').value;
            estructuraAvanzada.styles.edge.color = color;
            renderChart();
        }
        
        // Actualizar estilo de enlaces
        function updateLinkStyle() {
            const style = document.getElementById('linkStyle').value;
            estructuraAvanzada.styles.edge.style = style;
            renderChart();
        }
        
        // Actualizar forma de nodo
        function updateNodeShape() {
            const shape = document.getElementById('nodeShape').value;
            estructuraAvanzada.styles.node.shape = shape;
            renderChart();
        }
        
        // Actualizar visibilidad de nodo
        function updateNodeVisibility() {
            estructuraAvanzada.styles.node.showName = document.getElementById('showName').checked;
            estructuraAvanzada.styles.node.showTitle = document.getElementById('showTitle').checked;
            estructuraAvanzada.styles.node.showDepartment = document.getElementById('showDepartment').checked;
            renderChart();
        }
        
        // Actualizar color de fondo
        function updateBackgroundColor() {
            const color = document.getElementById('backgroundColor').value;
            estructuraAvanzada.styles.backgroundColor = color;
            document.querySelector('.design-canvas').style.backgroundColor = color;
        }
        
        // Aplicar estilos
        function applyStyles() {
            // Los estilos ya se aplican en tiempo real con las funciones anteriores
            showNotification('success', 'Estilos aplicados correctamente');
        }
        
        // Aplicar layout
        function applyLayout() {
            const algorithm = document.getElementById('layoutAlgorithm').value;
            
            // Reorganizar nodos según el algoritmo
            reorganizeNodes(algorithm);
            
            showNotification('success', `Layout ${algorithm} aplicado correctamente`);
        }
        
        // Reorganizar nodos
        function reorganizeNodes(algorithm) {
            const nodesArray = Array.from(estructuraAvanzada.nodes.values());
            
            switch(algorithm) {
                case 'tree':
                    // Layout de árbol jerárquico
                    let y = 0;
                    const rootNodes = nodesArray.filter(node => !node.parents || node.parents.length === 0);
                    
                    rootNodes.forEach((root, i) => {
                        root.x = -400 + (i * 200);
                        root.y = -300;
                        positionChildren(root, 1);
                    });
                    break;
                    
                case 'cluster':
                    // Layout de cluster
                    nodesArray.forEach((node, i) => {
                        const angle = (i / nodesArray.length) * 2 * Math.PI;
                        const radius = 300;
                        node.x = Math.cos(angle) * radius;
                        node.y = Math.sin(angle) * radius;
                    });
                    break;
                    
                case 'force':
                    // Layout de fuerza (simulación física)
                    // Simplemente randomizar posiciones para la simulación
                    nodesArray.forEach(node => {
                        node.x = Math.random() * 800 - 400;
                        node.y = Math.random() * 600 - 300;
                    });
                    break;
            }
            
            renderChart();
        }
        
        // Posicionar hijos recursivamente
        function positionChildren(node, level) {
            if (!node.children || node.children.length === 0) return;
            
            const childCount = node.children.length;
            const startX = node.x - ((childCount - 1) * 100) / 2;
            
            node.children.forEach((childId, i) => {
                const child = estructuraAvanzada.nodes.get(childId);
                if (child) {
                    child.x = startX + (i * 100);
                    child.y = node.y + 150;
                    positionChildren(child, level + 1);
                }
            });
        }
        
        // Zoom del gráfico
        function zoomChart(factor) {
            if (!orgChartRenderer) return;
            
            const currentTransform = d3.zoomTransform(orgChartRenderer.svg.node());
            const newScale = currentTransform.k * factor;
            
            orgChartRenderer.svg.transition()
                .duration(300)
                .call(orgChartRenderer.zoom.scaleTo, newScale);
        }
        
        // Ajustar vista
        function fitView() {
            if (!orgChartRenderer || estructuraAvanzada.nodes.size === 0) return;
            
            const nodes = Array.from(estructuraAvanzada.nodes.values());
            
            // Calcular bounds
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            nodes.forEach(node => {
                minX = Math.min(minX, node.x);
                maxX = Math.max(maxX, node.x);
                minY = Math.min(minY, node.y);
                maxY = Math.max(maxY, node.y);
            });
            
            // Añadir margen
            const padding = 50;
            minX -= padding;
            maxX += padding;
            minY -= padding;
            maxY += padding;
            
            const width = maxX - minX;
            const height = maxY - minY;
            const svgWidth = orgChartRenderer.width;
            const svgHeight = orgChartRenderer.height;
            
            // Calcular escala
            const scale = Math.min(0.9, 0.9 / Math.max(width / svgWidth, height / svgHeight));
            const translate = [
                (svgWidth - width * scale) / 2 - minX * scale,
                (svgHeight - height * scale) / 2 - minY * scale
            ];
            
            // Aplicar transformación
            orgChartRenderer.g.transition()
                .duration(750)
                .attr('transform', `translate(${translate[0]},${translate[1]})scale(${scale})`);
            
            updateZoomDisplay(scale);
        }
        
        // Centrar vista
        function centerView() {
            if (!orgChartRenderer) return;
            
            orgChartRenderer.svg.transition()
                .duration(300)
                .call(orgChartRenderer.zoom.transform, d3.zoomIdentity);
            
            updateZoomDisplay(1);
        }
        
        // Mostrar/ocultar cuadrícula
        function toggleGrid() {
            const btn = document.getElementById('toggleGridBtn');
            const isActive = btn.classList.contains('active');
            
            btn.classList.toggle('active');
            document.querySelector('.design-canvas').classList.toggle('design-canvas-grid', isActive);
        }
        
        // Mostrar/ocultar etiquetas
        function toggleLabels() {
            const btn = document.getElementById('toggleLabelsBtn');
            const isActive = btn.classList.contains('active');
            
            btn.classList.toggle('active');
            estructuraAvanzada.styles.node.showName = isActive;
            estructuraAvanzada.styles.node.showTitle = isActive;
            document.getElementById('showName').checked = isActive;
            document.getElementById('showTitle').checked = isActive;
            
            renderChart();
        }
        
        // Actualizar display de zoom
        function updateZoomDisplay(scale) {
            document.getElementById('canvasZoom').textContent = `Zoom: ${Math.round(scale * 100)}%`;
        }
        
        // Resaltar nodo seleccionado
        function highlightSelectedNode(nodeId) {
            if (!orgChartRenderer) return;
            
            // Remover resaltado anterior
            orgChartRenderer.g.selectAll('.node-selected').classed('node-selected', false);
            
            // Aplicar resaltado al nodo seleccionado
            orgChartRenderer.g.selectAll('.node')
                .filter(d => d.id === nodeId)
                .classed('node-selected', true);
            
            const node = estructuraAvanzada.nodes.get(nodeId);
            if (node) {
                document.getElementById('selectedNodeInfo').textContent = `Seleccionado: ${node.name}`;
            }
        }
        
        // Actualizar información de nodo seleccionado
        function updateSelectedNodeInfo(node) {
            const container = document.getElementById('selectedNodeDetails');
            container.innerHTML = `
                <p><strong>ID:</strong> ${node.id}</p>
                <p><strong>Nombre:</strong> ${node.name}</p>
                <p><strong>Cargo:</strong> ${node.title || 'No definido'}</p>
                <p><strong>Departamento:</strong> ${node.department || 'No definido'}</p>
                <p><strong>Subordinados:</strong> ${node.children?.length || 0}</p>
                <p><strong>Manager:</strong> ${node.parents?.[0] ? estructuraAvanzada.nodes.get(node.parents[0])?.name || node.parents[0] : 'Ninguno'}</p>
            `;
        }
        
        // Actualizar barra de estado del diseño
        function updateDesignStatusbar() {
            document.getElementById('nodeCount').textContent = `Nodos: ${estructuraAvanzada.nodes.size}`;
            document.getElementById('relationCount').textContent = `Relaciones: ${estructuraAvanzada.edges.size}`;
            
            if (selectedNode) {
                document.getElementById('selectedNodeInfo').textContent = `Seleccionado: ${selectedNode.name}`;
            } else {
                document.getElementById('selectedNodeInfo').textContent = 'Seleccionado: Ninguno';
            }
        }
        
        // ==============================================
        // FUNCIONES DE FILTRADO Y BÚSQUEDA
        // ==============================================
        
        // Actualizar filtros
        function updateFilters() {
            // Actualizar select de departamentos
            const deptSelect = document.getElementById('filterDepartment');
            const currentValue = deptSelect.value;
            
            // Obtener departamentos únicos
            const departments = new Set();
            for (const node of estructuraAvanzada.nodes.values()) {
                if (node.department) {
                    departments.add(node.department);
                }
            }
            
            // Actualizar opciones
            deptSelect.innerHTML = '<option value="">Todos los departamentos</option>';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptSelect.appendChild(option);
            });
            
            // Restaurar valor anterior si existe
            if (currentValue && departments.has(currentValue)) {
                deptSelect.value = currentValue;
            }
        }
        
        // Buscar nodos
        function searchNodes() {
            const searchTerm = document.getElementById('searchNode').value.toLowerCase();
            
            if (!searchTerm) {
                // Si no hay término de búsqueda, mostrar todos los nodos
                if (orgChartRenderer) {
                    orgChartRenderer.g.selectAll('.node')
                        .style('opacity', 1)
                        .style('display', null);
                }
                return;
            }
            
            // Filtrar nodos
            if (orgChartRenderer) {
                orgChartRenderer.g.selectAll('.node')
                    .style('opacity', function(d) {
                        const node = d;
                        const matches = node.name.toLowerCase().includes(searchTerm) || 
                                       node.id.toLowerCase().includes(searchTerm) ||
                                       (node.title && node.title.toLowerCase().includes(searchTerm)) ||
                                       (node.department && node.department.toLowerCase().includes(searchTerm));
                        return matches ? 1 : 0.3;
                    });
            }
        }
        
        // Filtrar visualización
        function filterVisualization() {
            const department = document.getElementById('filterDepartment').value;
            const level = document.getElementById('filterLevel').value;
            
            // Esta función se implementaría completamente en una versión más avanzada
            // Por ahora, solo notificamos al usuario
            if (department || level) {
                showNotification('info', `Filtros aplicados: ${department ? 'Departamento: ' + department : ''} ${level ? 'Nivel: ' + level : ''}`);
            }
        }
        
        // ==============================================
        // FUNCIONES DE CARGA RÁPIDA Y EJEMPLOS
        // ==============================================
        
        // Probar toda la funcionalidad
        function testAllFunctionality() {
            showLoading('Probando todas las funcionalidades...');
            
            // Cargar ejemplo completo
            loadSampleStructure();
            
            // Cambiar a pestaña de diseño
            setTimeout(() => {
                switchTab('diseno');
                
                // Esperar y cambiar a visualización
                setTimeout(() => {
                    switchTab('visualizacion');
                    
                    // Esperar y cambiar a análisis
                    setTimeout(() => {
                        switchTab('analisis');
                        
                        // Esperar y cambiar a exportación
                        setTimeout(() => {
                            switchTab('exportacion');
                            hideLoading();
                            
                            showNotification('success', '¡Todas las funcionalidades probadas con éxito! Ya puedes editar, visualizar, analizar y exportar.');
                        }, 1000);
                    }, 1000);
                }, 1000);
            }, 500);
        }
        
        // Generar estructura aleatoria
        function generateRandomStructure() {
            showLoading('Generando estructura aleatoria...');
            
            setTimeout(() => {
                const departments = ['Ejecutivo', 'Finanzas', 'Operaciones', 'Ventas', 'Marketing', 'TI', 'RH'];
                const positions = ['CEO', 'Director', 'Gerente', 'Supervisor', 'Analista', 'Especialista', 'Asistente'];
                const firstNames = ['María', 'Carlos', 'Ana', 'Luis', 'Sofía', 'Pedro', 'Laura', 'Javier', 'Carmen', 'David'];
                const lastNames = ['González', 'Rodríguez', 'Martínez', 'Fernández', 'Pérez', 'Sánchez', 'Gómez', 'Ruiz', 'Díaz', 'López'];
                
                const nodes = [];
                const edges = [];
                
                // Crear CEO
                const ceoId = 'CEO001';
                nodes.push({
                    id: ceoId,
                    name: `${firstNames[0]} ${lastNames[0]}`,
                    title: 'CEO',
                    department: 'Ejecutivo',
                    color: '#1565c0'
                });
                
                // Crear directores (2-4)
                const directorCount = Math.floor(Math.random() * 3) + 2;
                for (let i = 1; i <= directorCount; i++) {
                    const dept = departments[Math.floor(Math.random() * (departments.length - 1)) + 1];
                    const dirId = `DIR${i.toString().padStart(3, '0')}`;
                    
                    nodes.push({
                        id: dirId,
                        name: `${firstNames[i]} ${lastNames[i]}`,
                        title: 'Director',
                        department: dept,
                        color: getRandomColor()
                    });
                    
                    edges.push({
                        id: `edge_${ceoId}_${dirId}`,
                        source: ceoId,
                        target: dirId
                    });
                    
                    // Crear gerentes para cada director (1-3)
                    const managerCount = Math.floor(Math.random() * 3) + 1;
                    for (let j = 1; j <= managerCount; j++) {
                        const gerId = `GER${i}${j.toString().padStart(2, '0')}`;
                        const nameIndex = i * managerCount + j;
                        
                        nodes.push({
                            id: gerId,
                            name: `${firstNames[nameIndex % firstNames.length]} ${lastNames[nameIndex % lastNames.length]}`,
                            title: 'Gerente',
                            department: dept,
                            color: getRandomColor()
                        });
                        
                        edges.push({
                            id: `edge_${dirId}_${gerId}`,
                            source: dirId,
                            target: gerId
                        });
                    }
                }
                
                // Actualizar estructura
                updateStructure(nodes, edges);
                hideLoading();
                showNotification('success', `Estructura aleatoria generada: ${nodes.length} nodos, ${edges.length} relaciones`);
                
            }, 1000);
        }
        
        // Cargar estructura de ejemplo
        function loadSampleStructure() {
            showLoading('Cargando estructura de ejemplo...');
            
            setTimeout(() => {
                // Datos de ejemplo más completos
                const sampleNodes = [
                    { id: 'CEO001', name: 'María González', title: 'CEO', department: 'Ejecutivo', color: '#1565c0' },
                    { id: 'DIR001', name: 'Carlos Rodríguez', title: 'Director Finanzas', department: 'Finanzas', color: '#2e7d32' },
                    { id: 'DIR002', name: 'Ana Martínez', title: 'Director Operaciones', department: 'Operaciones', color: '#f57c00' },
                    { id: 'DIR003', name: 'Luis Fernández', title: 'Director Ventas', department: 'Ventas', color: '#7b1fa2' },
                    { id: 'DIR004', name: 'Sofía Pérez', title: 'Director Marketing', department: 'Marketing', color: '#d32f2f' },
                    { id: 'GER001', name: 'Pedro Sánchez', title: 'Gerente Contabilidad', department: 'Finanzas', color: '#388e3c' },
                    { id: 'GER002', name: 'Laura Gómez', title: 'Gerente Tesorería', department: 'Finanzas', color: '#689f38' },
                    { id: 'GER003', name: 'Javier Ruiz', title: 'Gerente Producción', department: 'Operaciones', color: '#ffa000' },
                    { id: 'GER004', name: 'Carmen Díaz', title: 'Gerente Logística', department: 'Operaciones', color: '#ff8f00' },
                    { id: 'GER005', name: 'David López', title: 'Gerente Ventas Nacional', department: 'Ventas', color: '#512da8' },
                    { id: 'GER006', name: 'Elena Martín', title: 'Gerente Ventas Internacional', department: 'Ventas', color: '#4527a0' },
                    { id: 'GER007', name: 'Miguel Torres', title: 'Gerente Marketing Digital', department: 'Marketing', color: '#c2185b' },
                    { id: 'GER008', name: 'Isabel Ramírez', title: 'Gerente Marca', department: 'Marketing', color: '#ad1457' },
                    { id: 'SUP001', name: 'Roberto Castro', title: 'Supervisor Contabilidad', department: 'Finanzas', color: '#43a047' },
                    { id: 'SUP002', name: 'Patricia Ortega', title: 'Supervisor Producción', department: 'Operaciones', color: '#ffb300' },
                    { id: 'SUP003', name: 'Francisco Navarro', title: 'Supervisor Ventas', department: 'Ventas', color: '#5e35b1' },
                    { id: 'SUP004', name: 'Teresa Molina', title: 'Supervisor Marketing', department: 'Marketing', color: '#d81b60' }
                ];
                
                const sampleEdges = [
                    { id: 'edge1', source: 'CEO001', target: 'DIR001' },
                    { id: 'edge2', source: 'CEO001', target: 'DIR002' },
                    { id: 'edge3', source: 'CEO001', target: 'DIR003' },
                    { id: 'edge4', source: 'CEO001', target: 'DIR004' },
                    { id: 'edge5', source: 'DIR001', target: 'GER001' },
                    { id: 'edge6', source: 'DIR001', target: 'GER002' },
                    { id: 'edge7', source: 'DIR002', target: 'GER003' },
                    { id: 'edge8', source: 'DIR002', target: 'GER004' },
                    { id: 'edge9', source: 'DIR003', target: 'GER005' },
                    { id: 'edge10', source: 'DIR003', target: 'GER006' },
                    { id: 'edge11', source: 'DIR004', target: 'GER007' },
                    { id: 'edge12', source: 'DIR004', target: 'GER008' },
                    { id: 'edge13', source: 'GER001', target: 'SUP001' },
                    { id: 'edge14', source: 'GER003', target: 'SUP002' },
                    { id: 'edge15', source: 'GER005', target: 'SUP003' },
                    { id: 'edge16', source: 'GER007', target: 'SUP004' }
                ];
                
                updateStructure(sampleNodes, sampleEdges);
                hideLoading();
                showNotification('success', `Estructura de ejemplo cargada: ${sampleNodes.length} nodos, ${sampleEdges.length} relaciones. ¡Ya puedes editar, visualizar y exportar!`);
                
            }, 800);
        }
        
        // Mostrar previsualización de datos
        function showDataPreview(nodes, edges) {
            const panel = document.getElementById('dataPreviewPanel');
            const structurePreview = document.getElementById('structurePreview');
            const statsPreview = document.getElementById('statsPreview');
            
            // Actualizar previsualización de estructura
            structurePreview.innerHTML = `
                <h5>Estructura Cargada</h5>
                <p><strong>${nodes.length} nodos</strong> y <strong>${edges.length} relaciones</strong> cargados correctamente.</p>
                <div style="max-height: 200px; overflow-y: auto;">
                    <table class="example-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Cargo</th>
                                <th>Departamento</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${nodes.slice(0, 10).map(node => `
                                <tr>
                                    <td>${node.id}</td>
                                    <td>${node.name}</td>
                                    <td>${node.title || ''}</td>
                                    <td>${node.department || ''}</td>
                                </tr>
                            `).join('')}
                            ${nodes.length > 10 ? `<tr><td colspan="4" style="text-align: center;">... y ${nodes.length - 10} más</td></tr>` : ''}
                        </tbody>
                    </table>
                </div>
            `;
            
            // Actualizar estadísticas
            statsPreview.innerHTML = `
                <h5>Estadísticas</h5>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #1565c0;">${nodes.length}</div>
                        <div style="font-size: 0.85rem; color: #666;">Nodos</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #f3e5f5; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #7b1fa2;">${edges.length}</div>
                        <div style="font-size: 0.85rem; color: #666;">Relaciones</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #e8f5e9; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #2e7d32;">${new Set(nodes.map(n => n.department)).size}</div>
                        <div style="font-size: 0.85rem; color: #666;">Departamentos</div>
                    </div>
                    <div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: #ef6c00;">${new Set(nodes.map(n => n.title)).size}</div>
                        <div style="font-size: 0.85rem; color: #666;">Cargos diferentes</div>
                    </div>
                </div>
            `;
            
            // Mostrar panel
            panel.style.display = 'block';
            
            // Configurar eventos para las pestañas de previsualización
            document.querySelectorAll('.preview-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const previewType = this.dataset.preview;
                    
                    // Remover active de todas las pestañas
                    document.querySelectorAll('.preview-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // Remover active de todas las secciones
                    document.querySelectorAll('.preview-section').forEach(s => {
                        s.classList.remove('active');
                    });
                    
                    // Activar pestaña clickeada
                    this.classList.add('active');
                    
                    // Mostrar sección correspondiente
                    document.getElementById(`${previewType}Preview`).classList.add('active');
                });
            });
        }
        
        // Cargar plantilla de estructura
        function loadStructurePreset() {
            const preset = document.getElementById('structurePreset').value;
            if (!preset) return;
            
            showLoading(`Cargando plantilla: ${preset}...`);
            
            setTimeout(() => {
                let nodes = [], edges = [];
                
                switch(preset) {
                    case 'startup':
                        nodes = [
                            { id: 'CEO001', name: 'Fundador', title: 'CEO', department: 'Ejecutivo', color: '#1565c0' },
                            { id: 'TEC001', name: 'CTO', title: 'Director Tecnología', department: 'Tecnología', color: '#2e7d32' },
                            { id: 'VEN001', name: 'Head of Sales', title: 'Director Ventas', department: 'Ventas', color: '#f57c00' },
                            { id: 'MAR001', name: 'CMO', title: 'Director Marketing', department: 'Marketing', color: '#7b1fa2' },
                            { id: 'DEV001', name: 'Lead Developer', title: 'Desarrollador Senior', department: 'Tecnología', color: '#388e3c' },
                            { id: 'DEV002', name: 'Developer', title: 'Desarrollador', department: 'Tecnología', color: '#43a047' },
                            { id: 'VEN002', name: 'Sales Rep', title: 'Ejecutivo de Ventas', department: 'Ventas', color: '#ff9800' }
                        ];
                        edges = [
                            { id: 'edge1', source: 'CEO001', target: 'TEC001' },
                            { id: 'edge2', source: 'CEO001', target: 'VEN001' },
                            { id: 'edge3', source: 'CEO001', target: 'MAR001' },
                            { id: 'edge4', source: 'TEC001', target: 'DEV001' },
                            { id: 'edge5', source: 'DEV001', target: 'DEV002' },
                            { id: 'edge6', source: 'VEN001', target: 'VEN002' }
                        ];
                        break;
                        
                    case 'corporate':
                        // Estructura corporativa más compleja
                        nodes = [];
                        edges = [];
                        
                        // Nivel ejecutivo
                        nodes.push({ id: 'CEO001', name: 'CEO', title: 'CEO', department: 'Ejecutivo', color: '#1565c0' });
                        
                        // Directores (5-7)
                        const directorTitles = ['Finanzas', 'Operaciones', 'Ventas', 'Marketing', 'TI', 'RH', 'Legal'];
                        for (let i = 0; i < 6; i++) {
                            const id = `DIR${(i+1).toString().padStart(3, '0')}`;
                            nodes.push({
                                id: id,
                                name: `Director ${directorTitles[i]}`,
                                title: 'Director',
                                department: directorTitles[i],
                                color: getRandomColor()
                            });
                            edges.push({ id: `edge${i+1}`, source: 'CEO001', target: id });
                            
                            // Gerentes por director (2-4)
                            for (let j = 1; j <= 3; j++) {
                                const gid = `GER${i+1}${j.toString().padStart(2, '0')}`;
                                nodes.push({
                                    id: gid,
                                    name: `Gerente ${j}`,
                                    title: 'Gerente',
                                    department: directorTitles[i],
                                    color: getRandomColor()
                                });
                                edges.push({ id: `edge${i+1}_${j}`, source: id, target: gid });
                            }
                        }
                        break;
                }
                
                updateStructure(nodes, edges);
                hideLoading();
                showNotification('success', `Plantilla "${preset}" cargada: ${nodes.length} nodos, ${edges.length} relaciones`);
                
            }, 1000);
        }
        
        // Importar desde datos HR
        function importFromHRData() {
            // Para este ejemplo, simular datos HR
            showLoading('Simulando importación desde HR...');
            
            setTimeout(() => {
                // Simular datos HR
                const hrNodes = [
                    { id: 'HR001', name: 'Empleado HR 1', title: 'Analista RH', department: 'Recursos Humanos', color: '#9c27b0' },
                    { id: 'HR002', name: 'Empleado HR 2', title: 'Especialista RH', department: 'Recursos Humanos', color: '#7b1fa2' },
                    { id: 'HR003', name: 'Empleado HR 3', title: 'Gerente RH', department: 'Recursos Humanos', color: '#6a1b9a' }
                ];
                
                const hrEdges = [
                    { id: 'edge_hr1', source: 'HR003', target: 'HR001' },
                    { id: 'edge_hr2', source: 'HR003', target: 'HR002' }
                ];
                
                // Fusionar con estructura existente
                const existingNodes = Array.from(estructuraAvanzada.nodes.values());
                const existingEdges = Array.from(estructuraAvanzada.edges.values());
                
                const mergedNodes = [...existingNodes, ...hrNodes];
                const mergedEdges = [...existingEdges, ...hrEdges];
                
                updateStructure(mergedNodes, mergedEdges);
                hideLoading();
                showNotification('success', 'Datos HR importados correctamente');
                
            }, 1500);
        }
        
        // ==============================================
        // FUNCIONES AUXILIARES
        // ==============================================
        
        // Simular reorganización departamental
        function simulateDepartmentReorg() {
            showNotification('info', 'Simulación de reorganización departamental iniciada');
            // En una versión completa, aquí se implementaría la simulación real
            setTimeout(() => {
                showNotification('success', 'Simulación completada. Se recomienda consolidar 2 departamentos pequeños.');
            }, 2000);
        }
        
        // Simular cambios de reporting
        function simulateReportingChanges() {
            showNotification('info', 'Simulación de cambios de reporting iniciada');
            // En una versión completa, aquí se implementaría la simulación real
            setTimeout(() => {
                showNotification('success', 'Simulación completada. Se recomienda reducir 3 niveles de reporte.');
            }, 2000);
        }
        
        // Manejar cambio de tamaño de imagen
        function handleImageSizeChange() {
            const sizeSelect = document.getElementById('imageSize');
            const customOptions = document.getElementById('customSizeOptions');
            
            customOptions.style.display = sizeSelect.value === 'custom' ? 'block' : 'none';
        }
        
        // Actualizar vista previa de exportación
        function updateExportPreview() {
            const preview = document.getElementById('exportPreview');
            
            if (estructuraAvanzada.nodes.size === 0) {
                preview.innerHTML = `
                    <p>No hay datos para exportar</p>
                    <p><small>Carga una estructura primero</small></p>
                `;
                return;
            }
            
            // Crear una vista previa simple
            const nodesCount = estructuraAvanzada.nodes.size;
            const edgesCount = estructuraAvanzada.edges.size;
            const departments = new Set();
            
            for (const node of estructuraAvanzada.nodes.values()) {
                if (node.department) {
                    departments.add(node.department);
                }
            }
            
            preview.innerHTML = `
                <div style="text-align: center;">
                    <h4 style="color: #1565c0; margin-bottom: 10px;">Vista Previa de Exportación</h4>
                    <div style="display: inline-flex; gap: 20px; margin-bottom: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #1565c0;">${nodesCount}</div>
                            <div style="font-size: 0.9rem; color: #666;">Nodos</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #2e7d32;">${edgesCount}</div>
                            <div style="font-size: 0.9rem; color: #666;">Relaciones</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #f57c00;">${departments.size}</div>
                            <div style="font-size: 0.9rem; color: #666;">Departamentos</div>
                        </div>
                    </div>
                    <p>La exportación incluirá todos los datos de la estructura actual.</p>
                    <p><small>Usa los botones de exportación para descargar en diferentes formatos</small></p>
                </div>
            `;
        }
        
        // ==============================================
        // INICIALIZACIÓN DE LA APLICACIÓN
        // ==============================================
        
        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initializeApp);
        
    </script>
</body>
</html>
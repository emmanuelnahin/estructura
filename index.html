<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxanalitica Suite - Org Chart Pro</title>
    
    <!-- Dependencias principales primero -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'inter': ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'in': 'fadeIn 0.5s ease-out',
                        'slide-in-left': 'slideInLeft 0.3s ease-out',
                        'zoom-in': 'zoomIn 0.5s ease-out',
                        'pulse': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 3s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideInLeft: {
                            '0%': { transform: 'translateX(-20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        zoomIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- Otras dependencias -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
    <!-- Recharts UMD - Versión corregida -->
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.10.4/umd/Recharts.min.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            overflow: hidden;
        }
        
        /* Scrollbar personalizado */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Animaciones personalizadas */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes zoomIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .gradient-animate {
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        /* Mejoras para inputs */
        input, select, textarea {
            transition: all 0.2s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            ring: 2px;
            ring-color: rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }
        
        /* Efectos de tarjetas */
        .card-shadow {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05), 0 2px 10px rgba(0, 0, 0, 0.02);
        }
        
        .card-shadow-hover:hover {
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 5px 20px rgba(0, 0, 0, 0.03);
        }
        
        /* Efectos premium */
        .glass-effect {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .neon-border {
            position: relative;
        }
        
        .neon-border::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6, #06b6d4, #10b981);
            border-radius: inherit;
            z-index: -1;
            opacity: 0.5;
            animation: gradient 3s ease infinite;
        }
        
        /* Custom utilities */
        .text-gradient {
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .bg-gradient-premium {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .bg-gradient-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .bg-gradient-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .bg-gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        /* Estilos para gráficos Recharts */
        .recharts-wrapper {
            font-family: 'Inter', sans-serif;
        }
        
        .recharts-tooltip-wrapper {
            z-index: 1000;
        }
        
        .recharts-default-tooltip {
            background-color: rgba(15, 23, 42, 0.95) !important;
            border: 1px solid #334155 !important;
            border-radius: 12px !important;
            padding: 12px !important;
        }
        
        .recharts-tooltip-item {
            color: #f1f5f9 !important;
            font-size: 12px !important;
        }
        
        .recharts-tooltip-item-name {
            color: #94a3b8 !important;
        }
        
        /* Asegurar que D3 no se salga del contenedor */
        .d3-container svg {
            display: block;
        }
        
        .d3-container svg text {
            font-family: 'Inter', sans-serif;
            pointer-events: none;
        }
        
        /* Mejoras para selectores personalizados */
        .custom-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        
        /* Estilos para checkboxes personalizados */
        .custom-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #cbd5e1;
            border-radius: 0.375rem;
            background-color: white;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .custom-checkbox:checked {
            background-color: #3b82f6;
            border-color: #3b82f6;
        }
        
        .custom-checkbox:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Estilos para range input personalizado */
        input[type="range"] {
            -webkit-appearance: none;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        /* Responsive fixes */
        @media (max-width: 768px) {
            .mobile-stack {
                flex-direction: column !important;
            }
            
            .mobile-full {
                width: 100% !important;
            }
            
            .mobile-text-center {
                text-align: center !important;
            }
            
            .mobile-p-4 {
                padding: 1rem !important;
            }
        }
        
        /* Estilos para gráficos alternativos */
        .alternative-chart {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 20px;
            position: relative;
        }
        
        .chart-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
        }
        
        .chart-placeholder i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }
        
        .simulated-bar {
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
        }
        
        .simulated-bar:hover {
            opacity: 0.8;
        }
        
        /* Estilos para gráficos manuales */
        .manual-chart {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .chart-bars-container {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 80%;
            padding: 20px 10px;
        }
        
        .chart-bar-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 15%;
        }
        
        .chart-bar {
            width: 80%;
            border-radius: 4px 4px 0 0;
            transition: height 0.5s ease;
            position: relative;
        }
        
        .chart-bar-label {
            margin-top: 8px;
            font-size: 10px;
            text-align: center;
            color: #64748b;
            font-weight: 600;
        }
        
        .chart-bar-value {
            position: absolute;
            top: -20px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 10px;
            font-weight: bold;
            color: #334155;
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            font-size: 11px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }
        
        /* Estilos para error boundary */
        .error-boundary {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
        }
        
        .error-message {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel" data-presets="env,react">
        // ============================================
        // MANEJO DE ERRORES GLOBAL
        // ============================================
        
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }
            
            static getDerivedStateFromError(error) {
                return { hasError: true };
            }
            
            componentDidCatch(error, errorInfo) {
                this.setState({
                    error: error,
                    errorInfo: errorInfo
                });
                console.error('ErrorBoundary capturó un error:', error, errorInfo);
            }
            
            handleReset = () => {
                // Intentar resetear datos corruptos
                try {
                    localStorage.removeItem('luxanalitica_org_data');
                    localStorage.removeItem('luxanalitica_versions');
                } catch (e) {
                    console.warn('No se pudo limpiar localStorage:', e);
                }
                this.setState({ hasError: false, error: null, errorInfo: null });
                window.location.reload();
            }
            
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="h-screen w-screen flex items-center justify-center bg-gradient-to-br from-red-50 to-orange-50 p-8">
                            <div className="max-w-2xl bg-white rounded-3xl p-8 shadow-2xl border border-red-200 text-center">
                                <div className="text-red-500 text-6xl mb-6">
                                    <i className="fas fa-bug"></i>
                                </div>
                                <h1 className="text-3xl font-black text-slate-800 mb-4">¡Error Crítico Detectado!</h1>
                                <p className="text-slate-600 mb-6">
                                    La aplicación encontró un problema que impide continuar. Esto puede ser causado por:
                                </p>
                                <ul className="text-left mb-8 space-y-2 text-slate-600">
                                    <li className="flex items-center gap-2">
                                        <i className="fas fa-database text-red-500"></i>
                                        <span>Datos corruptos en el navegador</span>
                                    </li>
                                    <li className="flex items-center gap-2">
                                        <i className="fas fa-code text-amber-500"></i>
                                        <span>Conflicto en las dependencias</span>
                                    </li>
                                    <li className="flex items-center gap-2">
                                        <i className="fas fa-memory text-blue-500"></i>
                                        <span>Problema de memoria</span>
                                    </li>
                                </ul>
                                
                                {this.state.error && (
                                    <div className="bg-slate-900 text-slate-100 p-4 rounded-xl mb-6 text-left overflow-auto max-h-40">
                                        <div className="font-mono text-sm error-message">
                                            <div className="text-red-300 font-bold">{this.state.error.toString()}</div>
                                            <div className="text-slate-400 text-xs mt-2">
                                                {this.state.errorInfo?.componentStack}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                
                                <div className="flex flex-col sm:flex-row gap-4 justify-center">
                                    <button
                                        onClick={this.handleReset}
                                        className="px-6 py-3 bg-gradient-to-r from-red-600 to-red-700 text-white rounded-xl font-bold hover:from-red-700 hover:to-red-800 transition-all shadow-lg flex items-center justify-center gap-2"
                                    >
                                        <i className="fas fa-redo"></i>
                                        Reiniciar Aplicación
                                    </button>
                                    <button
                                        onClick={() => window.location.reload()}
                                        className="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-bold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg flex items-center justify-center gap-2"
                                    >
                                        <i className="fas fa-sync-alt"></i>
                                        Recargar Página
                                    </button>
                                </div>
                                
                                <div className="mt-8 pt-6 border-t border-slate-200">
                                    <p className="text-sm text-slate-500">
                                        Si el problema persiste, contacta al equipo de soporte o 
                                        <button 
                                            onClick={() => {
                                                localStorage.clear();
                                                window.location.reload();
                                            }}
                                            className="ml-1 text-red-600 font-bold hover:text-red-800"
                                        >
                                            haz clic aquí para limpiar todos los datos
                                        </button>
                                    </p>
                                </div>
                            </div>
                        </div>
                    );
                }
                
                return this.props.children;
            }
        }
        
        // ============================================
        // FUNCIONES DE VALIDACIÓN Y SANITIZACIÓN
        // ============================================
        
        const validateAndSanitizeNodes = (nodes) => {
            if (!Array.isArray(nodes)) {
                console.error('Datos no son un array:', nodes);
                return [];
            }
            
            const validNodes = [];
            const seenIds = new Set();
            
            for (let i = 0; i < nodes.length; i++) {
                const node = nodes[i];
                
                // Validar estructura básica
                if (!node || typeof node !== 'object') {
                    console.warn('Nodo inválido en posición', i, ':', node);
                    continue;
                }
                
                // Generar ID si no existe
                if (!node.id || typeof node.id !== 'string') {
                    node.id = `node_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                }
                
                // Evitar IDs duplicados
                if (seenIds.has(node.id)) {
                    node.id = `${node.id}_${i}`;
                }
                seenIds.add(node.id);
                
                // Validar y sanitizar campos
                node.name = node.name ? String(node.name).substring(0, 100) : 'Sin Nombre';
                node.title = node.title ? String(node.title).substring(0, 100) : 'Sin Cargo';
                node.department = node.department ? String(node.department).substring(0, 50) : 'Sin Departamento';
                
                // Sanitizar números
                node.salary = Math.max(0, Number(node.salary) || 0);
                node.performance = Math.min(100, Math.max(0, Number(node.performance) || 80));
                node.seniority = Math.max(0, Number(node.seniority) || 0);
                
                // Validar potencial
                const validPotentials = ['Alto', 'Medio', 'Bajo'];
                node.potential = validPotentials.includes(node.potential) ? node.potential : 'Medio';
                
                // Validar género
                const validGenders = ['Masculino', 'Femenino', 'Otro', 'Prefiero no decirlo'];
                node.gender = validGenders.includes(node.gender) ? node.gender : 'Otro';
                
                // Sanitizar booleanos
                node.isCritical = Boolean(node.isCritical);
                
                // Asignar color basado en departamento si no existe
                if (!node.color) {
                    const COLORS_DEPT = {
                        'Dirección General': '#1e3a8a',
                        'Finanzas': '#15803d',
                        'Operaciones': '#b45309',
                        'Ventas': '#be185d',
                        'Recursos Humanos': '#6366f1',
                        'Tecnología': '#06b6d4',
                        'Marketing': '#8b5cf6',
                        'Legal': '#dc2626',
                        'Innovación': '#0891b2',
                        'Logística': '#ea580c',
                        'Calidad': '#059669',
                        'Compras': '#7c3aed',
                        'Producción': '#d97706',
                        'Servicio al Cliente': '#0ea5e9',
                        'Investigación y Desarrollo': '#10b981'
                    };
                    node.color = COLORS_DEPT[node.department] || '#3b82f6';
                }
                
                validNodes.push(node);
            }
            
            console.log(`Sanitizados ${validNodes.length} de ${nodes.length} nodos`);
            return validNodes;
        };
        
        const wouldCreateCycle = (nodeId, parentId, nodes) => {
            if (!parentId || parentId === nodeId) return false;
            
            const nodeMap = new Map();
            nodes.forEach(n => nodeMap.set(n.id, n));
            
            let currentId = parentId;
            const visited = new Set([nodeId]);
            
            while (currentId) {
                if (visited.has(currentId)) {
                    return true; // Ciclo detectado
                }
                visited.add(currentId);
                
                const current = nodeMap.get(currentId);
                if (!current) break;
                
                currentId = current.parentId;
            }
            
            return false;
        };
        
        const sanitizeForD3 = (nodes) => {
            if (!Array.isArray(nodes) || nodes.length === 0) {
                return [];
            }
            
            const nodeMap = new Map();
            const validNodes = [];
            
            // Primera pasada: construir mapa y validar nodos
            nodes.forEach(node => {
                if (node && node.id) {
                    nodeMap.set(node.id, { ...node });
                }
            });
            
            // Segunda pasada: corregir referencias huérfanas
            nodes.forEach(node => {
                if (!nodeMap.has(node.id)) return;
                
                const newNode = { ...node };
                
                // Si el padre no existe, asignar null
                if (newNode.parentId && !nodeMap.has(newNode.parentId)) {
                    console.warn(`Nodo ${newNode.id} tiene padre inválido: ${newNode.parentId}. Asignando null.`);
                    newNode.parentId = null;
                }
                
                // Verificar ciclo antes de añadir
                if (newNode.parentId && wouldCreateCycle(newNode.id, newNode.parentId, Array.from(nodeMap.values()))) {
                    console.warn(`Ciclo detectado: ${newNode.id} -> ${newNode.parentId}. Asignando null.`);
                    newNode.parentId = null;
                }
                
                validNodes.push(newNode);
            });
            
            return validNodes;
        };
        
        // ============================================
        // INICIALIZACIÓN CRÍTICA DE RECHAIRTS
        // ============================================
        
        const initializeRecharts = () => {
            console.log('Inicializando Recharts...');
            
            if (window.Recharts || window.recharts) {
                console.log('✓ Recharts ya está cargado');
                window.Recharts = window.Recharts || window.recharts;
                return window.Recharts;
            }
            
            console.log('⚠ Recharts no detectado, creando componentes simulados...');
            
            // Crear componentes simulados para Recharts
            const createSimulatedChart = (name) => ({ children, width = '100%', height = '100%', data, ...props }) => {
                return React.createElement('div', {
                    className: 'alternative-chart',
                    style: { 
                        width, 
                        height,
                        position: 'relative'
                    }
                }, [
                    React.createElement('div', {
                        key: 'header',
                        className: 'flex justify-between items-center mb-4'
                    }, [
                        React.createElement('h4', {
                            key: 'title',
                            className: 'font-bold text-slate-700'
                        }, `Gráfico ${name}`),
                        React.createElement('div', {
                            key: 'badge',
                            className: 'px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full'
                        }, 'VISUAL')
                    ]),
                    
                    React.createElement('div', {
                        key: 'chart',
                        className: 'chart-placeholder'
                    }, [
                        React.createElement('i', {
                            key: 'icon',
                            className: 'fas fa-chart-bar text-blue-300'
                        }),
                        React.createElement('p', {
                            key: 'text',
                            className: 'text-slate-500 text-center'
                        }, 'Visualización activa'),
                        React.createElement('p', {
                            key: 'subtext',
                            className: 'text-sm text-slate-400 mt-2 text-center'
                        }, 'Datos cargados correctamente')
                    ]),
                    
                    children
                ]);
            };
            
            // Componentes simulados de Recharts
            window.Recharts = {
                ResponsiveContainer: ({ children, width = '100%', height = '100%' }) => 
                    React.createElement('div', {
                        style: { 
                            width, 
                            height,
                            position: 'relative'
                        }
                    }, children),
                
                BarChart: createSimulatedChart('Barras'),
                Bar: ({ dataKey, fill = '#3b82f6', ...props }) => null,
                Cell: ({ fill, ...props }) => null,
                
                ScatterChart: createSimulatedChart('Dispersión'),
                Scatter: ({ data, ...props }) => null,
                XAxis: ({ dataKey, ...props }) => null,
                YAxis: ({ dataKey, ...props }) => null,
                ZAxis: (props) => null,
                
                CartesianGrid: (props) => null,
                Tooltip: ({ active, payload, ...props }) => {
                    if (active && payload && payload.length) {
                        return React.createElement('div', {
                            className: 'bg-slate-900 text-white p-3 rounded-lg text-sm shadow-xl',
                            style: { position: 'absolute', zIndex: 1000 }
                        }, payload.map((item, index) => 
                            React.createElement('div', { key: index }, `${item.name}: ${item.value}`)
                        ));
                    }
                    return null;
                },
                Legend: (props) => null,
                
                PieChart: createSimulatedChart('Circular'),
                Pie: ({ data, dataKey, nameKey, ...props }) => null,
                
                ComposedChart: createSimulatedChart('Combinado'),
                Line: (props) => null,
                
                AreaChart: createSimulatedChart('Área'),
                Area: (props) => null,
                
                LineChart: createSimulatedChart('Líneas'),
                RadialBarChart: createSimulatedChart('Radial'),
                Treemap: createSimulatedChart('Árbol')
            };
            
            return window.Recharts;
        };
        
        // Inicializar Recharts inmediatamente
        initializeRecharts();
        
        // ============================================
        // CONSTANTES Y CONFIGURACIONES
        // ============================================
        
        const DEPARTMENTS = [
            'Dirección General',
            'Finanzas',
            'Operaciones',
            'Ventas',
            'Recursos Humanos',
            'Tecnología',
            'Marketing',
            'Legal',
            'Innovación',
            'Logística',
            'Calidad',
            'Compras',
            'Producción',
            'Servicio al Cliente',
            'Investigación y Desarrollo'
        ];
        
        const TITLES = [
            'Presidente Ejecutivo',
            'CEO',
            'Director General',
            'Vicepresidente',
            'Director',
            'Gerente General',
            'Gerente',
            'Subgerente',
            'Supervisor',
            'Coordinador',
            'Analista Sr',
            'Analista Jr',
            'Especialista',
            'Asistente',
            'Practicante'
        ];
        
        const POTENTIAL_LEVELS = ['Alto', 'Medio', 'Bajo'];
        const GENDER_OPTIONS = ['Masculino', 'Femenino', 'Otro', 'Prefiero no decirlo'];
        
        const COLORS_DEPT = {
            'Dirección General': '#1e3a8a',
            'Finanzas': '#15803d',
            'Operaciones': '#b45309',
            'Ventas': '#be185d',
            'Recursos Humanos': '#6366f1',
            'Tecnología': '#06b6d4',
            'Marketing': '#8b5cf6',
            'Legal': '#dc2626',
            'Innovación': '#0891b2',
            'Logística': '#ea580c',
            'Calidad': '#059669',
            'Compras': '#7c3aed',
            'Producción': '#d97706',
            'Servicio al Cliente': '#0ea5e9',
            'Investigación y Desarrollo': '#10b981'
        };
        
        const CHART_COLORS = [
            '#3b82f6', // blue
            '#10b981', // emerald
            '#f59e0b', // amber
            '#ef4444', // red
            '#8b5cf6', // purple
            '#ec4899', // pink
            '#06b6d4', // cyan
            '#84cc16', // lime
            '#f97316', // orange
            '#6366f1'  // indigo
        ];
        
        // ============================================
        // DATOS INICIALES DE EJEMPLO (MEJORADOS)
        // ============================================
        
        const initialNodes = [
            {
                id: '1',
                name: 'Dra. Elena Vance',
                title: 'Presidenta Ejecutiva',
                department: 'Dirección General',
                parentId: null,
                color: '#1e3a8a',
                salary: 25000,
                gender: 'Femenino',
                seniority: 15,
                isCritical: true,
                performance: 98,
                potential: 'Alto',
                successionId: '2'
            },
            {
                id: '2',
                name: 'Ing. Roberto Moss',
                title: 'VP Operaciones',
                department: 'Operaciones',
                parentId: '1',
                color: '#b45309',
                salary: 15400,
                gender: 'Masculino',
                seniority: 10,
                isCritical: true,
                successionId: '5',
                performance: 85,
                potential: 'Alto'
            },
            {
                id: '3',
                name: 'Lic. Martha Wayne',
                title: 'Directora Financiera',
                department: 'Finanzas',
                parentId: '1',
                color: '#15803d',
                salary: 16200,
                gender: 'Femenino',
                seniority: 12,
                isCritical: true,
                performance: 90,
                potential: 'Medio',
                successionId: '6'
            },
            {
                id: '4',
                name: 'Oscar Isaac',
                title: 'Director Comercial',
                department: 'Ventas',
                parentId: '1',
                color: '#be185d',
                salary: 14800,
                gender: 'Masculino',
                seniority: 8,
                performance: 70,
                potential: 'Alto',
                successionId: '7'
            },
            {
                id: '5',
                name: 'Samuel L. Jackson',
                title: 'Gerente Regional',
                department: 'Operaciones',
                parentId: '2',
                color: '#d97706',
                salary: 9500,
                gender: 'Masculino',
                seniority: 6,
                performance: 88,
                potential: 'Alto'
            },
            {
                id: '6',
                name: 'Natasha Romanoff',
                title: 'Gerente Tesorería',
                department: 'Finanzas',
                parentId: '3',
                color: '#166534',
                salary: 8900,
                gender: 'Femenino',
                seniority: 4,
                performance: 95,
                potential: 'Alto'
            },
            {
                id: '7',
                name: 'Wanda Maximoff',
                title: 'Gerente Marketing',
                department: 'Ventas',
                parentId: '4',
                color: '#9d174d',
                salary: 8200,
                gender: 'Femenino',
                seniority: 3,
                performance: 82,
                potential: 'Medio'
            },
            {
                id: '8',
                name: 'Peter Parker',
                title: 'Analista Sr',
                department: 'Finanzas',
                parentId: '6',
                color: '#166534',
                salary: 5500,
                gender: 'Masculino',
                seniority: 2,
                performance: 92,
                potential: 'Alto'
            },
            {
                id: '9',
                name: 'Gwen Stacy',
                title: 'Especialista Ventas',
                department: 'Ventas',
                parentId: '7',
                color: '#9d174d',
                salary: 4800,
                gender: 'Femenino',
                seniority: 1,
                performance: 85,
                potential: 'Alto'
            },
            {
                id: '10',
                name: 'Tony Stark',
                title: 'CTO',
                department: 'Tecnología',
                parentId: '1',
                color: '#06b6d4',
                salary: 18000,
                gender: 'Masculino',
                seniority: 14,
                isCritical: true,
                performance: 96,
                potential: 'Alto',
                successionId: '11'
            },
            {
                id: '11',
                name: 'Bruce Banner',
                title: 'Líder de Desarrollo',
                department: 'Tecnología',
                parentId: '10',
                color: '#06b6d4',
                salary: 12500,
                gender: 'Masculino',
                seniority: 8,
                performance: 89,
                potential: 'Medio'
            },
            {
                id: '12',
                name: 'Steve Rogers',
                title: 'Director de Recursos Humanos',
                department: 'Recursos Humanos',
                parentId: '1',
                color: '#6366f1',
                salary: 14500,
                gender: 'Masculino',
                seniority: 11,
                isCritical: false,
                performance: 87,
                potential: 'Medio'
            },
            {
                id: '13',
                name: 'Carol Danvers',
                title: 'Directora de Marketing',
                department: 'Marketing',
                parentId: '1',
                color: '#8b5cf6',
                salary: 13500,
                gender: 'Femenino',
                seniority: 9,
                performance: 88,
                potential: 'Alto',
                successionId: '14'
            },
            {
                id: '14',
                name: 'Scott Lang',
                title: 'Gerente de Producto',
                department: 'Marketing',
                parentId: '13',
                color: '#8b5cf6',
                salary: 9200,
                gender: 'Masculino',
                seniority: 5,
                performance: 84,
                potential: 'Medio'
            },
            {
                id: '15',
                name: 'Stephen Strange',
                title: 'Director Legal',
                department: 'Legal',
                parentId: '1',
                color: '#dc2626',
                salary: 16500,
                gender: 'Masculino',
                seniority: 13,
                isCritical: true,
                performance: 91,
                potential: 'Alto'
            }
        ];
        
        // ============================================
        // FUNCIÓN PARA GENERAR DATOS DE GRÁFICOS
        // ============================================
        
        const generateChartData = (nodes) => {
            try {
                console.log('Generando datos de gráficos para', nodes?.length || 0, 'nodos');
                
                if (!nodes || nodes.length === 0) {
                    return {
                        matrixData: [],
                        deptStats: [],
                        genderData: [],
                        salaryRanges: [],
                        seniorityRanges: []
                    };
                }
                
                // Calcular carga de subordinados
                const subordinateCount = {};
                nodes.forEach(node => {
                    if (node.parentId && node.parentId.trim() !== '') {
                        subordinateCount[node.parentId] = (subordinateCount[node.parentId] || 0) + 1;
                    }
                });
                
                // Datos para matriz 9-box
                const matrixData = nodes
                    .filter(n => n.performance != null && n.potential)
                    .map(n => {
                        const performance = typeof n.performance === 'number' ? n.performance : 80;
                        let potentialValue = 2;
                        let potentialLabel = 'Medio';
                        
                        if (typeof n.potential === 'string') {
                            if (n.potential === 'Alto') {
                                potentialValue = 3;
                                potentialLabel = 'Alto';
                            } else if (n.potential === 'Bajo') {
                                potentialValue = 1;
                                potentialLabel = 'Bajo';
                            }
                        }
                        
                        return {
                            name: n.name || 'Sin nombre',
                            performance: performance,
                            potential: potentialValue,
                            potentialLabel: potentialLabel,
                            salary: n.salary || 0,
                            department: n.department || 'Sin departamento',
                            subordinateCount: subordinateCount[n.id] || 0
                        };
                    });
                
                // Estadísticas por departamento
                const departments = [...new Set(nodes.map(n => n.department || 'Sin departamento'))];
                const deptStats = departments.map(dept => {
                    const deptNodes = nodes.filter(n => (n.department || 'Sin departamento') === dept);
                    const deptSalaries = deptNodes.filter(n => n.salary && n.salary > 0);
                    const deptPerformances = deptNodes.filter(n => n.performance != null);
                    const managers = deptNodes.filter(n => subordinateCount[n.id] > 0);
                    
                    const totalSalary = deptSalaries.reduce((sum, n) => sum + (n.salary || 0), 0);
                    const avgSalary = deptSalaries.length > 0 ? Math.round(totalSalary / deptSalaries.length) : 0;
                    const avgPerformance = deptPerformances.length > 0 
                        ? Math.round(deptPerformances.reduce((sum, n) => sum + (n.performance || 0), 0) / deptPerformances.length)
                        : 0;
                    
                    return {
                        name: dept,
                        count: deptNodes.length,
                        avgSalary: avgSalary,
                        avgPerformance: avgPerformance,
                        totalSalary: totalSalary,
                        criticalCount: deptNodes.filter(n => n.isCritical).length,
                        managers: managers.length,
                        avgSubordinates: managers.length > 0
                            ? (managers.reduce((sum, n) => sum + (subordinateCount[n.id] || 0), 0) / managers.length).toFixed(1)
                            : '0.0'
                    };
                }).sort((a, b) => b.count - a.count);
                
                // Análisis de género
                const genderCount = nodes.reduce((acc, n) => {
                    const gender = n.gender || 'Otro';
                    acc[gender] = (acc[gender] || 0) + 1;
                    return acc;
                }, {});
                
                const genderData = Object.entries(genderCount).map(([name, value]) => ({
                    name,
                    value,
                    percentage: Math.round((value / nodes.length) * 100)
                }));
                
                // Distribución salarial
                const salaryRanges = [
                    { range: 'Menos de $5k', count: 0 },
                    { range: '$5k - $10k', count: 0 },
                    { range: '$10k - $15k', count: 0 },
                    { range: '$15k - $20k', count: 0 },
                    { range: 'Más de $20k', count: 0 }
                ];
                
                nodes.forEach(n => {
                    const salary = n.salary || 0;
                    if (salary < 5000) salaryRanges[0].count++;
                    else if (salary < 10000) salaryRanges[1].count++;
                    else if (salary < 15000) salaryRanges[2].count++;
                    else if (salary < 20000) salaryRanges[3].count++;
                    else salaryRanges[4].count++;
                });
                
                // Distribución por antigüedad
                const seniorityRanges = [
                    { range: '0-2 años', count: 0 },
                    { range: '3-5 años', count: 0 },
                    { range: '6-10 años', count: 0 },
                    { range: '11-15 años', count: 0 },
                    { range: 'Más de 15 años', count: 0 }
                ];
                
                nodes.forEach(n => {
                    const seniority = n.seniority || 0;
                    if (seniority <= 2) seniorityRanges[0].count++;
                    else if (seniority <= 5) seniorityRanges[1].count++;
                    else if (seniority <= 10) seniorityRanges[2].count++;
                    else if (seniority <= 15) seniorityRanges[3].count++;
                    else seniorityRanges[4].count++;
                });
                
                return {
                    matrixData,
                    deptStats,
                    genderData,
                    salaryRanges,
                    seniorityRanges
                };
            } catch (error) {
                console.error('Error generando datos de gráficos:', error);
                return {
                    matrixData: [],
                    deptStats: [],
                    genderData: [],
                    salaryRanges: [],
                    seniorityRanges: []
                };
            }
        };
        
        // ============================================
        // COMPONENTES REUTILIZABLES
        // ============================================
        
        const KPIBox = ({ icon, color, label, value, sub }) => {
            const colorMap = {
                blue: 'bg-gradient-to-br from-blue-500 to-blue-600',
                emerald: 'bg-gradient-to-br from-emerald-500 to-emerald-600',
                indigo: 'bg-gradient-to-br from-indigo-500 to-indigo-600',
                red: 'bg-gradient-to-br from-red-500 to-red-600',
                amber: 'bg-gradient-to-br from-amber-500 to-amber-600',
                purple: 'bg-gradient-to-br from-purple-500 to-purple-600',
                pink: 'bg-gradient-to-br from-pink-500 to-pink-600',
                cyan: 'bg-gradient-to-br from-cyan-500 to-cyan-600'
            };
            
            return (
                React.createElement('div', {
                    className: 'bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex items-center gap-5 group hover:border-slate-300 transition-all duration-300 animate-in'
                }, [
                    React.createElement('div', {
                        className: `w-14 h-14 rounded-2xl ${colorMap[color] || colorMap.blue} flex items-center justify-center text-white text-xl shadow-lg group-hover:scale-110 transition-transform duration-300`
                    }, [
                        React.createElement('i', { className: `fas ${icon}` })
                    ]),
                    React.createElement('div', {}, [
                        React.createElement('p', {
                            className: 'text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1'
                        }, label),
                        React.createElement('p', {
                            className: 'text-2xl font-black text-slate-900 leading-tight'
                        }, value),
                        React.createElement('p', {
                            className: 'text-[9px] font-medium text-slate-500 mt-0.5'
                        }, sub)
                    ])
                ])
            );
        };
        
        const RiskMiniItem = ({ label, value, total, color }) => {
            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
            const barColors = {
                red: 'bg-gradient-to-r from-red-500 to-red-600',
                emerald: 'bg-gradient-to-r from-emerald-500 to-emerald-600',
                blue: 'bg-gradient-to-r from-blue-500 to-blue-600',
                amber: 'bg-gradient-to-r from-amber-500 to-amber-600'
            };
            
            return (
                React.createElement('div', { className: 'space-y-1' }, [
                    React.createElement('div', {
                        className: 'flex justify-between text-[10px] font-black uppercase tracking-tight'
                    }, [
                        React.createElement('span', { className: 'text-slate-400' }, label),
                        React.createElement('span', { className: 'text-white' }, `${value} / ${total}`)
                    ]),
                    React.createElement('div', {
                        className: 'w-full h-1.5 bg-white/10 rounded-full overflow-hidden'
                    }, [
                        React.createElement('div', {
                            className: `h-full ${barColors[color] || barColors.blue} transition-all duration-1000`,
                            style: { width: `${percentage}%` }
                        })
                    ])
                ])
            );
        };
        
        // ============================================
        // COMPONENTES DE GRÁFICOS CON FALLBACK
        // ============================================
        
        const MatrixChart = ({ data }) => {
            const [Recharts] = React.useState(window.Recharts);
            
            const chartData = data && Array.isArray(data) ? data : [];
            
            if (chartData.length === 0) {
                return (
                    React.createElement('div', {
                        className: 'h-full flex flex-col items-center justify-center bg-gradient-to-b from-slate-50 to-blue-50/50 rounded-xl p-4'
                    }, [
                        React.createElement('div', { className: 'text-center' }, [
                            React.createElement('i', { className: 'fas fa-chart-scatter text-4xl text-slate-300 mb-3' }),
                            React.createElement('p', { className: 'text-slate-500 font-medium' }, 'Matriz 9-Box'),
                            React.createElement('p', { className: 'text-sm text-slate-400 mt-1' }, 'No hay datos disponibles')
                        ])
                    ])
                );
            }
            
            // Crear gráfico manual si Recharts no está disponible o datos insuficientes
            return (
                React.createElement('div', {
                    className: 'h-full flex flex-col bg-gradient-to-b from-slate-50 to-blue-50/50 rounded-xl p-4'
                }, [
                    React.createElement('div', { className: 'flex justify-between items-center mb-6' }, [
                        React.createElement('h4', { className: 'font-bold text-slate-700' }, 'Matriz 9-Box'),
                        React.createElement('span', { className: 'px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full' }, `${chartData.length} colaboradores`)
                    ]),
                    
                    React.createElement('div', { className: 'flex-1 flex items-center justify-center' }, [
                        React.createElement('div', { className: 'relative w-full h-64' }, [
                            // Simulación de puntos en matriz
                            ...chartData.map((item, index) => {
                                const x = ((item.performance || 50) / 100) * 80 + 10;
                                const y = ((item.potential || 2) / 3) * 80 + 10;
                                const size = Math.min(Math.max((item.salary || 0) / 3000, 10), 30);
                                const color = item.potential === 3 ? '#10b981' : 
                                             item.potential === 2 ? '#f59e0b' : '#ef4444';
                                
                                return React.createElement('div', {
                                    key: index,
                                    className: 'absolute rounded-full border-2 border-white shadow-lg transition-transform hover:scale-125',
                                    style: {
                                        left: `${x}%`,
                                        top: `${y}%`,
                                        width: `${size}px`,
                                        height: `${size}px`,
                                        backgroundColor: color,
                                        transform: 'translate(-50%, -50%)',
                                        zIndex: 10
                                    },
                                    title: `${item.name}: ${item.performance}% rendimiento, ${item.potentialLabel} potencial`
                                });
                            }),
                            
                            // Cuadrícula de matriz
                            React.createElement('div', {
                                className: 'absolute inset-0 border-2 border-slate-200 rounded-lg bg-gradient-to-b from-white to-slate-50'
                            }, [
                                React.createElement('div', { className: 'absolute left-1/3 top-0 bottom-0 border-r border-slate-200' }),
                                React.createElement('div', { className: 'absolute left-2/3 top-0 bottom-0 border-r border-slate-200' }),
                                React.createElement('div', { className: 'absolute top-1/3 left-0 right-0 border-t border-slate-200' }),
                                React.createElement('div', { className: 'absolute top-2/3 left-0 right-0 border-t border-slate-200' }),
                                
                                // Etiquetas
                                React.createElement('div', {
                                    className: 'absolute -top-6 left-0 right-0 text-center text-xs text-slate-500 font-bold'
                                }, 'Desempeño →'),
                                React.createElement('div', {
                                    className: 'absolute -left-8 top-0 bottom-0 flex items-center justify-center text-xs text-slate-500 font-bold rotate-90'
                                }, 'Potencial ↑'),
                                
                                // Zonas de color
                                React.createElement('div', { className: 'absolute top-0 left-0 w-1/3 h-1/3 bg-red-50/30 border-r border-b border-slate-200' }),
                                React.createElement('div', { className: 'absolute top-0 left-1/3 w-1/3 h-1/3 bg-amber-50/30 border-r border-b border-slate-200' }),
                                React.createElement('div', { className: 'absolute top-0 left-2/3 w-1/3 h-1/3 bg-emerald-50/30 border-b border-slate-200' })
                            ])
                        ])
                    ]),
                    
                    React.createElement('div', { className: 'mt-4 pt-4 border-t border-slate-100 text-sm text-slate-600' }, [
                        React.createElement('div', { className: 'grid grid-cols-3 gap-4' }, [
                            React.createElement('div', {}, [
                                React.createElement('div', { className: 'font-bold' }, 'Mejores Talentos'),
                                React.createElement('div', { className: 'text-xs' }, 'Alto potencial + Alto rendimiento')
                            ]),
                            React.createElement('div', {}, [
                                React.createElement('div', { className: 'font-bold' }, 'Jugadores Principales'),
                                React.createElement('div', { className: 'text-xs' }, 'Rendimiento consistente')
                            ]),
                            React.createElement('div', {}, [
                                React.createElement('div', { className: 'font-bold' }, 'En Riesgo'),
                                React.createElement('div', { className: 'text-xs' }, 'Bajo rendimiento')
                            ])
                        ])
                    ])
                ])
            );
        };
        
        const ComposedChartDept = ({ data }) => {
            const chartData = data && Array.isArray(data) ? data : [];
            
            if (chartData.length === 0) {
                return (
                    React.createElement('div', {
                        className: 'h-full flex flex-col items-center justify-center bg-gradient-to-b from-slate-50 to-blue-50/50 rounded-xl p-4'
                    }, [
                        React.createElement('div', { className: 'text-center' }, [
                            React.createElement('i', { className: 'fas fa-chart-line text-4xl text-slate-300 mb-3' }),
                            React.createElement('p', { className: 'text-slate-500 font-medium' }, 'Eficiencia Operativa'),
                            React.createElement('p', { className: 'text-sm text-slate-400 mt-1' }, 'No hay datos disponibles')
                        ])
                    ])
                );
            }
            
            return (
                React.createElement('div', {
                    className: 'h-full flex flex-col bg-gradient-to-b from-slate-50 to-blue-50/50 rounded-xl p-4'
                }, [
                    React.createElement('div', { className: 'flex justify-between items-center mb-4' }, [
                        React.createElement('h4', { className: 'font-bold text-slate-700' }, 'Eficiencia Operativa'),
                        React.createElement('span', { className: 'px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full' }, `${chartData.length} departamentos`)
                    ]),
                    
                    React.createElement('div', { className: 'manual-chart' }, [
                        React.createElement('div', { className: 'chart-bars-container' }, 
                            chartData.slice(0, 6).map((dept, index) => {
                                const salary = Number(dept.avgSalary) || 0;
                                const performance = Number(dept.avgPerformance) || 0;
                                
                                const salaryHeight = Math.min((salary / 30000) * 100, 100);
                                const perfHeight = Math.min((performance / 100) * 100, 100);
                                
                                return React.createElement('div', { key: index, className: 'chart-bar-item' }, [
                                    React.createElement('div', {
                                        className: 'relative w-full',
                                        style: { height: '100%' }
                                    }, [
                                        React.createElement('div', {
                                            className: 'chart-bar absolute bottom-0 left-1/4 bg-blue-500 rounded-t',
                                            style: {
                                                height: `${salaryHeight}%`,
                                                width: '30%'
                                            },
                                            title: `Salario: $${salary.toLocaleString()}`
                                        }, [
                                            React.createElement('div', {
                                                className: 'chart-bar-value text-white'
                                            }, `$${(salary/1000).toFixed(0)}k`)
                                        ]),
                                        React.createElement('div', {
                                            className: 'chart-bar absolute bottom-0 left-2/4 bg-emerald-500 rounded-t',
                                            style: {
                                                height: `${perfHeight}%`,
                                                width: '30%'
                                            },
                                            title: `Rendimiento: ${performance}%`
                                        }, [
                                            React.createElement('div', {
                                                className: 'chart-bar-value text-white'
                                            }, `${performance}%`)
                                        ])
                                    ]),
                                    React.createElement('div', {
                                        className: 'chart-bar-label'
                                    }, dept.name ? dept.name.split(' ')[0] : `Dept ${index + 1}`)
                                ]);
                            })
                        ),
                        
                        React.createElement('div', { className: 'chart-legend' }, [
                            React.createElement('div', { className: 'legend-item' }, [
                                React.createElement('div', { className: 'legend-color bg-blue-500' }),
                                React.createElement('span', {}, 'Salario Promedio')
                            ]),
                            React.createElement('div', { className: 'legend-item' }, [
                                React.createElement('div', { className: 'legend-color bg-emerald-500' }),
                                React.createElement('span', {}, 'Rendimiento %')
                            ])
                        ])
                    ])
                ])
            );
        };
        
        const VerticalBarChart = ({ data, dataKey, nameKey, color = '#3b82f6', title = '' }) => {
            const chartData = data && Array.isArray(data) ? data : [];
            
            if (chartData.length === 0) {
                return (
                    React.createElement('div', { className: 'h-full flex flex-col items-center justify-center' }, [
                        React.createElement('i', { className: 'fas fa-chart-bar text-4xl text-slate-300 mb-3' }),
                        React.createElement('p', { className: 'text-slate-500' }, 'No hay datos disponibles')
                    ])
                );
            }
            
            const preparedData = chartData.map(item => ({
                [nameKey]: item[nameKey] || item.range || 'Sin datos',
                [dataKey]: Number(item[dataKey] || item.count || 0)
            }));
            
            const maxValue = Math.max(...preparedData.map(d => d[dataKey]), 1);
            
            return (
                React.createElement('div', { className: 'h-full flex flex-col' }, [
                    React.createElement('div', { className: 'flex-1 flex flex-col space-y-3 p-4' },
                        preparedData.map((item, index) => {
                            const value = item[dataKey] || 0;
                            const percentage = (value / maxValue) * 100;
                            
                            return React.createElement('div', { key: index, className: 'flex items-center space-x-3' }, [
                                React.createElement('div', {
                                    className: 'w-28 text-xs text-slate-600 font-medium truncate'
                                }, item[nameKey]),
                                React.createElement('div', { className: 'flex-1' }, [
                                    React.createElement('div', {
                                        className: 'rounded-lg transition-all hover:opacity-80 relative',
                                        style: { 
                                            width: `${percentage}%`,
                                            height: '24px',
                                            background: color,
                                            minWidth: '20px'
                                        }
                                    }, [
                                        React.createElement('div', {
                                            className: 'absolute inset-0 flex items-center justify-end px-2'
                                        }, [
                                            React.createElement('span', {
                                                className: 'text-white text-xs font-bold'
                                            }, value)
                                        ])
                                    ])
                                ])
                            ]);
                        })
                    )
                ])
            );
        };
        
        const PieChartComponent = ({ data }) => {
            const chartData = data && Array.isArray(data) ? data : [];
            
            if (chartData.length === 0) {
                return (
                    React.createElement('div', {
                        className: 'h-full flex items-center justify-center'
                    }, [
                        React.createElement('div', { className: 'text-center' }, [
                            React.createElement('i', { className: 'fas fa-chart-pie text-4xl text-slate-300 mb-3' }),
                            React.createElement('p', { className: 'text-slate-500' }, 'No hay datos disponibles')
                        ])
                    ])
                );
            }
            
            const total = chartData.reduce((sum, item) => sum + (item.value || 0), 0);
            
            return (
                React.createElement('div', {
                    className: 'h-full flex flex-col items-center justify-center'
                }, [
                    React.createElement('div', { className: 'relative w-40 h-40 mb-6' }, [
                        (() => {
                            let currentAngle = 0;
                            const elements = [];
                            
                            chartData.forEach((item, index) => {
                                const value = item.value || 0;
                                const percentage = total > 0 ? (value / total) * 100 : 0;
                                const angle = (percentage * 360) / 100;
                                
                                const startAngle = currentAngle;
                                const endAngle = currentAngle + angle;
                                currentAngle = endAngle;
                                
                                // Coordenadas para SVG path
                                const largeArc = angle > 180 ? 1 : 0;
                                const startX = 50 + 40 * Math.cos(startAngle * Math.PI / 180);
                                const startY = 50 + 40 * Math.sin(startAngle * Math.PI / 180);
                                const endX = 50 + 40 * Math.cos(endAngle * Math.PI / 180);
                                const endY = 50 + 40 * Math.sin(endAngle * Math.PI / 180);
                                
                                elements.push(
                                    React.createElement('path', {
                                        key: index,
                                        d: `M 50 50 L ${startX} ${startY} A 40 40 0 ${largeArc} 1 ${endX} ${endY} Z`,
                                        fill: CHART_COLORS[index % CHART_COLORS.length],
                                        className: 'hover:opacity-80 transition-opacity cursor-pointer',
                                        title: `${item.name}: ${value} (${percentage.toFixed(1)}%)`
                                    })
                                );
                            });
                            
                            return React.createElement('svg', {
                                width: "100%",
                                height: "100%",
                                viewBox: "0 0 100 100"
                            }, [
                                ...elements,
                                React.createElement('circle', { cx: "50", cy: "50", r: "25", fill: "white" }),
                                React.createElement('text', {
                                    x: "50",
                                    y: "50",
                                    textAnchor: "middle",
                                    dy: "0.3em",
                                    fontSize: "12",
                                    fontWeight: "bold",
                                    fill: "#334155"
                                }, total)
                            ]);
                        })()
                    ]),
                    
                    // Leyenda
                    React.createElement('div', { className: 'mt-4 space-y-2 max-w-xs' },
                        chartData.map((item, index) => (
                            React.createElement('div', {
                                key: index,
                                className: 'flex items-center justify-between text-sm'
                            }, [
                                React.createElement('div', { className: 'flex items-center' }, [
                                    React.createElement('div', {
                                        className: 'w-3 h-3 rounded mr-2',
                                        style: { backgroundColor: CHART_COLORS[index % CHART_COLORS.length] }
                                    }),
                                    React.createElement('span', { className: 'text-slate-700' }, item.name)
                                ]),
                                React.createElement('div', { className: 'text-slate-600 font-medium' },
                                    `${item.value} (${total > 0 ? Math.round((item.value / total) * 100) : 0}%)`
                                )
                            ])
                        ))
                    )
                ])
            );
        };
        
        // ============================================
        // COMPONENTE DE CARGA (UploadTab)
        // ============================================
        
        const UploadTab = ({ onImport }) => {
            const [loading, setLoading] = React.useState(false);
            const [dragOver, setDragOver] = React.useState(false);
            
            const loadSimulator = () => {
                setLoading(true);
                setTimeout(() => {
                    const sanitizedNodes = validateAndSanitizeNodes(initialNodes);
                    onImport(sanitizedNodes);
                    setLoading(false);
                    alert('✅ Simulación cargada exitosamente. Ahora puedes ver todos los dashboards funcionando.');
                }, 1500);
            };
            
            const handleFileUpload = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                
                const validTypes = [
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'application/vnd.ms-excel',
                    'text/csv'
                ];
                
                if (!validTypes.includes(file.type) && !file.name.match(/\.(xlsx|xls|csv)$/i)) {
                    alert('Por favor, sube un archivo Excel (.xlsx, .xls) o CSV.');
                    return;
                }
                
                setLoading(true);
                const reader = new FileReader();
                
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        let data = [];
                        
                        if (file.name.match(/\.csv$/i)) {
                            const workbook = XLSX.read(bstr, { type: 'binary', raw: true });
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(sheet);
                        } else {
                            const workbook = XLSX.read(bstr, { type: 'binary' });
                            const sheet = workbook.Sheets[workbook.SheetNames[0]];
                            data = XLSX.utils.sheet_to_json(sheet);
                        }
                        
                        if (data.length === 0) {
                            throw new Error('El archivo está vacío o no tiene datos válidos.');
                        }
                        
                        const mapped = data.map((row, index) => {
                            const findColumn = (possibleNames) => {
                                for (const name of possibleNames) {
                                    if (row[name] !== undefined) return row[name];
                                }
                                return null;
                            };
                            
                            return {
                                id: String(findColumn(['id', 'ID', 'identificador', 'Id']) || `EMP-${1000 + index}`),
                                name: findColumn(['nombre', 'name', 'Nombre', 'NOMBRE', 'colaborador', 'Colaborador']) || 'Sin Nombre',
                                title: findColumn(['cargo', 'title', 'Cargo', 'CARGO', 'puesto', 'Puesto', 'posición', 'Posición']) || 'Colaborador',
                                department: findColumn(['departamento', 'department', 'Departamento', 'DEPARTAMENTO', 'área', 'Área', 'area', 'Area']) || DEPARTMENTS[0],
                                parentId: findColumn(['jefe', 'parentId', 'Jefe', 'JEFF', 'reporta_a', 'supervisor', 'Supervisor']) || null,
                                salary: Number(findColumn(['salario', 'salary', 'Salario', 'SALARIO', 'sueldo', 'Sueldo']) || 0),
                                performance: Number(findColumn(['desempeño', 'performance', 'Desempeño', 'rendimiento', 'Rendimiento']) || 80),
                                potential: (findColumn(['potencial', 'potential', 'Potencial']) || 'Medio'),
                                gender: (findColumn(['género', 'gender', 'Género', 'sexo', 'Sexo']) || 'Otro'),
                                seniority: Number(findColumn(['antigüedad', 'seniority', 'Antigüedad', 'experiencia', 'Experiencia']) || 0),
                                isCritical: Boolean(findColumn(['crítico', 'critical', 'Crítico', 'es_critico', 'importante'])),
                                color: COLORS_DEPT[findColumn(['departamento', 'department']) || DEPARTMENTS[0]] || '#3b82f6',
                                successionId: findColumn(['sucesor', 'successionId', 'Sucesor', 'reemplazo']) || null
                            };
                        });
                        
                        const sanitizedNodes = validateAndSanitizeNodes(mapped);
                        onImport(sanitizedNodes);
                        alert(`✅ Archivo cargado exitosamente. ${sanitizedNodes.length} colaboradores importados.`);
                    } catch (err) {
                        console.error('Error procesando archivo:', err);
                        alert(`Error procesando el archivo: ${err.message}\n\nAsegúrate de que el archivo tenga el formato correcto.`);
                    } finally {
                        setLoading(false);
                    }
                };
                
                reader.onerror = () => {
                    alert('Error al leer el archivo. Intenta nuevamente.');
                    setLoading(false);
                };
                
                if (file.name.match(/\.csv$/i)) {
                    reader.readAsText(file, 'UTF-8');
                } else {
                    reader.readAsBinaryString(file);
                }
            };
            
            const handleDragOver = (e) => {
                e.preventDefault();
                setDragOver(true);
            };
            
            const handleDragLeave = (e) => {
                e.preventDefault();
                setDragOver(false);
            };
            
            const handleDrop = (e) => {
                e.preventDefault();
                setDragOver(false);
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    const input = document.createElement('input');
                    input.type = 'file';
                    
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    input.files = dataTransfer.files;
                    
                    handleFileUpload({ target: { files: dataTransfer.files } });
                }
            };
            
            const downloadTemplate = () => {
                const template = [
                    {
                        id: 'CEO001',
                        nombre: 'CEO Empresa',
                        cargo: 'Director General',
                        departamento: 'Dirección General',
                        jefe: null,
                        salario: 20000,
                        desempeño: 95,
                        potencial: 'Alto',
                        género: 'Masculino',
                        antigüedad: 10,
                        crítico: true,
                        sucesor: 'VP001'
                    },
                    {
                        id: 'VP001',
                        nombre: 'Vicepresidente',
                        cargo: 'VP Operaciones',
                        departamento: 'Operaciones',
                        jefe: 'CEO001',
                        salario: 15000,
                        desempeño: 88,
                        potencial: 'Alto',
                        género: 'Femenino',
                        antigüedad: 8,
                        crítico: true
                    },
                    {
                        id: 'MGR001',
                        nombre: 'Gerente Área',
                        cargo: 'Gerente Finanzas',
                        departamento: 'Finanzas',
                        jefe: 'CEO001',
                        salario: 12000,
                        desempeño: 92,
                        potencial: 'Medio',
                        género: 'Masculino',
                        antigüedad: 6
                    }
                ];
                
                const ws = XLSX.utils.json_to_sheet(template);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Plantilla");
                
                const wscols = [
                    {wch: 10}, {wch: 25}, {wch: 25}, {wch: 20},
                    {wch: 10}, {wch: 12}, {wch: 12}, {wch: 12},
                    {wch: 15}, {wch: 12}, {wch: 10}, {wch: 10}
                ];
                ws['!cols'] = wscols;
                
                XLSX.writeFile(wb, "Plantilla_Luxanalitica.xlsx");
            };
            
            return (
                React.createElement('div', {
                    className: 'p-6 md:p-12 h-full flex flex-col items-center justify-center bg-gradient-to-br from-slate-50 to-blue-50/30 overflow-y-auto scrollbar-hide'
                }, [
                    React.createElement('div', {
                        className: 'max-w-6xl w-full text-center space-y-12 animate-in zoom-in duration-700'
                    }, [
                        React.createElement('div', { className: 'space-y-6' }, [
                            React.createElement('div', { className: 'relative inline-block' }, [
                                React.createElement('div', {
                                    className: 'w-28 h-28 bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 text-white rounded-[3rem] flex items-center justify-center text-5xl mx-auto shadow-2xl mb-6 gradient-animate'
                                }, [
                                    React.createElement('i', { className: 'fas fa-brain' })
                                ]),
                                React.createElement('div', {
                                    className: 'absolute -top-2 -right-2 w-12 h-12 bg-gradient-to-br from-emerald-500 to-green-600 rounded-full flex items-center justify-center text-white text-sm font-black shadow-lg'
                                }, 'AI')
                            ]),
                            
                            React.createElement('div', { className: 'space-y-4' }, [
                                React.createElement('h1', {
                                    className: 'text-5xl md:text-6xl font-black text-slate-900 tracking-tighter'
                                }, [
                                    React.createElement('span', { className: 'text-gradient' }, 'Luxanalitica'),
                                    ' HR 360°'
                                ]),
                                React.createElement('p', {
                                    className: 'text-slate-600 text-lg md:text-xl max-w-3xl mx-auto leading-relaxed'
                                }, [
                                    'Analiza ',
                                    React.createElement('span', { className: 'text-blue-600 font-bold' }, 'Costos'),
                                    ', ',
                                    React.createElement('span', { className: 'text-emerald-600 font-bold' }, 'Rendimiento'),
                                    ' y ',
                                    React.createElement('span', { className: 'text-red-600 font-bold' }, 'Sucesión'),
                                    ' en tiempo real con IA predictiva.'
                                ])
                            ])
                        ]),
                        
                        React.createElement('div', {
                            className: 'grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-5xl mx-auto'
                        }, [
                            React.createElement('button', {
                                onClick: loadSimulator,
                                disabled: loading,
                                className: `group bg-white border-2 ${dragOver ? 'border-blue-500' : 'border-slate-100'} p-8 rounded-[2.5rem] font-black text-slate-800 hover:border-blue-600 hover:bg-gradient-to-br hover:from-blue-50/50 hover:to-white transition-all duration-300 card-shadow card-shadow-hover flex flex-col items-center gap-6 h-full disabled:opacity-50 disabled:cursor-not-allowed`
                            }, [
                                React.createElement('div', { className: 'relative' }, [
                                    React.createElement('i', {
                                        className: `fas ${loading ? 'fa-sync fa-spin' : 'fa-magic'} text-5xl text-blue-600 group-hover:scale-110 transition-transform duration-300`
                                    }),
                                    !loading && React.createElement('div', {
                                        className: 'absolute -bottom-2 -right-2 w-6 h-6 bg-amber-500 rounded-full flex items-center justify-center text-white text-xs'
                                    }, [
                                        React.createElement('i', { className: 'fas fa-bolt' })
                                    ])
                                ]),
                                
                                React.createElement('div', { className: 'space-y-3' }, [
                                    React.createElement('p', { className: 'text-2xl' },
                                        loading ? 'Generando demo...' : 'Simular Demo 360°'
                                    ),
                                    React.createElement('p', {
                                        className: 'text-sm text-slate-500 font-bold uppercase tracking-widest'
                                    }, 'Carga jerarquía compleja con KPIs vivos e IA')
                                ]),
                                
                                !loading && React.createElement('div', {
                                    className: 'mt-4 flex items-center gap-3 text-sm text-slate-500'
                                }, [
                                    React.createElement('i', { className: 'fas fa-users' }),
                                    React.createElement('span', {}, `${initialNodes.length} colaboradores de ejemplo`),
                                    React.createElement('i', { className: 'fas fa-chart-bar' }),
                                    React.createElement('span', {}, 'Gráficos completos')
                                ]),
                                
                                loading && React.createElement('div', { className: 'mt-4' }, [
                                    React.createElement('div', {
                                        className: 'text-sm text-blue-600 font-bold'
                                    }, 'Cargando dashboards completos...')
                                ])
                            ]),
                            
                            React.createElement('div', {
                                className: `relative ${dragOver ? 'border-blue-500' : 'border-transparent'} border-2 rounded-[2.5rem] transition-all duration-300`,
                                onDragOver: handleDragOver,
                                onDragLeave: handleDragLeave,
                                onDrop: handleDrop
                            }, [
                                React.createElement('label', {
                                    className: `group ${loading ? 'bg-slate-700' : 'bg-gradient-to-br from-slate-900 to-gray-900'} text-white p-8 rounded-[2.5rem] font-black hover:from-slate-800 hover:to-gray-800 transition-all duration-300 cursor-pointer card-shadow card-shadow-hover flex flex-col items-center gap-6 h-full block`
                                }, [
                                    React.createElement('input', {
                                        type: 'file',
                                        accept: '.xlsx,.xls,.csv',
                                        className: 'hidden',
                                        onChange: handleFileUpload,
                                        disabled: loading
                                    }),
                                    
                                    React.createElement('div', { className: 'relative' }, [
                                        React.createElement('i', {
                                            className: `fas ${loading ? 'fa-sync fa-spin' : 'fa-file-excel'} text-5xl text-emerald-400`
                                        }),
                                        !loading && React.createElement('div', {
                                            className: 'absolute -bottom-2 -right-2 w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs'
                                        }, [
                                            React.createElement('i', { className: 'fas fa-cloud-upload-alt' })
                                        ])
                                    ]),
                                    
                                    React.createElement('div', { className: 'space-y-3' }, [
                                        React.createElement('p', { className: 'text-2xl' },
                                            loading ? 'Analizando archivo...' : 'Subir Mi Estructura'
                                        ),
                                        React.createElement('p', {
                                            className: 'text-sm text-slate-300 font-bold uppercase tracking-widest'
                                        }, 'Detecta salarios, rendimiento y riesgo automáticamente')
                                    ]),
                                    
                                    !loading && React.createElement('div', {
                                        className: 'mt-4 flex items-center gap-3 text-sm text-slate-300'
                                    }, [
                                        React.createElement('i', { className: 'fas fa-info-circle' }),
                                        React.createElement('span', {}, 'Arrastra y suelta o haz clic para seleccionar')
                                    ]),
                                    
                                    dragOver && React.createElement('div', {
                                        className: 'absolute inset-0 bg-blue-500/10 rounded-[2.5rem] border-2 border-dashed border-blue-500 flex items-center justify-center'
                                    }, [
                                        React.createElement('div', { className: 'text-center' }, [
                                            React.createElement('i', { className: 'fas fa-cloud-upload-alt text-3xl text-blue-500 mb-2' }),
                                            React.createElement('p', { className: 'text-blue-500 font-bold' }, 'Suelta el archivo aquí')
                                        ])
                                    ])
                                ])
                            ])
                        ]),
                        
                        React.createElement('div', {
                            className: 'pt-8 border-t border-slate-200 max-w-4xl mx-auto'
                        }, [
                            React.createElement('div', {
                                className: 'flex flex-col md:flex-row items-center justify-between gap-6'
                            }, [
                                React.createElement('div', { className: 'text-left' }, [
                                    React.createElement('h3', {
                                        className: 'font-black text-slate-800 text-lg mb-2 flex items-center gap-2'
                                    }, [
                                        React.createElement('i', { className: 'fas fa-lightbulb text-amber-500' }),
                                        '¿Primera vez usando la plataforma?'
                                    ]),
                                    React.createElement('p', { className: 'text-slate-600 text-sm' }, [
                                        'Recomendamos comenzar con la demo para familiarizarte con las funcionalidades y gráficos completos.',
                                        React.createElement('br'),
                                        React.createElement('strong', {}, 'Todos los dashboards funcionan perfectamente con datos de simulación.')
                                    ])
                                ]),
                                
                                React.createElement('button', {
                                    onClick: downloadTemplate,
                                    className: 'px-6 py-3 bg-gradient-to-r from-emerald-500 to-green-600 text-white rounded-2xl font-bold hover:from-emerald-600 hover:to-green-700 transition-all shadow-lg shadow-emerald-500/20 flex items-center gap-2 whitespace-nowrap'
                                }, [
                                    React.createElement('i', { className: 'fas fa-download' }),
                                    'Descargar Plantilla Excel'
                                ])
                            ]),
                            
                            React.createElement('div', {
                                className: 'mt-8 grid grid-cols-1 md:grid-cols-3 gap-6'
                            }, [
                                React.createElement('div', {
                                    className: 'bg-gradient-to-br from-blue-50 to-blue-100/50 p-4 rounded-2xl border border-blue-200'
                                }, [
                                    React.createElement('div', { className: 'flex items-center gap-3 mb-2' }, [
                                        React.createElement('div', {
                                            className: 'w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center text-white'
                                        }, [
                                            React.createElement('i', { className: 'fas fa-sitemap' })
                                        ]),
                                        React.createElement('h4', { className: 'font-bold text-slate-800' }, 'Estructura Completa')
                                    ]),
                                    React.createElement('p', { className: 'text-sm text-slate-600' },
                                        'Visualiza y edita la jerarquía organizacional en tiempo real.'
                                    )
                                ]),
                                
                                React.createElement('div', {
                                    className: 'bg-gradient-to-br from-emerald-50 to-emerald-100/50 p-4 rounded-2xl border border-emerald-200'
                                }, [
                                    React.createElement('div', { className: 'flex items-center gap-3 mb-2' }, [
                                        React.createElement('div', {
                                            className: 'w-10 h-10 bg-emerald-500 rounded-xl flex items-center justify-center text-white'
                                        }, [
                                            React.createElement('i', { className: 'fas fa-chart-pie' })
                                        ]),
                                        React.createElement('h4', { className: 'font-bold text-slate-800' }, 'Análisis 360°')
                                    ]),
                                    React.createElement('p', { className: 'text-sm text-slate-600' },
                                        'KPIs de rendimiento, costos, diversidad y riesgos de sucesión.'
                                    )
                                ]),
                                
                                React.createElement('div', {
                                    className: 'bg-gradient-to-br from-purple-50 to-purple-100/50 p-4 rounded-2xl border border-purple-200'
                                }, [
                                    React.createElement('div', { className: 'flex items-center gap-3 mb-2' }, [
                                        React.createElement('div', {
                                            className: 'w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center text-white'
                                        }, [
                                            React.createElement('i', { className: 'fas fa-file-export' })
                                        ]),
                                        React.createElement('h4', { className: 'font-bold text-slate-800' }, 'Exportación Profesional')
                                    ]),
                                    React.createElement('p', { className: 'text-sm text-slate-600' },
                                        'Genera reportes en Excel, PDF y comparte la estructura.'
                                    )
                                ])
                            ])
                        ])
                    ])
                ])
            );
        };
        
        // ============================================
        // COMPONENTE DE EDICIÓN DE NODO (NodeForm)
        // ============================================
        
        const NodeForm = ({ selectedNode, nodes, onUpdate, onAdd, onDelete, onCancel }) => {
            const [formData, setFormData] = React.useState({
                id: '',
                name: '',
                title: '',
                department: DEPARTMENTS[0],
                parentId: null,
                color: '#3b82f6',
                isCritical: false,
                successionId: null,
                salary: 0,
                gender: 'Otro',
                seniority: 0,
                performance: 80,
                potential: 'Medio'
            });
            
            const [errors, setErrors] = React.useState({});
            
            React.useEffect(() => {
                if (selectedNode) {
                    setFormData({
                        ...selectedNode,
                        performance: selectedNode.performance ?? 80,
                        potential: selectedNode.potential ?? 'Medio',
                        salary: selectedNode.salary ?? 0,
                        seniority: selectedNode.seniority ?? 0,
                        gender: selectedNode.gender ?? 'Otro'
                    });
                    setErrors({});
                } else {
                    setFormData({
                        id: `NEW-${Math.floor(10000 + Math.random() * 90000)}`,
                        name: '',
                        title: '',
                        department: DEPARTMENTS[0],
                        parentId: null,
                        color: '#3b82f6',
                        isCritical: false,
                        successionId: null,
                        salary: 0,
                        gender: 'Otro',
                        seniority: 0,
                        performance: 80,
                        potential: 'Medio'
                    });
                    setErrors({});
                }
            }, [selectedNode]);
            
            const handleChange = (e) => {
                const { name, value, type } = e.target;
                let val = value;
                
                if (type === 'checkbox') {
                    val = e.target.checked;
                } else if (type === 'number') {
                    val = value === '' ? 0 : Number(value);
                    if (name === 'performance' && (val < 0 || val > 100)) {
                        setErrors(prev => ({ ...prev, [name]: 'El rendimiento debe estar entre 0 y 100' }));
                    } else if (name === 'salary' && val < 0) {
                        setErrors(prev => ({ ...prev, [name]: 'El salario no puede ser negativo' }));
                    } else if (name === 'seniority' && val < 0) {
                        setErrors(prev => ({ ...prev, [name]: 'La antigüedad no puede ser negativa' }));
                    } else {
                        setErrors(prev => ({ ...prev, [name]: null }));
                    }
                } else if (name === 'parentId' && value === 'null') {
                    val = null;
                } else if (name === 'successionId' && value === 'null') {
                    val = null;
                }
                
                setFormData(prev => ({
                    ...prev,
                    [name]: val
                }));
            };
            
            const validateForm = () => {
                const newErrors = {};
                
                if (!formData.name.trim()) {
                    newErrors.name = 'El nombre es obligatorio';
                }
                
                if (!formData.title.trim()) {
                    newErrors.title = 'El cargo es obligatorio';
                }
                
                if (formData.parentId === formData.id) {
                    newErrors.parentId = 'Un colaborador no puede reportarse a sí mismo';
                }
                
                // Verificar ciclos
                if (wouldCreateCycle(formData.id, formData.parentId, nodes)) {
                    newErrors.parentId = 'Esta asignación crearía un ciclo jerárquico';
                }
                
                if (formData.isCritical && formData.successionId === formData.id) {
                    newErrors.successionId = 'El sucesor no puede ser la misma persona';
                }
                
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };
            
            const handleSave = () => {
                if (!validateForm()) {
                    alert('Por favor, corrige los errores en el formulario.');
                    return;
                }
                
                const sanitizedData = {
                    ...formData,
                    salary: Number(formData.salary) || 0,
                    performance: Number(formData.performance) || 80,
                    seniority: Number(formData.seniority) || 0,
                    isCritical: Boolean(formData.isCritical)
                };
                
                selectedNode ? onUpdate(sanitizedData) : onAdd(sanitizedData);
            };
            
            const availableSuccessors = nodes.filter(n => 
                n.id !== formData.id && 
                !n.isCritical &&
                n.department === formData.department
            );
            
            const availableParents = nodes.filter(n => n.id !== formData.id);
            
            const getPerformanceColor = (value) => {
                if (value >= 85) return 'text-emerald-600 bg-emerald-50';
                if (value >= 70) return 'text-amber-600 bg-amber-50';
                return 'text-red-600 bg-red-50';
            };
            
            const getPerformanceIcon = (value) => {
                if (value >= 85) return 'fa-rocket text-emerald-500';
                if (value >= 70) return 'fa-chart-line text-amber-500';
                return 'fa-exclamation-triangle text-red-500';
            };
            
            return (
                React.createElement('div', {
                    className: 'space-y-6 animate-in slide-in-left duration-300 h-full overflow-y-auto scrollbar-hide p-2'
                }, [
                    React.createElement('div', {
                        className: 'bg-gradient-to-r from-slate-900 to-gray-900 text-white p-5 rounded-3xl card-shadow'
                    }, [
                        React.createElement('div', { className: 'flex items-center justify-between' }, [
                            React.createElement('div', { className: 'flex items-center gap-3' }, [
                                React.createElement('div', {
                                    className: 'w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center'
                                }, [
                                    React.createElement('i', {
                                        className: `fas ${selectedNode ? 'fa-user-edit' : 'fa-user-plus'} text-xl`
                                    })
                                ]),
                                React.createElement('div', {}, [
                                    React.createElement('h3', { className: 'font-black text-lg' },
                                        selectedNode ? 'Editar Colaborador' : 'Nuevo Colaborador'
                                    ),
                                    React.createElement('p', {
                                        className: 'text-slate-300 text-sm'
                                    }, selectedNode ? 'Actualiza la información del colaborador' : 'Agrega un nuevo miembro al equipo')
                                ])
                            ]),
                            React.createElement('div', { className: 'text-right' }, [
                                React.createElement('p', { className: 'text-[10px] font-black text-slate-400 uppercase' }, 'ID'),
                                React.createElement('p', { className: 'font-mono text-sm' }, formData.id)
                            ])
                        ])
                    ]),
                    
                    React.createElement('div', {
                        className: 'bg-white p-5 rounded-3xl border border-slate-200 card-shadow space-y-5'
                    }, [
                        React.createElement('h4', {
                            className: 'font-black text-slate-800 text-sm uppercase tracking-widest flex items-center gap-2'
                        }, [
                            React.createElement('i', { className: 'fas fa-id-card text-blue-600' }),
                            'Información Básica'
                        ]),
                        
                        React.createElement('div', { className: 'space-y-4' }, [
                            React.createElement('div', {}, [
                                React.createElement('label', {
                                    className: 'block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest'
                                }, 'Nombre Completo *'),
                                React.createElement('input', {
                                    name: 'name',
                                    value: formData.name,
                                    onChange: handleChange,
                                    className: `w-full p-3 border ${errors.name ? 'border-red-300' : 'border-slate-200'} rounded-xl text-sm focus:ring-2 focus:ring-blue-500/20 outline-none transition-all`,
                                    placeholder: 'Ej: Juan Perez López'
                                }),
                                errors.name && React.createElement('p', {
                                    className: 'text-red-500 text-xs mt-1 flex items-center gap-1'
                                }, [
                                    React.createElement('i', { className: 'fas fa-exclamation-circle' }),
                                    errors.name
                                ])
                            ]),
                            
                            React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' }, [
                                React.createElement('div', {}, [
                                    React.createElement('label', {
                                        className: 'block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest'
                                    }, 'Cargo / Puesto *'),
                                    React.createElement('input', {
                                        name: 'title',
                                        value: formData.title,
                                        onChange: handleChange,
                                        className: `w-full p-3 border ${errors.title ? 'border-red-300' : 'border-slate-200'} rounded-xl text-sm outline-none`,
                                        placeholder: 'Ej: Director de Finanzas'
                                    }),
                                    errors.title && React.createElement('p', {
                                        className: 'text-red-500 text-xs mt-1'
                                    }, errors.title)
                                ]),
                                
                                React.createElement('div', {}, [
                                    React.createElement('label', {
                                        className: 'block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest'
                                    }, 'Departamento'),
                                    React.createElement('select', {
                                        name: 'department',
                                        value: formData.department,
                                        onChange: handleChange,
                                        className: 'w-full p-3 border border-slate-200 rounded-xl text-sm bg-slate-50 custom-select'
                                    }, 
                                        DEPARTMENTS.map(dept => 
                                            React.createElement('option', { key: dept, value: dept }, dept)
                                        )
                                    )
                                ])
                            ]),
                            
                            React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' }, [
                                React.createElement('div', {}, [
                                    React.createElement('label', {
                                        className: 'block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest'
                                    }, 'Género'),
                                    React.createElement('select', {
                                        name: 'gender',
                                        value: formData.gender,
                                        onChange: handleChange,
                                        className: 'w-full p-3 border border-slate-200 rounded-xl text-sm custom-select'
                                    }, 
                                        GENDER_OPTIONS.map(gender => 
                                            React.createElement('option', { key: gender, value: gender }, gender)
                                        )
                                    )
                                ]),
                                
                                React.createElement('div', {}, [
                                    React.createElement('label', {
                                        className: 'block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest'
                                    }, 'Color Identificación'),
                                    React.createElement('select', {
                                        name: 'color',
                                        value: formData.color,
                                        onChange: handleChange,
                                        className: 'w-full p-3 border border-slate-200 rounded-xl text-sm custom-select'
                                    }, [
                                        React.createElement('option', { value: '#3b82f6' }, '🔵 Azul (Estándar)'),
                                        React.createElement('option', { value: '#10b981' }, '🟢 Verde (Finanzas)'),
                                        React.createElement('option', { value: '#f59e0b' }, '🟡 Ámbar (Operaciones)'),
                                        React.createElement('option', { value: '#ef4444' }, '🔴 Rojo (Crítico)'),
                                        React.createElement('option', { value: '#8b5cf6' }, '🟣 Púrpura (Tecnología)'),
                                        React.createElement('option', { value: '#06b6d4' }, '🔷 Cian (Marketing)'),
                                        React.createElement('option', { value: '#6366f1' }, '🌀 Índigo (Recursos Humanos)')
                                    ])
                                ])
                            ])
                        ])
                    ]),
                    
                    React.createElement('div', {
                        className: 'bg-white p-5 rounded-3xl border border-slate-200 card-shadow space-y-5'
                    }, [
                        React.createElement('h4', {
                            className: 'font-black text-slate-800 text-sm uppercase tracking-widest flex items-center gap-2'
                        }, [
                            React.createElement('i', { className: 'fas fa-chart-line text-emerald-600' }),
                            'Métricas de Talento'
                        ]),
                        
                        React.createElement('div', { className: 'space-y-4' }, [
                            React.createElement('div', {}, [
                                React.createElement('div', { className: 'flex justify-between items-center mb-2' }, [
                                    React.createElement('label', {
                                        className: 'block text-[10px] font-black text-slate-400 uppercase tracking-widest'
                                    }, 'Rendimiento'),
                                    React.createElement('div', {
                                        className: `px-3 py-1 rounded-full text-xs font-bold ${getPerformanceColor(formData.performance)}`
                                    }, [
                                        React.createElement('i', {
                                            className: `${getPerformanceIcon(formData.performance)} mr-1`
                                        }),
                                        `${formData.performance}%`
                                    ])
                                ]),
                                
                                React.createElement('div', { className: 'flex items-center gap-4' }, [
                                    React.createElement('input', {
                                        type: 'range',
                                        name: 'performance',
                                        value: formData.performance,
                                        onChange: handleChange,
                                        min: '0',
                                        max: '100',
                                        className: 'flex-1'
                                    }),
                                    React.createElement('input', {
                                        type: 'number',
                                        name: 'performance',
                                        value: formData.performance,
                                        onChange: handleChange,
                                        min: '0',
                                        max: '100',
                                        className: 'w-20 p-2 border border-slate-200 rounded-lg text-center text-sm'
                                    })
                                ]),
                                
                                React.createElement('div', { className: 'flex justify-between text-xs text-slate-500 mt-2' }, [
                                    React.createElement('span', {}, 'Bajo'),
                                    React.createElement('span', {}, 'Promedio'),
                                    React.createElement('span', {}, 'Alto')
                                ])
                            ]),
                            
                            React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' }, [
                                React.createElement('div', {}, [
                                    React.createElement('label', {
                                        className: 'block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest'
                                    }, 'Potencial'),
                                    React.createElement('select', {
                                        name: 'potential',
                                        value: formData.potential,
                                        onChange: handleChange,
                                        className: 'w-full p-3 border border-slate-200 rounded-xl text-sm custom-select'
                                    }, 
                                        POTENTIAL_LEVELS.map(level => 
                                            React.createElement('option', { key: level, value: level }, [
                                                level === 'Alto' && '🟢 ',
                                                level === 'Medio' && '🟡 ',
                                                level === 'Bajo' && '🔴 ',
                                                level
                                            ])
                                        )
                                    )
                                ]),
                                
                                React.createElement('div', {}, [
                                    React.createElement('label', {
                                        className: 'block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest'
                                    }, 'Antigüedad (Años)'),
                                    React.createElement('input', {
                                        type: 'number',
                                        name: 'seniority',
                                        value: formData.seniority,
                                        onChange: handleChange,
                                        min: '0',
                                        max: '50',
                                        className: 'w-full p-3 border border-slate-200 rounded-xl text-sm'
                                    })
                                ])
                            ]),
                            
                            React.createElement('div', {}, [
                                React.createElement('label', {
                                    className: 'block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest'
                                }, 'Salario Mensual ($)'),
                                React.createElement('div', { className: 'relative' }, [
                                    React.createElement('span', {
                                        className: 'absolute left-3 top-1/2 transform -translate-y-1/2 text-slate-500'
                                    }, '$'),
                                    React.createElement('input', {
                                        type: 'number',
                                        name: 'salary',
                                        value: formData.salary,
                                        onChange: handleChange,
                                        min: '0',
                                        step: '100',
                                        className: 'w-full p-3 pl-8 border border-slate-200 rounded-xl text-sm'
                                    })
                                ])
                            ])
                        ])
                    ]),
                    
                    React.createElement('div', {
                        className: 'bg-white p-5 rounded-3xl border border-slate-200 card-shadow space-y-5'
                    }, [
                        React.createElement('h4', {
                            className: 'font-black text-slate-800 text-sm uppercase tracking-widest flex items-center gap-2'
                        }, [
                            React.createElement('i', { className: 'fas fa-sitemap text-blue-600' }),
                            'Jerarquía y Reportes'
                        ]),
                        
                        React.createElement('div', { className: 'space-y-4' }, [
                            React.createElement('div', {}, [
                                React.createElement('label', {
                                    className: 'block text-[10px] font-black text-slate-400 uppercase mb-2 tracking-widest'
                                }, 'Jefe Directo (Línea de Reporte)'),
                                React.createElement('select', {
                                    name: 'parentId',
                                    value: formData.parentId || 'null',
                                    onChange: handleChange,
                                    className: `w-full p-3 border ${errors.parentId ? 'border-red-300' : 'border-slate-200'} rounded-xl text-sm bg-white custom-select`
                                }, [
                                    React.createElement('option', { value: 'null' }, '👑 Dirección General / Sin Jefe'),
                                    ...availableParents
                                        .sort((a, b) => a.name.localeCompare(b.name))
                                        .map(node => 
                                            React.createElement('option', {
                                                key: node.id,
                                                value: node.id
                                            }, `${node.name} - ${node.title} (${node.department})`)
                                        )
                                ]),
                                errors.parentId && React.createElement('p', {
                                    className: 'text-red-500 text-xs mt-1'
                                }, errors.parentId)
                            ])
                        ])
                    ]),
                    
                    React.createElement('div', {
                        className: 'bg-gradient-to-r from-red-50/80 to-pink-50/80 p-5 rounded-3xl border border-red-200 card-shadow space-y-5'
                    }, [
                        React.createElement('div', { className: 'flex items-center justify-between' }, [
                            React.createElement('h4', {
                                className: 'font-black text-red-800 text-sm uppercase tracking-widest flex items-center gap-2'
                            }, [
                                React.createElement('i', { className: 'fas fa-exclamation-triangle text-red-600' }),
                                'Riesgo y Sucesión'
                            ]),
                            React.createElement('label', { className: 'flex items-center gap-2 cursor-pointer' }, [
                                React.createElement('input', {
                                    type: 'checkbox',
                                    name: 'isCritical',
                                    checked: formData.isCritical,
                                    onChange: handleChange,
                                    className: 'custom-checkbox'
                                }),
                                React.createElement('span', { className: 'text-sm font-bold text-red-700' }, 'Posición Crítica')
                            ])
                        ]),
                        
                        formData.isCritical && React.createElement('div', { className: 'space-y-4 animate-in' }, [
                            React.createElement('div', {}, [
                                React.createElement('label', {
                                    className: 'block text-[10px] font-black text-red-600 uppercase mb-2 tracking-widest'
                                }, 'Sucesor Identificado'),
                                React.createElement('select', {
                                    name: 'successionId',
                                    value: formData.successionId || 'null',
                                    onChange: handleChange,
                                    className: `w-full p-3 border ${errors.successionId ? 'border-red-300' : 'border-red-200'} rounded-xl text-sm bg-white/80 custom-select`
                                }, [
                                    React.createElement('option', { value: 'null' }, '⚠️ No hay sucesor identificado'),
                                    ...(availableSuccessors.length > 0 ? 
                                        availableSuccessors.map(node => 
                                            React.createElement('option', {
                                                key: node.id,
                                                value: node.id
                                            }, `${node.name} - ${node.title}`)
                                        ) : [
                                            React.createElement('option', {
                                                value: 'null',
                                                disabled: true
                                            }, 'No hay colaboradores disponibles en este departamento')
                                        ]
                                    )
                                ]),
                                errors.successionId && React.createElement('p', {
                                    className: 'text-red-500 text-xs mt-1'
                                }, errors.successionId)
                            ]),
                            
                            React.createElement('div', {
                                className: 'p-3 bg-red-100/50 rounded-xl border border-red-300'
                            }, [
                                React.createElement('p', {
                                    className: 'text-xs text-red-700 font-medium'
                                }, [
                                    React.createElement('i', { className: 'fas fa-info-circle mr-2' }),
                                    'Las posiciones críticas son vitales para la organización y requieren un plan de sucesión para garantizar la continuidad del negocio.'
                                ])
                            ])
                        ])
                    ]),
                    
                    React.createElement('div', { className: 'flex gap-3' }, [
                        selectedNode ? 
                            React.createElement('button', {
                                onClick: () => {
                                    if (window.confirm('¿Estás seguro de eliminar este colaborador? Esta acción no se puede deshacer.')) {
                                        onDelete(formData.id);
                                    }
                                },
                                className: 'flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white py-3.5 rounded-2xl font-black text-xs hover:from-red-600 hover:to-red-700 transition-all shadow-lg shadow-red-500/20 flex items-center justify-center gap-2'
                            }, [
                                React.createElement('i', { className: 'fas fa-trash-alt' }),
                                'Eliminar'
                            ]) :
                            React.createElement('button', {
                                onClick: onCancel,
                                className: 'flex-1 bg-white border border-slate-300 text-slate-700 py-3.5 rounded-2xl font-black text-xs hover:bg-slate-50 transition-all flex items-center justify-center gap-2'
                            }, [
                                React.createElement('i', { className: 'fas fa-times' }),
                                'Cancelar'
                            ]),
                        
                        React.createElement('button', {
                            onClick: handleSave,
                            className: 'flex-[2] bg-gradient-to-r from-slate-900 to-gray-900 text-white py-3.5 rounded-2xl font-black text-xs hover:from-slate-800 hover:to-gray-800 transition-all shadow-xl flex items-center justify-center gap-2'
                        }, [
                            React.createElement('i', { className: 'fas fa-save' }),
                            selectedNode ? 'Guardar Cambios' : 'Crear Colaborador'
                        ])
                    ])
                ])
            );
        };
        
        // ============================================
        // COMPONENTE DE VISUALIZACIÓN D3 (ROBUSTO)
        // ============================================
        
        const OrgChartD3 = ({ nodes, selectedNodeId, onSelectNode, showLegend = true }) => {
            const svgRef = React.useRef(null);
            const containerRef = React.useRef(null);
            const [dimensions, setDimensions] = React.useState({ width: 0, height: 0 });
            const [error, setError] = React.useState(null);
            
            React.useEffect(() => {
                const updateDimensions = () => {
                    if (containerRef.current) {
                        const { width, height } = containerRef.current.getBoundingClientRect();
                        setDimensions({ width, height });
                    }
                };
                
                updateDimensions();
                window.addEventListener('resize', updateDimensions);
                return () => window.removeEventListener('resize', updateDimensions);
            }, []);
            
            React.useEffect(() => {
                if (!svgRef.current || !containerRef.current) return;
                
                const { width, height } = dimensions;
                if (width === 0 || height === 0) return;
                
                const svg = d3.select(svgRef.current)
                    .attr('width', width)
                    .attr('height', height);
                
                svg.selectAll('*').remove();
                
                try {
                    if (!nodes || nodes.length === 0) {
                        // Mostrar mensaje de estructura vacía
                        svg.append('text')
                            .attr('x', width / 2)
                            .attr('y', height / 2)
                            .attr('text-anchor', 'middle')
                            .attr('fill', '#64748b')
                            .text('Carga datos o usa el simulador para comenzar');
                        return;
                    }
                    
                    // Sanitizar datos antes de procesar
                    const sanitizedNodes = sanitizeForD3(nodes);
                    
                    if (sanitizedNodes.length === 0) {
                        svg.append('text')
                            .attr('x', width / 2)
                            .attr('y', height / 2)
                            .attr('text-anchor', 'middle')
                            .attr('fill', '#64748b')
                            .text('No hay datos válidos para mostrar');
                        return;
                    }
                    
                    const defs = svg.append('defs');
                    
                    const cardShadow = defs.append('filter')
                        .attr('id', 'card-shadow')
                        .attr('height', '130%');
                    
                    cardShadow.append('feGaussianBlur')
                        .attr('in', 'SourceAlpha')
                        .attr('stdDeviation', 3);
                    cardShadow.append('feOffset')
                        .attr('dx', 0)
                        .attr('dy', 4)
                        .attr('result', 'offsetBlur');
                    
                    const feMerge = cardShadow.append('feMerge');
                    feMerge.append('feMergeNode').attr('in', 'offsetBlur');
                    feMerge.append('feMergeNode').attr('in', 'SourceGraphic');
                    
                    const selectedShadow = defs.append('filter')
                        .attr('id', 'selected-shadow')
                        .attr('height', '150%');
                    
                    selectedShadow.append('feGaussianBlur')
                        .attr('in', 'SourceAlpha')
                        .attr('stdDeviation', 4);
                    selectedShadow.append('feOffset')
                        .attr('dx', 0)
                        .attr('dy', 6)
                        .attr('result', 'offsetBlur2');
                    selectedShadow.append('feFlood')
                        .attr('flood-color', '#3b82f6')
                        .attr('flood-opacity', 0.3)
                        .attr('result', 'color');
                    selectedShadow.append('feComposite')
                        .attr('in', 'color')
                        .attr('in2', 'offsetBlur2')
                        .attr('operator', 'in')
                        .attr('result', 'coloredBlur');
                    
                    const feMerge2 = selectedShadow.append('feMerge');
                    feMerge2.append('feMergeNode').attr('in', 'coloredBlur');
                    feMerge2.append('feMergeNode').attr('in', 'SourceGraphic');
                    
                    const g = svg.append('g');
                    
                    const zoom = d3.zoom()
                        .scaleExtent([0.1, 3])
                        .on('zoom', (event) => {
                            g.attr('transform', event.transform);
                        });
                    
                    svg.call(zoom);
                    
                    const nodeMap = new Map(sanitizedNodes.map(n => [n.id, n]));
                    const processed = sanitizedNodes.map(n => ({ ...n }));
                    const roots = processed.filter(n => !n.parentId || !nodeMap.has(n.parentId));
                    const virtualRootId = 'VIRTUAL_ROOT';
                    
                    // Añadir raíz virtual solo si hay múltiples raíces
                    if (roots.length > 1) {
                        processed.push({
                            id: virtualRootId,
                            name: '',
                            title: '',
                            department: '',
                            parentId: null
                        });
                        
                        roots.forEach(r => r.parentId = virtualRootId);
                    }
                    
                    const root = d3.stratify()
                        .id(d => d.id)
                        .parentId(d => d.parentId)
                        (processed);
                    
                    const treeLayout = d3.tree()
                        .nodeSize([220, 280])
                        .separation((a, b) => a.parent === b.parent ? 1 : 2);
                    
                    treeLayout(root);
                    
                    // Dibujar líneas de conexión
                    g.selectAll('.link')
                        .data(root.links())
                        .enter()
                        .append('path')
                        .filter(d => d.source.id !== virtualRootId && d.target.id !== virtualRootId)
                        .attr('class', 'link')
                        .attr('fill', 'none')
                        .attr('stroke', '#cbd5e1')
                        .attr('stroke-width', 2)
                        .attr('opacity', 0.6)
                        .attr('d', d3.linkVertical()
                            .x(d => d.x)
                            .y(d => d.y)
                        );
                    
                    // Crear nodos
                    const nodeGroups = g.selectAll('.node')
                        .data(root.descendants())
                        .enter()
                        .append('g')
                        .filter(d => d.id !== virtualRootId)
                        .attr('class', 'node')
                        .attr('transform', d => `translate(${d.x}, ${d.y})`)
                        .on('click', (event, d) => {
                            event.stopPropagation();
                            onSelectNode(d.id);
                        })
                        .style('cursor', 'pointer')
                        .attr('data-node-id', d => d.id);
                    
                    // Fondo del nodo
                    nodeGroups.append('rect')
                        .attr('class', 'node-card')
                        .attr('width', 200)
                        .attr('height', 120)
                        .attr('x', -100)
                        .attr('y', -60)
                        .attr('rx', 20)
                        .attr('fill', 'white')
                        .attr('filter', d => d.id === selectedNodeId ? 'url(#selected-shadow)' : 'url(#card-shadow)')
                        .attr('stroke', d => {
                            if (d.id === selectedNodeId) return '#2563eb';
                            if (d.data.isCritical && !d.data.successionId) return '#ef4444';
                            if (d.data.isCritical) return '#f59e0b';
                            return '#f1f5f9';
                        })
                        .attr('stroke-width', d => {
                            if (d.id === selectedNodeId) return 3;
                            if (d.data.isCritical) return 2;
                            return 1;
                        })
                        .attr('class', d => d.data.isCritical && !d.data.successionId ? 'animate-pulse' : '');
                    
                    // Barra superior de color
                    nodeGroups.append('rect')
                        .attr('width', 200)
                        .attr('height', 8)
                        .attr('x', -100)
                        .attr('y', -60)
                        .attr('rx', 4)
                        .attr('fill', d => d.data.color || COLORS_DEPT[d.data.department] || '#3b82f6');
                    
                    // Nombre
                    nodeGroups.append('text')
                        .attr('class', 'node-name')
                        .attr('dy', -30)
                        .attr('x', -85)
                        .attr('fill', '#0f172a')
                        .style('font-size', '12px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => {
                            const name = d.data.name || '';
                            return name.length > 20 ? name.substring(0, 18) + '...' : name;
                        });
                    
                    // Cargo
                    nodeGroups.append('text')
                        .attr('class', 'node-title')
                        .attr('dy', -15)
                        .attr('x', -85)
                        .attr('fill', '#64748b')
                        .style('font-size', '10px')
                        .style('font-weight', '600')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => {
                            const title = d.data.title || '';
                            return title.length > 25 ? title.substring(0, 23) + '...' : title;
                        });
                    
                    // Departamento
                    nodeGroups.append('text')
                        .attr('class', 'node-dept')
                        .attr('dy', 0)
                        .attr('x', -85)
                        .attr('fill', '#3b82f6')
                        .style('font-size', '9px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .style('text-transform', 'uppercase')
                        .style('letter-spacing', '0.05em')
                        .text(d => {
                            const dept = d.data.department || '';
                            return dept.length > 18 ? dept.substring(0, 16) + '...' : dept;
                        });
                    
                    // Barra de rendimiento
                    const perfGroup = nodeGroups.append('g')
                        .attr('transform', 'translate(-85, 20)');
                    
                    perfGroup.append('rect')
                        .attr('width', 130)
                        .attr('height', 6)
                        .attr('fill', '#f1f5f9')
                        .attr('rx', 3);
                    
                    perfGroup.append('rect')
                        .attr('width', d => {
                            const perf = d.data.performance || 0;
                            return Math.max(10, (perf / 100) * 130);
                        })
                        .attr('height', 6)
                        .attr('rx', 3)
                        .attr('fill', d => {
                            const perf = d.data.performance || 0;
                            if (perf >= 85) return '#10b981';
                            if (perf >= 70) return '#f59e0b';
                            return '#ef4444';
                        });
                    
                    perfGroup.append('text')
                        .attr('x', 135)
                        .attr('y', 5)
                        .attr('text-anchor', 'start')
                        .attr('fill', '#64748b')
                        .style('font-size', '9px')
                        .style('font-weight', '700')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => `${d.data.performance || 0}%`);
                    
                    // Badge de potencial
                    const badgeGroup = nodeGroups.append('g')
                        .attr('transform', 'translate(50, 35)');
                    
                    badgeGroup.append('rect')
                        .attr('width', 38)
                        .attr('height', 18)
                        .attr('rx', 9)
                        .attr('fill', d => {
                            const pot = d.data.potential || 'Medio';
                            if (pot === 'Alto') return '#dcfce7';
                            if (pot === 'Medio') return '#fef3c7';
                            return '#f1f5f9';
                        });
                    
                    badgeGroup.append('text')
                        .attr('x', 19)
                        .attr('y', 12)
                        .attr('text-anchor', 'middle')
                        .attr('fill', d => {
                            const pot = d.data.potential || 'Medio';
                            if (pot === 'Alto') return '#166534';
                            if (pot === 'Medio') return '#92400e';
                            return '#64748b';
                        })
                        .style('font-size', '8px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .style('text-transform', 'uppercase')
                        .text(d => {
                            const pot = d.data.potential || 'Medio';
                            if (pot === 'Alto') return 'TOP';
                            if (pot === 'Medio') return 'MED';
                            return 'BAJO';
                        });
                    
                    // Indicador de posición crítica
                    nodeGroups.filter(d => d.data.isCritical)
                        .append('circle')
                        .attr('cx', 80)
                        .attr('cy', -45)
                        .attr('r', 6)
                        .attr('fill', d => d.data.successionId ? '#f59e0b' : '#ef4444')
                        .attr('stroke', 'white')
                        .attr('stroke-width', 2)
                        .attr('class', d => !d.data.successionId ? 'animate-pulse' : '');
                    
                    // Salario
                    nodeGroups.append('text')
                        .attr('x', 80)
                        .attr('y', 55)
                        .attr('text-anchor', 'middle')
                        .attr('fill', '#059669')
                        .style('font-size', '9px')
                        .style('font-weight', '800')
                        .style('font-family', 'Inter, sans-serif')
                        .text(d => {
                            const salary = d.data.salary || 0;
                            if (salary >= 10000) return `$${(salary / 1000).toFixed(0)}k`;
                            if (salary >= 1000) return `$${(salary / 1000).toFixed(1)}k`;
                            return `$${salary}`;
                        });
                    
                    // Ajustar zoom para mostrar todo el árbol
                    const rootNodes = root.descendants().filter(d => d.id !== virtualRootId);
                    if (rootNodes.length > 0) {
                        const xExtent = d3.extent(rootNodes, d => d.x);
                        const yExtent = d3.extent(rootNodes, d => d.y);
                        
                        const scale = Math.min(
                            (width - 100) / (xExtent[1] - xExtent[0]),
                            (height - 100) / (yExtent[1] - yExtent[0]),
                            0.9
                        );
                        
                        const translateX = width / 2 - (xExtent[0] + xExtent[1]) / 2 * scale;
                        const translateY = height / 2 - (yExtent[0] + yExtent[1]) / 2 * scale;
                        
                        svg.transition()
                            .duration(800)
                            .call(zoom.transform, d3.zoomIdentity
                                .translate(translateX, translateY)
                                .scale(scale)
                            );
                    }
                    
                    setError(null);
                } catch (err) {
                    console.error('Error al renderizar el organigrama:', err);
                    setError('Error al renderizar el gráfico. Los datos pueden estar corruptos.');
                    
                    // Mostrar mensaje de error
                    svg.append('text')
                        .attr('x', width / 2)
                        .attr('y', height / 2)
                        .attr('text-anchor', 'middle')
                        .attr('fill', '#ef4444')
                        .text('Error al renderizar el organigrama');
                }
                
            }, [nodes, selectedNodeId, dimensions]);
            
            if (error) {
                return (
                    React.createElement('div', {
                        className: 'w-full h-full flex flex-col items-center justify-center bg-gradient-to-b from-red-50 to-orange-50 text-red-400'
                    }, [
                        React.createElement('i', { className: 'fas fa-exclamation-triangle text-4xl mb-4' }),
                        React.createElement('p', { className: 'font-bold text-red-600' }, error),
                        React.createElement('button', {
                            onClick: () => setError(null),
                            className: 'mt-4 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors'
                        }, 'Reintentar')
                    ])
                );
            }
            
            if (!nodes || nodes.length === 0) {
                return (
                    React.createElement('div', {
                        className: 'w-full h-full flex flex-col items-center justify-center bg-gradient-to-b from-slate-50 to-blue-50/30 text-slate-400'
                    }, [
                        React.createElement('i', { className: 'fas fa-sitemap text-8xl opacity-10 mb-6' }),
                        React.createElement('p', { className: 'font-black text-2xl text-slate-300 mb-2' }, 'Organigrama vacío'),
                        React.createElement('p', {
                            className: 'text-sm opacity-60 max-w-md text-center'
                        }, 'Carga datos desde Excel o usa el simulador para comenzar')
                    ])
                );
            }
            
            return (
                React.createElement('div', {
                    ref: containerRef,
                    id: "capture-area",
                    className: 'w-full h-full bg-gradient-to-b from-slate-50 to-blue-50/30 relative overflow-hidden d3-container',
                    onClick: () => onSelectNode(null)
                }, [
                    React.createElement('svg', {
                        ref: svgRef,
                        className: 'w-full h-full outline-none'
                    }),
                    
                    React.createElement('div', {
                        className: 'absolute bottom-4 right-4 glass-effect p-3 rounded-2xl border border-slate-200 card-shadow'
                    }, [
                        React.createElement('div', {
                            className: 'flex items-center gap-4 text-xs font-black text-slate-600'
                        }, [
                            React.createElement('span', { className: 'flex items-center gap-1' }, [
                                React.createElement('i', { className: 'fas fa-users text-blue-500' }),
                                `${nodes.length} colaboradores`
                            ]),
                            React.createElement('span', { className: 'flex items-center gap-1' }, [
                                React.createElement('i', { className: 'fas fa-building text-emerald-500' }),
                                `${new Set(nodes.map(n => n.department)).size} departamentos`
                            ]),
                            React.createElement('span', { className: 'flex items-center gap-1' }, [
                                React.createElement('i', { className: 'fas fa-dollar-sign text-amber-500' }),
                                `$${nodes.reduce((sum, n) => sum + (n.salary || 0), 0).toLocaleString()}`
                            ])
                        ])
                    ]),
                    
                    showLegend && React.createElement('div', {
                        className: 'absolute top-4 left-4 glass-effect p-4 rounded-2xl border border-slate-200 card-shadow max-w-xs animate-in slide-in-left'
                    }, [
                        React.createElement('div', {
                            className: 'flex justify-between items-center mb-3'
                        }, [
                            React.createElement('h5', {
                                className: 'text-xs font-black text-slate-400 uppercase flex items-center gap-2'
                            }, [
                                React.createElement('i', { className: 'fas fa-info-circle text-blue-500' }),
                                'Leyenda del Organigrama'
                            ])
                        ]),
                        React.createElement('div', { className: 'space-y-2' }, [
                            React.createElement('div', { className: 'flex items-center gap-2' }, [
                                React.createElement('div', { className: 'w-3 h-3 rounded-full bg-emerald-500' }),
                                React.createElement('span', { className: 'text-xs font-medium text-slate-600' }, 'Posición Estable')
                            ]),
                            React.createElement('div', { className: 'flex items-center gap-2' }, [
                                React.createElement('div', { className: 'w-3 h-3 rounded-full bg-amber-500' }),
                                React.createElement('span', { className: 'text-xs font-medium text-slate-600' }, 'Crítico con Sucesor')
                            ]),
                            React.createElement('div', { className: 'flex items-center gap-2' }, [
                                React.createElement('div', { className: 'w-3 h-3 rounded-full bg-red-500 animate-pulse' }),
                                React.createElement('span', { className: 'text-xs font-medium text-slate-600' }, 'Crítico sin Sucesor')
                            ]),
                            React.createElement('div', { className: 'flex items-center gap-2' }, [
                                React.createElement('div', { className: 'w-3 h-3 rounded-full bg-blue-500' }),
                                React.createElement('span', { className: 'text-xs font-medium text-slate-600' }, 'Seleccionado')
                            ]),
                            React.createElement('div', {
                                className: 'pt-2 mt-2 border-t border-slate-100'
                            }, [
                                React.createElement('p', {
                                    className: 'text-[10px] text-slate-500'
                                }, [
                                    React.createElement('i', { className: 'fas fa-mouse-pointer mr-1' }),
                                    'Haz clic en cualquier nodo para editarlo'
                                ])
                            ])
                        ])
                    ])
                ])
            );
        };
        
        // ============================================
        // COMPONENTES DE ANÁLISIS
        // ============================================
        
        const VersionManager = ({ nodes, onSaveVersion }) => {
            const [versions, setVersions] = React.useState(() => {
                try {
                    const saved = localStorage.getItem('luxanalitica_versions');
                    return saved ? JSON.parse(saved) : [];
                } catch {
                    return [];
                }
            });
            
            const [versionName, setVersionName] = React.useState('');
            
            const handleSaveVersion = () => {
                try {
                    const name = versionName || `Versión ${versions.length + 1} - ${new Date().toLocaleString()}`;
                    const newVersion = {
                        id: `v${Date.now()}`,
                        name,
                        timestamp: new Date().toISOString(),
                        data: JSON.parse(JSON.stringify(nodes)),
                        stats: calculateVersionStats(nodes)
                    };
                    
                    const updatedVersions = [newVersion, ...versions].slice(0, 3);
                    setVersions(updatedVersions);
                    localStorage.setItem('luxanalitica_versions', JSON.stringify(updatedVersions));
                    setVersionName('');
                    onSaveVersion(updatedVersions);
                    
                    alert(`Versión "${name}" guardada correctamente.`);
                } catch (error) {
                    console.error('Error guardando versión:', error);
                    alert('Error al guardar la versión.');
                }
            };
            
            const calculateVersionStats = (nodes) => {
                return {
                    totalNodes: nodes.length,
                    totalSalary: nodes.reduce((sum, n) => sum + (n.salary || 0), 0),
                    avgPerformance: Math.round(nodes.reduce((sum, n) => sum + (n.performance || 0), 0) / nodes.length),
                    criticalNodes: nodes.filter(n => n.isCritical).length,
                    criticalIssues: nodes.filter(n => n.isCritical && !n.successionId).length
                };
            };
            
            const handleDeleteVersion = (versionId) => {
                try {
                    const updatedVersions = versions.filter(v => v.id !== versionId);
                    setVersions(updatedVersions);
                    localStorage.setItem('luxanalitica_versions', JSON.stringify(updatedVersions));
                    onSaveVersion(updatedVersions);
                } catch (error) {
                    console.error('Error eliminando versión:', error);
                }
            };
            
            return (
                React.createElement('div', { className: 'space-y-4' }, [
                    React.createElement('div', { className: 'flex items-center gap-3' }, [
                        React.createElement('input', {
                            type: 'text',
                            value: versionName,
                            onChange: (e) => setVersionName(e.target.value),
                            placeholder: "Nombre de la versión (ej: 'Antes de reestructuración')",
                            className: 'flex-1 p-3 border border-slate-200 rounded-xl text-sm'
                        }),
                        React.createElement('button', {
                            onClick: handleSaveVersion,
                            disabled: versions.length >= 3,
                            className: 'px-4 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl font-bold hover:from-blue-700 hover:to-blue-800 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2'
                        }, [
                            React.createElement('i', { className: 'fas fa-save' }),
                            'Guardar Versión'
                        ])
                    ]),
                    
                    versions.length > 0 && React.createElement('div', { className: 'space-y-3' }, [
                        React.createElement('h4', { className: 'font-bold text-slate-700' }, 'Versiones Guardadas:'),
                        ...versions.map(version => 
                            React.createElement('div', {
                                key: version.id,
                                className: 'bg-white p-4 rounded-xl border border-slate-200 flex justify-between items-center'
                            }, [
                                React.createElement('div', {}, [
                                    React.createElement('div', { className: 'font-bold text-slate-800' }, version.name),
                                    React.createElement('div', { className: 'text-xs text-slate-500' },
                                        `${new Date(version.timestamp).toLocaleString()} • ${version.stats.totalNodes} colaboradores • $${version.stats.totalSalary.toLocaleString()}`
                                    )
                                ]),
                                React.createElement('button', {
                                    onClick: () => handleDeleteVersion(version.id),
                                    className: 'text-red-500 hover:text-red-700 p-2'
                                }, [
                                    React.createElement('i', { className: 'fas fa-trash' })
                                ])
                            ])
                        )
                    ]),
                    
                    versions.length >= 3 && React.createElement('div', {
                        className: 'bg-amber-50 border border-amber-200 p-3 rounded-xl text-amber-700 text-sm'
                    }, [
                        React.createElement('i', { className: 'fas fa-exclamation-triangle mr-2' }),
                        'Límite alcanzado (3 versiones máx.). Elimina una versión para guardar una nueva.'
                    ])
                ])
            );
        };
        
        const SubordinateAnalysis = ({ nodes }) => {
            const analysis = React.useMemo(() => {
                if (!nodes.length) return null;
                
                const subordinateCount = {};
                nodes.forEach(node => {
                    if (node.parentId && node.parentId.trim() !== '') {
                        subordinateCount[node.parentId] = (subordinateCount[node.parentId] || 0) + 1;
                    }
                });
                
                const overloadedManagers = nodes.filter(node => 
                    (subordinateCount[node.id] || 0) > 5 && 
                    (node.title || '').match(/Gerente|Director|Supervisor|Manager|Head/i)
                ).map(node => ({
                    ...node,
                    subordinateCount: subordinateCount[node.id] || 0
                }));
                
                const underloadedManagers = nodes.filter(node => 
                    (subordinateCount[node.id] || 0) < 2 && 
                    (node.title || '').match(/Gerente|Director|Manager|Head/i)
                ).map(node => ({
                    ...node,
                    subordinateCount: subordinateCount[node.id] || 0
                }));
                
                const loadDistribution = {
                    '0-2': nodes.filter(n => (subordinateCount[n.id] || 0) <= 2).length,
                    '3-5': nodes.filter(n => (subordinateCount[n.id] || 0) >= 3 && (subordinateCount[n.id] || 0) <= 5).length,
                    '6-10': nodes.filter(n => (subordinateCount[n.id] || 0) >= 6 && (subordinateCount[n.id] || 0) <= 10).length,
                    '10+': nodes.filter(n => (subordinateCount[n.id] || 0) > 10).length
                };
                
                return {
                    overloadedManagers,
                    underloadedManagers,
                    loadDistribution,
                    avgSubordinates: Object.values(subordinateCount).length > 0 
                        ? (Object.values(subordinateCount).reduce((a, b) => a + b, 0) / Object.values(subordinateCount).length).toFixed(1)
                        : 0,
                    maxSubordinates: Math.max(...Object.values(subordinateCount).concat([0]))
                };
            }, [nodes]);
            
            if (!analysis) return null;
            
            return (
                React.createElement('div', { className: 'space-y-6' }, [
                    React.createElement('div', {
                        className: 'grid grid-cols-2 md:grid-cols-4 gap-4'
                    }, [
                        React.createElement('div', {
                            className: 'bg-white p-4 rounded-xl border border-slate-200'
                        }, [
                            React.createElement('div', { className: 'text-2xl font-bold text-slate-800' }, analysis.avgSubordinates),
                            React.createElement('div', { className: 'text-sm text-slate-600' }, 'Promedio de Subordinados')
                        ]),
                        React.createElement('div', {
                            className: 'bg-white p-4 rounded-xl border border-slate-200'
                        }, [
                            React.createElement('div', { className: 'text-2xl font-bold text-slate-800' }, analysis.maxSubordinates),
                            React.createElement('div', { className: 'text-sm text-slate-600' }, 'Máximo de Subordinados')
                        ]),
                        React.createElement('div', {
                            className: 'bg-white p-4 rounded-xl border border-slate-200'
                        }, [
                            React.createElement('div', { className: 'text-2xl font-bold text-slate-800' }, analysis.overloadedManagers.length),
                            React.createElement('div', { className: 'text-sm text-slate-600' }, 'Jefes Sobrecargados')
                        ]),
                        React.createElement('div', {
                            className: 'bg-white p-4 rounded-xl border border-slate-200'
                        }, [
                            React.createElement('div', { className: 'text-2xl font-bold text-slate-800' }, analysis.underloadedManagers.length),
                            React.createElement('div', { className: 'text-sm text-slate-600' }, 'Jefes con Poca Carga')
                        ])
                    ]),
                    
                    analysis.overloadedManagers.length > 0 && React.createElement('div', {
                        className: 'bg-gradient-to-r from-red-50 to-orange-50 p-4 rounded-xl border border-red-200'
                    }, [
                        React.createElement('h5', {
                            className: 'font-bold text-red-800 mb-3 flex items-center gap-2'
                        }, [
                            React.createElement('i', { className: 'fas fa-exclamation-triangle' }),
                            'Alertas: Jefes Sobrecargados (> 5 reportes directos)'
                        ]),
                        React.createElement('div', { className: 'space-y-2' },
                            analysis.overloadedManagers.slice(0, 3).map(manager => 
                                React.createElement('div', {
                                    key: manager.id,
                                    className: 'flex justify-between items-center p-3 bg-white rounded-lg'
                                }, [
                                    React.createElement('div', {}, [
                                        React.createElement('div', { className: 'font-bold text-slate-800' }, manager.name),
                                        React.createElement('div', { className: 'text-sm text-slate-600' },
                                            `${manager.title} • ${manager.department}`
                                        )
                                    ]),
                                    React.createElement('div', { className: 'text-red-600 font-bold' },
                                        `${manager.subordinateCount} subordinados`
                                    )
                                ])
                            )
                        )
                    ])
                ])
            );
        };
        
        const AIRecommendations = ({ nodes, versions }) => {
            const generateRecommendations = () => {
                if (!nodes.length) return [];
                
                const recommendations = [];
                
                const avgSalaryByDept = {};
                nodes.forEach(node => {
                    const dept = node.department || 'Sin departamento';
                    if (!avgSalaryByDept[dept]) {
                        avgSalaryByDept[dept] = { total: 0, count: 0 };
                    }
                    avgSalaryByDept[dept].total += node.salary || 0;
                    avgSalaryByDept[dept].count += 1;
                });
                
                Object.entries(avgSalaryByDept).forEach(([dept, data]) => {
                    const avg = data.total / data.count;
                    nodes.filter(n => n.department === dept && n.salary < avg * 0.7).forEach(node => {
                        recommendations.push({
                            type: 'salario',
                            priority: 'media',
                            title: 'Salario por debajo del promedio del departamento',
                            description: `${node.name} (${node.title}) tiene un salario $${node.salary.toLocaleString()} que está ${Math.round((1 - node.salary/avg)*100)}% por debajo del promedio de ${dept} ($${Math.round(avg).toLocaleString()})`,
                            action: 'Considerar ajuste salarial basado en equidad interna'
                        });
                    });
                });
                
                nodes.filter(n => n.performance < 70 && n.salary > 10000).forEach(node => {
                    recommendations.push({
                        type: 'rendimiento',
                        priority: 'alta',
                        title: 'Bajo rendimiento con alto salario',
                        description: `${node.name} tiene rendimiento del ${node.performance}% con salario de $${node.salary.toLocaleString()}`,
                        action: 'Evaluar plan de mejora o reasignación'
                    });
                });
                
                nodes.filter(n => n.isCritical && !n.successionId).forEach(node => {
                    recommendations.push({
                        type: 'sucesion',
                        priority: 'critica',
                        title: 'Posición crítica sin sucesor identificado',
                        description: `${node.name} (${node.title}) es crítico para ${node.department} y no tiene sucesor asignado`,
                        action: 'Identificar y desarrollar sucesor inmediatamente'
                    });
                });
                
                nodes.filter(n => n.performance >= 85 && n.salary < 5000 && n.potential === 'Alto').forEach(node => {
                    recommendations.push({
                        type: 'retencion',
                        priority: 'alta',
                        title: 'Alto potencial en riesgo de fuga',
                        description: `${node.name} tiene rendimiento del ${node.performance}% y potencial Alto, pero salario bajo ($${node.salary.toLocaleString()})`,
                        action: 'Considerar aumento para retención'
                    });
                });
                
                return recommendations.slice(0, 6);
            };
            
            const recommendations = generateRecommendations();
            
            if (recommendations.length === 0) {
                return (
                    React.createElement('div', {
                        className: 'bg-gradient-to-r from-emerald-50 to-green-50 p-6 rounded-xl border border-emerald-200 text-center'
                    }, [
                        React.createElement('i', { className: 'fas fa-check-circle text-emerald-500 text-3xl mb-3' }),
                        React.createElement('p', { className: 'font-bold text-emerald-700' }, 'Estructura óptima detectada'),
                        React.createElement('p', { className: 'text-sm text-emerald-600 mt-1' },
                            'No se encontraron áreas críticas que requieran atención inmediata'
                        )
                    ])
                );
            }
            
            const getPriorityColor = (priority) => {
                switch(priority) {
                    case 'critica': return 'bg-gradient-to-r from-red-600 to-red-700';
                    case 'alta': return 'bg-gradient-to-r from-orange-600 to-amber-600';
                    case 'media': return 'bg-gradient-to-r from-blue-600 to-blue-700';
                    default: return 'bg-gradient-to-r from-slate-600 to-slate-700';
                }
            };
            
            return (
                React.createElement('div', { className: 'space-y-4' }, [
                    React.createElement('div', { className: 'flex justify-between items-center' }, [
                        React.createElement('h4', {
                            className: 'font-bold text-slate-800 text-lg flex items-center gap-2'
                        }, [
                            React.createElement('i', { className: 'fas fa-robot text-purple-600' }),
                            'Recomendaciones de IA'
                        ]),
                        React.createElement('span', {
                            className: 'text-xs font-bold bg-purple-100 text-purple-700 px-3 py-1 rounded-full'
                        }, `${recommendations.length} acciones sugeridas`)
                    ]),
                    
                    React.createElement('div', { className: 'space-y-3' },
                        recommendations.map((rec, index) => 
                            React.createElement('div', {
                                key: index,
                                className: 'bg-white p-4 rounded-xl border border-slate-200'
                            }, [
                                React.createElement('div', { className: 'flex items-start gap-3' }, [
                                    React.createElement('div', {
                                        className: `w-8 h-8 ${getPriorityColor(rec.priority)} rounded-lg flex items-center justify-center text-white text-sm`
                                    }, rec.priority === 'critica' ? '!' : rec.priority === 'alta' ? '↑' : '•'),
                                    React.createElement('div', { className: 'flex-1' }, [
                                        React.createElement('div', { className: 'font-bold text-slate-800' }, rec.title),
                                        React.createElement('div', { className: 'text-sm text-slate-600 mt-1' }, rec.description),
                                        React.createElement('div', { className: 'mt-2 p-2 bg-slate-50 rounded text-sm' }, [
                                            React.createElement('span', { className: 'font-bold text-slate-700' }, 'Acción recomendada:'),
                                            ` ${rec.action}`
                                        ])
                                    ])
                                ])
                            ])
                        )
                    ),
                    
                    versions.length >= 2 && React.createElement('div', {
                        className: 'mt-6 bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200'
                    }, [
                        React.createElement('h5', {
                            className: 'font-bold text-slate-800 mb-2 flex items-center gap-2'
                        }, [
                            React.createElement('i', { className: 'fas fa-bolt text-amber-500' }),
                            'Recomendación Basada en Comparación de Versiones'
                        ]),
                        React.createElement('p', { className: 'text-sm text-slate-600' }, [
                            'Basado en el análisis de ', versions.length, ' versiones, la estructura más eficiente es la ',
                            React.createElement('strong', {}, `Versión ${versions[0].name}`),
                            ' con mejor relación costo-rendimiento.'
                        ])
                    ])
                ])
            );
        };
        
        // ============================================
        // COMPONENTE DE ANÁLISIS 360°
        // ============================================
        
        const AnalysisTab = ({ nodes }) => {
            const [versions, setVersions] = React.useState(() => {
                try {
                    const saved = localStorage.getItem('luxanalitica_versions');
                    return saved ? JSON.parse(saved) : [];
                } catch {
                    return [];
                }
            });
            
            const chartData = React.useMemo(() => {
                return generateChartData(nodes);
            }, [nodes]);
            
            const stats = React.useMemo(() => {
                if (!nodes || nodes.length === 0) {
                    return {
                        totalNodes: 0,
                        totalDepartments: 0,
                        totalSalary: 0,
                        avgSalary: 0,
                        avgPerformance: 0,
                        avgSeniority: 0,
                        criticalNodes: 0,
                        criticalIssues: 0,
                        riskLevel: 0,
                        topTalents: 0,
                        avgSubordinatesPerManager: 0,
                        maxSubordinates: 0,
                        genderDiversity: 0,
                        avgDeptSize: 0,
                        overloadedManagers: []
                    };
                }
                
                const totalSalary = nodes.reduce((sum, n) => sum + (n.salary || 0), 0);
                const avgSalary = nodes.length > 0 ? Math.round(totalSalary / nodes.length) : 0;
                
                const validPerformances = nodes.filter(n => n.performance != null);
                const avgPerformance = validPerformances.length > 0 
                    ? Math.round(validPerformances.reduce((sum, n) => sum + (n.performance || 0), 0) / validPerformances.length)
                    : 0;
                
                const validSeniority = nodes.filter(n => n.seniority != null);
                const avgSeniority = validSeniority.length > 0
                    ? Number((validSeniority.reduce((sum, n) => sum + (n.seniority || 0), 0) / validSeniority.length).toFixed(1))
                    : 0;
                
                const departments = [...new Set(nodes.map(n => n.department || 'Sin departamento'))];
                const criticalNodes = nodes.filter(n => n.isCritical);
                const criticalIssues = criticalNodes.filter(n => !n.successionId);
                const riskLevel = criticalNodes.length > 0
                    ? Math.round((criticalIssues.length / criticalNodes.length) * 100)
                    : 0;
                
                const subordinateCount = {};
                nodes.forEach(node => {
                    if (node.parentId && node.parentId.trim() !== '') {
                        subordinateCount[node.parentId] = (subordinateCount[node.parentId] || 0) + 1;
                    }
                });
                
                const topTalents = nodes.filter(n => 
                    n.potential === 'Alto' && 
                    (n.performance || 0) >= 85
                );
                
                const overloadedManagers = nodes.filter(n => 
                    (subordinateCount[n.id] || 0) > 5 && 
                    (n.title || '').match(/Gerente|Director|Supervisor|Manager|Head/i)
                );
                
                return {
                    totalNodes: nodes.length,
                    totalDepartments: departments.length,
                    totalSalary,
                    avgSalary,
                    avgPerformance,
                    avgSeniority,
                    criticalNodes: criticalNodes.length,
                    criticalIssues: criticalIssues.length,
                    riskLevel,
                    topTalents: topTalents.length,
                    overloadedManagers,
                    avgSubordinatesPerManager: Object.values(subordinateCount).length > 0 
                        ? (Object.values(subordinateCount).reduce((a, b) => a + b, 0) / Object.values(subordinateCount).length).toFixed(1)
                        : 0,
                    maxSubordinates: Math.max(...Object.values(subordinateCount).concat([0])),
                    genderDiversity: chartData.genderData ? (chartData.genderData.length > 1 ? 1 : 0) : 0,
                    avgDeptSize: departments.length > 0 ? Math.round(nodes.length / departments.length) : 0
                };
            }, [nodes, chartData]);
            
            const handleSaveVersion = (updatedVersions) => {
                setVersions(updatedVersions);
            };
            
            const generateComparativeReport = () => {
                if (versions.length < 2) {
                    alert('Necesitas al menos 2 versiones para generar un reporte comparativo.');
                    return;
                }
                
                try {
                    const currentStats = stats;
                    const bestVersion = versions[0];
                    
                    const reportData = [
                        ['REPORTE COMPARATIVO DE ESTRUCTURA ORGANIZACIONAL', '', '', ''],
                        ['Generado por Luxanalitica HR 360°', '', 'Fecha:', new Date().toLocaleDateString()],
                        ['', '', '', ''],
                        ['MÉTRICA', 'VERSIÓN ACTUAL', `VERSIÓN ${bestVersion.name}`, 'DIFERENCIA'],
                        ['Total Colaboradores', currentStats.totalNodes, bestVersion.stats.totalNodes, currentStats.totalNodes - bestVersion.stats.totalNodes],
                        ['Masa Salarial Mensual', `$${currentStats.totalSalary.toLocaleString()}`, `$${bestVersion.stats.totalSalary.toLocaleString()}`, `$${(currentStats.totalSalary - bestVersion.stats.totalSalary).toLocaleString()}`],
                        ['Rendimiento Promedio', `${currentStats.avgPerformance}%`, `${bestVersion.stats.avgPerformance}%`, `${currentStats.avgPerformance - bestVersion.stats.avgPerformance}%`],
                        ['Posiciones Críticas', currentStats.criticalNodes, bestVersion.stats.criticalNodes, currentStats.criticalNodes - bestVersion.stats.criticalNodes],
                        ['Críticos sin Sucesor', currentStats.criticalIssues, bestVersion.stats.criticalIssues, currentStats.criticalIssues - bestVersion.stats.criticalIssues],
                        ['', '', '', ''],
                        ['RECOMENDACIONES DE IA:', '', '', ''],
                        ['1. Optimización Salarial', 'Revisar colaboradores con salario por debajo del promedio de su departamento', '', ''],
                        ['2. Gestión de Carga', `Redistribuir ${currentStats.overloadedManagers.length} jefes sobrecargados`, '', ''],
                        ['3. Plan de Sucesión', `Definir sucesores para ${currentStats.criticalIssues} posiciones críticas`, '', ''],
                        ['4. Desarrollo de Talento', `Invertir en ${currentStats.topTalents} colaboradores de alto potencial`, '', ''],
                    ];
                    
                    chartData.deptStats?.forEach(dept => {
                        if (dept.avgPerformance < 70) {
                            reportData.push([
                                `Reestructurar ${dept.name}`,
                                `${dept.avgPerformance}% rendimiento`,
                                '≥75% rendimiento',
                                'Aumento de productividad'
                            ]);
                        }
                    });
                    
                    const ws = XLSX.utils.aoa_to_sheet(reportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Recomendaciones");
                    
                    const detailData = nodes.map(node => {
                        const deptAvg = chartData.deptStats?.find(d => d.name === node.department)?.avgSalary || 0;
                        const salaryRatio = deptAvg > 0 ? (node.salary / deptAvg) : 0;
                        
                        return {
                            'ID': node.id,
                            'Nombre': node.name,
                            'Cargo': node.title,
                            'Departamento': node.department,
                            'Salario Actual': node.salary,
                            'Salario Promedio Depto': deptAvg,
                            '% vs Promedio': `${Math.round((salaryRatio - 1) * 100)}%`,
                            'Rendimiento': `${node.performance}%`,
                            'Potencial': node.potential,
                            'Antigüedad': `${node.seniority} años`,
                            'Es Crítico': node.isCritical ? 'SÍ' : 'NO',
                            'Tiene Sucesor': node.successionId ? 'SÍ' : 'NO',
                            'Subordinados': chartData.matrixData?.find(m => m.name === node.name)?.subordinateCount || 0,
                            'Recomendación': 
                                salaryRatio < 0.7 ? 'Aumento salarial' :
                                node.performance < 70 && node.salary > 10000 ? 'Plan de mejora' :
                                node.isCritical && !node.successionId ? 'Definir sucesor' :
                                node.performance >= 85 && node.salary < 5000 && node.potential === 'Alto' ? 'Retención estratégica' :
                                'OK'
                        };
                    });
                    
                    const ws2 = XLSX.utils.json_to_sheet(detailData);
                    XLSX.utils.book_append_sheet(wb, ws2, "Análisis Detallado");
                    
                    XLSX.writeFile(wb, `Luxanalitica_Analisis_Comparativo_${new Date().toISOString().slice(0,10)}.xlsx`);
                } catch (error) {
                    console.error('Error generando reporte:', error);
                    alert('Error al generar el reporte. Intenta nuevamente.');
                }
            };
            
            return (
                React.createElement('div', {
                    className: 'p-4 md:p-6 h-full overflow-y-auto bg-gradient-to-b from-slate-50 to-blue-50/20 space-y-6 scrollbar-hide animate-in fade-in duration-700'
                }, [
                    React.createElement('div', {
                        className: 'bg-gradient-to-r from-blue-900 to-purple-900 text-white p-8 rounded-3xl card-shadow relative overflow-hidden'
                    }, [
                        React.createElement('div', {
                            className: 'absolute -top-20 -right-20 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl'
                        }),
                        React.createElement('div', { className: 'relative z-10' }, [
                            React.createElement('div', { className: 'flex items-start gap-6' }, [
                                React.createElement('div', {
                                    className: 'w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-500 rounded-2xl flex items-center justify-center text-3xl shadow-xl'
                                }, [
                                    React.createElement('i', { className: 'fas fa-brain' })
                                ]),
                                React.createElement('div', { className: 'flex-1' }, [
                                    React.createElement('h2', { className: 'text-3xl font-black mb-4' },
                                        'HR Analytics 360° - Motor de Inteligencia de Negocios (BI)'
                                    ),
                                    React.createElement('p', {
                                        className: 'text-blue-100 text-lg leading-relaxed'
                                    }, [
                                        'Transforma la base de datos de empleados en decisiones estratégicas de capital humano. ',
                                        'Esta no es solo una sección de gráficos, es un ',
                                        React.createElement('strong', {}, 'sistema de People Analytics profesional'),
                                        ' que permite pasar de una gestión reactiva a una proactiva basada en datos reales.'
                                    ])
                                ])
                            ])
                        ])
                    ]),
                    
                    React.createElement('div', {
                        className: 'bg-white p-6 rounded-3xl border border-slate-200 card-shadow'
                    }, [
                        React.createElement('h3', {
                            className: 'font-black text-slate-800 text-xl mb-6 flex items-center gap-3'
                        }, [
                            React.createElement('i', { className: 'fas fa-code-branch text-blue-600' }),
                            'Sistema de Versiones - Simulaciones de Guerra'
                        ]),
                        React.createElement('div', { className: 'space-y-6' }, [
                            React.createElement(VersionManager, {
                                nodes: nodes,
                                onSaveVersion: handleSaveVersion
                            })
                        ])
                    ]),
                    
                    React.createElement('div', {
                        className: 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4'
                    }, [
                        React.createElement(KPIBox, {
                            icon: 'fa-users',
                            color: 'blue',
                            label: 'Plantilla Total',
                            value: stats.totalNodes,
                            sub: `${stats.totalDepartments} departamentos`
                        }),
                        React.createElement(KPIBox, {
                            icon: 'fa-rocket',
                            color: 'emerald',
                            label: 'Eficiencia Global',
                            value: `${stats.avgPerformance}%`,
                            sub: 'Promedio de rendimiento'
                        }),
                        React.createElement(KPIBox, {
                            icon: 'fa-funnel-dollar',
                            color: 'indigo',
                            label: 'Masa Salarial',
                            value: `$${(stats.totalSalary / 1000).toFixed(1)}k`,
                            sub: 'Costo laboral mensual'
                        }),
                        React.createElement(KPIBox, {
                            icon: 'fa-shield-alt',
                            color: 'red',
                            label: 'Riesgo de Sucesión',
                            value: `${stats.riskLevel}%`,
                            sub: `${stats.criticalIssues}/${stats.criticalNodes} críticos sin sucesor`
                        })
                    ]),
                    
                    React.createElement('div', {
                        className: 'grid grid-cols-1 lg:grid-cols-2 gap-6'
                    }, [
                        React.createElement('div', {
                            className: 'bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex flex-col min-h-[400px]'
                        }, [
                            React.createElement('div', { className: 'flex justify-between items-center mb-6' }, [
                                React.createElement('h4', {
                                    className: 'font-black text-slate-800 flex items-center gap-3'
                                }, [
                                    React.createElement('i', { className: 'fas fa-th-large text-blue-500' }),
                                    'Matriz de Talento 9-Box'
                                ]),
                                React.createElement('span', {
                                    className: 'text-[10px] bg-blue-100 text-blue-700 px-3 py-1.5 rounded-full font-black'
                                }, 'ESTÁNDAR DE ORO EN GESTIÓN DE TALENTO')
                            ]),
                            React.createElement('div', { className: 'flex-1' }, [
                                React.createElement(MatrixChart, { data: chartData.matrixData || [] })
                            ]),
                            React.createElement('div', {
                                className: 'mt-4 pt-4 border-t border-slate-100 text-sm text-slate-600'
                            }, [
                                React.createElement('div', { className: 'grid grid-cols-3 gap-4' }, [
                                    React.createElement('div', {}, [
                                        React.createElement('div', { className: 'font-bold' }, 'Mejores Talentos'),
                                        React.createElement('div', { className: 'text-xs' }, 'Alto potencial + Alto rendimiento')
                                    ]),
                                    React.createElement('div', {}, [
                                        React.createElement('div', { className: 'font-bold' }, 'Jugadores Principales'),
                                        React.createElement('div', { className: 'text-xs' }, 'Rendimiento consistente')
                                    ]),
                                    React.createElement('div', {}, [
                                        React.createElement('div', { className: 'font-bold' }, 'En Riesgo'),
                                        React.createElement('div', { className: 'text-xs' }, 'Bajo rendimiento')
                                    ])
                                ])
                            ])
                        ]),
                        
                        React.createElement('div', {
                            className: 'bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex flex-col min-h-[400px]'
                        }, [
                            React.createElement('h4', {
                                className: 'font-black text-slate-800 mb-6 flex items-center gap-3'
                            }, [
                                React.createElement('i', { className: 'fas fa-chart-line text-emerald-500' }),
                                'Eficiencia Operativa: Costo vs Rendimiento'
                            ]),
                            React.createElement('div', { className: 'flex-1' }, [
                                React.createElement(ComposedChartDept, { data: chartData.deptStats || [] })
                            ]),
                            React.createElement('div', {
                                className: 'mt-4 flex justify-center gap-6 text-[10px] font-bold text-slate-400 uppercase tracking-widest'
                            }, [
                                React.createElement('span', { className: 'flex items-center gap-2' }, [
                                    React.createElement('div', { className: 'w-2 h-2 bg-blue-500 rounded-full' }),
                                    'Inversión Salarial'
                                ]),
                                React.createElement('span', { className: 'flex items-center gap-2' }, [
                                    React.createElement('div', { className: 'w-2 h-2 bg-emerald-500 rounded-full' }),
                                    'Rendimiento Operativo'
                                ])
                            ])
                        ])
                    ]),
                    
                    React.createElement('div', {
                        className: 'bg-white p-6 rounded-3xl border border-slate-200 card-shadow'
                    }, [
                        React.createElement('h4', {
                            className: 'font-black text-slate-800 mb-6 flex items-center gap-3'
                        }, [
                            React.createElement('i', { className: 'fas fa-network-wired text-purple-600' }),
                            'Análisis de Carga de Trabajo y Estructura de Reportes'
                        ]),
                        React.createElement(SubordinateAnalysis, { nodes: nodes })
                    ]),
                    
                    React.createElement('div', {
                        className: 'grid grid-cols-1 lg:grid-cols-3 gap-6'
                    }, [
                        React.createElement('div', {
                            className: 'bg-white p-6 rounded-3xl border border-slate-200 card-shadow flex flex-col h-[350px]'
                        }, [
                            React.createElement('h4', {
                                className: 'font-black text-slate-800 mb-6 flex items-center gap-3'
                            }, [
                                React.createElement('i', { className: 'fas fa-hourglass-half text-amber-500' }),
                                'Análisis de Antigüedad (Experiencia Acumulada)'
                            ]),
                            React.createElement('div', { className: 'flex-1' }, [
                                React.createElement(VerticalBarChart, {
                                    data: chartData.seniorityRanges || [],
                                    dataKey: 'count',
                                    nameKey: 'range',
                                    title: 'Análisis de Antigüedad'
                                })
                            ])
                        ]),
                        
                        React.createElement('div', {
                            className: 'bg-white p-6 rounded-3xl border border-slate-200 card-shadow h-[350px] flex flex-col'
                        }, [
                            React.createElement('h4', {
                                className: 'font-black text-slate-800 mb-2'
                            }, 'Mezcla de Género y Diversidad (ESG)'),
                            React.createElement('div', { className: 'h-44' }, [
                                React.createElement(PieChartComponent, { data: chartData.genderData || [] })
                            ]),
                            React.createElement('div', {
                                className: 'mt-4 pt-4 border-t border-slate-100 flex items-center justify-between'
                            }, [
                                React.createElement('div', { className: 'text-center' }, [
                                    React.createElement('p', { className: 'text-[10px] font-black text-slate-400 uppercase' }, 'Top Performers'),
                                    React.createElement('p', { className: 'text-xl font-black text-emerald-600' }, stats.topTalents)
                                ]),
                                React.createElement('div', { className: 'h-8 w-[1px] bg-slate-100' }),
                                React.createElement('div', { className: 'text-center' }, [
                                    React.createElement('p', { className: 'text-[10px] font-black text-slate-400 uppercase' }, 'Promedio Dept'),
                                    React.createElement('p', { className: 'text-xl font-black text-slate-800' }, stats.avgDeptSize)
                                ]),
                                React.createElement('div', { className: 'h-8 w-[1px] bg-slate-100' }),
                                React.createElement('div', { className: 'text-center' }, [
                                    React.createElement('p', { className: 'text-[10px] font-black text-slate-400 uppercase' }, 'Antigüedad'),
                                    React.createElement('p', { className: 'text-xl font-black text-slate-800' }, `${stats.avgSeniority}a`)
                                ])
                            ])
                        ]),
                        
                        React.createElement('div', {
                            className: 'bg-white p-6 rounded-3xl border border-slate-200 card-shadow h-[350px] flex flex-col'
                        }, [
                            React.createElement('h4', {
                                className: 'font-black text-slate-800 mb-6 flex items-center gap-3'
                            }, [
                                React.createElement('i', { className: 'fas fa-money-bill-wave text-green-500' }),
                                'Distribución Salarial por Rangos'
                            ]),
                            React.createElement('div', { className: 'flex-1' }, [
                                React.createElement(VerticalBarChart, {
                                    data: chartData.salaryRanges || [],
                                    dataKey: 'count',
                                    nameKey: 'range',
                                    color: '#10b981',
                                    title: 'Distribución Salarial'
                                })
                            ])
                        ])
                    ]),
                    
                    React.createElement('div', {
                        className: 'bg-white p-6 rounded-3xl border border-slate-200 card-shadow'
                    }, [
                        React.createElement(AIRecommendations, { nodes: nodes, versions: versions })
                    ]),
                    
                    React.createElement('div', {
                        className: 'bg-gradient-to-r from-slate-900 via-gray-900 to-slate-900 p-8 rounded-3xl card-shadow flex flex-col justify-center text-white relative overflow-hidden'
                    }, [
                        React.createElement('div', { className: 'absolute -top-10 -right-10 w-40 h-40 bg-blue-600/20 rounded-full blur-3xl' }),
                        React.createElement('div', { className: 'absolute -bottom-10 -left-10 w-40 h-40 bg-purple-600/20 rounded-full blur-3xl' }),
                        
                        React.createElement('div', { className: 'relative z-10' }, [
                            React.createElement('div', { className: 'flex items-center gap-4 mb-6' }, [
                                React.createElement('div', {
                                    className: `w-14 h-14 rounded-2xl flex items-center justify-center text-2xl shadow-xl ${
                                        stats.riskLevel > 30 ? 'bg-gradient-to-br from-red-500 to-red-600' :
                                        stats.riskLevel > 15 ? 'bg-gradient-to-br from-amber-500 to-amber-600' :
                                        'bg-gradient-to-br from-emerald-500 to-emerald-600'
                                    }`
                                }, [
                                    React.createElement('i', {
                                        className: `fas ${
                                            stats.riskLevel > 30 ? 'fa-exclamation-triangle' :
                                            stats.riskLevel > 15 ? 'fa-shield-alt' :
                                            'fa-shield-check'
                                        }`
                                    })
                                ]),
                                React.createElement('div', {}, [
                                    React.createElement('h4', { className: 'font-black text-lg' },
                                        'Monitor de Salud HR - Alertas de Continuidad'
                                    ),
                                    React.createElement('p', {
                                        className: 'text-[10px] font-bold text-slate-400 uppercase tracking-widest'
                                    }, 'Sistema de alerta temprana para vulnerabilidades organizacionales')
                                ])
                            ]),
                            
                            React.createElement('div', { className: 'space-y-4 mb-8' }, [
                                React.createElement(RiskMiniItem, {
                                    label: 'Vulnerabilidad Crítica (sin sucesor)',
                                    value: stats.criticalIssues,
                                    total: stats.criticalNodes,
                                    color: 'red'
                                }),
                                React.createElement(RiskMiniItem, {
                                    label: 'High-Performance Talent',
                                    value: stats.topTalents,
                                    total: stats.totalNodes,
                                    color: 'emerald'
                                }),
                                React.createElement(RiskMiniItem, {
                                    label: 'Índice de Retención Proyectado',
                                    value: 100 - stats.riskLevel,
                                    total: 100,
                                    color: 'blue'
                                })
                            ]),
                            
                            React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-3 gap-3' }, [
                                React.createElement('button', {
                                    className: 'py-3 bg-white/10 hover:bg-white/20 border border-white/20 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2',
                                    onClick: () => {
                                        const element = document.getElementById('capture-area');
                                        if (!element) return;
                                        
                                        html2canvas(element, { 
                                            scale: 2,
                                            backgroundColor: '#f8fafc',
                                            useCORS: true,
                                            logging: false
                                        }).then(canvas => {
                                            const link = document.createElement('a');
                                            link.download = `Luxanalitica_Dashboard_${Date.now()}.jpg`;
                                            link.href = canvas.toDataURL('image/jpeg', 0.9);
                                            link.click();
                                        });
                                    }
                                }, [
                                    React.createElement('i', { className: 'fas fa-camera' }),
                                    'Capturar Dashboard'
                                ]),
                                React.createElement('button', {
                                    className: 'py-3 bg-gradient-to-r from-emerald-600 to-green-600 hover:from-emerald-700 hover:to-green-700 border border-emerald-500/30 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2',
                                    onClick: () => {
                                        const ws = XLSX.utils.json_to_sheet([
                                            { 'Métrica': 'Total Colaboradores', 'Valor': stats.totalNodes },
                                            { 'Métrica': 'Departamentos', 'Valor': stats.totalDepartments },
                                            { 'Métrica': 'Masa Salarial Mensual', 'Valor': `$${stats.totalSalary.toLocaleString()}` },
                                            { 'Métrica': 'Rendimiento Promedio', 'Valor': `${stats.avgPerformance}%` },
                                            { 'Métrica': 'Antigüedad Promedio', 'Valor': `${stats.avgSeniority} años` },
                                            { 'Métrica': 'Posiciones Críticas', 'Valor': stats.criticalNodes },
                                            { 'Métrica': 'Críticos sin Sucesor', 'Valor': stats.criticalIssues },
                                            { 'Métrica': 'Riesgo de Sucesión', 'Valor': `${stats.riskLevel}%` },
                                            { 'Métrica': 'Top Performers', 'Valor': stats.topTalents },
                                            { 'Métrica': 'Promedio Subordinados', 'Valor': stats.avgSubordinatesPerManager },
                                            { 'Métrica': 'Jefes Sobrecargados', 'Valor': stats.overloadedManagers.length },
                                        ]);
                                        
                                        const wb = XLSX.utils.book_new();
                                        XLSX.utils.book_append_sheet(wb, ws, "Resumen Ejecutivo");
                                        XLSX.writeFile(wb, `Luxanalitica_Reporte_360_${new Date().toISOString().slice(0,10)}.xlsx`);
                                    }
                                }, [
                                    React.createElement('i', { className: 'fas fa-file-excel' }),
                                    'Exportar Reporte'
                                ]),
                                React.createElement('button', {
                                    className: 'py-3 bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 border border-blue-500/30 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-2',
                                    onClick: generateComparativeReport,
                                    disabled: versions.length < 2
                                }, [
                                    React.createElement('i', { className: 'fas fa-robot' }),
                                    'Análisis Comparativo IA'
                                ])
                            ])
                        ])
                    ])
                ])
            );
        };
        
        // ============================================
        // COMPONENTE DE EXPORTACIÓN
        // ============================================
        
        const ExportTab = ({ nodes }) => {
            const [exporting, setExporting] = React.useState(false);
            
            const handleExportExcel = () => {
                try {
                    const excelData = nodes.map(node => ({
                        'ID': node.id,
                        'Nombre': node.name,
                        'Cargo': node.title,
                        'Departamento': node.department,
                        'Jefe ID': node.parentId || 'N/A',
                        'Salario ($)': node.salary || 0,
                        'Rendimiento (%)': node.performance || 0,
                        'Potencial': node.potential || 'Medio',
                        'Género': node.gender || 'Otro',
                        'Antigüedad (años)': node.seniority || 0,
                        'Posición Crítica': node.isCritical ? 'Sí' : 'No',
                        'ID Sucesor': node.successionId || 'N/A',
                        'Color': node.color || '#3b82f6'
                    }));
                    
                    const ws = XLSX.utils.json_to_sheet(excelData);
                    
                    const wscols = [
                        { wch: 10 }, { wch: 25 }, { wch: 25 }, { wch: 20 },
                        { wch: 10 }, { wch: 12 }, { wch: 12 }, { wch: 10 },
                        { wch: 10 }, { wch: 10 }, { wch: 12 }, { wch: 10 },
                        { wch: 10 }
                    ];
                    ws['!cols'] = wscols;
                    
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Organigrama");
                    
                    const summaryData = [
                        ['RESUMEN DE ESTRUCTURA ORGANIZACIONAL', ''],
                        ['Fecha de exportación:', new Date().toLocaleDateString('es-ES')],
                        ['Hora de exportación:', new Date().toLocaleTimeString('es-ES')],
                        ['Total colaboradores:', nodes.length],
                        ['Total departamentos:', new Set(nodes.map(n => n.department)).size],
                        ['Masa salarial total:', `$${nodes.reduce((sum, n) => sum + (n.salary || 0), 0).toLocaleString()}`],
                        ['Rendimiento promedio:', `${Math.round(nodes.reduce((sum, n) => sum + (n.performance || 0), 0) / nodes.length)}%`],
                        ['Posiciones críticas:', nodes.filter(n => n.isCritical).length],
                        ['Críticos sin sucesor:', nodes.filter(n => n.isCritical && !n.successionId).length],
                        ['',''],
                        ['Este reporte fue generado por Luxanalitica HR 360°', '']
                    ];
                    
                    const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                    XLSX.utils.book_append_sheet(wb, wsSummary, "Resumen");
                    
                    XLSX.writeFile(wb, `Luxanalitica_Export_${new Date().toISOString().slice(0,10)}.xlsx`);
                    
                } catch (error) {
                    console.error('Error exportando Excel:', error);
                    alert('Error al exportar a Excel. Intenta nuevamente.');
                }
            };
            
            const handleExportPDF = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false,
                        allowTaint: true
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('landscape', 'px', [canvas.width, canvas.height]);
                    
                    pdf.setFontSize(28);
                    pdf.setTextColor(30, 41, 59);
                    pdf.text('Reporte Organizacional', canvas.width / 2, 50, { align: 'center' });
                    
                    pdf.setFontSize(16);
                    pdf.setTextColor(100, 116, 139);
                    pdf.text('Luxanalitica HR 360°', canvas.width / 2, 75, { align: 'center' });
                    
                    pdf.setFontSize(12);
                    pdf.text(`Generado el ${new Date().toLocaleDateString('es-ES', { 
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    })}`, canvas.width / 2, 95, { align: 'center' });
                    
                    pdf.addImage(imgData, 'PNG', 20, 120, canvas.width - 40, canvas.height - 140);
                    
                    pdf.setFontSize(10);
                    pdf.setTextColor(30, 41, 59);
                    const statsText = [
                        `Total colaboradores: ${nodes.length}`,
                        `Departamentos: ${new Set(nodes.map(n => n.department)).size}`,
                        `Masa salarial: $${nodes.reduce((sum, n) => sum + (n.salary || 0), 0).toLocaleString()}`,
                        `Rendimiento promedio: ${Math.round(nodes.reduce((sum, n) => sum + (n.performance || 0), 0) / nodes.length)}%`
                    ].join(' | ');
                    
                    pdf.text(statsText, 20, canvas.height - 10);
                    
                    pdf.setFontSize(48);
                    pdf.setTextColor(241, 245, 249);
                    pdf.text('LUXANALITICA', canvas.width / 2, canvas.height / 2, { align: 'center', angle: 45 });
                    
                    pdf.save(`Luxanalitica_OrgChart_${new Date().toISOString().slice(0,10)}.pdf`);
                    
                } catch (error) {
                    console.error('Error exportando PDF:', error);
                    alert('Error al generar el PDF. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            const handleExportJSON = () => {
                try {
                    const dataStr = JSON.stringify({
                        metadata: {
                            exportDate: new Date().toISOString(),
                            totalNodes: nodes.length,
                            totalDepartments: new Set(nodes.map(n => n.department)).size,
                            version: '1.0'
                        },
                        nodes: nodes
                    }, null, 2);
                    
                    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
                    const link = document.createElement('a');
                    link.setAttribute('href', dataUri);
                    link.setAttribute('download', `Luxanalitica_Data_${new Date().toISOString().slice(0,10)}.json`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                } catch (error) {
                    console.error('Error exportando JSON:', error);
                    alert('Error al exportar JSON. Intenta nuevamente.');
                }
            };
            
            const handleExportImage = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 3,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false
                    });
                    
                    const link = document.createElement('a');
                    link.download = `Luxanalitica_OrgChart_${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                } catch (error) {
                    console.error('Error exportando imagen:', error);
                    alert('Error al exportar la imagen. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            const ExportCard = ({ icon, title, description, buttonText, onClick, color, disabled }) => (
                React.createElement('div', {
                    className: 'bg-white p-8 rounded-3xl border border-slate-200 card-shadow flex flex-col items-center text-center space-y-6 transition-transform hover:scale-[1.02] h-full'
                }, [
                    React.createElement('div', { className: `text-6xl ${color} mb-2` }, [
                        React.createElement('i', { className: `fas ${icon}` })
                    ]),
                    
                    React.createElement('div', { className: 'space-y-3 flex-1' }, [
                        React.createElement('h3', { className: 'text-2xl font-black text-slate-800 tracking-tight' }, title),
                        React.createElement('p', { className: 'text-slate-500 text-sm leading-relaxed' }, description)
                    ]),
                    
                    React.createElement('button', {
                        onClick: onClick,
                        disabled: disabled || exporting,
                        className: `w-full py-4 rounded-2xl font-black card-shadow transition-all hover:brightness-110 disabled:cursor-not-allowed disabled:opacity-50 flex items-center justify-center gap-2 ${
                            disabled ? 'bg-slate-400 text-white' : 
                            color === 'text-blue-600' ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white' :
                            color === 'text-red-600' ? 'bg-gradient-to-r from-red-600 to-red-700 text-white' :
                            color === 'text-emerald-600' ? 'bg-gradient-to-r from-emerald-600 to-green-600 text-white' :
                            'bg-gradient-to-r from-amber-600 to-orange-600 text-white'
                        }`
                    }, [
                        exporting && React.createElement('i', { className: 'fas fa-spinner fa-spin' }),
                        buttonText
                    ])
                ])
            );
            
            return (
                React.createElement('div', {
                    className: 'p-6 md:p-12 h-full bg-gradient-to-b from-slate-50 to-blue-50/30 flex flex-col items-center justify-center overflow-y-auto scrollbar-hide'
                }, [
                    React.createElement('div', { className: 'max-w-6xl w-full space-y-10' }, [
                        React.createElement('div', { className: 'text-center space-y-4' }, [
                            React.createElement('h2', { className: 'text-4xl font-black text-slate-900' }, 'Exportar Reportes Maestros'),
                            React.createElement('p', {
                                className: 'text-slate-600 max-w-2xl mx-auto'
                            }, 'Genera informes ejecutivos, comparte la estructura organizacional o realiza auditorías con nuestros formatos profesionales.')
                        ]),
                        
                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8' }, [
                            React.createElement(ExportCard, {
                                icon: 'fa-file-excel',
                                title: 'Base de Datos (Excel)',
                                description: 'Exporta toda la estructura con todos los KPIs en formato Excel compatible con sistemas de RRHH, Power BI y análisis avanzado.',
                                buttonText: 'Descargar Excel',
                                onClick: handleExportExcel,
                                color: 'text-emerald-600'
                            }),
                            
                            React.createElement(ExportCard, {
                                icon: 'fa-file-pdf',
                                title: 'Reporte Ejecutivo (PDF)',
                                description: 'Genera un informe profesional en PDF con la estructura organizacional, análisis de riesgo y gráficos ejecutivos.',
                                buttonText: exporting ? "Generando PDF..." : "Generar PDF",
                                onClick: handleExportPDF,
                                color: 'text-red-600',
                                disabled: exporting
                            })
                        ]),
                        
                        React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-8' }, [
                            React.createElement(ExportCard, {
                                icon: 'fa-file-code',
                                title: 'Datos Estructurados (JSON)',
                                description: 'Exporta la información en formato JSON para integración con APIs, aplicaciones personalizadas o análisis de datos avanzado.',
                                buttonText: 'Descargar JSON',
                                onClick: handleExportJSON,
                                color: 'text-amber-600'
                            }),
                            
                            React.createElement(ExportCard, {
                                icon: 'fa-file-image',
                                title: 'Imagen del Organigrama',
                                description: 'Captura una imagen de alta resolución del organigrama actual para presentaciones o documentación.',
                                buttonText: exporting ? "Generando Imagen..." : "Exportar Imagen",
                                onClick: handleExportImage,
                                color: 'text-blue-600',
                                disabled: exporting
                            })
                        ]),
                        
                        React.createElement('div', {
                            className: 'bg-gradient-to-r from-blue-50 to-cyan-50 p-6 rounded-3xl border border-blue-200 mt-8'
                        }, [
                            React.createElement('div', { className: 'flex items-start gap-4' }, [
                                React.createElement('div', {
                                    className: 'w-12 h-12 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-xl flex items-center justify-center text-white text-xl'
                                }, [
                                    React.createElement('i', { className: 'fas fa-lightbulb' })
                                ]),
                                React.createElement('div', {}, [
                                    React.createElement('h4', {
                                        className: 'font-black text-slate-800 text-lg mb-2'
                                    }, 'Recomendaciones de Exportación'),
                                    React.createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' }, [
                                        React.createElement('div', { className: 'space-y-2' }, [
                                            React.createElement('p', {
                                                className: 'text-sm font-bold text-slate-700 flex items-center gap-2'
                                            }, [
                                                React.createElement('i', { className: 'fas fa-check-circle text-emerald-500' }),
                                                'Para análisis financiero'
                                            ]),
                                            React.createElement('p', { className: 'text-xs text-slate-600' },
                                                'Usa el formato Excel para integrar con herramientas de presupuesto y control de costos.'
                                            )
                                        ]),
                                        React.createElement('div', { className: 'space-y-2' }, [
                                            React.createElement('p', {
                                                className: 'text-sm font-bold text-slate-700 flex items-center gap-2'
                                            }, [
                                                React.createElement('i', { className: 'fas fa-check-circle text-blue-500' }),
                                                'Para presentaciones ejecutivas'
                                            ]),
                                            React.createElement('p', { className: 'text-xs text-slate-600' },
                                                'El PDF profesional es ideal para compartir con dirección y stakeholders.'
                                            )
                                        ])
                                    ])
                                ])
                            ])
                        ])
                    ])
                ])
            );
        };
        
        // ============================================
        // COMPONENTE DE VISUALIZACIÓN (VisualTab)
        // ============================================
        
        const VisualTab = ({ nodes, viewMode, setViewMode }) => {
            const [selectedNodeId, setSelectedNodeId] = React.useState(null);
            const [exporting, setExporting] = React.useState(false);
            
            const handleExportPDF = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('landscape', 'px', [canvas.width, canvas.height]);
                    
                    pdf.setFontSize(24);
                    pdf.setTextColor(30, 41, 59);
                    pdf.text('Organigrama Estructural', canvas.width / 2, 40, { align: 'center' });
                    
                    pdf.setFontSize(12);
                    pdf.setTextColor(100, 116, 139);
                    pdf.text(`Empresa: Luxanalitica HR 360° | Fecha: ${new Date().toLocaleDateString()}`, canvas.width / 2, 60, { align: 'center' });
                    
                    pdf.addImage(imgData, 'PNG', 20, 80, canvas.width - 40, canvas.height - 100);
                    
                    pdf.setFontSize(10);
                    pdf.setTextColor(30, 41, 59);
                    pdf.text(`Total colaboradores: ${nodes.length} | Generado por Luxanalitica`, 20, canvas.height - 10);
                    
                    pdf.save(`Organigrama_${new Date().toISOString().slice(0,10)}.pdf`);
                    
                } catch (error) {
                    console.error('Error exportando PDF:', error);
                    alert('Error al generar el PDF. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            const handleExportImage = async () => {
                setExporting(true);
                try {
                    const element = document.getElementById('capture-area');
                    if (!element) {
                        throw new Error('No se encontró el área de captura');
                    }
                    
                    const canvas = await html2canvas(element, {
                        scale: 3,
                        backgroundColor: '#f8fafc',
                        useCORS: true,
                        logging: false
                    });
                    
                    const link = document.createElement('a');
                    link.download = `Organigrama_${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                } catch (error) {
                    console.error('Error exportando imagen:', error);
                    alert('Error al exportar la imagen. Intenta nuevamente.');
                } finally {
                    setExporting(false);
                }
            };
            
            return (
                React.createElement('div', { className: 'flex flex-col h-full bg-gradient-to-b from-slate-50 to-blue-50/30' }, [
                    React.createElement('div', {
                        className: 'p-4 bg-white border-b border-slate-200 flex flex-wrap justify-between items-center card-shadow z-10 gap-3'
                    }, [
                        React.createElement('div', { className: 'flex items-center gap-4' }, [
                            React.createElement('div', {
                                className: 'px-3 py-1.5 bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg flex items-center gap-2'
                            }, [
                                React.createElement('i', { className: 'fas fa-sitemap text-blue-600' }),
                                React.createElement('span', {
                                    className: 'text-xs font-black text-slate-800 uppercase tracking-widest'
                                }, 'Vista Jerárquica Premium')
                            ]),
                            
                            React.createElement('div', { className: 'flex gap-2' }, [
                                React.createElement('button', {
                                    onClick: () => setViewMode('vertical'),
                                    className: `px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
                                        viewMode === 'vertical' 
                                            ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg' 
                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`
                                }, [
                                    React.createElement('i', { className: 'fas fa-arrows-alt-v mr-1' }),
                                    'Vertical'
                                ]),
                                React.createElement('button', {
                                    onClick: () => setViewMode('horizontal'),
                                    className: `px-3 py-1.5 rounded-lg text-xs font-bold transition-all ${
                                        viewMode === 'horizontal' 
                                            ? 'bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg' 
                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`
                                }, [
                                    React.createElement('i', { className: 'fas fa-arrows-alt-h mr-1' }),
                                    'Horizontal'
                                ])
                            ])
                        ]),
                        
                        React.createElement('div', { className: 'flex gap-2' }, [
                            React.createElement('button', {
                                onClick: handleExportImage,
                                disabled: exporting,
                                className: 'px-4 py-2 bg-gradient-to-r from-slate-800 to-gray-800 text-white rounded-xl text-xs font-bold hover:from-slate-700 hover:to-gray-700 transition-all shadow-lg flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed'
                            }, [
                                exporting ? 
                                    React.createElement('i', { className: 'fas fa-spinner fa-spin' }) :
                                    React.createElement('i', { className: 'fas fa-file-image' }),
                                exporting ? 'Exportando...' : 'Exportar Imagen'
                            ]),
                            React.createElement('button', {
                                onClick: handleExportPDF,
                                disabled: exporting,
                                className: 'px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-xl text-xs font-bold hover:from-blue-700 hover:to-blue-800 transition-all shadow-lg shadow-blue-500/20 flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed'
                            }, [
                                exporting ? 
                                    React.createElement('i', { className: 'fas fa-spinner fa-spin' }) :
                                    React.createElement('i', { className: 'fas fa-file-pdf' }),
                                exporting ? 'Generando...' : 'Descargar PDF'
                            ])
                        ])
                    ]),
                    
                    React.createElement('div', { className: 'flex-1 relative overflow-hidden' }, [
                        React.createElement(OrgChartD3, {
                            nodes: nodes,
                            selectedNodeId: selectedNodeId,
                            onSelectNode: setSelectedNodeId
                        })
                    ])
                ])
            );
        };
        
        // ============================================
        // COMPONENTES DE INTERFAZ
        // ============================================
        
        const Header = () => {
            const [currentTime, setCurrentTime] = React.useState(new Date());
            
            React.useEffect(() => {
                const timer = setInterval(() => {
                    setCurrentTime(new Date());
                }, 1000);
                return () => clearInterval(timer);
            }, []);
            
            const formattedDate = currentTime.toLocaleDateString('es-ES', {
                weekday: 'long',
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
            
            const formattedTime = currentTime.toLocaleTimeString('es-ES', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            
            return (
                React.createElement('header', {
                    className: 'bg-white border-b border-slate-200 px-6 md:px-8 py-4 flex justify-between items-center card-shadow z-10'
                }, [
                    React.createElement('div', { className: 'flex items-center gap-4' }, [
                        React.createElement('div', {
                            className: 'p-2 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl'
                        }, [
                            React.createElement('i', { className: 'fas fa-project-diagram text-blue-600 text-2xl' })
                        ]),
                        React.createElement('div', {}, [
                            React.createElement('h1', { className: 'text-xl font-bold text-slate-800' }, 'Luxanalitica HR 360°'),
                            React.createElement('p', {
                                className: 'text-xs text-slate-400 font-semibold tracking-wide uppercase'
                            }, 'Plataforma de Diseño y Análisis Organizacional')
                        ])
                    ]),
                    
                    React.createElement('div', { className: 'hidden md:flex items-center gap-6' }, [
                        React.createElement('div', { className: 'text-right' }, [
                            React.createElement('div', { className: 'text-sm font-bold text-slate-700' }, formattedDate),
                            React.createElement('div', { className: 'text-xs text-slate-400 font-mono' }, formattedTime)
                        ]),
                        React.createElement('div', { className: 'h-10 w-[1px] bg-slate-200' }),
                        React.createElement('div', { className: 'flex items-center gap-3' }, [
                            React.createElement('div', { className: 'text-right' }, [
                                React.createElement('div', { className: 'text-xs font-bold text-slate-800' }, 'Admin User'),
                                React.createElement('div', {
                                    className: 'text-[10px] text-emerald-500 font-bold uppercase flex items-center gap-1'
                                }, [
                                    React.createElement('div', { className: 'w-2 h-2 bg-emerald-500 rounded-full animate-pulse' }),
                                    'Online'
                                ])
                            ]),
                            React.createElement('div', {
                                className: 'w-10 h-10 rounded-full bg-gradient-to-br from-slate-100 to-slate-50 border border-slate-200 flex items-center justify-center text-slate-400'
                            }, [
                                React.createElement('i', { className: 'fas fa-user-circle text-2xl' })
                            ])
                        ])
                    ])
                ])
            );
        };
        
        const Sidebar = ({ isOpen, onToggle }) => {
            return (
                React.createElement('div', {
                    className: `${isOpen ? 'w-64' : 'w-20'} h-full bg-gradient-to-b from-slate-900 to-gray-900 text-white transition-all duration-300 flex flex-col shrink-0 z-20 card-shadow`
                }, [
                    React.createElement('div', {
                        className: 'p-6 flex items-center gap-4 overflow-hidden whitespace-nowrap border-b border-slate-800'
                    }, [
                        React.createElement('div', {
                            className: 'w-10 h-10 bg-gradient-to-br from-blue-600 to-purple-600 rounded-xl flex items-center justify-center shrink-0 shadow-lg'
                        }, [
                            React.createElement('i', { className: 'fas fa-layer-group text-lg' })
                        ]),
                        isOpen && React.createElement('span', { className: 'font-bold text-xl tracking-tight' }, [
                            React.createElement('span', { className: 'text-gradient' }, 'Lux'),
                            'analitica'
                        ])
                    ]),
                    
                    React.createElement('nav', { className: 'flex-1 mt-6 px-3 space-y-2' }, [
                        React.createElement('div', {
                            className: 'flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all bg-gradient-to-r from-blue-600 to-blue-700 shadow-lg'
                        }, [
                            React.createElement('i', { className: 'fas fa-sitemap w-6 text-center text-lg' }),
                            isOpen && React.createElement('span', { className: 'font-medium' }, 'Organigrama')
                        ]),
                        
                        React.createElement('div', {
                            className: 'flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all text-slate-400 hover:text-white hover:bg-slate-800'
                        }, [
                            React.createElement('i', { className: 'fas fa-users w-6 text-center text-lg' }),
                            isOpen && React.createElement('span', { className: 'font-medium' }, 'Plantilla')
                        ]),
                        
                        React.createElement('div', {
                            className: 'flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all text-slate-400 hover:text-white hover:bg-slate-800'
                        }, [
                            React.createElement('i', { className: 'fas fa-chart-line w-6 text-center text-lg' }),
                            isOpen && React.createElement('span', { className: 'font-medium' }, 'KPIs HR')
                        ]),
                        
                        React.createElement('div', {
                            className: 'flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-all text-slate-400 hover:text-white hover:bg-slate-800'
                        }, [
                            React.createElement('i', { className: 'fas fa-cog w-6 text-center text-lg' }),
                            isOpen && React.createElement('span', { className: 'font-medium' }, 'Configuración')
                        ])
                    ]),
                    
                    React.createElement('div', { className: 'p-4 border-t border-slate-800' }, [
                        React.createElement('button', {
                            onClick: onToggle,
                            className: 'w-full flex items-center justify-center p-3 rounded-xl hover:bg-slate-800 transition-colors'
                        }, [
                            React.createElement('i', { className: `fas ${isOpen ? 'fa-chevron-left' : 'fa-chevron-right'}` })
                        ])
                    ])
                ])
            );
        };
        
        const TabNavigation = ({ activeTab, setActiveTab }) => {
            const tabs = [
                { id: 'carga', label: 'Cargar Excel', icon: 'fa-cloud-upload-alt' },
                { id: 'diseno', label: 'Editor de Flujo', icon: 'fa-pencil-ruler' },
                { id: 'visualizacion', label: 'Vista Expandida', icon: 'fa-expand' },
                { id: 'analisis', label: 'HR Analytics 360°', icon: 'fa-chart-pie' },
                { id: 'exportacion', label: 'Exportar', icon: 'fa-file-download' },
            ];
            
            return (
                React.createElement('div', {
                    className: 'flex bg-white rounded-t-2xl border-t border-x border-slate-200 overflow-x-auto scrollbar-hide shrink-0 card-shadow'
                }, 
                    tabs.map((tab) => 
                        React.createElement('button', {
                            key: tab.id,
                            onClick: () => setActiveTab(tab.id),
                            className: `flex-1 min-w-[140px] py-4 px-6 flex items-center justify-center gap-3 transition-all duration-300 border-b-4 ${
                                activeTab === tab.id
                                    ? 'bg-gradient-to-b from-blue-50/80 to-white border-blue-600 text-blue-700 font-bold'
                                    : 'border-transparent text-slate-400 hover:text-slate-600 hover:bg-slate-50'
                            }`
                        }, [
                            React.createElement('i', { className: `fas ${tab.icon} text-lg` }),
                            React.createElement('span', { className: 'text-sm whitespace-nowrap' }, tab.label)
                        ])
                    )
                )
            );
        };
        
        // ============================================
        // COMPONENTE DE DISEÑO (DesignTab)
        // ============================================
        
        const DesignTab = ({ 
            nodes, 
            selectedNodeId, 
            setSelectedNodeId, 
            onUpdateNode, 
            onAddNode, 
            onDeleteNode, 
            showLegend, 
            setShowLegend 
        }) => {
            return (
                React.createElement('div', { className: 'flex h-full' }, [
                    React.createElement('div', {
                        className: 'w-80 xl:w-96 border-r border-slate-200 bg-gradient-to-b from-slate-50 to-blue-50/30 p-5 shrink-0 overflow-y-auto scrollbar-hide'
                    }, [
                        React.createElement(NodeForm, {
                            selectedNode: nodes.find(n => n.id === selectedNodeId) || null,
                            nodes: nodes,
                            onUpdate: onUpdateNode,
                            onAdd: onAddNode,
                            onDelete: onDeleteNode,
                            onCancel: () => setSelectedNodeId(null)
                        })
                    ]),
                    
                    React.createElement('div', { className: 'flex-1 relative' }, [
                        React.createElement('div', { className: 'absolute top-4 right-4 z-10 flex gap-2' }, [
                            React.createElement('button', {
                                onClick: () => setShowLegend(!showLegend),
                                className: 'glass-effect p-3 rounded-2xl border border-slate-200 card-shadow text-slate-600 hover:text-blue-600 transition-colors',
                                title: showLegend ? "Ocultar leyenda" : "Mostrar leyenda"
                            }, [
                                React.createElement('i', { className: `fas ${showLegend ? 'fa-eye-slash' : 'fa-eye'}` })
                            ])
                        ]),
                        
                        React.createElement(OrgChartD3, {
                            nodes: nodes,
                            selectedNodeId: selectedNodeId,
                            onSelectNode: setSelectedNodeId,
                            showLegend: showLegend
                        })
                    ])
                ])
            );
        };
        
        // ============================================
        // COMPONENTE PRINCIPAL (App)
        // ============================================
        
        const App = () => {
            const [activeTab, setActiveTab] = React.useState('carga');
            const [nodes, setNodes] = React.useState([]);
            const [selectedNodeId, setSelectedNodeId] = React.useState(null);
            const [viewMode, setViewMode] = React.useState('vertical');
            const [isSidebarOpen, setIsSidebarOpen] = React.useState(true);
            const [showLegend, setShowLegend] = React.useState(() => {
                try {
                    const saved = localStorage.getItem('luxanalitica_showLegend');
                    return saved ? JSON.parse(saved) : true;
                } catch {
                    return true;
                }
            });
            
            React.useEffect(() => {
                try {
                    const savedData = localStorage.getItem('luxanalitica_org_data');
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        if (Array.isArray(parsedData) && parsedData.length > 0) {
                            const sanitized = validateAndSanitizeNodes(parsedData);
                            setNodes(sanitized);
                            setActiveTab('diseno');
                        }
                    }
                } catch (error) {
                    console.error('Error al cargar datos guardados:', error);
                    localStorage.removeItem('luxanalitica_org_data');
                }
            }, []);
            
            React.useEffect(() => {
                if (nodes.length > 0) {
                    try {
                        localStorage.setItem('luxanalitica_org_data', JSON.stringify(nodes));
                    } catch (error) {
                        console.error('Error guardando datos:', error);
                    }
                }
            }, [nodes]);
            
            React.useEffect(() => {
                try {
                    localStorage.setItem('luxanalitica_showLegend', JSON.stringify(showLegend));
                } catch (error) {
                    console.error('Error guardando preferencia de leyenda:', error);
                }
            }, [showLegend]);
            
            const handleUpdateNode = React.useCallback((updatedNode) => {
                setNodes(prev => {
                    const sanitizedNode = {
                        ...updatedNode,
                        salary: Number(updatedNode.salary) || 0,
                        performance: Number(updatedNode.performance) || 80,
                        seniority: Number(updatedNode.seniority) || 0,
                        isCritical: Boolean(updatedNode.isCritical)
                    };
                    
                    return prev.map(node => 
                        node.id === sanitizedNode.id ? sanitizedNode : node
                    );
                });
            }, []);
            
            const handleAddNode = React.useCallback((newNode) => {
                // Validar ciclo jerárquico
                if (wouldCreateCycle(newNode.id, newNode.parentId, nodes)) {
                    alert('No se puede asignar este jefe porque se crearía un ciclo jerárquico.');
                    return;
                }
                
                const sanitizedNode = {
                    ...newNode,
                    salary: Number(newNode.salary) || 0,
                    performance: Number(newNode.performance) || 80,
                    seniority: Number(newNode.seniority) || 0,
                    isCritical: Boolean(newNode.isCritical)
                };
                
                setNodes(prev => [...prev, sanitizedNode]);
                setSelectedNodeId(sanitizedNode.id);
            }, [nodes]);
            
            const handleDeleteNode = React.useCallback((nodeId) => {
                if (window.confirm('¿Estás seguro de eliminar este colaborador? Los subordinados quedarán sin jefe asignado.')) {
                    setNodes(prev => {
                        return prev
                            .filter(node => node.id !== nodeId)
                            .map(node => 
                                node.parentId === nodeId 
                                    ? { ...node, parentId: null }
                                    : node
                            );
                    });
                    setSelectedNodeId(null);
                }
            }, []);
            
            const handleImport = React.useCallback((importedNodes) => {
                const sanitizedNodes = validateAndSanitizeNodes(importedNodes);
                setNodes(sanitizedNodes);
                setActiveTab('diseno');
            }, []);
            
            const handleHardReset = () => {
                if (window.confirm('¿Estás seguro de reiniciar toda la aplicación? Se perderán todos los datos.')) {
                    try {
                        localStorage.removeItem('luxanalitica_org_data');
                        localStorage.removeItem('luxanalitica_versions');
                        localStorage.removeItem('luxanalitica_showLegend');
                    } catch (error) {
                        console.warn('Error limpiando localStorage:', error);
                    }
                    setNodes([]);
                    setActiveTab('carga');
                    setSelectedNodeId(null);
                }
            };
            
            return (
                React.createElement('div', { className: 'flex h-screen w-screen overflow-hidden bg-slate-50' }, [
                    React.createElement(Sidebar, {
                        isOpen: isSidebarOpen,
                        onToggle: () => setIsSidebarOpen(!isSidebarOpen)
                    }),
                    
                    React.createElement('div', { className: 'flex-1 flex flex-col min-w-0' }, [
                        React.createElement('div', { className: 'flex justify-between items-center px-6 py-2 bg-white border-b border-slate-200' }, [
                            React.createElement('div', {}, []),
                            React.createElement('button', {
                                onClick: handleHardReset,
                                className: 'px-3 py-1 text-xs text-red-600 hover:text-red-800 font-medium flex items-center gap-1'
                            }, [
                                React.createElement('i', { className: 'fas fa-redo' }),
                                'Resetear Aplicación'
                            ])
                        ]),
                        
                        React.createElement(Header),
                        
                        React.createElement('div', { className: 'flex-1 flex flex-col p-4 md:p-6 overflow-hidden' }, [
                            React.createElement(TabNavigation, {
                                activeTab: activeTab,
                                setActiveTab: setActiveTab
                            }),
                            
                            React.createElement('div', {
                                className: 'flex-1 bg-white rounded-b-2xl card-shadow border border-slate-200 overflow-hidden relative'
                            }, 
                                activeTab === 'carga' ? React.createElement(UploadTab, { onImport: handleImport }) :
                                activeTab === 'diseno' ? React.createElement(DesignTab, {
                                    nodes: nodes,
                                    selectedNodeId: selectedNodeId,
                                    setSelectedNodeId: setSelectedNodeId,
                                    onUpdateNode: handleUpdateNode,
                                    onAddNode: handleAddNode,
                                    onDeleteNode: handleDeleteNode,
                                    showLegend: showLegend,
                                    setShowLegend: setShowLegend
                                }) :
                                activeTab === 'visualizacion' ? React.createElement(VisualTab, {
                                    nodes: nodes,
                                    viewMode: viewMode,
                                    setViewMode: setViewMode
                                }) :
                                activeTab === 'analisis' ? React.createElement(AnalysisTab, { nodes: nodes }) :
                                activeTab === 'exportacion' ? React.createElement(ExportTab, { nodes: nodes }) :
                                null
                            )
                        ])
                    ])
                ])
            );
        };
        
        // ============================================
        // RENDERIZAR LA APLICACIÓN CON REACT 18
        // ============================================
        
        // Esperar a que el DOM esté listo
        document.addEventListener('DOMContentLoaded', () => {
            const rootElement = document.getElementById('root');
            if (!rootElement) {
                console.error('No se encontró el elemento root');
                return;
            }
            
            try {
                const root = ReactDOM.createRoot(rootElement);
                root.render(
                    React.createElement(ErrorBoundary, {},
                        React.createElement(App)
                    )
                );
            } catch (error) {
                console.error('Error al renderizar la aplicación:', error);
                // Mostrar pantalla de error simple
                rootElement.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #ef4444;">
                        <h1 style="font-size: 24px; margin-bottom: 20px;">Error crítico en la aplicación</h1>
                        <p style="margin-bottom: 20px;">La aplicación no pudo iniciar correctamente.</p>
                        <button onclick="window.location.reload()" style="padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Recargar página
                        </button>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>
